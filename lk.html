<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tab-btn.active {
            border-color: #4f46e5;
            color: #4f46e5;
        }
        /* –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ –∑–∞–∫–∞–∑–æ–≤ */
        .order-card.hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="max-w-4xl mx-auto p-4 sm:p-6">
        <div id="loading-state">
            <p class="text-center text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤–∞—à–µ–≥–æ –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞...</p>
        </div>

        <div id="error-state" class="hidden text-center p-8 bg-red-100 rounded-lg">
            <h1 class="text-2xl font-bold text-red-700">–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞</h1>
            <p class="mt-2 text-red-600">–°—Å—ã–ª–∫–∞ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞ –∏–ª–∏ —É—Å—Ç–∞—Ä–µ–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø—Ä–æ—Å–∏—Ç–µ –Ω–æ–≤—É—é —Å—Å—ã–ª–∫—É —É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.</p>
        </div>

        <div id="main-content" class="hidden">
            <h1 class="text-3xl font-bold text-gray-800">–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, <span id="client-name"></span>!</h1>
            <p class="text-gray-600 mt-1">–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å—ã –≤–∞—à–∏—Ö –∑–∞–∫–∞–∑–æ–≤ –∏ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ.</p>

            <div class="bg-white p-6 rounded-lg shadow-md my-6">
                <h2 class="text-xl font-semibold mb-4">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑ –Ω–∞ –¥–æ—Å—Ç–∞–≤–∫—É</h2>
                <form id="add-order-form" class="space-y-4">
                    <div>
                        <label for="track_code" class="block text-sm font-medium text-gray-700">–¢—Ä–µ–∫-–∫–æ–¥</label>
                        <input type="text" id="track_code" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="comment" class="block text-sm font-medium text-gray-700">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–∫—Ä–∞—Å–Ω—ã–µ –∫—Ä–æ—Å—Å–æ–≤–∫–∏")</label>
                        <input type="text" id="comment" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border rounded-md shadow-sm font-medium text-white bg-green-600 hover:bg-green-700">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</button>
                </form>
            </div>

            <div class="my-4">
                <input type="search" id="client-order-search" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ —Ç—Ä–µ–∫-–∫–æ–¥—É..." class="w-full p-3 border rounded-lg shadow-sm">
            </div>

            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8" id="client-tabs">
                    <button data-tab="current" class="tab-btn active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">–¢–µ–∫—É—â–∏–µ –∑–∞–∫–∞–∑—ã</button>
                    <button data-tab="history" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700">–ò—Å—Ç–æ—Ä–∏—è</button>
                </nav>
            </div>

            <div class="mt-6">
                <div id="current-pane" class="space-y-4"></div>
                <div id="history-pane" class="hidden space-y-4"></div>
            </div>
        </div>
    </div>

    <script>
        const CLIENT_API_URL = 'http://127.0.0.1:8001'; 

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¢–ï–ö–£–©–ò–• –∑–∞–∫–∞–∑–æ–≤
        function renderOrders(orders) {
            const ordersList = document.getElementById('current-pane');
            if (orders.length === 0) {
                ordersList.innerHTML = '<p class="text-gray-500 p-4 text-center">–ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –Ω–µ—Ç.</p>';
            } else {
                ordersList.innerHTML = orders.map(order => `
                    <div class="bg-white p-4 rounded-lg shadow-sm order-card">
                        <div class="flex justify-between items-center">
                            <p class="font-bold text-gray-800 break-all">${order.track_code}</p>
                            <span class="text-xs text-center sm:text-sm font-semibold text-white bg-blue-500 px-3 py-1 rounded-full whitespace-nowrap ml-2">${order.status}</span>
                        </div>
                        ${order.comment ? `<p class="text-sm text-gray-600 mt-2"><b>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</b> ${order.comment}</p>` : ''}
                    </div>
                `).join('');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ò–°–¢–û–†–ò–ò –∑–∞–∫–∞–∑–æ–≤
        function renderHistory(orders) {
            const historyList = document.getElementById('history-pane');
            if (orders.length === 0) {
                historyList.innerHTML = '<p class="text-gray-500 p-4 text-center">–£ –≤–∞—Å –µ—â–µ –Ω–µ—Ç –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤.</p>';
            } else {
                historyList.innerHTML = orders.map(order => `
                    <div class="bg-white p-4 rounded-lg shadow-sm opacity-80 order-card">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-bold text-gray-600 break-all">${order.track_code}</p>
                                <p class="text-xs text-gray-500">–í—ã–¥–∞–Ω: ${new Date(order.issued_at).toLocaleDateString()}</p>
                            </div>
                            <span class="text-sm font-semibold text-gray-700 whitespace-nowrap ml-2">${order.final_cost_som ? order.final_cost_som.toFixed(2) + ' —Å–æ–º' : ''}</span>
                        </div>
                        ${order.comment ? `<p class="text-sm text-gray-500 mt-2"><b>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</b> ${order.comment}</p>` : ''}
                    </div>
                `).join('');
            }
        }
        
        // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ü–û–ò–°–ö–ê
        function handleClientOrderSearch(e) {
            const searchTerm = e.target.value.toLowerCase();
            // –ò—â–µ–º –ø–æ –≤—Å–µ–º –∫–∞—Ä—Ç–æ—á–∫–∞–º –∑–∞–∫–∞–∑–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
            document.querySelectorAll('.order-card').forEach(orderCard => {
                const trackCode = orderCard.querySelector('.font-bold').textContent.toLowerCase();
                if (trackCode.includes(searchTerm)) {
                    orderCard.classList.remove('hidden');
                } else {
                    orderCard.classList.add('hidden');
                }
            });
        }

        // –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∫–ª–∞–¥–æ–∫
        document.getElementById('client-tabs').addEventListener('click', (e) => {
            if (!e.target.classList.contains('tab-btn')) return;
            const tabName = e.target.dataset.tab;
            document.getElementById('client-tabs').querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active', 'border-indigo-600', 'text-indigo-600'));
            e.target.classList.add('active', 'border-indigo-600', 'text-indigo-600');
            document.getElementById('current-pane').classList.add('hidden');
            document.getElementById('history-pane').classList.add('hidden');
            document.getElementById(`${tabName}-pane`).classList.remove('hidden');
        });

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞
        document.getElementById('add-order-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const token = new URLSearchParams(window.location.search).get('token');
            const trackCode = document.getElementById('track_code').value;
            const comment = document.getElementById('comment').value;
            if (!trackCode) { alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç—Ä–µ–∫-–∫–æ–¥.'); return; }
            try {
                const response = await fetch(`${CLIENT_API_URL}/api/client/orders?token=${token}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ track_code: trackCode, comment: comment })
                });
                if (!response.ok) { const errData = await response.json(); throw new Error(errData.detail || "–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑."); }
                alert("–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!");
                location.reload();
            } catch (error) { alert(`–û—à–∏–±–∫–∞: ${error.message}`); }
        });

        // –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('DOMContentLoaded', async () => {
            const loadingDiv = document.getElementById('loading-state');
            const errorDiv = document.getElementById('error-state');
            const mainDiv = document.getElementById('main-content');

            try {
                const token = new URLSearchParams(window.location.search).get('token');
                if (!token) throw new Error("–¢–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω.");

                const response = await fetch(`${CLIENT_API_URL}/api/client/data?token=${token}`);
                if (!response.ok) throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.");
                
                const data = await response.json();
                document.getElementById('client-name').textContent = data.full_name;
                
                const allOrders = data.orders.sort((a, b) => new Date(b.created_at) - new Date(a.created_at)) || [];
                const currentOrders = allOrders.filter(order => order.status !== '–í—ã–¥–∞–Ω');
                const issuedOrders = allOrders.filter(order => order.status === '–í—ã–¥–∞–Ω');
                
                renderOrders(currentOrders);
                renderHistory(issuedOrders);

                // "–û–∂–∏–≤–ª—è–µ–º" –ø–æ–∏—Å–∫–æ–≤—É—é —Å—Ç—Ä–æ–∫—É
                document.getElementById('client-order-search').addEventListener('input', handleClientOrderSearch);

                loadingDiv.classList.add('hidden');
                mainDiv.classList.remove('hidden');
            } catch (error) {
                console.error(error);
                loadingDiv.classList.add('hidden');
                errorDiv.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
