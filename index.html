<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cargo CRM - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
    .modal { display: none; position: fixed; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s linear 0.3s; }
    .modal.is-open { display: flex; align-items: center; justify-content: center; opacity: 1; visibility: visible; transition: opacity 0.3s ease; }
    .modal-content { background-color: #fff; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); max-width: 90%; width: 800px; max-height: 90vh; overflow-y: auto; position: relative; }
    /* --- –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –°–¢–ò–õ–¨ –õ–û–ê–î–ï–†–ê --- */
#loader {
    display: none !important; /* –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —Å–∫—Ä—ã—Ç –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ */
    position: fixed; left: 0; top: 0; width: 100%; height: 100%;
    background-color: rgba(255, 255, 255, 0.7);
    z-index: 2000;
    align-items: center; justify-content: center; /* –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ display: flex */
}
    .loader-spinner { border: 8px solid #f3f3f3; border-top: 8px solid #4f46e5; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #calculate-modal .modal-content {
        width: 42rem; /* –ó–∞–¥–∞–µ–º —à–∏—Ä–∏–Ω—É (max-w-2xl) */
        min-height: 550px; /* –ó–∞–¥–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É, —á—Ç–æ–±—ã —Å–ø–∏—Å–æ–∫ –ø–æ–º–µ—â–∞–ª—Å—è */
    }
    /* –°—Ç–∏–ª—å –¥–ª—è –≤–ª–æ–∂–µ–Ω–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã –∑–∞–∫–∞–∑–æ–≤ */
   .order-details-row { background-color: #f8fafc; }
   .order-sub-list { padding: 10px 20px; }
   .order-sub-item { display: flex; align-items: center; padding: 4px 0; border-bottom: 1px dashed #e2e8f0; font-size: 0.85rem; color: #475569; }
   .order-sub-item:last-child { border-bottom: none; }

   /* –°—Ç–∏–ª–∏ –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (–ê–∫–∫–æ—Ä–¥–µ–æ–Ω –≤ –¥–æ–ª–≥–∞—Ö) */
.transaction-details-row {
    background-color: #f9fafb; /* –°–≤–µ—Ç–ª–æ-—Å–µ—Ä—ã–π —Ñ–æ–Ω */
    transition: all 0.3s ease;
}
.cursor-pointer {
    cursor: pointer;
}
/* –ê–Ω–∏–º–∞—Ü–∏—è —Å—Ç—Ä–µ–ª–∫–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ */
.details-open .arrow-icon {
    transform: rotate(180deg);
}
</style>
</head>
<body class="bg-gray-100">
    <div id="loader"><div class="loader-spinner"></div></div>

    <div id="shift-screen" class="hidden min-h-screen flex items-center justify-center">
    <div class="max-w-md w-full bg-white p-8 rounded-lg shadow-lg">
        <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">–û—Ç–∫—Ä—ã—Ç—å –Ω–æ–≤—É—é —Å–º–µ–Ω—É</h2>
        <form id="open-shift-form" class="space-y-4">
            <div id="shift-employee-selector" class="hidden">
                <label for="shift-employee-select" class="block text-sm font-medium text-gray-700">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</label>
                <select id="shift-employee-select" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white"></select>
            </div>
            <div id="shift-location-selector" class="hidden">
                <label for="shift-location-select" class="block text-sm font-medium text-gray-700">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª–∏–∞–ª</label>
                <select id="shift-location-select" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white"></select>
            </div>
            <div>
                <label for="shift-exchange-rate" class="block text-sm font-medium text-gray-700">–¢–µ–∫—É—â–∏–π –∫—É—Ä—Å $</label>
                <input type="number" step="0.1" id="shift-exchange-rate" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
            </div>
            <div>
                <label for="shift-price-per-kg" class="block text-sm font-medium text-gray-700">–¶–µ–Ω–∞ –∑–∞ –∫–≥ ($)</label>
                <input type="number" step="0.1" id="shift-price-per-kg" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
            </div>
            <div>
                <label for="starting-cash" class="block text-sm font-medium text-gray-700">–ù–∞–ª–∏—á–Ω—ã–µ –≤ –∫–∞—Å—Å–µ (—Å–æ–º)</label>
                <input type="number" step="0.01" id="starting-cash" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
            </div>
            <button type="submit" class="w-full flex justify-center py-2 px-4 border rounded-md shadow-sm font-medium text-white bg-green-600 hover:bg-green-700">–ù–∞—á–∞—Ç—å —Å–º–µ–Ω—É</button>
             <button type="button" id="cancel-open-shift-btn" class="hidden w-full flex justify-center py-2 px-4 border rounded-md shadow-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 mt-2">–û—Ç–º–µ–Ω–∞</button>
        </form>
    </div>
</div>

    <div id="login-screen" class="min-h-screen flex items-center justify-center">
        <div class="max-w-md w-full bg-white p-8 rounded-lg shadow-lg">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">–í—Ö–æ–¥ –≤ Cargo CRM</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="company-code" class="block text-sm font-medium text-gray-700">–ö–æ–¥ –ö–æ–º–ø–∞–Ω–∏–∏</label>
                    <input type="text" id="company-code" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: SUPER –∏–ª–∏ VISH" required
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm uppercase">
                    <p class="text-xs text-gray-500 mt-1">–î–ª—è –≤—Ö–æ–¥–∞ –∫–∞–∫ –°—É–ø–µ—Ä-–ê–¥–º–∏–Ω, –≤–≤–µ–¥–∏—Ç–µ <b>SUPER</b>.</p>
                </div>
                <div class="mb-4">
                    <label for="password" class="block text-sm font-medium text-gray-700">–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="password" required
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <button type="submit" class="w-full flex justify-center py-2 px-4 border rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">–í–æ–π—Ç–∏</button>
            </form>
            <p id="login-error" class="text-red-500 text-sm mt-4 text-center"></p>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <div class="max-w-7xl mx-auto p-4 sm:p-6">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
                <div class="flex items-center gap-4">
                    <div id="user-info" class="text-right"></div>
                    <div id="company-info" class="text-right border-l pl-4"></div>
                    <button id="logout-btn" title="–í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-3 rounded-lg text-sm">–í—ã–π—Ç–∏</button>
                </div>
            </div>
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8" id="tabs"></nav>
            </div>
            <div id="tab-content" class="mt-6"></div>
        </div>
    </div>

    <div id="company-modal" class="modal"><div class="modal-content w-full max-w-lg"></div></div>
    <div id="location-modal" class="modal"><div class="modal-content w-full max-w-md"></div></div>
    <div id="employee-modal" class="modal"><div class="modal-content w-full max-w-md"></div></div>
    <div id="role-modal" class="modal"><div class="modal-content w-full max-w-md"></div></div>
    <div id="permissions-modal" class="modal"><div class="modal-content w-full max-w-2xl"></div></div>

    <div id="client-tools-modal" class="modal">
    <div class="modal-content w-full max-w-lg">
        <div class="flex justify-between items-start">
            <h3 class="text-2xl font-bold mb-4">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –ö–ª–∏–µ–Ω—Ç–æ–≤</h3>
            <button onclick="closeModal('client-tools-modal')" class="text-2xl font-bold">&times;</button>
        </div>

        <div class="bg-gray-50 p-4 rounded-lg">
            <h4 class="text-lg font-semibold mb-2">–ò–º–ø–æ—Ä—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏–∑ Excel</h4>
            <p class="text-sm text-gray-600 mb-1">–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏: <strong>full_name</strong>, <strong>phone</strong>.</p>
            <p class="text-sm text-gray-600 mb-4">–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ: <strong>client_code</strong> (–ø—Ä–µ—Ñ–∏–∫—Å+–Ω–æ–º–µ—Ä –∏–ª–∏ —Ç–æ–ª—å–∫–æ –Ω–æ–º–µ—Ä).</p>
            <input type="file" id="client-excel-input" accept=".xlsx, .xls" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
            <button id="import-clients-btn" class="mt-4 w-full bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <div id="client-import-results" class="mt-4 text-sm max-h-40 overflow-y-auto border p-2 bg-white rounded"></div>
        </div>

         </div>
</div>

<div id="expense-type-modal" class="modal"><div class="modal-content w-full max-w-md"></div></div>

<div id="client-modal" class="modal">
    <div class="modal-content w-full max-w-md">
        </div>
</div>

<div id="edit-order-modal" class="modal">
    <div class="modal-content w-full max-w-lg">
        </div>
</div>

<div id="buyout-modal" class="modal">
    <div class="modal-content w-full max-w-lg">
        </div>
</div>

<div id="expense-modal" class="modal">
    <div class="modal-content w-full max-w-md">
        </div>
</div>

<div id="issue-modal" class="modal">
    <div class="modal-content w-full max-w-4xl">
        </div>
</div>

<div id="issued-history-modal" class="modal">
    <div class="modal-content w-full max-w-5xl">
        </div>
</div>

<div id="calculate-modal" class="modal">
        <div class="modal-content relative bg-white p-6 rounded-lg shadow-lg max-w-2xl w-full">
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-2xl font-bold">–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç</h3>
                <button onclick="closeModal('calculate-modal')" class="text-2xl font-bold">&times;</button>
            </div>

            <div id="calc-step-1-search" class="space-y-4">
                 <label class="block text-sm font-medium">–ù–∞–π–¥–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞</label>
                <div class="relative">
                    <input type="text" id="calc-client-search-input" autocomplete="off" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è, –∫–æ–¥ –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω..." class="w-full p-2 border rounded">
                    <div id="calc-client-search-results" class="absolute hidden top-full left-0 right-0 bg-white border mt-1 rounded-md shadow-lg z-30 max-h-48 overflow-y-auto"></div>
                </div>
                <p id="calc-selected-client-info" class="hidden text-center font-semibold p-2 bg-gray-100 rounded"></p>
                <input type="hidden" id="calc-selected-client-id">
            </div>

            <div id="calc-step-2-orders" class="hidden space-y-4 mt-4 border-t pt-4">
                <label class="block text-sm font-medium">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–∫–∞–∑—ã –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞:</label>
                <div id="calc-orders-list" class="max-h-60 overflow-y-auto space-y-2 border p-2 rounded">
                    <p class="text-gray-500">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞.</p>
                </div>
                 <div class="flex items-center">
                    <input type="checkbox" id="calc-select-all-orders" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                    <label for="calc-select-all-orders" class="ml-2 text-sm">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</label>
                </div>
            </div>

            <div id="calc-step-3-calculation" class="hidden mt-4 border-t pt-4 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-4">
                     <div class="p-3 bg-blue-50 rounded-lg">
                        <label class="block text-sm font-medium">–û–±—â–∏–π –≤–µ—Å (–∫–≥)</label>
                        <input type="number" step="any" id="calc-total-weight-input" placeholder="–î–ª—è –∞–≤—Ç–æ-—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è" class="mt-1 w-full p-2 border rounded-md">
                    </div>
                    <div id="calc-individual-weights" class="max-h-40 overflow-y-auto pr-2 space-y-2">
                        </div>
                </div>
                 <div class="space-y-4">
                     <div class="p-3 bg-gray-100 rounded-lg space-y-2">
                        <div>
                            <label class="block text-sm">–¶–µ–Ω–∞ –∑–∞ –∫–≥ ($) *</label>
                            <input type="number" step="0.1" id="calc-price-per-kg" value="" class="w-full p-2 border rounded" required>
                        </div>
                        <div>
                            <label class="block text-sm">–ö—É—Ä—Å USD (—Å–æ–º) *</label>
                            <input type="number" step="0.1" id="calc-exchange-rate" value="" class="w-full p-2 border rounded" required>
                        </div>
                    </div>
                     <div class="p-4 bg-indigo-50 rounded-lg text-right">
                        <div class="text-lg">–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ: <span id="calc-total-cost-display" class="font-bold">0.00 —Å–æ–º</span></div>
                     </div>
                </div>
            </div>

            <div id="calc-step-4-actions" class="hidden mt-6 flex justify-between items-center border-t pt-4">
                 <div class="flex items-center gap-2">
                     <label for="calc-new-status-select" class="text-sm">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞:</label>
                     <select id="calc-new-status-select" class="p-2 border rounded bg-white text-sm">
                         <option value="">-- –ù–µ –º–µ–Ω—è—Ç—å --</option>
                         </select>
                 </div>
                 <div class="flex gap-4">
                    <button type="button" onclick="closeModal('calculate-modal')" class="bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-6 rounded-lg">–û—Ç–º–µ–Ω–∞</button>
                    <button type="button" id="save-calculation-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                 </div>
             </div>

        </div>
    </div>

    <div id="assign-client-modal" class="modal">
    <div class="modal-content w-full max-w-lg">
        <div class="flex justify-between items-start mb-4">
            <h3 class="text-2xl font-bold">–ù–∞–∑–Ω–∞—á–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</h3>
            <button onclick="closeModal('assign-client-modal')" class="text-2xl font-bold">&times;</button>
        </div>
        <p id="assign-client-info" class="mb-4 font-semibold text-gray-700">–í—ã–±—Ä–∞–Ω–æ –∑–∞–∫–∞–∑–æ–≤: 0</p>
        <div class="relative">
            <label for="assign-client-search-input" class="block text-sm font-medium text-gray-700">–ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞ (–∏–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω, –∫–æ–¥)</label>
            <input type="text" id="assign-client-search-input" autocomplete="off" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è, –∫–æ–¥ –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω..." class="w-full p-2 border rounded mt-1">
            <div id="assign-client-search-results" class="absolute hidden top-full left-0 right-0 bg-white border mt-1 rounded-md shadow-lg z-30 max-h-48 overflow-y-auto"></div>
        </div>
        <input type="hidden" id="assign-client-selected-id">
        <p id="assign-client-selected-info" class="hidden text-center font-semibold p-2 bg-gray-100 rounded mt-4"></p>
        <div class="mt-4">
            <label for="assign-client-new-status" class="block text-sm font-medium text-gray-700">–ù–∞–∑–Ω–∞—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å:</label>
            <select id="assign-client-new-status" class="mt-1 w-full p-2 border rounded bg-white focus:ring-indigo-500 focus:border-indigo-500">
                </select>
        </div>
        <div class="flex gap-4 mt-6 border-t pt-4">
            <button type="button" onclick="closeModal('assign-client-modal')" class="w-full bg-gray-200 py-2 rounded hover:bg-gray-300">–û—Ç–º–µ–Ω–∞</button>
            <button type="button" id="assign-client-save-btn" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 disabled:opacity-50" disabled>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
        </div>
    </div>
</div>

<div id="manual-claim-modal" class="modal">
    <div class="modal-content w-full max-w-5xl h-[90vh] flex flex-col">
        <div class="flex justify-between items-start mb-4">
            <div>
                <h3 class="text-2xl font-bold text-gray-800">–†—É—á–Ω–æ–µ –ø—Ä–∏—Å–≤–æ–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤</h3>
                <p class="text-sm text-gray-500">–ù–∞–π–¥–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –µ–≥–æ –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã–µ –ø–æ—Å—ã–ª–∫–∏</p>
            </div>
            <button onclick="closeModal('manual-claim-modal')" class="text-2xl font-bold">&times;</button>
        </div>

        <div class="flex-grow flex flex-col md:flex-row gap-6 overflow-hidden">
            <div class="w-full md:w-1/3 flex flex-col border-r pr-4 bg-gray-50 p-4 rounded-l-lg">
                <h4 class="font-bold text-lg mb-3 text-indigo-800">1. –ö–û–ú–£ –ü–†–ò–°–í–û–ò–¢–¨?</h4>
                
                <div id="claim-client-search-container" class="relative mb-4">
                    <label class="text-xs text-gray-500 mb-1 block">–ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞ (–ò–º—è, –ö–æ–¥, –¢–µ–ª)</label>
                    <input type="text" id="claim-client-search" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å..." class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 shadow-sm">
                    <div id="claim-client-results" class="absolute hidden top-full left-0 right-0 bg-white border mt-1 rounded-md shadow-xl z-50 max-h-60 overflow-y-auto"></div>
                </div>
                
                <div id="claim-selected-client-card" class="hidden flex-col items-center text-center p-4 bg-white rounded-xl border-2 border-indigo-500 shadow-md animation-fade-in">
                    <div class="bg-indigo-100 text-indigo-600 rounded-full p-3 mb-2">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                    </div>
                    <div id="claim-client-info-block" class="mb-3"></div>
                    
                    <input type="hidden" id="claim-selected-client-id">
                    <button id="claim-change-client-btn" class="text-sm text-red-500 hover:text-red-700 font-medium border border-red-200 px-3 py-1 rounded hover:bg-red-50 transition">‚úï –°–º–µ–Ω–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</button>
                </div>
                
                <div id="claim-client-placeholder" class="flex-grow flex items-center justify-center text-center text-gray-400">
                    <div>
                        <p class="text-4xl mb-2">üëà</p>
                        <p>–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞,<br>—á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É</p>
                    </div>
                </div>
            </div>

            <div class="w-full md:w-2/3 flex flex-col relative">
                <div class="flex justify-between items-end mb-3">
                    <h4 class="font-bold text-lg text-gray-800">2. –ß–¢–û –ü–†–ò–°–í–û–ò–¢–¨?</h4>
                </div>
                
                <div class="mb-3 relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                    <input type="text" id="claim-order-search" placeholder="üîç –°–∫–∞–Ω–∏—Ä—É–π—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —á–∞—Å—Ç—å —Ç—Ä–µ–∫-–∫–æ–¥–∞..." class="w-full pl-10 p-3 border rounded-lg focus:ring-2 focus:ring-green-500 disabled:bg-gray-100" disabled>
                </div>

                <div class="flex-grow overflow-y-auto border rounded-lg bg-white relative shadow-inner">
                    <div class="grid grid-cols-12 gap-2 bg-gray-100 p-2 text-xs font-bold text-gray-500 border-b sticky top-0 z-10">
                        <div class="col-span-1 text-center">‚úì</div>
                        <div class="col-span-7">–¢—Ä–µ–∫-–∫–æ–¥ / –ò–Ω—Ñ–æ</div>
                        <div class="col-span-4 text-right">–î–∞—Ç–∞</div>
                    </div>
                    
                    <div id="claim-orders-list" class="divide-y divide-gray-100">
                        <p class="text-center text-gray-400 p-10 mt-10">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ —Å–ª–µ–≤–∞ üëà</p>
                    </div>
                    
                    <div id="claim-loading-overlay" class="hidden absolute inset-0 bg-white bg-opacity-90 flex items-center justify-center z-20">
                        <div class="text-center">
                            <div class="loader-spinner border-4 w-10 h-10 border-indigo-500 mx-auto mb-2"></div>
                            <p class="text-indigo-600 font-medium">–ó–∞–≥—Ä—É–∂–∞—é "–ø–æ—Ç–µ—Ä—è—à–µ–∫"...</p>
                        </div>
                    </div>
                </div>

                <div class="mt-auto border-t bg-gray-50 p-4 rounded-b-lg">
                    
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center gap-3">
                            <span class="text-sm font-bold text-gray-700">–°—Ç–∞—Ç—É—Å:</span>
                            <select id="claim-new-status" class="border-gray-300 rounded-md text-sm p-2 shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="–í –ø—É—Ç–∏" selected>üöö –í –ø—É—Ç–∏ (–°—Ç–∞–Ω–¥–∞—Ä—Ç)</option>
                                <option value="–ù–∞ —Å–∫–ª–∞–¥–µ –≤ –ö–†">üá∞üá¨ –ù–∞ —Å–∫–ª–∞–¥–µ –≤ –ö–†</option>
                                <option value="–ì–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ">‚úÖ –ì–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ (+ –†–∞—Å—á–µ—Ç)</option>
                            </select>
                        </div>
                        <div class="text-sm">
                            –í—ã–±—Ä–∞–Ω–æ: <span id="claim-top-selected-count" class="font-bold text-blue-600 text-lg">0</span> —à—Ç.
                        </div>
                    </div>

                    <div id="claim-calculation-panel" class="hidden bg-white border border-green-200 rounded-lg p-3 mb-4 shadow-inner animate-fade-in">
                        <h5 class="text-xs font-bold text-green-800 uppercase mb-2">‚ö°Ô∏è –≠–∫—Å–ø—Ä–µ—Å—Å-—Ä–∞—Å—á–µ—Ç</h5>
                        <div class="grid grid-cols-3 gap-3">
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">–û–±—â–∏–π –≤–µ—Å (–∫–≥)</label>
                                <input type="number" id="claim-total-weight" step="0.001" placeholder="0.000" class="w-full p-2 border border-green-300 rounded text-sm focus:ring-green-500 focus:border-green-500 font-bold">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">–¶–µ–Ω–∞ ($/–∫–≥)</label>
                                <input type="number" id="claim-price" step="0.1" class="w-full p-2 border border-gray-300 rounded text-sm bg-gray-50">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">–ö—É—Ä—Å ($)</label>
                                <input type="number" id="claim-rate" step="0.1" class="w-full p-2 border border-gray-300 rounded text-sm bg-gray-50">
                            </div>
                        </div>
                        <div class="mt-2 text-right text-sm">
                            –ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ: <span id="claim-total-sum" class="font-bold text-green-600 text-lg">0</span> —Å–æ–º
                        </div>
                    </div>

                    <div class="flex justify-end">
                        <button id="claim-submit-btn" class="w-full md:w-auto bg-green-600 text-white font-bold py-3 px-10 rounded-xl hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg transform active:scale-95 transition-all flex justify-center items-center gap-2" disabled>
                            <span id="claim-btn-text">–ü–†–ò–°–í–û–ò–¢–¨</span>
                            <span id="claim-btn-badge" class="bg-white text-green-700 text-xs py-0.5 px-2 rounded-full hidden">0</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="buyout-cart-modal" class="modal">
    <div class="modal-content w-full max-w-6xl h-[90vh] flex flex-col">
        <div class="flex justify-between items-start mb-4 border-b pb-2">
            <div>
                <h3 class="text-2xl font-bold text-gray-800">üõí –ö–æ—Ä–∑–∏–Ω–∞ –í—ã–∫—É–ø–∞</h3>
                <p class="text-sm text-gray-500">–î–æ–±–∞–≤–ª—è–π—Ç–µ –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ —Ñ–∏–∫—Å–∏—Ä—É–π—Ç–µ –æ–ø–ª–∞—Ç—ã –æ–¥–Ω–∏–º —Å–ø–∏—Å–∫–æ–º.</p>
            </div>
            <div class="flex items-center gap-4">
                <div>
                    <label class="text-xs font-bold text-gray-600 block">–ö—É—Ä—Å —Å–µ–≥–æ–¥–Ω—è (—Å–æ–º/—é–∞–Ω—å):</label>
                    <input type="number" id="buyout-cart-rate" class="border border-purple-300 rounded p-1 w-24 font-bold text-purple-700 text-center" step="0.01" placeholder="0.00">
                </div>
                <button onclick="closeModal('buyout-cart-modal')" class="text-4xl font-bold text-gray-400 hover:text-gray-600">&times;</button>
            </div>
        </div>

        <div class="mb-4 relative z-20">
            <input type="text" id="buyout-cart-search" placeholder="‚ûï –ù–∞–π—Ç–∏ –∏ –¥–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ (–ò–º—è, –¢–µ–ª–µ—Ñ–æ–Ω, –ö–æ–¥)..." class="w-full p-3 border rounded-lg shadow-sm focus:ring-2 focus:ring-purple-500 text-lg">
            <div id="buyout-cart-search-results" class="absolute hidden top-full left-0 right-0 bg-white border mt-1 rounded-md shadow-xl max-h-60 overflow-y-auto"></div>
        </div>

        <div class="flex-grow overflow-y-auto border rounded-lg bg-white shadow-inner relative">
            <table class="w-full text-left border-collapse">
                <thead class="bg-gray-100 sticky top-0 z-10 text-xs uppercase text-gray-600">
                    <tr>
                        <th class="p-3 border-b">–ö–ª–∏–µ–Ω—Ç</th>
                        <th class="p-3 border-b text-center">–ó–∞–∫–∞–∑–æ–≤</th>
                        <th class="p-3 border-b text-right">–°—É–º–º–∞ (¬•)</th>
                        <th class="p-3 border-b text-right">–ò—Ç–æ–≥ (—Å–æ–º)</th>
                        <th class="p-3 border-b text-center w-48">–û–ø–ª–∞—á–µ–Ω–æ (—Å–æ–º)</th>
                        <th class="p-3 border-b text-right">–î–æ–ª–≥</th>
                        <th class="p-3 border-b text-center">–£–±—Ä–∞—Ç—å</th>
                    </tr>
                </thead>
                <tbody id="buyout-cart-table-body" class="text-sm">
                    </tbody>
            </table>
            <div id="buyout-cart-empty-msg" class="flex flex-col items-center justify-center h-full text-gray-400">
                <span class="text-5xl mb-2">üõí</span>
                <p>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞. –ù–∞–π–¥–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ —Å–≤–µ—Ä—Ö—É.</p>
            </div>
        </div>

        <div class="mt-auto border-t bg-gray-50 p-4 rounded-b-lg flex justify-between items-center">
            <div class="text-sm text-gray-600">
                –ö–ª–∏–µ–Ω—Ç–æ–≤: <span id="buyout-cart-client-count" class="font-bold">0</span> | 
                –ó–∞–∫–∞–∑–æ–≤: <span id="buyout-cart-order-count" class="font-bold">0</span>
            </div>
            <div class="text-right flex gap-4 items-center">
                <div>
                    <div class="text-xs text-gray-500">–û–±—â–∞—è —Å—É–º–º–∞ –≤—ã–∫—É–ø–∞:</div>
                    <div id="buyout-cart-total-sum" class="text-xl font-bold text-gray-800">0 —Å.</div>
                </div>
                <button id="buyout-cart-submit-btn" class="bg-purple-600 text-white font-bold py-3 px-8 rounded-xl hover:bg-purple-700 shadow-lg transform active:scale-95 transition-all disabled:opacity-50" disabled>
                    ‚úÖ –í–´–ö–£–ü–ò–¢–¨ –í–°–ï–•
                </button>
            </div>
        </div>
    </div>
</div>

<div id="mass-track-update-modal" class="modal">
    <div class="modal-content w-full max-w-4xl h-[85vh] flex flex-col">
        <div class="flex justify-between items-center mb-4 border-b pb-2">
            <h3 class="text-2xl font-bold text-gray-800">üìù –ú–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç—Ä–µ–∫–æ–≤</h3>
            <button onclick="closeModal('mass-track-update-modal')" class="text-2xl font-bold">&times;</button>
        </div>
        
        <div class="mb-4 relative z-30">
            <label class="block text-xs font-bold text-gray-500 mb-1">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞:</label>
            <input type="text" id="mass-track-client-search" placeholder="üîç –ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞ (–ò–º—è, –ö–æ–¥)..." class="w-full p-3 border rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500">
            <div id="mass-track-client-results" class="absolute hidden top-full left-0 right-0 bg-white border mt-1 rounded-md shadow-xl max-h-60 overflow-y-auto"></div>
            <input type="hidden" id="mass-track-selected-client-id">
        </div>

        <div class="bg-blue-50 p-3 rounded mb-4 text-sm text-blue-800 flex justify-between items-center">
            <span id="mass-track-info-text">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –µ–≥–æ –∑–∞–∫–∞–∑—ã <b>PENDING...</b></span>
        </div>

        <div class="flex-grow overflow-y-auto border rounded-lg bg-white relative shadow-inner">
            <table class="w-full text-left">
                <thead class="bg-gray-100 sticky top-0 z-10 text-xs uppercase text-gray-600">
                    <tr>
                        <th class="p-3 border-b">–ö–ª–∏–µ–Ω—Ç</th>
                        <th class="p-3 border-b">–¢–æ–≤–∞—Ä / –ö–æ–º–º–µ–Ω—Ç</th>
                        <th class="p-3 border-b">–¢–µ–∫—É—â–∏–π PENDING</th>
                        <th class="p-3 border-b w-1/3">‚¨áÔ∏è –ù–û–í–´–ô –¢–†–ï–ö (–í–≤–æ–¥)</th>
                    </tr>
                </thead>
                <tbody id="mass-track-table-body" class="text-sm">
                    </tbody>
            </table>
            <div id="mass-track-empty-msg" class="p-10 text-center text-gray-400 flex flex-col items-center">
                <span class="text-4xl mb-2">üëà</span>
                <span>–í–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –ø–æ–∏—Å–∫–æ–º —Å–≤–µ—Ä—Ö—É</span>
            </div>
        </div>

        <div class="mt-4 pt-4 border-t flex justify-end">
            <button id="mass-track-save-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 shadow-md disabled:opacity-50" disabled>
                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –£–≤–µ–¥–æ–º–∏—Ç—å
            </button>
        </div>
    </div>
</div>

<script>
// =================================================================
// –ú–û–î–£–õ–¨: –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò –ù–ê–°–¢–†–û–ô–ö–ò (v4.1 - Rebuild)
// =================================================================
const API_URL = 'http://213.148.7.107:8000'; // URL –≤–∞—à–µ–≥–æ –±—ç–∫–µ–Ω–¥–∞
let currentUser = {}; // –î–∞–Ω–Ω—ã–µ –≤–æ—à–µ–¥—à–µ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ { id, full_name, role, permissions, is_super_admin }
let currentCompany = {}; // –î–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–π –∫–æ–º–ø–∞–Ω–∏–∏ { id, name } (null –¥–ª—è SuperAdmin)
let activeShift = null; // –î–∞–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ–π —Å–º–µ–Ω—ã { id, start_time, employee_id, location_id, ... } (null –µ—Å–ª–∏ –Ω–µ—Ç)

// --- –ö—ç—à–∏ –¥–∞–Ω–Ω—ã—Ö (–∑–∞–ø–æ–ª–Ω—è—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏) ---
// –≠—Ç–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –±—É–¥—É—Ç —Ö—Ä–∞–Ω–∏—Ç—å —Å–ø–∏—Å–∫–∏ –æ–±—ä–µ–∫—Ç–æ–≤, –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞,
// —á—Ç–æ–±—ã –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å –∏—Ö –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –∏–ª–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–µ —Å–ø–∏—Å–∫–æ–≤.
let companyLocations = []; // –°–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤ Location –¥–ª—è —Ç–µ–∫—É—â–µ–π –∫–æ–º–ø–∞–Ω–∏–∏
let companyRoles = []; // –°–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤ Role –¥–ª—è —Ç–µ–∫—É—â–µ–π –∫–æ–º–ø–∞–Ω–∏–∏
let companyPermissions = []; // –°–ø–∏—Å–æ–∫ –í–°–ï–• –æ–±—ä–µ–∫—Ç–æ–≤ Permission (–≥–ª–æ–±–∞–ª—å–Ω—ã–µ)
let companyClients = []; // –°–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤ Client –¥–ª—è —Ç–µ–∫—É—â–µ–π –∫–æ–º–ø–∞–Ω–∏–∏
let companyOrders = []; // –°–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤ Order –¥–ª—è —Ç–µ–∫—É—â–µ–π –∫–æ–º–ø–∞–Ω–∏–∏ (–ø–æ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Ñ–∏–ª—å—Ç—Ä—É)
let orderStatuses = ["–í –æ–±—Ä–∞–±–æ—Ç–∫–µ", "–û–∂–∏–¥–∞–µ—Ç –≤—ã–∫—É–ø–∞", "–í—ã–∫—É–ø–ª–µ–Ω", "–ù–∞ —Å–∫–ª–∞–¥–µ –≤ –ö–∏—Ç–∞–µ", "–í –ø—É—Ç–∏", "–ù–∞ —Å–∫–ª–∞–¥–µ –≤ –ö–†", "–ì–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ", "–í—ã–¥–∞–Ω"]; // –°–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫-—Å—Ç–∞—Ç—É—Å–æ–≤
let availablePartyDates = []; // –°–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫-–¥–∞—Ç (YYYY-MM-DD)
let companyExpenseTypes = []; // –°–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤ ExpenseType –¥–ª—è —Ç–µ–∫—É—â–µ–π –∫–æ–º–ø–∞–Ω–∏–∏

// --- –°—Å—ã–ª–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–Ω—ã–µ DOM-—ç–ª–µ–º–µ–Ω—Ç—ã (–¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞) ---
// –ò—â–µ–º —ç—Ç–∏ —ç–ª–µ–º–µ–Ω—Ç—ã –û–î–ò–ù –†–ê–ó –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–∫—Ä–∏–ø—Ç–∞. –ï—Å–ª–∏ –∏—Ö –Ω–µ—Ç - —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ HTML.
const loginScreen = document.getElementById('login-screen');
const mainApp = document.getElementById('main-app');
const loginForm = document.getElementById('login-form');
const loginError = document.getElementById('login-error');
const loader = document.getElementById('loader');
const tabsContainer = document.getElementById('tabs');
const tabContentContainer = document.getElementById('tab-content');

// --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –æ—Å–Ω–æ–≤–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ ---
// –ï—Å–ª–∏ –∫–∞–∫–æ–π-—Ç–æ –∏–∑ —ç—Ç–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ HTML, –¥–∞–ª—å–Ω–µ–π—à–∞—è —Ä–∞–±–æ—Ç–∞ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞.
if (!loginScreen || !mainApp || !loginForm || !loginError || !loader || !tabsContainer || !tabContentContainer) {
    console.error("!!! –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –û–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ DOM (loginScreen, mainApp, loginForm, loginError, loader, tabs, tab-content) –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–∫—Ä–∏–ø—Ç–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ HTML-—Ä–∞–∑–º–µ—Ç–∫—É. !!!");
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞
    document.body.innerHTML = '<div style="padding: 20px; text-align: center; color: red; font-size: 1.2em;">–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.</div>';
    // –ú–æ–∂–Ω–æ –≤—ã–±—Ä–æ—Å–∏—Ç—å –æ—à–∏–±–∫—É, —á—Ç–æ–±—ã —Ç–æ—á–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫—Ä–∏–ø—Ç:
    // throw new Error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã DOM –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.");
} else {
     console.log("[Init] –û—Å–Ω–æ–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã DOM –Ω–∞–π–¥–µ–Ω—ã.");
}

// =================================================================
// –ú–û–î–£–õ–¨: –£–¢–ò–õ–ò–¢–´ (–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏)
// =================================================================

// –ü–æ–∫–∞–∑–∞—Ç—å/–°–∫—Ä—ã—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
const showLoader = () => {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º setProperty –¥–ª—è –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è !important –≤ CSS, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
    loader?.style.setProperty('display', 'flex', 'important');
};
const hideLoader = () => {
    loader?.style.setProperty('display', 'none', 'important');
};

// –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ ID
const openModal = (modalId) => {
     const modal = document.getElementById(modalId);
     if (modal) {
          modal.classList.add('is-open');
          console.log(`[Util] Modal opened: #${modalId}`);
     } else {
          console.error(`[Util] openModal: Modal #${modalId} not found.`);
          alert(`–û—à–∏–±–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞: –ù–µ –Ω–∞–π–¥–µ–Ω–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ ${modalId}`);
     }
};

// –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ ID
const closeModal = (modalId) => {
     const modal = document.getElementById(modalId);
     if (modal) {
          modal.classList.remove('is-open');
          console.log(`[Util] Modal closed: #${modalId}`);
     } else {
          console.error(`[Util] closeModal: Modal #${modalId} not found.`);
     }
};

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ API –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
async function handleApiError(response) {
    try {
        // –ü—ã—Ç–∞–µ–º—Å—è –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ç–µ–ª–æ –æ—Ç–≤–µ—Ç–∞ –∫–∞–∫ JSON
        const errorJson = await response.json();
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–ª–µ 'detail' (—Å—Ç–∞–Ω–¥–∞—Ä—Ç –¥–ª—è FastAPI) –∏–ª–∏ –≤–µ—Å—å JSON, –µ—Å–ª–∏ 'detail' –Ω–µ—Ç
        return errorJson.detail || JSON.stringify(errorJson);
    } catch (e) {
        // –ï—Å–ª–∏ —Ç–µ–ª–æ –Ω–µ JSON –∏–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –¥—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞—Ç—É—Å
        console.warn(`[Util] handleApiError: Could not parse error response as JSON. Status: ${response.status}`);
        return `–°—Ç–∞—Ç—É—Å: ${response.status} - ${response.statusText || 'Unknown Server Error'}`;
    }
}

// --- –û–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API (–ò–°–ü–†–ê–í–õ–ï–ù–ê –¥–ª—è GET params) ---
async function apiFetch(endpoint, options = {}) {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –∑–∞–ø—Ä–æ—Å–æ–º
    if (!currentUser || !currentUser.id) {
         console.error(`[API] –ü–æ–ø—ã—Ç–∫–∞ –≤—ã–∑–æ–≤–∞ API (${endpoint}) –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏! –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞...`);
         alert("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.");
         location.reload();
         throw new Error("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω");
    }

    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    options.headers = {
        'Content-Type': 'application/json',
        'X-Employee-ID': currentUser.id, // –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
        ...options.headers
    };

    // --- –î–û–ë–ê–í–õ–ï–ù–û: –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–ª—è GET –∑–∞–ø—Ä–æ—Å–æ–≤ ---
    let url = `${API_URL}${endpoint}`;
    const method = options.method?.toUpperCase() || 'GET'; // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Ç–æ–¥

    // –ï—Å–ª–∏ —ç—Ç–æ GET –∑–∞–ø—Ä–æ—Å –∏ –µ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ options.params
    if (method === 'GET' && options.params) {
        // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç URLSearchParams –∏–∑ options.params
        const searchParams = new URLSearchParams();
        // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –∫–ª—é—á–∞–º –æ–±—ä–µ–∫—Ç–∞ params
        for (const key in options.params) {
            const value = options.params[key];
            // –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ - –º–∞—Å—Å–∏–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'keys' –∏–ª–∏ 'statuses'), –¥–æ–±–∞–≤–ª—è–µ–º –∫–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç –æ—Ç–¥–µ–ª—å–Ω–æ
            if (Array.isArray(value)) {
                value.forEach(item => searchParams.append(key, item));
            } else if (value !== undefined && value !== null) { // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ–ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
                searchParams.append(key, value);
            }
        }
        // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫ URL, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
        const queryString = searchParams.toString();
        if (queryString) {
            url += `?${queryString}`;
        }
        // –£–¥–∞–ª—è–µ–º params –∏–∑ options, —á—Ç–æ–±—ã –æ–Ω–∏ –Ω–µ –º–µ—à–∞–ª–∏ fetch
        delete options.params;
    }
    // --- –ö–û–ù–ï–¶ –î–û–ë–ê–í–õ–ï–ù–ò–Ø ---

    // –õ–æ–≥–∏—Ä—É–µ–º –∏—Å—Ö–æ–¥—è—â–∏–π –∑–∞–ø—Ä–æ—Å (—Ç–µ–ø–µ—Ä—å —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º URL –¥–ª—è GET)
    console.log(`[API] Request: ${method} ${url}`);
    // if (options.body) console.log(`[API] Request Body:`, options.body); // –ú–æ–∂–Ω–æ —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

    try {
        // –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ API (–∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π url)
        const response = await fetch(url, options); // <--- –ò—Å–ø–æ–ª—å–∑—É–µ–º url

        // –õ–æ–≥–∏—Ä—É–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
        console.log(`[API] Response: ${response.status} ${response.statusText} for ${method} ${url}`);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
        if (!response.ok) {
            const errorDetails = await handleApiError(response);
            console.error(`[API] Error Response Body for ${endpoint}:`, errorDetails);
            throw new Error(errorDetails); // –í—ã–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ 204 No Content
        if (response.status === 204) {
            console.log(`[API] Received 204 No Content for ${endpoint}`);
            return null;
        }

        // –ü–∞—Ä—Å–∏–º —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç –∫–∞–∫ JSON
        const data = await response.json();
        // console.log(`[API] Success Response Data for ${endpoint}:`, data); // –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –æ—Ç–ª–∞–¥–∫–∏
        return data; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ

    } catch (error) { // –õ–æ–≤–∏–º –æ—à–∏–±–∫–∏ —Å–µ—Ç–∏, –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –∏–ª–∏ –≤—ã–±—Ä–æ—à–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ API
         console.error(`[API] Network or Processing Error for ${endpoint}:`, error);
         // –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –¥–∞–ª—å—à–µ
         throw error;
    }
}


// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —á—Ç–µ–Ω–∏—è Excel —Ñ–∞–π–ª–∞ –∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –≤ JSON
// –¢—Ä–µ–±—É–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ XLSX –≤ <head> –≤–∞—à–µ–≥–æ HTML
const readExcelFile = (file) => new Promise((resolve, reject) => {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –ª–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ XLSX
    if (typeof XLSX === 'undefined') {
         console.error("!!! [Util] readExcelFile: –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ XLSX –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ–Ω–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ –≤ <head>.");
         return reject(new Error("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ XLSX –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞."));
    }
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–µ—Ä–µ–¥–∞–Ω —Ñ–∞–π–ª
    if (!file) {
         return reject(new Error("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: –§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω."));
    }

    const reader = new FileReader(); // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –¥–ª—è —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É—Å–ø–µ—à–Ω–æ–≥–æ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞
    reader.onload = (event) => {
        console.log("[Util] readExcelFile: –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—á–∏—Ç–∞–Ω.");
        try {
            const data = new Uint8Array(event.target.result); // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª–∞ –∫–∞–∫ –º–∞—Å—Å–∏–≤ –±–∞–π—Ç
            // –ß–∏—Ç–∞–µ–º –∫–Ω–∏–≥—É Excel –∏–∑ –º–∞—Å—Å–∏–≤–∞ –±–∞–π—Ç
            const workbook = XLSX.read(data, { type: 'array' });
            // –ü–æ–ª—É—á–∞–µ–º –∏–º—è –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Å—Ç–∞
            const sheetName = workbook.SheetNames[0];
            if (!sheetName) {
                 console.error("!!! [Util] readExcelFile: –í Excel —Ñ–∞–π–ª–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –ª–∏—Å—Ç—ã.");
                 throw new Error("–í Excel —Ñ–∞–π–ª–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –ª–∏—Å—Ç—ã.");
            }
            console.log(`[Util] readExcelFile: –ß—Ç–µ–Ω–∏–µ –ª–∏—Å—Ç–∞ "${sheetName}"...`);
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Å—Ç–∞
            const worksheet = workbook.Sheets[sheetName];
            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ª–∏—Å—Ç–∞ –≤ –º–∞—Å—Å–∏–≤ JSON –æ–±—ä–µ–∫—Ç–æ–≤
            const json = XLSX.utils.sheet_to_json(worksheet);
            console.log(`[Util] readExcelFile: –õ–∏—Å—Ç —É—Å–ø–µ—à–Ω–æ —Å–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ JSON (${json.length} —Å—Ç—Ä–æ–∫).`);
            resolve(json); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤)
        } catch (err) {
            console.error("!!! [Util] readExcelFile: –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ Excel –¥–∞–Ω–Ω—ã—Ö:", err);
            reject(err); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—à–∏–±–∫—É –æ–±—Ä–∞–±–æ—Ç–∫–∏
        }
    };

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–∫–∏ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞
    reader.onerror = error => {
         console.error("!!! [Util] readExcelFile: –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞:", error);
         reject(error);
    };

    // –ù–∞—á–∏–Ω–∞–µ–º —á—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –∫–∞–∫ ArrayBuffer
    reader.readAsArrayBuffer(file);
    console.log(`[Util] readExcelFile: –ù–∞—á–∞—Ç–æ —á—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ "${file.name}"...`);
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–ª—É—à–∞—Ç–µ–ª—è —Å–æ–±—ã—Ç–∏–π (—Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞)
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–ª—É—à–∞—Ç–µ–ª—è —Å–æ–±—ã—Ç–∏–π (—Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞)
function safeAddEventListener(elementId, eventType, handlerFunction) {
     const element = document.getElementById(elementId);
     if (element) {
         // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Å–ª—É—à–∞—Ç–µ–ª—å (–µ—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –∏–º–µ–Ω–æ–≤–∞–Ω–Ω–∞—è), —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–µ–π
         try { element.removeEventListener(eventType, handlerFunction); } catch(e){}
         // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —Å–ª—É—à–∞—Ç–µ–ª—å –°–†–ê–ó–£, —Ç–∞–∫ –∫–∞–∫ DOM —É–∂–µ –≥–æ—Ç–æ–≤
         element.addEventListener(eventType, handlerFunction);
         console.log(`[Listener OK] Added ${eventType} to #${elementId}`);
     } else {
         console.error(`!!! Listener FAILED: Element #${elementId} not found.`);
     }
}

// =================================================================
// –ú–û–î–£–õ–¨: –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø –ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø (v4.1 - Rebuild)
// =================================================================

// --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Ö–æ–¥–∞ –≤ —Å–∏—Å—Ç–µ–º—É ---
// –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –∫ —Ñ–æ—Ä–º–µ –≤—Ö–æ–¥–∞, –µ—Å–ª–∏ –æ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if (loginForm) {
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã
        showLoader(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        if(loginError) loginError.textContent = ''; // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ—à–∏–±–∫–∏

        // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã
        const companyCodeInput = document.getElementById('company-code');
        const passwordInput = document.getElementById('password');
        const companyCode = companyCodeInput ? companyCodeInput.value.toUpperCase().trim() : null;
        const password = passwordInput ? passwordInput.value : null;

        // –ü—Ä–æ—Å—Ç–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
        if (!companyCode || !password) {
             if(loginError) loginError.textContent = "–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–ø–∞–Ω–∏–∏ –∏ –ø–∞—Ä–æ–ª—å.";
             hideLoader(); // –°–∫—Ä—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
             return; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
        }

        console.log(`[Auth] –ü–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞ —Å –∫–æ–¥–æ–º: ${companyCode}`);

        try {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º POST –∑–∞–ø—Ä–æ—Å –Ω–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç /login
            const response = await fetch(`${API_URL}/api/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password: password, company_code: companyCode })
            });

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞
            if (!response.ok) {
                 // –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É, –ø–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏ –∏ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
                 throw new Error(await handleApiError(response));
            }

            // –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç —É—Å–ø–µ—à–Ω—ã–π, –ø–∞—Ä—Å–∏–º JSON
            const data = await response.json();
            currentUser = data.employee; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≥–ª–æ–±. –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
            currentCompany = data.company; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏ (–∏–ª–∏ null –¥–ª—è SuperAdmin)
            console.log("[Auth] –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥:", currentUser, currentCompany);

            // --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ—Ç–∫—Ä—ã—Ç–∏—è —Å–º–µ–Ω—ã ---
            // –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¢–û–õ–¨–ö–û –¥–ª—è –û–ë–´–ß–ù–´–• –°–û–¢–†–£–î–ù–ò–ö–û–í (–Ω–µ –í–ª–∞–¥–µ–ª–µ—Ü, –Ω–µ SuperAdmin)
             if (!currentUser.is_super_admin && currentUser.role !== '–í–ª–∞–¥–µ–ª–µ—Ü') {
                  console.log("[Auth] –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π —Å–º–µ–Ω—ã –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞...");
                  await checkActiveShiftStatus(); // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–º–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–æ–±–Ω–æ–≤–ª—è–µ—Ç –≥–ª–æ–±. activeShift)

                  if (!activeShift) { // –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ–π —Å–º–µ–Ω—ã –ù–ï–¢
                       console.log("[Auth] –ê–∫—Ç–∏–≤–Ω–æ–π —Å–º–µ–Ω—ã –Ω–µ—Ç.");
                       // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –ø—Ä–∞–≤–∞ –Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∏–µ —Å–º–µ–Ω—ã
                       if (currentUser.permissions && currentUser.permissions.includes('open_close_shift')) {
                            // –ï—Å–ª–∏ –ü–†–ê–í–ê –ï–°–¢–¨ -> –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –æ—Ç–∫—Ä—ã—Ç–∏—è —Å–º–µ–Ω—ã
                            console.log("[Auth] –ï—Å—Ç—å –ø—Ä–∞–≤–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –æ—Ç–∫—Ä—ã—Ç–∏—è —Å–º–µ–Ω—ã.");
                            await showOpenShiftScreen(); // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç—Ä–∏—Å—É–µ—Ç —ç–∫—Ä–∞–Ω –∏ –¥–æ–±–∞–≤–∏—Ç –ï–ì–û —Å–ª—É—à–∞—Ç–µ–ª–∏
                            // –í–ê–ñ–ù–û: –ù–ï –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∑–¥–µ—Å—å
                            return; // –í—ã—Ö–æ–¥–∏–º –∏–∑ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –≤—Ö–æ–¥–∞, —Ç.–∫. –ø–æ–∫–∞–∑–∞–ª–∏ –¥—Ä—É–≥–æ–π —ç–∫—Ä–∞–Ω
                       } else {
                           // –ï—Å–ª–∏ –ü–†–ê–í –ù–ï–¢ -> –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –∏ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –≤—Ö–æ–¥
                           console.error("[Auth] –ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∏–µ —Å–º–µ–Ω—ã.");
                           throw new Error("–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π —Å–º–µ–Ω—ã –≤ –≤–∞—à–µ–º —Ñ–∏–ª–∏–∞–ª–µ –∏ –Ω–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –µ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.");
                       }
                  }
                   console.log("[Auth] –ê–∫—Ç–∏–≤–Ω–∞—è —Å–º–µ–Ω–∞ –Ω–∞–π–¥–µ–Ω–∞, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤—Ö–æ–¥.");
                  // –ï—Å–ª–∏ —Å–º–µ–Ω–∞ –ï–°–¢–¨ - –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–¥–∞ –Ω–∏–∂–µ
             } else {
                  console.log("[Auth] –í—Ö–æ–¥ SuperAdmin –∏–ª–∏ –í–ª–∞–¥–µ–ª—å—Ü–∞, –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π —Å–º–µ–Ω—ã –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.");
                  activeShift = null; // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –¥–ª—è –Ω–∏—Ö activeShift = null
             }

             // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ UI –∏ –ì–ª–æ–±–∞–ª—å–Ω—ã—Ö —Å–ª—É—à–∞—Ç–µ–ª–µ–π ---
             // –≠—Ç–æ—Ç –∫–æ–¥ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –µ—Å–ª–∏ —ç—Ç–æ SuperAdmin, –í–ª–∞–¥–µ–ª–µ—Ü, –ò–õ–ò –µ—Å–ª–∏ —É –æ–±—ã—á–Ω–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è —Å–º–µ–Ω–∞
             console.log("[Auth] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞...");
             await initializeMainAppUI(); // –†–µ–Ω–¥–µ—Ä–∏–º HTML –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (—à–∞–ø–∫–∞, –≤–∫–ª–∞–¥–∫–∏, –∫–æ–Ω—Ç–µ–Ω—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏)
             console.log("[Auth] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö —Å–ª—É—à–∞—Ç–µ–ª–µ–π...");
             initializeGlobalEventListeners(); // –î–æ–±–∞–≤–ª—è–µ–º –ì–õ–û–ë–ê–õ–¨–ù–´–ï —Å–ª—É—à–∞—Ç–µ–ª–∏ (–∫–Ω–æ–ø–∫–∞ –í—ã—Ö–æ–¥, –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–∫–ª–∞–¥–æ–∫ –∏ —Ç.–¥.)

             // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å —ç–∫—Ä–∞–Ω–æ–≤
             if(loginScreen) loginScreen.classList.add('hidden');
             if(mainApp) mainApp.classList.remove('hidden');
             console.log("[Auth] –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ.");
             // hideLoader() –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω –≤ finally —Ñ—É–Ω–∫—Ü–∏–∏ initializeMainAppUI

        } catch (error) { // –û–±—Ä–∞–±–æ—Ç–∫–∞ –õ–Æ–ë–´–• –æ—à–∏–±–æ–∫ (—Å–µ—Ç—å, —Å–µ—Ä–≤–µ—Ä, –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–º–µ–Ω—ã, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI)
            console.error("[Auth] –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:", error);
            if(loginError) loginError.textContent = error.message; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –ª–æ–∞–¥–µ—Ä —Å–∫—Ä—ã—Ç, –µ—Å–ª–∏ –º—ã –æ—Å—Ç–∞–ª–∏—Å—å –Ω–∞ —ç–∫—Ä–∞–Ω–µ –≤—Ö–æ–¥–∞ (–∏–ª–∏ –µ—Å–ª–∏ —ç–∫—Ä–∞–Ω —Å–º–µ–Ω—ã –Ω–µ –±—ã–ª –ø–æ–∫–∞–∑–∞–Ω)
            const shiftScreen = document.getElementById('shift-screen');
            if (!shiftScreen || shiftScreen.classList.contains('hidden')) {
                 hideLoader();
            }
        }
    });
} else {
     // –≠—Ç–∞ –æ—à–∏–±–∫–∞ –Ω–µ –¥–æ–ª–∂–Ω–∞ –≤–æ–∑–Ω–∏–∫–∞—Ç—å, –µ—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–π HTML –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω
     console.error("!!! –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –≠–ª–µ–º–µ–Ω—Ç login-form –Ω–µ –Ω–∞–π–¥–µ–Ω! –í—Ö–æ–¥ –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω.");
     alert("–û—à–∏–±–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞: –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.");
     hideLoader(); // –°–∫—Ä—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
}


// --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ (–¢–û–õ–¨–ö–û —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ HTML) ---
// –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ü–û–°–õ–ï —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—Ö–æ–¥–∞ (–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–º–µ–Ω—ã, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
// index.html (–ü–û–õ–ù–û–°–¢–¨–Æ –ó–ê–ú–ï–ù–Ø–ï–¢ initializeMainAppUI)

async function initializeMainAppUI() {
    console.log("[UI] initializeMainAppUI: –ù–∞—á–∞–ª–æ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ UI");
    try {
        // 1. –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –∏ –∫–æ–º–ø–∞–Ω–∏–∏
        console.log("[UI] –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ user/company info...");
        const userInfoDiv = document.getElementById('user-info');
        const companyInfoDiv = document.getElementById('company-info');
        const logoutBtn = document.getElementById('logout-btn');

        if (!userInfoDiv || !companyInfoDiv || !logoutBtn) {
            throw new Error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ UI: –ù–µ –Ω–∞–π–¥–µ–Ω—ã —ç–ª–µ–º–µ–Ω—Ç—ã —à–∞–ø–∫–∏.");
        }

        userInfoDiv.innerHTML = `<p class="font-semibold">${currentUser.full_name || '–ò–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ'}</p><p class="text-sm text-gray-600">${currentUser.role || '–†–æ–ª—å –Ω–µ —É–∫–∞–∑–∞–Ω–∞'}</p>`;
        if (currentCompany && currentCompany.name) {
            companyInfoDiv.innerHTML = `<p class="font-semibold">${currentCompany.name}</p><p class="text-sm text-gray-600">–ö–æ–º–ø–∞–Ω–∏—è</p>`;
        } else if (currentUser.is_super_admin) {
            companyInfoDiv.innerHTML = `<p class="font-semibold text-purple-600">Super-Admin</p><p class="text-sm text-gray-600">–ì–ª–æ–±–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø</p>`;
        } else {
            companyInfoDiv.innerHTML = '';
        }

        // 2. –î–æ–±–∞–≤–ª—è–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–º–µ–Ω–æ–π
        console.log("[UI] –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ shiftControlDiv...");
        let shiftControlDiv = document.getElementById('shift-control-container');
        if (!shiftControlDiv) {
            shiftControlDiv = document.createElement('div');
            shiftControlDiv.id = 'shift-control-container';
            logoutBtn.parentNode?.insertBefore(shiftControlDiv, logoutBtn);
        }
        await updateShiftControlButtonUI();
        console.log("[UI] HTML –∫–Ω–æ–ø–∫–∏ —Å–º–µ–Ω—ã –æ–±–Ω–æ–≤–ª–µ–Ω.");

        // --- –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö (–§–∏–ª–∏–∞–ª—ã) ---
        // –ú—ã –¥–æ–ª–∂–Ω—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∏–ª–∏–∞–ª—ã –î–û —Ç–æ–≥–æ, –∫–∞–∫ –±—É–¥–µ–º —Ä–µ–Ω–¥–µ—Ä–∏—Ç—å –≤–∫–ª–∞–¥–∫–∏,
        // —Ç–∞–∫ –∫–∞–∫ —Ñ–∏–ª—å—Ç—Ä—ã —Ñ–∏–ª–∏–∞–ª–æ–≤ (–Ω–∞ –≤–∫–ª–∞–¥–∫–∞—Ö –ó–∞–∫–∞–∑—ã, –í—ã–¥–∞—á–∞, –û—Ç—á–µ—Ç—ã) –∑–∞–≤–∏—Å—è—Ç –æ—Ç companyLocations.
        if (!currentUser.is_super_admin && (!companyLocations || companyLocations.length === 0)) {
            try {
                console.log("[UI] –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∏–ª–∏–∞–ª–æ–≤ (companyLocations)...");
                companyLocations = await apiFetch('/api/locations');
                console.log("[UI] –§–∏–ª–∏–∞–ª—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:", companyLocations.length);
            } catch (e) {
                console.error("!!! [UI] –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∏–ª–∏–∞–ª—ã:", e.message);
                companyLocations = []; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫
            }
        }
        // --- –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø ---

        // 3. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –¥–ª—è –≤–∫–ª–∞–¥–æ–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–∞–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        console.log("[UI] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML –≤–∫–ª–∞–¥–æ–∫...");
        if (!tabsContainer || !tabContentContainer) throw new Error("–ù–µ –Ω–∞–π–¥–µ–Ω—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –≤–∫–ª–∞–¥–æ–∫.");

        let tabsHtml = '';
        let contentHtml = '';
        const userPerms = new Set(currentUser.permissions || []);

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–∏–µ –≤–∫–ª–∞–¥–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å
        if (currentUser.is_super_admin) {
            if (userPerms.has('manage_companies')) { tabsHtml += '<button data-tab="companies" class="tab-btn">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ö–æ–º–ø–∞–Ω–∏—è–º–∏</button>'; contentHtml += '<div id="tab-companies" class="tab-pane"></div>'; }
        } else { // –î–ª—è –í–ª–∞–¥–µ–ª—å—Ü–∞ –∏ –¥—Ä—É–≥–∏—Ö —Ä–æ–ª–µ–π
            if (userPerms.has('manage_locations')) { tabsHtml += '<button data-tab="locations" class="tab-btn">–§–∏–ª–∏–∞–ª—ã</button>'; contentHtml += '<div id="tab-locations" class="tab-pane"></div>'; }
            if (userPerms.has('manage_employees')) { tabsHtml += '<button data-tab="employees" class="tab-btn">–ü–µ—Ä—Å–æ–Ω–∞–ª</button>'; contentHtml += '<div id="tab-employees" class="tab-pane"></div>'; }
            if (userPerms.has('manage_roles')) { tabsHtml += '<button data-tab="roles" class="tab-btn">–î–æ–ª–∂–Ω–æ—Å—Ç–∏ –∏ –î–æ—Å—Ç—É–ø—ã</button>'; contentHtml += '<div id="tab-roles" class="tab-pane"></div>'; }
            if (userPerms.has('manage_clients')) { tabsHtml += '<button data-tab="clients" class="tab-btn">–ö–ª–∏–µ–Ω—Ç—ã</button>'; contentHtml += '<div id="tab-clients" class="tab-pane"></div>'; }
            if (userPerms.has('manage_orders')) { tabsHtml += '<button data-tab="orders" class="tab-btn">–ó–∞–∫–∞–∑—ã</button>'; contentHtml += '<div id="tab-orders" class="tab-pane"></div>'; }
            if (userPerms.has('issue_orders')) { tabsHtml += '<button data-tab="issue" class="tab-btn">–í—ã–¥–∞—á–∞</button>'; contentHtml += '<div id="tab-issue" class="tab-pane"></div>'; }
            if (userPerms.has('manage_expense_types')) { tabsHtml += '<button data-tab="expense-types" class="tab-btn">–¢–∏–ø—ã –†–∞—Å—Ö–æ–¥–æ–≤</button>'; contentHtml += '<div id="tab-expense-types" class="tab-pane"></div>'; }
            if (userPerms.has('add_expense') || userPerms.has('view_full_reports')) { tabsHtml += '<button data-tab="expenses" class="tab-btn">–†–∞—Å—Ö–æ–¥—ã</button>'; contentHtml += '<div id="tab-expenses" class="tab-pane"></div>'; }
            if (userPerms.has('view_shift_report') || userPerms.has('view_full_reports')) {
                tabsHtml += '<button data-tab="reports" class="tab-btn">–û—Ç—á–µ—Ç—ã</button>'; 
                contentHtml += '<div id="tab-reports" class="tab-pane"></div>'; 
            }
            // --- –î–û–ë–ê–í–¨ –≠–¢–ò –î–í–ï –°–¢–†–û–ö–ò (–¢–æ–ª—å–∫–æ –í–ª–∞–¥–µ–ª–µ—Ü –≤–∏–¥–∏—Ç –ù–∞—Å—Ç—Ä–æ–π–∫–∏) ---
            if (currentUser.role === '–í–ª–∞–¥–µ–ª–µ—Ü') {
                 tabsHtml += '<button data-tab="settings" class="tab-btn">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>';
                 contentHtml += '<div id="tab-settings" class="tab-pane"></div>';
            }
            // --- –ö–û–ù–ï–¶ –î–û–ë–ê–í–õ–ï–ù–ò–Ø ---
        }
        
        tabsContainer.innerHTML = tabsHtml.replaceAll('class="tab-btn"', 'class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"'); 
        tabContentContainer.innerHTML = contentHtml;
        console.log("[UI] HTML –≤–∫–ª–∞–¥–æ–∫ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.");

        // 4. –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ (—Ç–µ–ø–µ—Ä—å companyLocations –ì–ê–†–ê–ù–¢–ò–†–û–í–ê–ù–ù–û —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
        console.log("[UI] –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –¥–ª—è –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–∫–ª–∞–¥–æ–∫...");
        const renderPromises = [];
        if (document.getElementById('tab-companies')) renderPromises.push(renderCompaniesTab());
        if (document.getElementById('tab-locations')) renderPromises.push(renderLocationsTab());
        if (document.getElementById('tab-employees')) renderPromises.push(renderEmployeesTab());
        if (document.getElementById('tab-roles')) renderPromises.push(renderRolesTab());
        if (document.getElementById('tab-clients')) renderPromises.push(renderClientsTab());
        if (document.getElementById('tab-orders')) renderPromises.push(renderOrdersTab());
        if (document.getElementById('tab-issue')) renderPromises.push(renderIssueTab());
        if (document.getElementById('tab-expense-types')) renderPromises.push(renderExpenseTypesTab());
        if (document.getElementById('tab-expenses')) renderPromises.push(renderExpensesTab());
        if (document.getElementById('tab-reports')) renderPromises.push(renderReportsTab());
        if (document.getElementById('tab-settings')) renderPromises.push(renderSettingsTab());
        if (document.getElementById('tab-settings')) renderPromises.push(renderSettingsTab()); 
        
        await Promise.all(renderPromises); 
        console.log("[UI] –§—É–Ω–∫—Ü–∏–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –≤–∫–ª–∞–¥–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω—ã.");

        // 5. –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–µ—Ä–≤—É—é –¥–æ—Å—Ç—É–ø–Ω—É—é –≤–∫–ª–∞–¥–∫—É
        const firstTab = tabsContainer.querySelector('.tab-btn');
        if (firstTab) {
            console.log("[UI] –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–µ—Ä–≤–æ–π –≤–∫–ª–∞–¥–∫–∏:", firstTab.dataset.tab);
            activateTab(firstTab.dataset.tab);
        } else {
            console.warn("[UI] –ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏.");
            if(tabContentContainer) tabContentContainer.innerHTML = '<p class="p-4 text-center text-gray-500">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ä–∞–∑–¥–µ–ª–æ–≤.</p>';
        }

        console.log("[UI] --- initializeMainAppUI: –£—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ ---");
    } catch (e) {
        console.error("[UI] !!! initializeMainAppUI: –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê:", e);
        alert(`–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞: ${e.message}\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.`);
    } finally {
        console.log("[UI] initializeMainAppUI: –ë–ª–æ–∫ finally, —Å–∫—Ä—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä.");
        hideLoader();
    }
}


// --- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ì–õ–û–ë–ê–õ–¨–ù–´–• —Å–ª—É—à–∞—Ç–µ–ª–µ–π (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ü–û–°–õ–ï initializeMainAppUI) ---
function initializeGlobalEventListeners() {
     console.log("--- initializeGlobalEventListeners: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ì–õ–û–ë–ê–õ–¨–ù–´–• —Å–ª—É—à–∞—Ç–µ–ª–µ–π ---");

     // --- –û—Å–Ω–æ–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ (—à–∞–ø–∫–∞, –≤–∫–ª–∞–¥–∫–∏) ---
     safeAddEventListener('logout-btn', 'click', () => { if (confirm('–í—ã–π—Ç–∏?')) location.reload(); });
     safeAddEventListener('tabs', 'click', e => {
          const tabButton = e.target.closest('.tab-btn');
          if (tabButton) {
              // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–µ—Ä–µ–¥–∞–µ–º –∏–º—è –≤–∫–ª–∞–¥–∫–∏ –∫–∞–∫ —Å—Ç—Ä–æ–∫—É (dataset.tab), –∞ –Ω–µ —Å–∞–º —ç–ª–µ–º–µ–Ω—Ç
              activateTab(tabButton.dataset.tab); 
            }
      });

     // --- –≠–∫—Ä–∞–Ω –æ—Ç–∫—Ä—ã—Ç–∏—è —Å–º–µ–Ω—ã (—Å–ª—É—à–∞—Ç–µ–ª–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ showOpenShiftScreen) ---

     // --- –§–æ—Ä–º—ã –∏ –∫–Ω–æ–ø–∫–∏ –≤–Ω—É—Ç—Ä–∏ –°–¢–ê–¢–ò–ß–ù–´–• –ú–æ–¥–∞–ª—å–Ω—ã—Ö –û–∫–æ–Ω ---
     // (–ú–æ–¥–∞–ª–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ HTML, –∏—Ö —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏)
     // –°–ª—É—à–∞—Ç–µ–ª–∏ –¥–ª—è —Ñ–æ—Ä–º –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ open...Modal —Ñ—É–Ω–∫—Ü–∏—è—Ö –ü–û–°–õ–ï –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ HTML —Ñ–æ—Ä–º—ã
     safeAddEventListener('import-clients-btn', 'click', handleClientExcelImport); // –ö–Ω–æ–ø–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –≤ –º–æ–¥–∞–ª–∫–µ –ö–ª–∏–µ–Ω—Ç–æ–≤

     // --- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∫–Ω–æ–ø–∫–∞ –û—Ç–∫—Ä—ã—Ç—å/–ó–∞–∫—Ä—ã—Ç—å –°–º–µ–Ω—É ---
     // –°–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è –Ω–µ–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –û–¢–î–ï–õ–¨–ù–û –≤ updateShiftControlButtonUI

     console.log("--- initializeGlobalEventListeners: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ì–õ–û–ë–ê–õ–¨–ù–´–• —Å–ª—É—à–∞—Ç–µ–ª–µ–π –∑–∞–≤–µ—Ä—à–µ–Ω–æ ---");
}

// –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∫–ª–∞–¥–∫–∏ (–¥–µ–ª–∞–µ—Ç –µ–µ –≤–∏–¥–∏–º–æ–π –∏ —Å—Ç–∏–ª–∏–∑—É–µ—Ç –∫–Ω–æ–ø–∫—É)
function activateTab(tabName) { // –§—É–Ω–∫—Ü–∏—è —Ç–µ–ø–µ—Ä—å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç tabName (—Å—Ç—Ä–æ–∫—É)
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (tabName —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ —Å—Ç—Ä–æ–∫–∞)
    if (!tabName || !tabsContainer || !tabContentContainer) {
         console.error("[ActivateTab] –û—à–∏–±–∫–∞: tabName, tabsContainer –∏–ª–∏ tabContentContainer –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.");
         return;
    }
    console.log(`[UI] –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∫–ª–∞–¥–∫–∏: ${tabName}`);

    // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –í–°–ï–• –∫–Ω–æ–ø–æ–∫ –≤–∫–ª–∞–¥–æ–∫
    tabsContainer.querySelectorAll('.tab-btn').forEach(btn => {
         btn.classList.remove('border-indigo-500', 'text-indigo-600'); // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–ª–∞—Å—Å—ã
         btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
    });

    // –ù–∞—Ö–æ–¥–∏–º –ù–ê–ñ–ê–¢–£–Æ –∫–Ω–æ–ø–∫—É –ø–æ data-tab
    const activeTabButton = tabsContainer.querySelector(`[data-tab="${tabName}"]`);
    
    if(activeTabButton) {
        // –í—ã–¥–µ–ª—è–µ–º –ù–ê–ñ–ê–¢–£–Æ –∫–Ω–æ–ø–∫—É
        activeTabButton.classList.add('border-indigo-500', 'text-indigo-600'); // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–ª–∞—Å—Å—ã
        activeTabButton.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
    }
    
    // –°–∫—Ä—ã–≤–∞–µ–º –í–°–ï –ø–∞–Ω–µ–ª–∏ —Å –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º –≤–∫–ª–∞–¥–æ–∫
    tabContentContainer.querySelectorAll('.tab-pane').forEach(pane => {
         pane.classList.add('hidden');
    });

    // –ù–∞—Ö–æ–¥–∏–º –∏ –ü–û–ö–ê–ó–´–í–ê–ï–ú –ø–∞–Ω–µ–ª—å, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –Ω–∞–∂–∞—Ç–æ–π –∫–Ω–æ–ø–∫–µ
    const activePane = document.getElementById(`tab-${tabName}`);
    if (activePane) {
         activePane.classList.remove('hidden'); // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å 'hidden'
         console.log(`[UI] –í–∫–ª–∞–¥–∫–∞ ${tabName} –ø–æ–∫–∞–∑–∞–Ω–∞.`);
    } else {
         console.warn(`[UI] –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ tab-${tabName} –Ω–µ –Ω–∞–π–¥–µ–Ω.`);
         if (tabContentContainer) { // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –≤ –æ–±—â–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
              tabContentContainer.innerHTML = `<p class="p-4 text-center text-red-500">–û—à–∏–±–∫–∞: –ö–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ '${tabName}' –Ω–µ –Ω–∞–π–¥–µ–Ω.</p>`;
         }
    }
}

// =================================================================
// –ú–û–î–£–õ–¨: –ö–ê–°–°–ê –ò –°–ú–ï–ù–´ (v4.1 - Rebuild)
// =================================================================

// --- –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –∞–∫—Ç–∏–≤–Ω–æ–π —Å–º–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ ---
// –û–±–Ω–æ–≤–ª—è–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `activeShift`
async function checkActiveShiftStatus() {
     activeShift = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–µ—Ä–µ–¥ –ø—Ä–æ–≤–µ—Ä–∫–æ–π
     // –ù–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª—è –í–ª–∞–¥–µ–ª—å—Ü–∞ –∏–ª–∏ SuperAdmin
     if (!currentUser || currentUser.is_super_admin || currentUser.role === '–í–ª–∞–¥–µ–ª–µ—Ü') {
          console.log("[Shift Check] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–º–µ–Ω—ã –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è –í–ª–∞–¥–µ–ª—å—Ü–∞/SuperAdmin.");
          return;
     }

     console.log("[Shift Check] –ó–∞–ø—Ä–æ—Å –∞–∫—Ç–∏–≤–Ω–æ–π —Å–º–µ–Ω—ã –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ ID:", currentUser.id);
     try {
         // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é —Å–º–µ–Ω—É –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (–±—ç–∫–µ–Ω–¥ –ø—Ä–æ–≤–µ—Ä–∏—Ç —Ñ–∏–ª–∏–∞–ª)
         const shiftData = await apiFetch('/api/shifts/active'); // –û–∂–∏–¥–∞–µ–º –æ–±—ä–µ–∫—Ç —Å–º–µ–Ω—ã –∏–ª–∏ null
         activeShift = shiftData; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–º–æ–∂–µ—Ç –±—ã—Ç—å null)
         console.log("[Shift Check] –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏:", activeShift);
     } catch (error) {
          // –û—à–∏–±–∫–∏ —Å–µ—Ç–∏ –∏–ª–∏ –µ—Å–ª–∏ –±—ç–∫–µ–Ω–¥ –≤–µ—Ä–Ω—É–ª 4xx/5xx (–∫—Ä–æ–º–µ 404, –∫–æ—Ç–æ—Ä—É—é apiFetch –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ null?)
          console.warn("[Shift Check] –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—É—é —Å–º–µ–Ω—É:", error.message);
          activeShift = null; // –°—á–∏—Ç–∞–µ–º, —á—Ç–æ —Å–º–µ–Ω—ã –Ω–µ—Ç
     }
}

// --- –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —ç–∫—Ä–∞–Ω–∞ "–û—Ç–∫—Ä—ã—Ç—å –Ω–æ–≤—É—é —Å–º–µ–Ω—É" ---
// –í—ã–∑—ã–≤–∞–µ—Ç—Å—è, –µ—Å–ª–∏ —É –æ–±—ã—á–Ω–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π —Å–º–µ–Ω—ã, –Ω–æ –µ—Å—Ç—å –ø—Ä–∞–≤–∞
// index.html (–ü–û–õ–ù–û–°–¢–¨–Æ –ó–ê–ú–ï–ù–Ø–ï–¢ showOpenShiftScreen)

async function showOpenShiftScreen(locationId = null) {
    console.log(`[Shift UI] –ü–æ–∫–∞–∑ —ç–∫—Ä–∞–Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —Å–º–µ–Ω—ã. –¶–µ–ª–µ–≤–æ–π —Ñ–∏–ª–∏–∞–ª: ${locationId || '–ù–µ —É–∫–∞–∑–∞–Ω'}`);
    const shiftScreen = document.getElementById('shift-screen');
    const form = document.getElementById('open-shift-form');
    const employeeSelectorDiv = document.getElementById('shift-employee-selector');
    const locationSelectorDiv = document.getElementById('shift-location-selector');
    const employeeSelect = document.getElementById('shift-employee-select');
    const locationSelect = document.getElementById('shift-location-select');
    const cancelBtn = document.getElementById('cancel-open-shift-btn');

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    if (!shiftScreen || !form || !employeeSelectorDiv || !locationSelectorDiv || !employeeSelect || !locationSelect || !cancelBtn) {
        console.error("!!! –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê UI: –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞ —ç–∫—Ä–∞–Ω–µ –æ—Ç–∫—Ä—ã—Ç–∏—è —Å–º–µ–Ω—ã.");
        alert("–û—à–∏–±–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —ç–∫—Ä–∞–Ω –æ—Ç–∫—Ä—ã—Ç–∏—è —Å–º–µ–Ω—ã.");
        hideLoader(); 
        return;
    }

    try {
        // --- –ü—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã (–ö—É—Ä—Å—ã, –¶–µ–Ω–∞) ---
        const exchangeRateInput = document.getElementById('shift-exchange-rate');
        const pricePerKgInput = document.getElementById('shift-price-per-kg');
        const startingCashInput = document.getElementById('starting-cash');
        
        // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ sysConfig
        const defaultRate = activeShift?.exchange_rate_usd 
                            || (typeof sysConfig !== 'undefined' && sysConfig.exchange_rate_usd) 
                            || 87.5;
        const defaultPrice = activeShift?.price_per_kg_usd 
                             || (typeof sysConfig !== 'undefined' && sysConfig.price_per_kg_usd) 
                             || 5.5;

        if(exchangeRateInput) exchangeRateInput.value = defaultRate; 
        if(pricePerKgInput) pricePerKgInput.value = defaultPrice;   
        if(startingCashInput) startingCashInput.value = 0;

        // --- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –†–û–õ–ò ---
        
        if (currentUser.role === '–í–ª–∞–¥–µ–ª–µ—Ü') {
            // --- –õ–û–ì–ò–ö–ê –î–õ–Ø –í–õ–ê–î–ï–õ–¨–¶–ê ---
            console.log("[Shift UI] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –í–ª–∞–¥–µ–ª–µ—Ü. –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏ —Ñ–∏–ª–∏–∞–ª–æ–≤...");
            
            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –∫—ç—à–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
            if (!companyLocations || companyLocations.length === 0) {
                 companyLocations = await apiFetch('/api/locations');
            }
            const employees = await apiFetch('/api/employees'); 

            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
            if (employeeSelect) {
                employeeSelect.innerHTML = employees
                    .filter(emp => emp.is_active) 
                    .map(emp => `<option value="${emp.id}">${emp.full_name} (${emp.role?.name || '?'})</option>`)
                    .join('');
                // –í—ã–±–∏—Ä–∞–µ–º –í–ª–∞–¥–µ–ª—å—Ü–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                employeeSelect.value = currentUser.id; 
            }
            employeeSelectorDiv.classList.remove('hidden'); 
            employeeSelect.required = true; 

            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä —Ñ–∏–ª–∏–∞–ª–æ–≤
            if (locationSelect) {
                 locationSelect.innerHTML = companyLocations
                    .map(loc => `<option value="${loc.id}">${loc.name}</option>`)
                    .join('');
                 
                 // --- –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –í–´–ë–û–† –§–ò–õ–ò–ê–õ–ê ---
                 // –ï—Å–ª–∏ –í–ª–∞–¥–µ–ª–µ—Ü –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É –≤ —à–∞–ø–∫–µ (locationId=null), –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ —Ñ–∏–ª–∏–∞–ª.
                 // –ï—Å–ª–∏ –í–ª–∞–¥–µ–ª–µ—Ü –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É –≤ —Å–ø–∏—Å–∫–µ (locationId=6), –∏—Å–ø–æ–ª—å–∑—É–µ–º —ç—Ç–æ—Ç ID.
                 locationSelect.value = locationId || currentUser.location_id; 
                 // --- –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø ---
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä —Ñ–∏–ª–∏–∞–ª–æ–≤, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏—Ö –±–æ–ª—å—à–µ –æ–¥–Ω–æ–≥–æ
            if (companyLocations.length > 1) {
                locationSelectorDiv.classList.remove('hidden');
                locationSelect.required = true; 
            } else {
                 locationSelectorDiv.classList.add('hidden');
                 locationSelect.required = false; 
            }
            
            cancelBtn.classList.remove('hidden'); 
            console.log("[Shift UI] –°–µ–ª–µ–∫—Ç–æ—Ä—ã –¥–ª—è –í–ª–∞–¥–µ–ª—å—Ü–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã.");

        } else { 
            // --- –õ–û–ì–ò–ö–ê –î–õ–Ø –û–ë–´–ß–ù–û–ì–û –°–û–¢–†–£–î–ù–ò–ö–ê ---
            console.log("[Shift UI] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –æ–±—ã—á–Ω—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫. –°–∫—Ä—ã—Ç–∏–µ —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤.");
            
            employeeSelectorDiv.classList.add('hidden');
            locationSelectorDiv.classList.add('hidden');
            employeeSelect.required = false; 
            locationSelect.required = false;

            cancelBtn.classList.add('hidden'); 
        }

        // --- –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏ –∫ —ç–ª–µ–º–µ–Ω—Ç–∞–º —ç—Ç–æ–≥–æ —ç–∫—Ä–∞–Ω–∞ ---
        const currentForm = document.getElementById('open-shift-form');
        if (currentForm) {
             const newForm = currentForm.cloneNode(true);
             currentForm.parentNode.replaceChild(newForm, currentForm);
             newForm.addEventListener('submit', handleOpenShiftSubmit);
             console.log("[Shift UI Listener OK] Added submit to #open-shift-form");
        }
        
        const currentCancelBtn = document.getElementById('cancel-open-shift-btn');
        if (currentCancelBtn) {
             const newCancelBtn = currentCancelBtn.cloneNode(true);
             currentCancelBtn.parentNode.replaceChild(newCancelBtn, currentCancelBtn);
             newCancelBtn.addEventListener('click', () => {
                 console.log("[Shift UI] Cancel button clicked.");
                 if(shiftScreen) shiftScreen.classList.add('hidden');
                 // –ï—Å–ª–∏ –æ—Ç–º–µ–Ω—è–µ–º, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –ì–ª–∞–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–¥–ª—è –í–ª–∞–¥–µ–ª—å—Ü–∞)
                 if(mainApp) mainApp.classList.remove('hidden'); 
                 hideLoader();
             });
             console.log("[Shift UI Listener OK] Added click to #cancel-open-shift-btn");
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –æ—Ç–∫—Ä—ã—Ç–∏—è —Å–º–µ–Ω—ã
        if(loginScreen) loginScreen.classList.add('hidden');
        if(mainApp) mainApp.classList.add('hidden'); 
        if(shiftScreen) shiftScreen.classList.remove('hidden');
        console.log("[Shift UI] –≠–∫—Ä–∞–Ω –æ—Ç–∫—Ä—ã—Ç–∏—è —Å–º–µ–Ω—ã –ø–æ–∫–∞–∑–∞–Ω.");

    } catch (error) {
         console.error("[Shift UI] –û—à–∏–±–∫–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ —ç–∫—Ä–∞–Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —Å–º–µ–Ω—ã:", error);
         alert(`–û—à–∏–±–∫–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ —ç–∫—Ä–∞–Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —Å–º–µ–Ω—ã: ${error.message}`);
         if(shiftScreen) shiftScreen.classList.add('hidden');
         if(loginScreen) loginScreen.classList.remove('hidden');
    } finally {
         hideLoader(); 
         console.log("[Shift UI] showOpenShiftScreen: End");
    }
}


// index.html (–ü–û–õ–ù–û–°–¢–¨–Æ –ó–ê–ú–ï–ù–Ø–ï–¢ handleOpenShiftSubmit)

async function handleOpenShiftSubmit(e) {
    e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É
    console.log("[Shift Action] handleOpenShiftSubmit: Start");
    showLoader(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä

    let employeeIdToOpen = currentUser.id; 
    let locationIdToOpen = currentUser.location_id; 

    // --- –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ ID —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –∏ —Ñ–∏–ª–∏–∞–ª–∞ (–¥–ª—è –í–ª–∞–¥–µ–ª—å—Ü–∞) ---
    if (currentUser.role === '–í–ª–∞–¥–µ–ª–µ—Ü') {
        const employeeSelect = document.getElementById('shift-employee-select');
        const locationSelect = document.getElementById('shift-location-select');
        
        // –í–ª–∞–¥–µ–ª–µ—Ü –í–°–ï–ì–î–ê –≤—ã–±–∏—Ä–∞–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –∏–∑ —Å–ø–∏—Å–∫–∞
        if (employeeSelect) {
            employeeIdToOpen = parseInt(employeeSelect.value);
            console.log("[Shift Action] –í–ª–∞–¥–µ–ª–µ—Ü –≤—ã–±—Ä–∞–ª —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞:", employeeIdToOpen);
        } else {
            // –ï—Å–ª–∏ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ –Ω–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –í–ª–∞–¥–µ–ª—å—Ü–∞ (–∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç)
            employeeIdToOpen = currentUser.id;
        }

        // –í–ª–∞–¥–µ–ª–µ—Ü –í–°–ï–ì–î–ê –≤—ã–±–∏—Ä–∞–µ—Ç —Ñ–∏–ª–∏–∞–ª –∏–∑ —Å–ø–∏—Å–∫–∞
        if (locationSelect) {
            locationIdToOpen = parseInt(locationSelect.value);
            console.log("[Shift Action] –í–ª–∞–¥–µ–ª–µ—Ü –≤—ã–±—Ä–∞–ª —Ñ–∏–ª–∏–∞–ª:", locationIdToOpen);
        } else {
             // –ï—Å–ª–∏ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ –Ω–µ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–æ–ª—å–∫–æ 1 —Ñ–∏–ª–∏–∞–ª –≤ –∫–æ–º–ø–∞–Ω–∏–∏)
             if (companyLocations && companyLocations.length === 1) {
                 locationIdToOpen = companyLocations[0].id;
             } else {
                 locationIdToOpen = currentUser.location_id; // –ó–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
             }
        }
    }
    // –î–ª—è –æ–±—ã—á–Ω–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ ID –æ—Å—Ç–∞—é—Ç—Å—è currentUser.id –∏ currentUser.location_id
    // --- –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ô –õ–û–ì–ò–ö–ò ---

    if (!locationIdToOpen) {
        hideLoader();
        console.error("[Shift Action] –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID —Ñ–∏–ª–∏–∞–ª–∞ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —Å–º–µ–Ω—ã.");
        alert("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ñ–∏–ª–∏–∞–ª –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —Å–º–µ–Ω—ã.");
        return;
    }
    
    // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã
    const startingCashInput = document.getElementById('starting-cash');
    const exchangeRateInput = document.getElementById('shift-exchange-rate');
    const pricePerKgInput = document.getElementById('shift-price-per-kg');

    const payload = {
        employee_id: employeeIdToOpen,
        location_id: locationIdToOpen, // <-- –¢–µ–ø–µ—Ä—å –∑–¥–µ—Å—å –±—É–¥–µ—Ç ID –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ñ–∏–ª–∏–∞–ª–∞
        starting_cash: startingCashInput ? parseFloat(startingCashInput.value) : 0,
        exchange_rate_usd: exchangeRateInput ? parseFloat(exchangeRateInput.value) : 0,
        price_per_kg_usd: pricePerKgInput ? parseFloat(pricePerKgInput.value) : 0
    };

    // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
     if (isNaN(payload.starting_cash) || payload.starting_cash < 0 ||
         isNaN(payload.exchange_rate_usd) || payload.exchange_rate_usd <= 0 ||
         isNaN(payload.price_per_kg_usd) || payload.price_per_kg_usd <= 0) {
           hideLoader();
           alert("–û—à–∏–±–∫–∞: –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —á–∏—Å–ª–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è.");
           return;
     }

    console.log("[Shift Action] –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∏–µ —Å–º–µ–Ω—ã:", payload);

    try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –±—ç–∫–µ–Ω–¥ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —Å–º–µ–Ω—ã
        const newShift = await apiFetch('/api/shifts/open', {
            method: 'POST',
            body: JSON.stringify(payload)
        });
        
        // –í–ê–ñ–ù–û: –ë—ç–∫–µ–Ω–¥ (main.py, —Ñ—É–Ω–∫—Ü–∏—è open_shift) –£–ñ–ï –ò–ú–ï–ï–¢ –ø—Ä–æ–≤–µ—Ä–∫—É, 
        // —á—Ç–æ –≤ –¶–ï–õ–ï–í–û–ú —Ñ–∏–ª–∏–∞–ª–µ (payload.location_id) –Ω–µ—Ç –æ—Ç–∫—Ä—ã—Ç–æ–π —Å–º–µ–Ω—ã.
        // –ü–æ—ç—Ç–æ–º—É, –µ—Å–ª–∏ –≤—ã –≤—ã–±–µ—Ä–µ—Ç–µ "–ì–ª–∞–≤–Ω—ã–π —Ñ–∏–ª–∏–∞–ª", –≤—ã –ø–æ–ª—É—á–∏—Ç–µ –æ—à–∏–±–∫—É (—ç—Ç–æ –ü–†–ê–í–ò–õ–¨–ù–û).
        // –ï—Å–ª–∏ –≤—ã –≤—ã–±–µ—Ä–µ—Ç–µ "WishKargo" (–≥–¥–µ —Å–º–µ–Ω—ã –Ω–µ—Ç), –±—ç–∫–µ–Ω–¥ –µ–µ –æ—Ç–∫—Ä–æ–µ—Ç.

        activeShift = newShift; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–æ–≤–æ–π –∞–∫—Ç–∏–≤–Ω–æ–π —Å–º–µ–Ω—ã
        console.log("[Shift Action] –°–º–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–∫—Ä—ã—Ç–∞:", activeShift);
        
        // 1. –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å —ç–∫—Ä–∞–Ω–æ–≤
        const shiftScreen = document.getElementById('shift-screen');
        if(shiftScreen) shiftScreen.classList.add('hidden');
        if(mainApp) mainApp.classList.remove('hidden');
        console.log("[Shift Action] –ü–µ—Ä–µ—Ö–æ–¥ –≤ –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.");

        // 2. –°–ù–ê–ß–ê–õ–ê –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º HTML –≥–ª–∞–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        await initializeMainAppUI(); 
        
        // 3. –¢–ï–ü–ï–†–¨ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —Å–º–µ–Ω—ã
        // (–ú—ã –¥–æ–ª–∂–Ω—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ get_active_shift –≤–µ—Ä–Ω–µ—Ç —Å–º–µ–Ω—É –í–ª–∞–¥–µ–ª—å—Ü–∞, –µ—Å–ª–∏ –æ–Ω –µ–µ –æ—Ç–∫—Ä—ã–ª)
        await updateShiftControlButtonUI(); 

        // 4. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ì–õ–û–ë–ê–õ–¨–ù–´–ï —Å–ª—É—à–∞—Ç–µ–ª–∏
        initializeGlobalEventListeners(); 
        
    } catch (err) { // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (–≤–∫–ª—é—á–∞—è "—Å–º–µ–Ω–∞ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç–∞")
         console.error("[Shift Action] –û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —Å–º–µ–Ω—ã:", err);
         alert(`–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —Å–º–µ–Ω—ã: ${err.message}`);
         hideLoader(); // –°–∫—Ä—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä –ø—Ä–∏ –æ—à–∏–±–∫–µ
    }
     console.log("[Shift Action] handleOpenShiftSubmit: End");
}

// --- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ HTML –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–º–µ–Ω–æ–π (–±–µ–∑ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–ª—É—à–∞—Ç–µ–ª—è –∑–¥–µ—Å—å) ---
// –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ initializeMainAppUI
async function updateShiftControlButtonUI() {
     console.log("[Shift Button UI] updateShiftControlButtonUI: Start");
     const container = document.getElementById('shift-control-container');
     if (!container) {
          console.warn("[Shift Button UI] –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä #shift-control-container –Ω–µ –Ω–∞–π–¥–µ–Ω.");
          return; // –í—ã—Ö–æ–¥–∏–º, –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –Ω–µ—Ç
     }
     // –î–ª—è SuperAdmin –∫–Ω–æ–ø–∫–∞ –Ω–µ –Ω—É–∂–Ω–∞
     if (!currentUser || currentUser.is_super_admin) {
          container.innerHTML = ''; // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
          console.log("[Shift Button UI] SuperAdmin, –∫–Ω–æ–ø–∫–∞ –Ω–µ –Ω—É–∂–Ω–∞.");
          return;
     }

     container.innerHTML = '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–º–µ–Ω—ã...'; // –í—Ä–µ–º–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç

     // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–º–µ–Ω—ã –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —ç—Ç–æ –ù–ï –í–ª–∞–¥–µ–ª–µ—Ü
     if (currentUser.role !== '–í–ª–∞–¥–µ–ª–µ—Ü') {
          await checkActiveShiftStatus(); // –û–±–Ω–æ–≤–ª—è–µ–º global activeShift
     } else {
          activeShift = null; // –î–ª—è –í–ª–∞–¥–µ–ª—å—Ü–∞ —Å–º–µ–Ω—ã –Ω–µ—Ç
          console.log("[Shift Button UI] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –í–ª–∞–¥–µ–ª–µ—Ü, activeShift —Å–±—Ä–æ—à–µ–Ω –≤ null.");
     }


     let buttonHtml = '';
     const buttonId = 'shift-action-btn'; // ID –¥–ª—è –∫–Ω–æ–ø–∫–∏

     // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–æ–π HTML –ø–æ–∫–∞–∑–∞—Ç—å
     if (activeShift && currentUser.id === activeShift.employee_id) {
          // –ï—Å–ª–∏ —Å–º–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞ –ò —ç—Ç–æ —Å–º–µ–Ω–∞ –¢–ï–ö–£–©–ï–ì–û —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ -> –ö–Ω–æ–ø–∫–∞ "–ó–∞–∫—Ä—ã—Ç—å"
          console.log("[Shift Button UI] –°–º–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞ (—Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞), –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º '–ó–∞–∫—Ä—ã—Ç—å'.");
          buttonHtml = `<button id="${buttonId}" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-sm animate-pulse">–ó–∞–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É #${activeShift.id}</button>`;
     } else if (!activeShift && currentUser.permissions?.includes('open_close_shift')) {
           // –ï—Å–ª–∏ —Å–º–µ–Ω—ã –ù–ï–¢ –ò –µ—Å—Ç—å –ü–†–ê–í–ê –Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∏–µ -> –ö–Ω–æ–ø–∫–∞ "–û—Ç–∫—Ä—ã—Ç—å"
           console.log("[Shift Button UI] –°–º–µ–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∞, –µ—Å—Ç—å –ø—Ä–∞–≤–∞, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º '–û—Ç–∫—Ä—ã—Ç—å'.");
           buttonHtml = `<button id="${buttonId}" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg text-sm">–û—Ç–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É</button>`;
     } else if (activeShift && currentUser.role === '–í–ª–∞–¥–µ–ª–µ—Ü'){
          // –ï—Å–ª–∏ –í–ª–∞–¥–µ–ª–µ—Ü –≤–∏–¥–∏—Ç –∞–∫—Ç–∏–≤–Ω—É—é —Å–º–µ–Ω—É –î–†–£–ì–û–ì–û —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ -> –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ
          console.log("[Shift Button UI] –í–ª–∞–¥–µ–ª–µ—Ü –≤–∏–¥–∏—Ç –∞–∫—Ç–∏–≤–Ω—É—é —Å–º–µ–Ω—É –¥—Ä—É–≥–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (ID:", activeShift.id, ")");
          // TODO: –ü–æ–ª—É—á–∏—Ç—å –∏–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ —Å–º–µ–Ω—ã?
           buttonHtml = `<span class="text-sm text-yellow-600 font-semibold" title="–°–º–µ–Ω–∞ ID ${activeShift.id} –∞–∫—Ç–∏–≤–Ω–∞">–°–º–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞</span>`;
           // TODO: –ú–æ–∂–µ—Ç –í–ª–∞–¥–µ–ª–µ—Ü –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–∫—Ä—ã—Ç—å —á—É–∂—É—é —Å–º–µ–Ω—É?
     } else { // –°–º–µ–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∞ –∏ –Ω–µ—Ç –ø—Ä–∞–≤ –ò–õ–ò —Å–º–µ–Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –¥—Ä—É–≥–∏–º (–Ω–µ –≤–ª–∞–¥–µ–ª—å—Ü–µ–º)
          console.log("[Shift Button UI] –°–º–µ–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∞ (–Ω–µ—Ç –ø—Ä–∞–≤) –∏–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞ –¥—Ä—É–≥–∏–º.");
          buttonHtml = `<span class="text-sm text-red-600 font-semibold">–°–º–µ–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∞</span>`;
     }

     // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º HTML
     container.innerHTML = buttonHtml;
     console.log("[Shift Button UI] HTML –∫–Ω–æ–ø–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω.");

     // --- –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –∫ –¢–û–õ–¨–ö–û –ß–¢–û —Å–æ–∑–¥–∞–Ω–Ω–æ–π –∫–Ω–æ–ø–∫–µ (–µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å) ---
     const actionButton = document.getElementById(buttonId);
     if (actionButton) {
          let listenerFunc = null;
          if (activeShift && currentUser.id === activeShift.employee_id) {
               listenerFunc = handleCloseShiftClick; // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è
          } else if (!activeShift && currentUser.permissions?.includes('open_close_shift')) {
               listenerFunc = () => { // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è (–ø–æ–∫–∞–∑ —ç–∫—Ä–∞–Ω–∞)
                   console.log("[Shift Button UI] –ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ '–û—Ç–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É'");
                   if(mainApp) mainApp.classList.add('hidden');
                   showOpenShiftScreen(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –æ—Ç–∫—Ä—ã—Ç–∏—è
               };
          }

          if (listenerFunc) {
               // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Å–ª—É—à–∞—Ç–µ–ª—å –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ
               actionButton.replaceWith(actionButton.cloneNode(true));
               document.getElementById(buttonId)?.addEventListener('click', listenerFunc);
               console.log(`[Shift Button Listener OK] Added click to #${buttonId}`);
          }
     } else {
          console.log(`[Shift Button UI] –ö–Ω–æ–ø–∫–∞ #${buttonId} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –¥–ª—è –Ω–µ–µ –Ω–µ –Ω—É–∂–µ–Ω —Å–ª—É—à–∞—Ç–µ–ª—å.`);
     }
     console.log("[Shift Button UI] updateShiftControlButtonUI: End");
}


// --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ "–ó–∞–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É" ---
async function handleCloseShiftClick() {
     if (!activeShift) {
          console.warn("[Shift Action] –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É, –Ω–æ activeShift is null.");
          alert("–û—à–∏–±–∫–∞: –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞—è —Å–º–µ–Ω–∞ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è.");
          await updateShiftControlButtonUI(); // –û–±–Ω–æ–≤–∏–º –∫–Ω–æ–ø–∫—É –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
          return;
     }
     console.log(`[Shift Action] handleCloseShiftClick: Start closing shift ID ${activeShift.id}`);

     // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å—É–º–º—É –Ω–∞–ª–∏—á–Ω—ã—Ö –≤ –∫–∞—Å—Å–µ
     const closingCashStr = prompt(`–ó–∞–∫—Ä—ã—Ç–∏–µ —Å–º–µ–Ω—ã #${activeShift.id}.\n–í–≤–µ–¥–∏—Ç–µ –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É –ù–ê–õ–ò–ß–ù–´–• –≤ –∫–∞—Å—Å–µ (—Å–æ–º):`);
     // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞–∂–∞–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –û—Ç–º–µ–Ω–∞
     if (closingCashStr === null) {
         console.log("[Shift Action] –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–º–µ–Ω—ã –æ—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.");
         return; // –í—ã—Ö–æ–¥–∏–º, –µ—Å–ª–∏ –û—Ç–º–µ–Ω–∞
     }

     // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–≤–µ–¥–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
     const closingCash = parseFloat(closingCashStr);
     if (isNaN(closingCash) || closingCash < 0) {
         alert("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—É–º–º–∞. –í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ.");
         return; // –í—ã—Ö–æ–¥–∏–º, –µ—Å–ª–∏ —Å—É–º–º–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞
     }

     console.log(`[Shift Action] –í–≤–µ–¥–µ–Ω–∞ —Å—É–º–º–∞ –∑–∞–∫—Ä—ã—Ç–∏—è: ${closingCash}`);
     showLoader(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º

     try {
         // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –±—ç–∫–µ–Ω–¥ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è —Å–º–µ–Ω—ã
         await apiFetch('/api/shifts/close', {
             method: 'POST',
             body: JSON.stringify({ closing_cash: closingCash }) // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—É–º–º—É
         });
         console.log(`[Shift Action] –°–º–µ–Ω–∞ #${activeShift.id} —É—Å–ø–µ—à–Ω–æ –∑–∞–∫—Ä—ã—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.`);
         alert(`–°–º–µ–Ω–∞ #${activeShift.id} —É—Å–ø–µ—à–Ω–æ –∑–∞–∫—Ä—ã—Ç–∞!`);
         activeShift = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é

         // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—à–µ–ª –∏–∑ —Å–∏—Å—Ç–µ–º—ã
         console.log("[Shift Action] –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã...");
         location.reload();

     } catch (err) { // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –æ—Ç apiFetch
         console.error("[Shift Action] –û—à–∏–±–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Å–º–µ–Ω—ã:", err);
         alert(`–û—à–∏–±–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Å–º–µ–Ω—ã: ${err.message}`);
         hideLoader(); // –°–∫—Ä—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ—à–∏–±–∫–µ (–ø—Ä–∏ —É—Å–ø–µ—Ö–µ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—Å—è)
     }
     // –ü—Ä–∏ —É—Å–ø–µ—Ö–µ hideLoader –Ω–µ –Ω—É–∂–µ–Ω, —Ç.–∫. —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
     console.log("[Shift Action] handleCloseShiftClick: End");
}

// =================================================================
// –ú–û–î–£–õ–¨: –¢–ò–ü–´ –†–ê–°–•–û–î–û–í (–í–ª–∞–¥–µ–ª–µ—Ü) (v4.1 - Rebuild)
// =================================================================
companyExpenseTypes = []; // –ö—ç—à –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Ç–∏–ø–æ–≤ —Ä–∞—Å—Ö–æ–¥–æ–≤

// --- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≤–∫–ª–∞–¥–∫–∏ "–¢–∏–ø—ã –†–∞—Å—Ö–æ–¥–æ–≤" ---
// –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ initializeMainAppUI, –µ—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å –ø—Ä–∞–≤–∞
async function renderExpenseTypesTab() {
    console.log("[Render] renderExpenseTypesTab: Start");
    const pane = document.getElementById('tab-expense-types');
    if (!pane) {
        console.warn("[Render] renderExpenseTypesTab: Pane #tab-expense-types not found.");
        return; // –í—ã—Ö–æ–¥–∏–º, –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–∫–ª–∞–¥–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω
    }

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π HTML –¥–ª—è –≤–∫–ª–∞–¥–∫–∏
    pane.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="md:col-span-1">
                <div class="bg-white p-6 rounded-lg shadow-md h-fit">
                    <h2 class="text-xl font-semibold mb-4">–î–æ–±–∞–≤–∏—Ç—å –¢–∏–ø –†–∞—Å—Ö–æ–¥–∞</h2>
                    <form id="add-expense-type-form" class="space-y-3">
                        <label for="new-expense-type-name" class="block text-sm font-medium text-gray-700">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                        <input type="text" id="new-expense-type-name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ê—Ä–µ–Ω–¥–∞, –ö–∞–Ω—Ü—Ç–æ–≤–∞—Ä—ã" class="w-full p-2 border rounded" required>
                        <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-2 rounded-lg hover:bg-indigo-700">–°–æ–∑–¥–∞—Ç—å –¢–∏–ø</button>
                    </form>
                </div>
            </div>
            <div class="md:col-span-2">
                 <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold mb-4">–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¢–∏–ø—ã –†–∞—Å—Ö–æ–¥–æ–≤</h2>
                    <div id="expense-types-list" class="space-y-3">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∏–ø–æ–≤...</div>
                </div>
            </div>
        </div>
    `;

    // --- –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏ –∫ —ç–ª–µ–º–µ–Ω—Ç–∞–º, —Å–æ–∑–¥–∞–Ω–Ω—ã–º –í–´–®–ï ---
    const addForm = document.getElementById('add-expense-type-form');
    const typeListDiv = document.getElementById('expense-types-list');

    if (addForm) {
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Å–ª—É—à–∞—Ç–µ–ª—å –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ
        addForm.replaceWith(addForm.cloneNode(true));
        document.getElementById('add-expense-type-form').addEventListener('submit', handleAddExpenseType);
        console.log("[Listener OK] Added submit to #add-expense-type-form");
    } else {
        console.error("!!! renderExpenseTypesTab: Element #add-expense-type-form NOT FOUND after innerHTML.");
    }

    if (typeListDiv) {
         // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤–Ω—É—Ç—Ä–∏ —Å–ø–∏—Å–∫–∞
         typeListDiv.replaceWith(typeListDiv.cloneNode(true)); // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ
         document.getElementById('expense-types-list').addEventListener('click', handleExpenseTypeActions);
         console.log("[Listener OK] Added click listener to #expense-types-list");
    } else {
         console.error("!!! renderExpenseTypesTab: Element #expense-types-list NOT FOUND after innerHTML.");
    }
    // --- –ö–æ–Ω–µ—Ü –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–ª—É—à–∞—Ç–µ–ª–µ–π ---

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    await fetchAndRenderExpenseTypes();
    console.log("[Render] renderExpenseTypesTab: End");
}

// --- –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –¢–∏–ø–æ–≤ –†–∞—Å—Ö–æ–¥–æ–≤ ---
async function fetchAndRenderExpenseTypes() {
     console.log("[Fetch] fetchAndRenderExpenseTypes: Start");
     const listDiv = document.getElementById('expense-types-list');
     if (!listDiv) return; // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –∏—Å—á–µ–∑
     listDiv.innerHTML = '<p class="text-gray-500 animate-pulse">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∏–ø–æ–≤ —Ä–∞—Å—Ö–æ–¥–æ–≤...</p>'; // –£–ª—É—á—à–µ–Ω–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞
     // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –ª–æ–∞–¥–µ—Ä –∑–¥–µ—Å—å, —Ç.–∫. –∑–∞–≥—Ä—É–∑–∫–∞ –æ–±—ã—á–Ω–æ –±—ã—Å—Ç—Ä–∞—è
     // showLoader();
     try {
         // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ç–∏–ø—ã —Ä–∞—Å—Ö–æ–¥–æ–≤ –¥–ª—è —Ç–µ–∫—É—â–µ–π –∫–æ–º–ø–∞–Ω–∏–∏
         const types = await apiFetch('/api/expense_types');
         companyExpenseTypes = types; // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à

         if (!types || types.length === 0) {
             listDiv.innerHTML = '<p class="text-gray-500">–£ –≤–∞—à–µ–π –∫–æ–º–ø–∞–Ω–∏–∏ –µ—â–µ –Ω–µ—Ç —Ç–∏–ø–æ–≤ —Ä–∞—Å—Ö–æ–¥–æ–≤. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π!</p>';
         } else {
             // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å/–£–¥–∞–ª–∏—Ç—å
             listDiv.innerHTML = types.map(t => `
                 <div class="p-3 bg-gray-50 rounded-md flex flex-wrap justify-between items-center gap-2">
                     <p class="font-bold flex-grow">${t.name}</p>
                     <div class="flex-shrink-0 flex gap-2">
                        <button data-type-id="${t.id}" data-type-name="${t.name}" class="edit-expense-type-btn text-sm bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                        <button data-type-id="${t.id}" data-type-name="${t.name}" class="delete-expense-type-btn text-sm bg-red-200 hover:bg-red-300 text-red-800 px-3 py-1 rounded">–£–¥–∞–ª–∏—Ç—å</button>
                     </div>
                 </div>
             `).join('');
         }
         console.log("[Fetch] fetchAndRenderExpenseTypes: Success");
     } catch (e) {
         console.error("[Fetch] fetchAndRenderExpenseTypes: Error", e);
         listDiv.innerHTML = `<p class="text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∏–ø–æ–≤ —Ä–∞—Å—Ö–æ–¥–æ–≤: ${e.message}</p>`;
     } finally {
         // hideLoader();
     }
}

// --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ñ–æ—Ä–º—ã "–î–æ–±–∞–≤–∏—Ç—å –¢–∏–ø –†–∞—Å—Ö–æ–¥–∞" ---
async function handleAddExpenseType(e) {
    e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É
    console.log("[Expense Type Action] handleAddExpenseType: Start");
    const nameInput = document.getElementById('new-expense-type-name');
    const name = nameInput ? nameInput.value.trim() : null;

    if (!name) {
        alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–∏–ø–∞ —Ä–∞—Å—Ö–æ–¥–∞.");
        return;
    }
    showLoader(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º
    try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º POST –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ
        await apiFetch('/api/expense_types', {
             method: 'POST',
             body: JSON.stringify({ name: name })
        });
        alert(`–¢–∏–ø —Ä–∞—Å—Ö–æ–¥–∞ "${name}" —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω.`);
        if(nameInput) nameInput.value = ''; // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
        await fetchAndRenderExpenseTypes(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    } catch(err) {
        console.error("[Expense Type Action] handleAddExpenseType: Error", err);
        alert(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∏–ø–∞ —Ä–∞—Å—Ö–æ–¥–∞: ${err.message}`);
    } finally {
        hideLoader(); // –°–∫—Ä—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
        console.log("[Expense Type Action] handleAddExpenseType: End");
    }
}

// --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤ –ø–æ –∫–Ω–æ–ø–∫–∞–º –≤ —Å–ø–∏—Å–∫–µ –¢–∏–ø–æ–≤ –†–∞—Å—Ö–æ–¥–æ–≤ (–¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ) ---
function handleExpenseTypeActions(e) {
     // –ò—â–µ–º –±–ª–∏–∂–∞–π—à—É—é –∫–Ω–æ–ø–∫—É –∫ –º–µ—Å—Ç—É –∫–ª–∏–∫–∞
     const btn = e.target.closest('button');
     if (!btn) return; // –ö–ª–∏–∫ –Ω–µ –ø–æ –∫–Ω–æ–ø–∫–µ

     const typeId = btn.dataset.typeId;
     const typeName = btn.dataset.typeName;

     // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–µ–π—Å—Ç–≤–∏–µ –ø–æ –∫–ª–∞—Å—Å—É –∫–Ω–æ–ø–∫–∏
     if (btn.classList.contains('edit-expense-type-btn')) {
          console.log(`[Expense Type Action] Edit button clicked for ID: ${typeId}`);
          // –ù–∞—Ö–æ–¥–∏–º –¥–∞–Ω–Ω—ã–µ —Ç–∏–ø–∞ –≤ –∫—ç—à–µ
          const currentType = companyExpenseTypes.find(t => t.id == typeId); // –ò—Å–ø–æ–ª—å–∑—É–µ–º '==' –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–∏ –∏ —á–∏—Å–ª–∞
          if (currentType) {
               openExpenseTypeModal(currentType); // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
          } else {
               console.error(`!!! Edit Expense Type: Type with ID ${typeId} not found in cache.`);
               alert("–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.");
          }
     } else if (btn.classList.contains('delete-expense-type-btn')) {
          console.log(`[Expense Type Action] Delete button clicked for ID: ${typeId}`);
          // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º
          if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ç–∏–ø —Ä–∞—Å—Ö–æ–¥–∞ "${typeName}"?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.`)) {
               handleDeleteExpenseType(typeId, typeName); // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é —É–¥–∞–ª–µ–Ω–∏—è
          }
     }
}

// --- –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –¢–∏–ø–∞ –†–∞—Å—Ö–æ–¥–∞ ---
function openExpenseTypeModal(expenseType = null) {
     console.log("[Modal] openExpenseTypeModal: Start", expenseType);
     const modal = document.getElementById('expense-type-modal');
     if (!modal) return console.error("!!! openExpenseTypeModal: Modal element #expense-type-modal not found!");
     const modalContent = modal.querySelector('.modal-content');
     if (!modalContent) return console.error("!!! openExpenseTypeModal: Modal content not found!");

     const isEdit = expenseType !== null;

     // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
     modalContent.innerHTML = `
         <div class="flex justify-between items-start">
             <h3 class="text-2xl font-bold mb-4">${isEdit ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¢–∏–ø –†–∞—Å—Ö–æ–¥–∞' : '–°–æ–∑–¥–∞—Ç—å –¢–∏–ø –†–∞—Å—Ö–æ–¥–∞'}</h3>
             <button onclick="closeModal('expense-type-modal')" class="text-2xl font-bold">&times;</button>
         </div>
         <form id="expense-type-form-inner" data-type-id="${isEdit ? expenseType.id : ''}" class="space-y-4">
             <div>
                 <label for="modal-expense-type-name" class="block text-sm font-medium text-gray-700">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                 <input type="text" id="modal-expense-type-name" value="${isEdit ? expenseType.name : ''}" class="mt-1 w-full p-2 border rounded" required>
             </div>
             <div class="flex gap-4 mt-6 border-t pt-4">
                 <button type="button" onclick="closeModal('expense-type-modal')" class="w-full bg-gray-200 py-2 rounded hover:bg-gray-300">–û—Ç–º–µ–Ω–∞</button>
                 <button type="submit" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
             </div>
         </form>
     `;

     // --- –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å submit –∫ –¢–û–õ–¨–ö–û –ß–¢–û —Å–æ–∑–¥–∞–Ω–Ω–æ–π —Ñ–æ—Ä–º–µ ---
     const formElement = document.getElementById('expense-type-form-inner');
     if (formElement) {
         formElement.replaceWith(formElement.cloneNode(true)); // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Å–ª—É—à–∞—Ç–µ–ª–∏
         document.getElementById('expense-type-form-inner').addEventListener('submit', handleSaveExpenseType);
         console.log("[Modal Listener OK] Added submit to #expense-type-form-inner");
     } else {
         console.error("!!! openExpenseTypeModal: Form #expense-type-form-inner NOT FOUND after innerHTML!");
     }
     // --- –ö–æ–Ω–µ—Ü –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–ª—É—à–∞—Ç–µ–ª—è ---

     openModal('expense-type-modal'); // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
     console.log("[Modal] openExpenseTypeModal: End");
 }

// --- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¢–∏–ø–∞ –†–∞—Å—Ö–æ–¥–∞ ---
async function handleSaveExpenseType(e) {
     e.preventDefault();
     console.log("[Save] handleSaveExpenseType: Start");
     showLoader();
     const form = e.target;
     const typeId = form.dataset.typeId;
     const isEdit = !!typeId;
     const nameInput = document.getElementById('modal-expense-type-name');
     const name = nameInput ? nameInput.value.trim() : null;

     if (!name) {
         hideLoader();
         alert("–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∏–ø–∞ —Ä–∞—Å—Ö–æ–¥–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.");
         return;
     }

     const url = isEdit ? `/expense_types/${typeId}` : '/expense_types';
     const method = isEdit ? 'PATCH' : 'POST';
     const payload = { name: name };

     try {
         console.log(`[Save] handleSaveExpenseType: Sending ${method} to ${url}`, payload);
         await apiFetch(url, { method: method, body: JSON.stringify(payload) });
         alert(isEdit ? '–¢–∏–ø —Ä–∞—Å—Ö–æ–¥–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!' : '–¢–∏–ø —Ä–∞—Å—Ö–æ–¥–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!');
         closeModal('expense-type-modal');
         await fetchAndRenderExpenseTypes(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
     } catch (err) {
         console.error("[Save] handleSaveExpenseType: Error", err);
         alert(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–∏–ø–∞ —Ä–∞—Å—Ö–æ–¥–∞: ${err.message}`);
     } finally {
         hideLoader();
         console.log("[Save] handleSaveExpenseType: End");
     }
 }

// --- –£–¥–∞–ª–µ–Ω–∏–µ –¢–∏–ø–∞ –†–∞—Å—Ö–æ–¥–∞ ---
async function handleDeleteExpenseType(typeId, typeName) {
    console.log(`[Delete] handleDeleteExpenseType: Start deleting ID ${typeId} (${typeName})`);
    showLoader();
    try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º DELETE –∑–∞–ø—Ä–æ—Å –Ω–∞ –±—ç–∫–µ–Ω–¥
        await apiFetch(`/api/expense_types/${typeId}`, { method: 'DELETE' });
        alert(`–¢–∏–ø —Ä–∞—Å—Ö–æ–¥–∞ "${typeName}" —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω.`);
        await fetchAndRenderExpenseTypes(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
    } catch(err) {
        console.error("[Delete] handleDeleteExpenseType: Error", err);
        // –ë—ç–∫–µ–Ω–¥ –≤–µ—Ä–Ω–µ—Ç –æ—à–∏–±–∫—É (400), –µ—Å–ª–∏ —Ç–∏–ø –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, apiFetch –µ–µ –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç
        alert(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–∏–ø–∞ —Ä–∞—Å—Ö–æ–¥–∞: ${err.message}`);
    } finally {
        hideLoader();
        console.log("[Delete] handleDeleteExpenseType: End");
    }
}

// =================================================================
// –ú–û–î–£–õ–¨: –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–û–ú–ü–ê–ù–ò–Ø–ú–ò (Super-Admin) (v4.1 - Rebuild)
// =================================================================

// --- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≤–∫–ª–∞–¥–∫–∏ "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ö–æ–º–ø–∞–Ω–∏—è–º–∏" ---
// –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ initializeMainAppUI, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å SuperAdmin –∏ –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞
async function renderCompaniesTab() {
    console.log("[Render] renderCompaniesTab: Start");
    const pane = document.getElementById('tab-companies');
    if (!pane) {
         console.warn("[Render] renderCompaniesTab: Pane #tab-companies not found.");
         return; // –í—ã—Ö–æ–¥–∏–º, –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–∫–ª–∞–¥–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω
    }

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –¥–ª—è –≤–∫–ª–∞–¥–∫–∏
    pane.innerHTML = `
        <div class="bg-white p-6 rounded-lg shadow-md">
            <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                <h2 class="text-2xl font-bold">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ö–æ–º–ø–∞–Ω–∏—è–º–∏-–ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞–º–∏</h2>
                <button id="add-company-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ö–æ–º–ø–∞–Ω–∏—é</button>
            </div>
            <div id="companies-list" class="space-y-3">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∫–æ–º–ø–∞–Ω–∏–π...</div>
        </div>
    `;

    // --- –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏ –∫ —ç–ª–µ–º–µ–Ω—Ç–∞–º, —Å–æ–∑–¥–∞–Ω–Ω—ã–º –í–´–®–ï ---
    const addBtn = document.getElementById('add-company-btn');
    const companyListDiv = document.getElementById('companies-list');

    if (addBtn) {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º replaceWith(cloneNode) –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö —Å–ª—É—à–∞—Ç–µ–ª–µ–π –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ
        const newAddBtn = addBtn.cloneNode(true);
        addBtn.parentNode?.replaceChild(newAddBtn, addBtn);
        newAddBtn.addEventListener('click', () => openCompanyModal()); // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –∫ –ù–û–í–û–ô –∫–Ω–æ–ø–∫–µ
        console.log("[Listener OK] Added click to #add-company-btn");
    } else {
        console.error("!!! renderCompaniesTab: Element #add-company-btn NOT FOUND after innerHTML.");
    }

    if (companyListDiv) {
         // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å/–£–¥–∞–ª–∏—Ç—å –≤–Ω—É—Ç—Ä–∏ —Å–ø–∏—Å–∫–∞
         const newCompanyListDiv = companyListDiv.cloneNode(false); // –ö–ª–æ–Ω–∏—Ä—É–µ–º –ø—É—Å—Ç–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
         companyListDiv.parentNode?.replaceChild(newCompanyListDiv, companyListDiv); // –ó–∞–º–µ–Ω—è–µ–º —Å—Ç–∞—Ä—ã–π
         newCompanyListDiv.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∫–æ–º–ø–∞–Ω–∏–π...'; // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É
         newCompanyListDiv.addEventListener('click', handleCompanyActions); // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –∫ –ù–û–í–û–ú–£ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É
         console.log("[Listener OK] Added click delegate listener to #companies-list");
    } else {
         console.error("!!! renderCompaniesTab: Element #companies-list NOT FOUND after innerHTML.");
    }
    // --- –ö–æ–Ω–µ—Ü –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–ª—É—à–∞—Ç–µ–ª–µ–π ---

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –¢–û–õ–¨–ö–û –ß–¢–û —Å–æ–∑–¥–∞–Ω–Ω–æ–º #companies-list
    await fetchAndRenderCompanies();
    console.log("[Render] renderCompaniesTab: End");
}

// --- –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–æ–º–ø–∞–Ω–∏–π ---
async function fetchAndRenderCompanies() {
    console.log("[Fetch] fetchAndRenderCompanies: Start");
    const listDiv = document.getElementById('companies-list'); // –ò—â–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–Ω–æ–≤–æ
    if (!listDiv) {
        console.error("!!! fetchAndRenderCompanies: listDiv #companies-list not found!");
        return; // –í—ã—Ö–æ–¥–∏–º, –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω (–Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏–∑–æ–π—Ç–∏)
    }
    listDiv.innerHTML = '<p class="text-gray-500 animate-pulse">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–ø–∞–Ω–∏–π...</p>';
    // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –ª–æ–∞–¥–µ—Ä
    try {
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π —É –±—ç–∫–µ–Ω–¥–∞
        const companies = await apiFetch('/api/superadmin/companies');
        console.log("[Fetch] fetchAndRenderCompanies: Received companies:", companies);

        if (!companies || companies.length === 0) {
            listDiv.innerHTML = '<p class="text-gray-500">–ö–æ–º–ø–∞–Ω–∏–π-–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–æ–≤ –µ—â–µ –Ω–µ—Ç. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é!</p>';
        } else {
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –¥–ª—è –∫–∞–∂–¥–æ–π –∫–æ–º–ø–∞–Ω–∏–∏ –≤ —Å–ø–∏—Å–∫–µ
            listDiv.innerHTML = companies.map(c => `
                <div class="p-3 ${c.is_active ? 'bg-gray-50' : 'bg-red-50 opacity-70'} rounded-md flex flex-wrap justify-between items-center gap-2 border">
                    <div class="flex-grow">
                        <p class="font-bold text-lg">${c.name} (–ö–æ–¥: <span class="text-indigo-600 font-mono">${c.company_code}</span>)</p>
                        <p class="text-sm text-gray-500">
                            –ü–æ–¥–ø–∏—Å–∫–∞ –¥–æ: ${c.subscription_paid_until ? new Date(c.subscription_paid_until).toLocaleDateString() : '–ù–µ —É—Å—Ç.'} |
                            –°—Ç–∞—Ç—É—Å: ${c.is_active ? '<span class="text-green-600 font-semibold">–ê–∫—Ç–∏–≤–Ω–∞</span>' : '<span class="text-red-600 font-semibold">–ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–ê</span>'}
                        </p>
                        ${c.contact_person || c.contact_phone ? `<p class="text-xs text-gray-500">–ö–æ–Ω—Ç–∞–∫—Ç: ${c.contact_person || ''} ${c.contact_phone || ''}</p>` : ''}
                    </div>
                    <div class="flex-shrink-0 flex gap-2">
                        <button data-company-json='${JSON.stringify(c)}' class="edit-company-btn text-sm bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button data-company-id="${c.id}" data-company-name="${c.name}" class="delete-company-btn text-sm bg-red-200 hover:bg-red-300 text-red-800 px-3 py-1 rounded">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                </div>
            `).join('');
        }
        console.log("[Fetch] fetchAndRenderCompanies: Success");
    } catch (e) {
        console.error("[Fetch] fetchAndRenderCompanies: Error", e);
        listDiv.innerHTML = `<p class="text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –∫–æ–º–ø–∞–Ω–∏–π: ${e.message}</p>`;
    } finally {
        // hideLoader(); // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ª–æ–∞–¥–µ—Ä –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–¥–µ—Å—å
    }
}

// --- –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ö–æ–º–ø–∞–Ω–∏–∏ (–¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è) ---
function openCompanyModal(company = null) {
    console.log("[Modal] openCompanyModal: Start", company);
    // –ù–∞—Ö–æ–¥–∏–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    const modal = document.getElementById('company-modal');
    if (!modal) return console.error("!!! openCompanyModal: Modal element #company-modal not found!");
    const modalContent = modal.querySelector('.modal-content');
    if (!modalContent) return console.error("!!! openCompanyModal: Modal content not found!");

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (true) –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏—è (false)
    const isEdit = company !== null;

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –¥–ª—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    modalContent.innerHTML = `
        <div class="flex justify-between items-start mb-4">
            <h3 class="text-2xl font-bold">${isEdit ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ö–æ–º–ø–∞–Ω–∏—é' : '–°–æ–∑–¥–∞—Ç—å –ù–æ–≤—É—é –ö–æ–º–ø–∞–Ω–∏—é'}</h3>
            <button onclick="closeModal('company-modal')" class="text-2xl font-bold leading-none p-1 -m-1">&times;</button>
        </div>
        <form id="modal-company-form" class="space-y-4">
            <input type="hidden" id="modal-company-id" value="${isEdit ? company.id : ''}">

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="modal-company-name" class="block text-sm font-medium text-gray-700">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ *</label>
                    <input type="text" id="modal-company-name" class="mt-1 w-full p-2 border rounded" required value="${isEdit ? company.name : ''}">
                </div>
                <div>
                    <label for="modal-company-code" class="block text-sm font-medium text-gray-700">–ö–æ–¥ –ö–æ–º–ø–∞–Ω–∏–∏ (A-Z, 0-9, _) *</label>
                    <input type="text" id="modal-company-code" class="mt-1 w-full p-2 border rounded uppercase font-mono" required
                           value="${isEdit ? company.company_code : ''}"
                           ${isEdit ? 'readonly title="–ö–æ–¥ –Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è"' : 'placeholder="–ù–∞–ø—Ä. VISH, CARGO_KG"'} maxlength="15">
                     <p class="text-xs text-gray-500 mt-1">3-15 –∑–Ω–∞–∫–æ–≤. –ù–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å.</p>
                </div>
            </div>
            <div>
                <label for="modal-company-subscription" class="block text-sm font-medium text-gray-700">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ *</label>
                <input type="date" id="modal-company-subscription" class="mt-1 w-full p-2 border rounded" required value="${isEdit && company.subscription_paid_until ? company.subscription_paid_until.split('T')[0] : ''}">
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                     <label for="modal-company-contact-person" class="block text-sm font-medium text-gray-700">–ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ</label>
                     <input type="text" id="modal-company-contact-person" class="mt-1 w-full p-2 border rounded" value="${isEdit ? (company.contact_person || '') : ''}">
                </div>
                <div>
                     <label for="modal-company-contact-phone" class="block text-sm font-medium text-gray-700">–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω</label>
                     <input type="text" id="modal-company-contact-phone" class="mt-1 w-full p-2 border rounded" value="${isEdit ? (company.contact_phone || '') : ''}">
                </div>
            </div>

            <div class="border-t pt-4 space-y-4">
                <h4 class="text-lg font-semibold text-gray-700">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram –ë–æ—Ç–∞</h4>
                <div>
                     <label for="modal-company-bot-token" class="block text-sm font-medium text-gray-700">–¢–æ–∫–µ–Ω Telegram –ë–æ—Ç–∞</label>
                     <input type="text" id="modal-company-bot-token" class="mt-1 w-full p-2 border rounded font-mono text-xs" value="${isEdit ? (company.telegram_bot_token || '') : ''}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 1234567890:ABC...">
                     <p class="text-xs text-gray-500 mt-1">–ü–æ–ª—É—á–∏—Ç–µ —É @BotFather –≤ Telegram. –û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ –±–æ—Ç –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è.</p>
                </div>
                <div>
                     <label for="modal-company-bot-username" class="block text-sm font-medium text-gray-700">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ë–æ—Ç–∞ (Username)</label>
                     <input type="text" id="modal-company-bot-username" class="mt-1 w-full p-2 border rounded" value="${isEdit ? (company.telegram_bot_username || '') : ''}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: @MyCargoCompanyBot">
                     <p class="text-xs text-gray-500 mt-1">–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ. –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å @.</p>
                </div>
            </div>
            <div id="modal-company-owner-fields" class="border-t pt-4 space-y-4 ${isEdit ? 'hidden' : 'block'}">
                 <h4 class="text-lg font-semibold">–î–∞–Ω–Ω—ã–µ –í–ª–∞–¥–µ–ª—å—Ü–∞ –ö–æ–º–ø–∞–Ω–∏–∏</h4>
                 <div>
                      <label for="modal-company-owner-name" class="block text-sm font-medium text-gray-700">–§–ò–û –í–ª–∞–¥–µ–ª—å—Ü–∞ *</label>
                      <input type="text" id="modal-company-owner-name" class="mt-1 w-full p-2 border rounded" ${!isEdit ? 'required' : ''}>
                 </div>
                 <div>
                      <label for="modal-company-owner-password" class="block text-sm font-medium text-gray-700">–ü–∞—Ä–æ–ª—å –í–ª–∞–¥–µ–ª—å—Ü–∞ *</label>
                      <input type="text" id="modal-company-owner-password" class="mt-1 w-full p-2 border rounded" ${!isEdit ? 'required' : ''}>
                 </div>
            </div>

            <div id="modal-company-status-field" class="border-t pt-4 ${isEdit ? 'block' : 'hidden'}">
                  <label class="flex items-center">
                      <input type="checkbox" id="modal-company-is-active" class="h-4 w-4 rounded" ${isEdit && company.is_active ? 'checked' : ''}>
                      <span class="ml-2 text-sm font-medium text-gray-700">–ö–æ–º–ø–∞–Ω–∏—è –ê–∫—Ç–∏–≤–Ω–∞ (–†–∞–∑—Ä–µ—à–µ–Ω –≤—Ö–æ–¥)</span>
                  </label>
                   <label class="flex items-center mt-2">
                       <input type="checkbox" id="modal-company-ai-enabled" class="h-4 w-4 rounded" ${isEdit && (company.ai_enabled === true) ? 'checked' : ''}>
                       <span class="ml-2 text-sm font-medium text-gray-700">ü§ñ –í–∫–ª—é—á–∏—Ç—å AI –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ (–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –†—É–±–∏–ª—å–Ω–∏–∫)</span>
                   </label>
            </div>

            <div class="flex gap-4 mt-6 border-t pt-4">
                <button type="button" onclick="closeModal('company-modal')" class="w-full bg-gray-200 py-2 rounded hover:bg-gray-300 text-gray-800">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </form>
    `;

    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–∞—Ç—ã –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (+30 –¥–Ω–µ–π) –¥–ª—è –ù–û–í–û–ô –∫–æ–º–ø–∞–Ω–∏–∏
    if (!isEdit) {
         const subInput = document.getElementById('modal-company-subscription');
         if (subInput && !subInput.value) {
              const today = new Date();
              today.setDate(today.getDate() + 30);
              // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –≤ YYYY-MM-DD –¥–ª—è input type="date"
              subInput.value = today.toISOString().split('T')[0];
              console.log("[Modal] –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –¥–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:", subInput.value);
         }
    }

    // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å submit –∫ –¢–û–õ–¨–ö–û –ß–¢–û —Å–æ–∑–¥–∞–Ω–Ω–æ–π —Ñ–æ—Ä–º–µ
    const formElement = document.getElementById('modal-company-form');
    if (formElement) {
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Å–ª—É—à–∞—Ç–µ–ª–∏ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ
        const newFormElement = formElement.cloneNode(true);
        formElement.parentNode.replaceChild(newFormElement, formElement);
        newFormElement.addEventListener('submit', handleSaveCompany);
        console.log("[Modal Listener OK] Added submit to #modal-company-form");
    } else {
        // –ï—Å–ª–∏ —Ñ–æ—Ä–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ HTML - —ç—Ç–æ –æ—à–∏–±–∫–∞
        console.error("!!! openCompanyModal: Form #modal-company-form NOT FOUND after innerHTML!");
    }

    openModal('company-modal'); // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    console.log("[Modal] openCompanyModal: End");
}

// --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –≤ —Å–ø–∏—Å–∫–µ –∫–æ–º–ø–∞–Ω–∏–π (–¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ) ---
// –í—ã–∑—ã–≤–∞–µ—Ç—Å—è —Å–ª—É—à–∞—Ç–µ–ª–µ–º, –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–º –≤ renderCompaniesTab
function handleCompanyActions(e) {
    const editButton = e.target.closest('.edit-company-btn');
    const deleteButton = e.target.closest('.delete-company-btn');

    if (editButton) {
        console.log("[Action] Edit company button clicked");
        try {
            // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏ –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–∞ –∫–Ω–æ–ø–∫–∏
            const companyData = JSON.parse(editButton.dataset.companyJson);
            openCompanyModal(companyData); // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        } catch (err) {
            console.error("Error parsing company data for edit:", err);
            alert("–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.");
        }
    } else if (deleteButton) {
        console.log("[Action] Delete company button clicked");
        const companyId = deleteButton.dataset.companyId;
        const companyName = deleteButton.dataset.companyName;
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º
        if (confirm(`–í–ù–ò–ú–ê–ù–ò–ï!\n\n–í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å –£–î–ê–õ–ò–¢–¨ –∫–æ–º–ø–∞–Ω–∏—é "${companyName}" –∏ –í–°–ï —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –Ω–µ–π –¥–∞–Ω–Ω—ã–µ (—Ñ–∏–ª–∏–∞–ª—ã, —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏, —Ä–æ–ª–∏, –∫–ª–∏–µ–Ω—Ç—ã, –∑–∞–∫–∞–∑—ã, —Å–º–µ–Ω—ã, —Ä–∞—Å—Ö–æ–¥—ã)?\n\n–î–ï–ô–°–¢–í–ò–ï –ù–ï–û–ë–†–ê–¢–ò–ú–û!`)) {
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
             if (prompt(`–î–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è "${companyName}" –≤–≤–µ–¥–∏—Ç–µ –µ–µ –∫–æ–¥ –∫–æ–º–ø–∞–Ω–∏–∏ (${companyName === 'WishCargo' ? 'WISH' : '–ö–û–î'}):`)?.toUpperCase() === companyName === 'WishCargo' ? 'WISH' : deleteButton.closest('.p-3').querySelector('.text-indigo-600')?.textContent) {
                  handleDeleteCompany(companyId, companyName); // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é —É–¥–∞–ª–µ–Ω–∏—è
             } else {
                  alert("–£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ: –ö–æ–¥ –∫–æ–º–ø–∞–Ω–∏–∏ –≤–≤–µ–¥–µ–Ω –Ω–µ–≤–µ—Ä–Ω–æ.");
             }
        }
    }
}

// --- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ö–æ–º–ø–∞–Ω–∏–∏ (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞) ---
// index.html (–í–Ω—É—Ç—Ä–∏ –ú–û–î–£–õ–¨: –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–û–ú–ü–ê–ù–ò–Ø–ú–ò)

async function handleSaveCompany(e) {
    e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã
    console.log("[Save] handleSaveCompany: Start");
    showLoader(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏

    const companyId = document.getElementById('modal-company-id')?.value;
    const isEdit = !!companyId; // true, –µ—Å–ª–∏ ID –µ—Å—Ç—å
    let url = '/api/superadmin/companies'; // URL –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è
    let method = 'POST'; // –ú–µ—Ç–æ–¥ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è
    if(isEdit) {
        url = `/api/superadmin/companies/${companyId}`; // URL –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        method = 'PATCH'; // –ú–µ—Ç–æ–¥ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    }
    
    // --- –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å—á–∏—Ç—ã–≤–∞–Ω–∏–µ AI-–†—É–±–∏–ª—å–Ω–∏–∫–∞ ---
    const aiEnabledCheckbox = document.getElementById('modal-company-ai-enabled');
    // –°—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –∫–∞–∫ boolean, –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ò–Ω–∞—á–µ –æ—Å—Ç–∞–≤–ª—è–µ–º undefined –¥–ª—è PATCH
    const aiEnabledStatus = aiEnabledCheckbox ? aiEnabledCheckbox.checked : undefined;
    
    let payload = {};

    try {
        if (isEdit) {
            // --- –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï ---
            payload = {
                name: document.getElementById('modal-company-name')?.value.trim(),
                subscription_paid_until: document.getElementById('modal-company-subscription')?.value,
                contact_person: document.getElementById('modal-company-contact-person')?.value.trim() || null,
                contact_phone: document.getElementById('modal-company-contact-phone')?.value.trim() || null,
                is_active: document.getElementById('modal-company-is-active')?.checked, 
                telegram_bot_token: document.getElementById('modal-company-bot-token')?.value.trim() || null, 
                telegram_bot_username: document.getElementById('modal-company-bot-username')?.value.trim() || null,
                // –ò–°–ü–†–ê–í–õ–ï–ù–û: –¢–µ–ø–µ—Ä—å –±–µ–∑–æ–ø–∞—Å–Ω–æ –ø–µ—Ä–µ–¥–∞–µ–º ai_enabled (true, false, –∏–ª–∏ undefined)
                ai_enabled: aiEnabledStatus 
            };
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
            if (!payload.name || !payload.subscription_paid_until) {
                throw new Error("–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ –∏ –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã.");
            }
        } else {
            // --- –°–û–ó–î–ê–ù–ò–ï ---
            payload = {
                name: document.getElementById('modal-company-name')?.value.trim(),
                company_code: document.getElementById('modal-company-code')?.value.toUpperCase().trim(),
                subscription_paid_until: document.getElementById('modal-company-subscription')?.value,
                contact_person: document.getElementById('modal-company-contact-person')?.value.trim() || null,
                contact_phone: document.getElementById('modal-company-contact-phone')?.value.trim() || null,
                owner_full_name: document.getElementById('modal-company-owner-name')?.value.trim(),
                owner_password: document.getElementById('modal-company-owner-password')?.value, 
                telegram_bot_token: document.getElementById('modal-company-bot-token')?.value.trim() || null,
                telegram_bot_username: document.getElementById('modal-company-bot-username')?.value.trim() || null,
                // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏, –µ—Å–ª–∏ undefined (–Ω–µ—Ç —ç–ª–µ–º–µ–Ω—Ç–∞), —Å—Ç–∞–≤–∏–º false
                ai_enabled: aiEnabledStatus || false 
            };
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
             if (!payload.name || !payload.company_code || !payload.subscription_paid_until || !payload.owner_full_name || !payload.owner_password) {
                  throw new Error("–í—Å–µ –ø–æ–ª—è —Å–æ –∑–≤–µ–∑–¥–æ—á–∫–æ–π (*) –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–º–ø–∞–Ω–∏–∏.");
             }
             if (!/^[A-Z0-9_]{3,15}$/.test(payload.company_code)) {
                  throw new Error("–ö–æ–¥ –∫–æ–º–ø–∞–Ω–∏–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω (3-15 –∑–Ω–∞–∫–æ–≤, —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã A-Z, —Ü–∏—Ñ—Ä—ã 0-9 –∏ —Å–∏–º–≤–æ–ª –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è '_').");
             }
        }

        // --- –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä ---
        console.log(`[Save] handleSaveCompany: Sending ${method} to ${url}`, payload);
        const result = await apiFetch(url, { method: method, body: JSON.stringify(payload) });
        console.log("[Save] handleSaveCompany: Server response", result);

        // --- –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—Ö–∞ ---
        alert(isEdit ? '–î–∞–Ω–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!' : '–ù–æ–≤–∞—è –∫–æ–º–ø–∞–Ω–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!');
        closeModal('company-modal'); 
        await fetchAndRenderCompanies(); 

    } catch(err) {
        console.error("[Save] handleSaveCompany: Error", err);
        alert(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∫–æ–º–ø–∞–Ω–∏–∏: ${err.message}`);
    } finally {
        hideLoader();
        console.log("[Save] handleSaveCompany: End");
    }
}

// --- –£–¥–∞–ª–µ–Ω–∏–µ –ö–æ–º–ø–∞–Ω–∏–∏ ---
async function handleDeleteCompany(companyId, companyName) {
    console.log(`[Delete] handleDeleteCompany: Start deleting ID ${companyId} (${companyName})`);
    showLoader();
    try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º DELETE –∑–∞–ø—Ä–æ—Å –Ω–∞ –±—ç–∫–µ–Ω–¥
        await apiFetch(`/api/superadmin/companies/${companyId}`, { method: 'DELETE' });
        console.log(`[Delete] handleDeleteCompany: Company ID ${companyId} deleted successfully.`);
        alert(`–ö–æ–º–ø–∞–Ω–∏—è "${companyName}" –∏ –≤—Å–µ –µ–µ –¥–∞–Ω–Ω—ã–µ –±—ã–ª–∏ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω—ã.`);
        await fetchAndRenderCompanies(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π
    } catch (err) { // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –æ—Ç apiFetch
        console.error("[Delete] handleDeleteCompany: Error", err);
        alert(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–º–ø–∞–Ω–∏–∏ "${companyName}": ${err.message}`);
    } finally {
        hideLoader(); // –°–∫—Ä—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
        console.log("[Delete] handleDeleteCompany: End");
    }
}

// =================================================================
// –ú–û–î–£–õ–¨: –§–ò–õ–ò–ê–õ–´ (–í–ª–∞–¥–µ–ª–µ—Ü) 
// =================================================================

// --- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≤–∫–ª–∞–¥–∫–∏ "–§–∏–ª–∏–∞–ª—ã" (–°–æ–∑–¥–∞–µ—Ç HTML-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã) ---

async function renderLocationsTab() {
    console.log("[Render] renderLocationsTab: Start");
    const pane = document.getElementById('tab-locations');
    if (!pane) {
         console.warn("[Render] renderLocationsTab: Pane #tab-locations not found.");
         return; 
    }

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π HTML –¥–ª—è –≤–∫–ª–∞–¥–∫–∏
    pane.innerHTML = `
        <div class="bg-white p-6 rounded-lg shadow-md">
            <div class="flex flex-wrap justify-between items-start gap-4 mb-4">
                <div class="flex flex-col">
                    <h2 class="text-2xl font-bold">–§–∏–ª–∏–∞–ª—ã (–¢–æ—á–∫–∏) –ö–æ–º–ø–∞–Ω–∏–∏</h2>
                    <p id="locations-status" class="text-sm text-gray-600">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–∞...</p>
                </div>
                <button id="add-location-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">‚ûï –î–æ–±–∞–≤–∏—Ç—å –§–∏–ª–∏–∞–ª</button>
            </div>
            <div id="locations-list" class="space-y-3">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ñ–∏–ª–∏–∞–ª–æ–≤...</div>
        </div>
    `;

    // --- –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏ ---
    const addBtn = document.getElementById('add-location-btn');
    if (addBtn) addBtn.addEventListener('click', () => openLocationModal()); 

    const locationListDiv = document.getElementById('locations-list');
    if (locationListDiv) {
         // –ó–∞–º–µ–Ω—è–µ–º, —á—Ç–æ–±—ã –æ—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —Å–ª—É—à–∞—Ç–µ–ª–∏
         const newLocationListDiv = locationListDiv.cloneNode(false);
         locationListDiv.parentNode?.replaceChild(newLocationListDiv, locationListDiv);
         newLocationListDiv.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ñ–∏–ª–∏–∞–ª–æ–≤...';
         
         newLocationListDiv.addEventListener('click', (e) => {
             const editBtn = e.target.closest('.edit-location-btn');
             const deleteBtn = e.target.closest('.delete-location-btn');
             const toggleBtn = e.target.closest('.toggle-shift-btn');
             
             if (editBtn) {
                 openLocationModal(JSON.parse(editBtn.dataset.locationJson));
                 return; // –í—ã—Ö–æ–¥–∏–º
             }
             
             if (toggleBtn) {
                 handleShiftToggle(e); 
                 return; // –í—ã—Ö–æ–¥–∏–º
             }

             // --- –î–û–ë–ê–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê –£–î–ê–õ–ï–ù–ò–Ø ---
             if (deleteBtn) {
                console.log("[Action] Delete location button clicked");
                const locationId = deleteBtn.dataset.locationId;
                const locationName = deleteBtn.dataset.locationName;
                // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è —Å–æ–¥–µ—Ä–∂–∏—Ç confirm
                handleDeleteLocation(locationId, locationName); 
                return; // –í—ã—Ö–æ–¥–∏–º
             }
             // --- –ö–û–ù–ï–¶ –î–û–ë–ê–í–õ–ï–ù–ù–û–ô –õ–û–ì–ò–ö–ò ---
         });
         console.log("[Listener OK] Added click delegate listener to #locations-list (with delete)");
    }

    await fetchAndRenderLocations();
    console.log("[Render] renderLocationsTab: End");
}

// --- –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ñ–∏–ª–∏–∞–ª–æ–≤ (–ì–î–ï –ë–´–õ–ê –û–®–ò–ë–ö–ê) ---
// index.html (–ü–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–º–µ–Ω—è–µ—Ç fetchAndRenderLocations)

async function fetchAndRenderLocations() {
    console.log("[Fetch] fetchAndRenderLocations: Start");
    
    // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è listDiv –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ!
    const listDiv = document.getElementById('locations-list'); 
    
    if (!listDiv) {
        console.error("!!! fetchAndRenderLocations: –≠–ª–µ–º–µ–Ω—Ç #locations-list –Ω–µ –Ω–∞–π–¥–µ–Ω.");
        return; 
    }
    
    listDiv.innerHTML = '<p class="text-gray-500 animate-pulse">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∏–ª–∏–∞–ª–æ–≤...</p>';
    showLoader(); 

    try {
        // --- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∏–ª–∏–∞–ª–æ–≤ –∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–º–µ–Ω ---
        const [locations, activeShifts] = await Promise.all([
            apiFetch('/api/locations'),
            fetchActiveShiftsForCompany() 
        ]);
        companyLocations = locations; 
        
        const shiftsByLocation = new Map();
        activeShifts.forEach(shift => shiftsByLocation.set(shift.location_id, shift));

        // --- –û–ë–ù–û–í–õ–ï–ù–ò–ï –î–ò–ù–ê–ú–ò–ß–ï–°–ö–û–ì–û –°–¢–ê–¢–£–°–ê ---
        const statusEl = document.getElementById('locations-status');
        const totalLocations = locations.length;
        const activeShiftCount = activeShifts.length;
        if (statusEl) {
            statusEl.textContent = `–í—Å–µ–≥–æ —Ç–æ—á–µ–∫: ${totalLocations} | –û—Ç–∫—Ä—ã—Ç—ã—Ö —Å–º–µ–Ω: ${activeShiftCount}`;
        }
        // ----------------------------------------

        if (!locations || locations.length === 0) {
             listDiv.innerHTML = '<p class="text-gray-500">–£ –≤–∞—à–µ–π –∫–æ–º–ø–∞–Ω–∏–∏ –Ω–µ—Ç —Ñ–∏–ª–∏–∞–ª–æ–≤.</p>';
        } else {
            listDiv.innerHTML = locations.map(loc => {
                const shiftInfo = shiftsByLocation.get(loc.id);
                const isActive = !!shiftInfo;
                const employeeName = shiftInfo?.employee?.full_name || '‚Äî';
                const buttonText = isActive ? '–ó–∞–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É' : '–û—Ç–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É';
                const buttonClass = isActive ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600';

                return `
                    <div class="p-3 bg-gray-50 rounded-md border flex flex-wrap justify-between items-center gap-2">
                        <div class="flex-grow">
                            <p class="font-bold text-lg">${loc.name}</p>
                            <p class="text-sm text-gray-600">${loc.address || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω'}</p>
                            <p class="text-xs ${isActive ? 'text-green-600 font-semibold' : 'text-red-600'}">
                                ${isActive ? `–°–ú–ï–ù–ê –û–¢–ö–†–´–¢–ê (–°–æ—Ç—Ä—É–¥–Ω–∏–∫: ${employeeName})` : '–°–ú–ï–ù–ê –ó–ê–ö–†–´–¢–ê'}
                            </p>
                        </div>
                        <div class="flex-shrink-0 flex gap-2">
                            <button data-location-json='${JSON.stringify(loc)}' class="edit-location-btn text-sm bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                            <button data-location-id="${loc.id}" 
                                    data-is-active="${isActive}"
                                    data-shift-id="${shiftInfo?.id || ''}"
                                    data-employee-id="${shiftInfo?.employee_id || ''}"
                                    class="toggle-shift-btn text-sm ${buttonClass} text-white px-3 py-1 rounded">
                                ${buttonText}
                            </button>
                            ${loc.name !== '–ì–ª–∞–≤–Ω—ã–π —Ñ–∏–ª–∏–∞–ª' ? `<button data-location-id="${loc.id}" data-location-name="${loc.name}" class="delete-location-btn text-sm bg-red-200 hover:bg-red-300 text-red-800 px-3 py-1 rounded">–£–¥–∞–ª–∏—Ç—å</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            // Note: addLocationActionListeners() –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–∞, —Ç.–∫. –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        }
    } catch (e) {
        listDiv.innerHTML = `<p class="text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Ñ–∏–ª–∏–∞–ª–æ–≤: ${e.message}</p>`;
    } finally {
        hideLoader();
    }
}

// --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–º–µ–Ω—ã –∫–æ–º–ø–∞–Ω–∏–∏ ---
async function fetchActiveShiftsForCompany() {
    try {
        const response = await apiFetch('/api/shifts/all_active');
        return response || [];
    } catch (e) {
        // –õ–æ–≤–∏–º 404, –µ—Å–ª–∏ —Ä–æ—É—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
        if (e.message && e.message.includes('404')) return [];
        console.error("[Shift Status] Failed to fetch all active shifts:", e);
        return []; 
    }
}

// --- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–ª—É—à–∞—Ç–µ–ª–µ–π –∫ –∫–Ω–æ–ø–∫–∞–º –†–µ–¥–∞–∫—Ç/–£–¥–∞–ª–∏—Ç—å –≤ —Å–ø–∏—Å–∫–µ —Ñ–∏–ª–∏–∞–ª–æ–≤ ---
// –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ü–û–°–õ–ï —Ç–æ–≥–æ, –∫–∞–∫ fetchAndRenderLocations —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª HTML —Å–ø–∏—Å–∫–∞
function addLocationActionListeners() {
     const listDiv = document.getElementById('locations-list');
     if (!listDiv) return;

     // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
     listDiv.querySelectorAll('.edit-location-btn').forEach(btn => {
          // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Å–ª—É—à–∞—Ç–µ–ª—å (–µ—Å–ª–∏ –±—ã–ª) —á–µ—Ä–µ–∑ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
          const newBtn = btn.cloneNode(true);
          btn.parentNode.replaceChild(newBtn, btn);
          // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π
          newBtn.addEventListener('click', (e) => {
               console.log("[Action] Edit location button clicked");
               try {
                    const locationData = JSON.parse(e.currentTarget.dataset.locationJson);
                    openLocationModal(locationData); // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É —Å –¥–∞–Ω–Ω—ã–º–∏
               } catch (err) {
                    console.error("Error parsing location data for edit:", err);
                    alert("–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —Ñ–∏–ª–∏–∞–ª–∞.");
               }
          });
     });

      // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
     listDiv.querySelectorAll('.delete-location-btn').forEach(btn => {
           const newBtn = btn.cloneNode(true);
           btn.parentNode.replaceChild(newBtn, btn);
           newBtn.addEventListener('click', (e) => {
                console.log("[Action] Delete location button clicked");
                const locationId = e.currentTarget.dataset.locationId;
                const locationName = e.currentTarget.dataset.locationName;
                if (confirm(`–£–¥–∞–ª–∏—Ç—å —Ñ–∏–ª–∏–∞–ª "${locationName}"?\n\n–í–ù–ò–ú–ê–ù–ò–ï: –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –∫ —ç—Ç–æ–º—É —Ñ–∏–ª–∏–∞–ª—É, –æ—Å—Ç–∞–Ω—É—Ç—Å—è –±–µ–∑ —Ñ–∏–ª–∏–∞–ª–∞!`)) {
                     handleDeleteLocation(locationId, locationName); // –í—ã–∑—ã–≤–∞–µ–º —É–¥–∞–ª–µ–Ω–∏–µ
                }
           });
     });
     console.log("[Listeners OK] Added action listeners to location list buttons.");
}


// --- –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –§–∏–ª–∏–∞–ª–∞ (–¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è) ---
// index.html (–ü–û–õ–ù–û–°–¢–¨–Æ –ó–ê–ú–ï–ù–Ø–ï–¢ openLocationModal)

function openLocationModal(locationData = null) {
    console.log("[Modal] openLocationModal: Start", locationData);
    const modal = document.getElementById('location-modal');
    if (!modal) return console.error("!!! openLocationModal: Modal element #location-modal not found!");
    const modalContent = modal.querySelector('.modal-content');
    if (!modalContent) return console.error("!!! openLocationModal: Modal content not found!");

    const isEdit = locationData !== null;

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –¥–ª—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    modalContent.innerHTML = `
        <div class="flex justify-between items-start mb-4">
            <h3 class="text-2xl font-bold">${isEdit ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –§–∏–ª–∏–∞–ª' : '–î–æ–±–∞–≤–∏—Ç—å –ù–æ–≤—ã–π –§–∏–ª–∏–∞–ª'}</h3>
            <button onclick="closeModal('location-modal')" class="text-2xl font-bold leading-none p-1 -m-1">&times;</button>
        </div>
        <form id="location-form" data-location-id="${isEdit ? locationData.id : ''}" class="space-y-4">
            
            <div>
                <label for="location-name" class="block text-sm font-medium text-gray-700">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                <input type="text" id="location-name" class="mt-1 w-full p-2 border rounded" required 
                       value="${isEdit && locationData.name ? locationData.name : ''}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–∫–ª–∞–¥ –î–æ—Ä–¥–æ–π, –û—Ñ–∏—Å –¶–µ–Ω—Ç—Ä">
            </div>
            <div>
                <label for="location-address" class="block text-sm font-medium text-gray-700">–ê–¥—Ä–µ—Å</label>
                <input type="text" id="location-address" class="mt-1 w-full p-2 border rounded" 
                       value="${isEdit && locationData.address ? locationData.address : ''}" placeholder="–ì–æ—Ä–æ–¥, —É–ª–∏—Ü–∞, –¥–æ–º">
            </div>

            <div class="border-t pt-4">
                <label for="location-phone" class="block text-sm font-medium text-gray-700">–¢–µ–ª–µ—Ñ–æ–Ω —Ñ–∏–ª–∏–∞–ª–∞</label>
                <input type="text" id="location-phone" class="mt-1 w-full p-2 border rounded" 
                       value="${isEdit && locationData.phone ? locationData.phone : ''}" placeholder="+996 555 123456">
            </div>
            <div>
                <label for="location-whatsapp" class="block text-sm font-medium text-gray-700">–°—Å—ã–ª–∫–∞ WhatsApp</label>
                <input type="text" id="location-whatsapp" class="mt-1 w-full p-2 border rounded" 
                       value="${isEdit && locationData.whatsapp_link ? locationData.whatsapp_link : ''}" placeholder="https://wa.me/996555123456">
            </div>
            <div>
                <label for="location-instagram" class="block text-sm font-medium text-gray-700">–°—Å—ã–ª–∫–∞ Instagram</label>
                <input type="text" id="location-instagram" class="mt-1 w-full p-2 border rounded" 
                       value="${isEdit && locationData.instagram_link ? locationData.instagram_link : ''}" placeholder="https://instagram.com/...">
            </div>
            <div>
                <label for="location-map" class="block text-sm font-medium text-gray-700">–°—Å—ã–ª–∫–∞ –Ω–∞ –ö–∞—Ä—Ç—É (2GIS, Google)</label>
                <input type="text" id="location-map" class="mt-1 w-full p-2 border rounded" 
                       value="${isEdit && locationData.map_link ? locationData.map_link : ''}" placeholder="https://go.2gis.com/...">
            </div>
            <div>
                <label for="location-schedule" class="block text-sm font-medium text-gray-700">–ì—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã —Ñ–∏–ª–∏–∞–ª–∞</label>
                <input type="text" id="location-schedule" class="mt-1 w-full p-2 border rounded" 
                       value="${isEdit && locationData.schedule ? locationData.schedule : ''}" placeholder="–ù–∞–ø—Ä. –ü–Ω-–ü—Ç 9:00-18:00">
            </div>
            <div class="flex gap-4 mt-6 border-t pt-4">
                <button type="button" onclick="closeModal('location-modal')" class="w-full bg-gray-200 py-2 rounded hover:bg-gray-300 text-gray-800">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </form>
    `;

    // --- –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å submit –∫ –¢–û–õ–¨–ö–û –ß–¢–û —Å–æ–∑–¥–∞–Ω–Ω–æ–π —Ñ–æ—Ä–º–µ ---
    const formElement = document.getElementById('location-form');
    if (formElement) {
        const newFormElement = formElement.cloneNode(true);
        formElement.parentNode.replaceChild(newFormElement, formElement);
        newFormElement.addEventListener('submit', handleSaveLocation);
        console.log("[Modal Listener OK] Added submit to #location-form");
    } else {
        console.error("!!! openLocationModal: Form #location-form NOT FOUND after innerHTML!");
    }
    // --- –ö–æ–Ω–µ—Ü –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–ª—É—à–∞—Ç–µ–ª—è ---

    openModal('location-modal'); // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    console.log("[Modal] openLocationModal: End");
}

// --- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –§–∏–ª–∏–∞–ª–∞ (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞) ---
// index.html (–ü–û–õ–ù–û–°–¢–¨–Æ –ó–ê–ú–ï–ù–Ø–ï–¢ handleSaveLocation)

async function handleSaveLocation(e) {
    e.preventDefault(); 
    console.log("[Save] handleSaveLocation: Start");
    showLoader(); 

    const form = e.target;
    const locationId = form.dataset.locationId;
    const isEdit = !!locationId; 
    
    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º /api/locations
    const url = isEdit ? `/api/locations/${locationId}` : '/api/locations'; 
    const method = isEdit ? 'PATCH' : 'POST'; 

    // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã
    const payload = {
        name: document.getElementById('location-name')?.value.trim(),
        address: document.getElementById('location-address')?.value.trim() || null,
        // --- –ù–û–í–´–ï –ü–û–õ–Ø ---
        phone: document.getElementById('location-phone')?.value.trim() || null,
        whatsapp_link: document.getElementById('location-whatsapp')?.value.trim() || null,
        instagram_link: document.getElementById('location-instagram')?.value.trim() || null,
        map_link: document.getElementById('location-map')?.value.trim() || null,
        schedule: document.getElementById('location-schedule')?.value.trim() || null // <-- –î–û–ë–ê–í–õ–ï–ù–û
        // --- –ö–û–ù–ï–¶ –ù–û–í–´–• –ü–û–õ–ï–ô ---
    };

    if (!payload.name) {
         hideLoader();
         alert("–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∏–ª–∏–∞–ª–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.");
         return; 
     }

    try {
        console.log(`[Save] handleSaveLocation: Sending ${method} to ${url}`, payload);
        
        // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º apiFetch
        const result = await apiFetch(url, { 
            method: method, 
            body: JSON.stringify(payload) 
        });
        
        console.log("[Save] handleSaveLocation: Server response", result);
        alert(isEdit ? '–î–∞–Ω–Ω—ã–µ —Ñ–∏–ª–∏–∞–ª–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!' : '–ù–æ–≤—ã–π —Ñ–∏–ª–∏–∞–ª —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!');
        closeModal('location-modal'); 
        
        // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à companyLocations
        companyLocations = await apiFetch('/api/locations'); 
        
        await fetchAndRenderLocations(); 

    } catch(err) { 
        console.error("[Save] handleSaveLocation: Error", err);
        alert(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ñ–∏–ª–∏–∞–ª–∞: ${err.message}`);
    } finally {
        hideLoader();
        console.log("[Save] handleSaveLocation: End");
    }
}

// --- –£–¥–∞–ª–µ–Ω–∏–µ –§–∏–ª–∏–∞–ª–∞ ---
async function handleDeleteLocation(locationId, locationName) {
    console.log(`[Delete] handleDeleteLocation: Start deleting ID ${locationId} (${locationName})`);
    
    // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ñ–∏–ª–∏–∞–ª "${locationName}"?\n\n–í–ù–ò–ú–ê–ù–ò–ï: –£–¥–∞–ª–µ–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫ —Ñ–∏–ª–∏–∞–ª—É –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏, —Å–º–µ–Ω—ã –∏–ª–∏ –∑–∞–∫–∞–∑—ã.`)) {
         alert("–£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.");
         return;
    }
    
    showLoader();
    try {
        // –í—ã–∑—ã–≤–∞–µ–º –Ω–æ–≤—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç
        await apiFetch(`/api/locations/${locationId}`, { method: 'DELETE' });
        
        console.log(`[Delete] handleDeleteLocation: –§–∏–ª–∏–∞–ª ${locationName} (ID: ${locationId}) —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω.`);
        alert(`–§–∏–ª–∏–∞–ª "${locationName}" —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω.`);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –∏ —Å–ø–∏—Å–æ–∫
        companyLocations = companyLocations.filter(loc => loc.id != locationId);
        await fetchAndRenderLocations(); 

    } catch(err) { // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –æ—Ç apiFetch (–≤–∫–ª—é—á–∞—è 400 Bad Request, –µ—Å–ª–∏ –µ—Å—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏)
        console.error("[Delete] handleDeleteLocation: Error", err);
        alert(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∏–ª–∏–∞–ª–∞ "${locationName}": ${err.message}`);
    } finally {
        hideLoader(); // –°–∫—Ä—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
        console.log("[Delete] handleDeleteLocation: End");
    }
}

// index.html (–í–Ω—É—Ç—Ä–∏ –ú–û–î–£–õ–¨: –§–ò–õ–ò–ê–õ–´)

// --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–µ "–û—Ç–∫—Ä—ã—Ç—å/–ó–∞–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É" ---
async function handleShiftToggle(e) {
    const btn = e.target.closest('.toggle-shift-btn');
    if (!btn) return;
    
    const isActive = btn.dataset.isActive === 'true'; // –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å —Å–º–µ–Ω—ã
    const locationId = btn.dataset.locationId; // ID —Ñ–∏–ª–∏–∞–ª–∞, –≥–¥–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –¥–µ–π—Å—Ç–≤–∏–µ
    const shiftId = btn.dataset.shiftId; // ID —Å–º–µ–Ω—ã (–µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞)
    
    if (isActive) {
        // –°–ú–ï–ù–ê –û–¢–ö–†–´–¢–ê -> –í–ª–∞–¥–µ–ª–µ—Ü –¥–æ–ª–∂–µ–Ω –µ–µ –∑–∞–∫—Ä—ã—Ç—å
        await handleForcedCloseShift(shiftId, locationId);
    } else {
        // –°–ú–ï–ù–ê –ó–ê–ö–†–´–¢–ê -> –í–ª–∞–¥–µ–ª–µ—Ü –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –Ω–æ–≤—É—é —Å–º–µ–Ω—É
        await showOpenShiftScreen(locationId);
    }
}

// --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —Å–º–µ–Ω—ã –í–ª–∞–¥–µ–ª—å—Ü–µ–º ---
async function handleForcedCloseShift(shiftId, locationId) {
    if (!shiftId) return alert("–û—à–∏–±–∫–∞: ID —Å–º–µ–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω.");
    
    // –í–ª–∞–¥–µ–ª–µ—Ü –¥–æ–ª–∂–µ–Ω –∑–Ω–∞—Ç—å —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –æ—Å—Ç–∞—Ç–æ–∫ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è 
    const closingCashStr = prompt(`–í–≤–µ–¥–∏—Ç–µ –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É –Ω–∞–ª–∏—á–Ω—ã—Ö –≤ –∫–∞—Å—Å–µ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è —Å–º–µ–Ω—ã #${shiftId} (—Ñ–∏–ª–∏–∞–ª ID ${locationId}):`);
    
    if (closingCashStr === null || closingCashStr === '') {
        alert("–ó–∞–∫—Ä—ã—Ç–∏–µ —Å–º–µ–Ω—ã –æ—Ç–º–µ–Ω–µ–Ω–æ.");
        return;
    }
    const closingCash = parseFloat(closingCashStr);
    if (isNaN(closingCash) || closingCash < 0) {
        alert("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—É–º–º–∞. –ó–∞–∫—Ä—ã—Ç–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.");
        return;
    }

    const password = prompt("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –ø–∞—Ä–æ–ª—å –í–ª–∞–¥–µ–ª—å—Ü–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è:");
    if (!password) return alert("–ó–∞–∫—Ä—ã—Ç–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.");
    
    showLoader();
    try {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è
        await apiFetch(`/api/shifts/${shiftId}/force_close`, {
            method: 'POST',
            body: JSON.stringify({ closing_cash: closingCash, password: password })
        });
        
        alert(`–°–º–µ–Ω–∞ #${shiftId} —É—Å–ø–µ—à–Ω–æ –∑–∞–∫—Ä—ã—Ç–∞!`);
        await fetchAndRenderLocations(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∏–ª–∏–∞–ª–æ–≤
        
    } catch (err) {
        alert(`–û—à–∏–±–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Å–º–µ–Ω—ã: ${err.message}`);
    } finally {
        hideLoader();
    }
}

// --- –ò–ó–ú–ï–ù–ï–ù–ò–ï –°–£–©–ï–°–¢–í–£–Æ–©–ï–ô –§–£–ù–ö–¶–ò–ò: –ü—Ä–∏–≤—è–∑–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª—è ---
function addLocationActionListeners() {
    // ... (–∫–æ–¥ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è)
    
    // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –æ—Ç–∫—Ä—ã—Ç–∏—è/–∑–∞–∫—Ä—ã—Ç–∏—è —Å–º–µ–Ω—ã
    listDiv.querySelectorAll('.toggle-shift-btn').forEach(btn => {
         const newBtn = btn.cloneNode(true);
         btn.parentNode.replaceChild(newBtn, btn);
         // !!! –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–ò–í–Ø–ó–ö–ê !!!
         newBtn.addEventListener('click', handleShiftToggle); 
    });
    console.log("[Listeners OK] Added action listeners to location list buttons.");
}

// –¢–µ–ø–µ—Ä—å –≤–∞–º –Ω—É–∂–Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ handleOpenShiftSubmit (–≤ –º–æ–¥–∞–ª–∫–µ) –º–æ–∂–µ—Ç –ø—Ä–∏–Ω—è—Ç—å locationId 
// –∏ –≤—ã–∑–≤–∞—Ç—å open_shift –Ω–∞ –±—ç–∫–µ–Ω–¥–µ.
// –≠—Ç—É —á–∞—Å—Ç—å –º—ã —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞–ª–∏ –≤ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —à–∞–≥–∞—Ö, –æ–Ω–∞ –¥–æ–ª–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç—å —Å locationId.

// =================================================================
// –ú–û–î–£–õ–¨: –ü–ï–†–°–û–ù–ê–õ (–í–ª–∞–¥–µ–ª–µ—Ü) (v4.1 - Rebuild)
// =================================================================

// --- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≤–∫–ª–∞–¥–∫–∏ "–ü–µ—Ä—Å–æ–Ω–∞–ª" ---
// –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ initializeMainAppUI, –µ—Å–ª–∏ —É –í–ª–∞–¥–µ–ª—å—Ü–∞ –µ—Å—Ç—å –ø—Ä–∞–≤–∞ 'manage_employees'
async function renderEmployeesTab() {
    console.log("[Render] renderEmployeesTab: Start");
    const pane = document.getElementById('tab-employees');
    if (!pane) {
        console.warn("[Render] renderEmployeesTab: Pane #tab-employees not found.");
        return;
    }

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π HTML –¥–ª—è –≤–∫–ª–∞–¥–∫–∏
    pane.innerHTML = `
        <div class="bg-white p-6 rounded-lg shadow-md border">
            <div class="flex flex-wrap justify-between items-center gap-4 mb-4 border-b pb-4">
                <h2 class="text-2xl font-bold text-gray-800">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ü–µ—Ä—Å–æ–Ω–∞–ª–æ–º</h2>
                <button id="add-employee-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 text-sm">‚ûï –î–æ–±–∞–≤–∏—Ç—å –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</button>
            </div>
            <div id="employees-list" class="space-y-3">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤...</div>
        </div>
    `;

    // --- –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏ –∫ —ç–ª–µ–º–µ–Ω—Ç–∞–º, —Å–æ–∑–¥–∞–Ω–Ω—ã–º –í–´–®–ï ---
    const addBtn = document.getElementById('add-employee-btn');
    const employeeListDiv = document.getElementById('employees-list');

    // –ö–Ω–æ–ø–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∞"
    if (addBtn) {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º replaceWith(cloneNode) –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö —Å–ª—É—à–∞—Ç–µ–ª–µ–π –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ
        const newAddBtn = addBtn.cloneNode(true);
        addBtn.parentNode?.replaceChild(newAddBtn, addBtn);
        newAddBtn.addEventListener('click', () => openEmployeeModal()); // –î–æ–±–∞–≤–ª—è–µ–º –∫ –Ω–æ–≤–æ–π –∫–Ω–æ–ø–∫–µ
        console.log("[Listener OK] Added click to #add-employee-btn");
    } else {
        console.error("!!! renderEmployeesTab: Element #add-employee-btn NOT FOUND after innerHTML.");
    }

    // –°–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ (–¥–ª—è –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∫–ª–∏–∫–æ–≤ –ø–æ –∫–Ω–æ–ø–∫–∞–º –†–µ–¥–∞–∫—Ç/–£–≤–æ–ª–∏—Ç—å/–£–¥–∞–ª–∏—Ç—å)
    if (employeeListDiv) {
         const newEmployeeListDiv = employeeListDiv.cloneNode(false); // –ö–ª–æ–Ω–∏—Ä—É–µ–º –ø—É—Å—Ç–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
         employeeListDiv.parentNode?.replaceChild(newEmployeeListDiv, employeeListDiv); // –ó–∞–º–µ–Ω—è–µ–º —Å—Ç–∞—Ä—ã–π
         newEmployeeListDiv.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤...'; // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É
         // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –∫ –ù–û–í–û–ú–£ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É
         newEmployeeListDiv.addEventListener('click', handleEmployeeActions);
         console.log("[Listener OK] Added click delegate listener to #employees-list");
    } else {
         console.error("!!! renderEmployeesTab: Element #employees-list NOT FOUND after innerHTML.");
    }
    // --- –ö–æ–Ω–µ—Ü –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–ª—É—à–∞—Ç–µ–ª–µ–π ---

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    await fetchAndRenderEmployees();
    console.log("[Render] renderEmployeesTab: End");
}

async function fetchAndRenderEmployees() {
    console.log("[Fetch] fetchAndRenderEmployees: Start");
    const listDiv = document.getElementById('employees-list'); // –ò—â–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    if (!listDiv) return console.error("!!! fetchAndRenderEmployees: listDiv #employees-list not found!");
    listDiv.innerHTML = '<p class="text-gray-500 animate-pulse">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤...</p>';
    showLoader(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä

    try {
        // --- –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –†–æ–ª–µ–π –∏ –§–∏–ª–∏–∞–ª–æ–≤ (–µ—Å–ª–∏ –Ω—É–∂–Ω—ã –∏ –∫—ç—à –ø—É—Å—Ç) ---
        if (!currentUser.is_super_admin) {
             if (!companyLocations || companyLocations.length === 0 || !companyRoles || companyRoles.length === 0) {
                 console.log("[Fetch] fetchAndRenderEmployees: Preloading locations and roles...");
                 const results = await Promise.allSettled([
                     // –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 1: –î–û–ë–ê–í–õ–ï–ù /api
                     (!companyLocations || companyLocations.length === 0) ? apiFetch('/api/locations') : Promise.resolve(companyLocations),
                     // –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 2: –î–û–ë–ê–í–õ–ï–ù /api
                     (!companyRoles || companyRoles.length === 0) ? apiFetch('/api/roles') : Promise.resolve(companyRoles)
                 ]);
                 if (results[0].status === 'fulfilled') companyLocations = results[0].value; else console.warn("Failed to preload locations:", results[0].reason);
                 if (results[1].status === 'fulfilled') companyRoles = results[1].value; else console.warn("Failed to preload roles:", results[1].reason);
                 console.log("[Fetch] fetchAndRenderEmployees: Locations and roles loaded/updated.");
             } else {
                 console.log("[Fetch] fetchAndRenderEmployees: Using cached locations and roles.");
             }
        } else { // –î–ª—è SuperAdmin —ç—Ç–∏ –∫—ç—à–∏ –Ω–µ –Ω—É–∂–Ω—ã
             companyLocations = []; companyRoles = [];
        }

        // --- –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ ---
        console.log("[Fetch] fetchAndRenderEmployees: Fetching employees list...");
        // –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 3: –î–û–ë–ê–í–õ–ï–ù /api
        const employees = await apiFetch('/api/employees'); 
        console.log("[Fetch] fetchAndRenderEmployees: Received employees:", employees);

        // --- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–ø–∏—Å–∫–∞ ---
        if (!employees || employees.length === 0) {
            listDiv.innerHTML = '<p class="text-gray-500">–£ –≤–∞—à–µ–π –∫–æ–º–ø–∞–Ω–∏–∏ –µ—â–µ –Ω–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ (–∫—Ä–æ–º–µ –í–ª–∞–¥–µ–ª—å—Ü–∞).</p>';
        } else {
            listDiv.innerHTML = employees.map(emp => {
                // –ò—â–µ–º –∏–º—è —Ä–æ–ª–∏ –≤ –∫—ç—à–µ companyRoles (–∏—Å–ø–æ–ª—å–∑—É–µ–º Optional Chaining `?.`)
                const roleName = companyRoles.find(r => r.id === emp.role_id)?.name || emp.role?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Ä–æ–ª—å';
                // –ò—â–µ–º –∏–º—è —Ñ–∏–ª–∏–∞–ª–∞ –≤ –∫—ç—à–µ companyLocations
                const locationName = companyLocations.find(loc => loc.id === emp.location_id)?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–∏–ª–∏–∞–ª';

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const canManage = currentUser.permissions?.includes('manage_employees');
                const isOwnerRole = roleName === '–í–ª–∞–¥–µ–ª–µ—Ü'; // –ù–µ–ª—å–∑—è —É–≤–æ–ª–∏—Ç—å/—É–¥–∞–ª–∏—Ç—å –í–ª–∞–¥–µ–ª—å—Ü–∞

                return `
                 <div class="p-3 ${emp.is_active ? 'bg-gray-50' : 'bg-red-50 opacity-70'} rounded-md border flex flex-wrap justify-between items-center gap-2 shadow-sm">
                     <div class="flex-grow min-w-[200px]">
                         <p class="font-bold text-lg text-gray-800">${emp.full_name}</p>
                         <p class="text-sm text-gray-600">${roleName} @ ${locationName}</p>
                         <p class="text-xs font-semibold ${emp.is_active ? 'text-green-600' : 'text-red-600'}">${emp.is_active ? '–ê–ö–¢–ò–í–ï–ù' : '–£–í–û–õ–ï–ù'}</p>
                     </div>
                      <div class="flex-shrink-0 flex gap-2">
                          ${canManage ? `
                              <button data-employee-json='${JSON.stringify(emp)}' class="edit-employee-btn text-sm bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded transition-colors duration-150">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                              ${!isOwnerRole ? `
                              <button data-employee-id="${emp.id}" data-employee-name="${emp.full_name}" data-is-active="${emp.is_active}" class="toggle-status-employee-btn text-sm ${emp.is_active ? 'bg-yellow-200 text-yellow-800 hover:bg-yellow-300' : 'bg-green-200 text-green-800 hover:bg-green-300'} px-3 py-1 rounded transition-colors duration-150">
                                  ${emp.is_active ? '–£–≤–æ–ª–∏—Ç—å' : '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å'}
                              </button>
                              <button data-employee-id="${emp.id}" data-employee-name="${emp.full_name}" class="delete-employee-btn text-sm bg-red-200 hover:bg-red-300 text-red-800 px-3 py-1 rounded transition-colors duration-150" title="–ü–æ–ª–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (–Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ)">–£–¥–∞–ª–∏—Ç—å</button>
                              ` : '<span class="text-xs text-gray-400">(–î–µ–π—Å—Ç–≤–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã)</span>'}
                          ` : ''} 
                      </div>
                 </div>
                `;}).join('');
            // –°–ª—É—à–∞—Ç–µ–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–∞ #employees-list —á–µ—Ä–µ–∑ –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        }
        console.log("[Fetch] fetchAndRenderEmployees: Success");
    } catch (e) {
        console.error("!!! [Fetch] fetchAndRenderEmployees: Error", e);
        listDiv.innerHTML = `<p class="text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: ${e.message}</p>`;
    } finally {
        hideLoader(); // –°–∫—Ä—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
        console.log("[Fetch] fetchAndRenderEmployees: End");
    }
}

// --- –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (–¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è) ---
function openEmployeeModal(employee = null) {
    console.log("[Modal] openEmployeeModal: Start", employee);
    const modal = document.getElementById('employee-modal');
    if (!modal) return console.error("!!! openEmployeeModal: Modal element #employee-modal not found!");
    const modalContent = modal.querySelector('.modal-content');
    if (!modalContent) return console.error("!!! openEmployeeModal: Modal content not found!");

    const isEdit = employee !== null; // true, –µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω—ã –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

    // --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∫—ç—à–µ–π –†–æ–ª–µ–π –∏ –§–∏–ª–∏–∞–ª–æ–≤ ---
    if (!companyLocations || companyLocations.length === 0 || !companyRoles || companyRoles.length === 0) {
        console.error("!!! openEmployeeModal: –ö—ç—à–∏ companyLocations –∏–ª–∏ companyRoles –ø—É—Å—Ç—ã! –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å...");
        // –ü—ã—Ç–∞–µ–º—Å—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏ —Å–Ω–æ–≤–∞ –æ—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É
        // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞—â–∏—Ç—É –æ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ —Ü–∏–∫–ª–∞
        if (!window.openEmployeeModalRetry) {
             window.openEmployeeModalRetry = true; // –°—Ç–∞–≤–∏–º —Ñ–ª–∞–≥
             showLoader();
             Promise.allSettled([apiFetch('/api/locations'), apiFetch('/api/roles')])
                 .then(results => {
                      if (results[0].status === 'fulfilled') companyLocations = results[0].value;
                      if (results[1].status === 'fulfilled') companyRoles = results[1].value;
                      // –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—ã–∑–æ–≤ –ü–û–°–õ–ï –∑–∞–≥—Ä—É–∑–∫–∏
                      openEmployeeModal(employee);
                 })
                 .catch(err => alert(`–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ñ–æ—Ä–º—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞: ${err.message}`))
                 .finally(() => {
                      hideLoader();
                      delete window.openEmployeeModalRetry; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥
                 });
        } else {
             alert("–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ —Ñ–∏–ª–∏–∞–ª–∞—Ö –∏–ª–∏ –¥–æ–ª–∂–Ω–æ—Å—Ç—è—Ö –¥–∞–∂–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏.");
        }
        return; // –í—ã—Ö–æ–¥–∏–º –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ, –ø–æ–∫–∞ –¥–∞–Ω–Ω—ã–µ –≥—Ä—É–∑—è—Ç—Å—è
    }
    // --- –ö–æ–Ω–µ—Ü –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫—ç—à–µ–π ---

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ–ø—Ü–∏–∏ –¥–ª—è select'–æ–≤, –∏—Å–ø–æ–ª—å–∑—É—è –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∫—ç—à–∏
    const locationsOptions = companyLocations
        .map(loc => `<option value="${loc.id}" ${isEdit && employee.location_id === loc.id ? 'selected' : ''}>${loc.name}</option>`)
        .join('');
    // –ò—Å–∫–ª—é—á–∞–µ–º —Ä–æ–ª—å –í–ª–∞–¥–µ–ª—å—Ü–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
    const rolesOptions = companyRoles
        .filter(role => role.name !== '–í–ª–∞–¥–µ–ª–µ—Ü') // –ù–µ–ª—å–∑—è –Ω–∞–∑–Ω–∞—á–∏—Ç—å/–∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞ –í–ª–∞–¥–µ–ª—å—Ü–∞
        .map(role => `<option value="${role.id}" ${isEdit && employee.role_id === role.id ? 'selected' : ''}>${role.name}</option>`)
        .join('');

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤–æ–æ–±—â–µ —Ä–æ–ª–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ (–∫—Ä–æ–º–µ –í–ª–∞–¥–µ–ª—å—Ü–∞) –ø—Ä–∏ –°–û–ó–î–ê–ù–ò–ò
    if (!rolesOptions && !isEdit) {
         alert("–û—à–∏–±–∫–∞: –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–æ–ª–∂–Ω–æ—Å—Ç–µ–π –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è.\n\n–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –¥–æ–ª–∂–Ω–æ—Å—Ç—å –≤–æ –≤–∫–ª–∞–¥–∫–µ '–î–æ–ª–∂–Ω–æ—Å—Ç–∏ –∏ –î–æ—Å—Ç—É–ø—ã'.");
         return; // –ù–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
    }

    // --- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ ---
    modalContent.innerHTML = `
        <div class="flex justify-between items-start mb-4">
            <h3 class="text-2xl font-bold text-gray-800">${isEdit ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∞' : '–î–æ–±–∞–≤–∏—Ç—å –ù–æ–≤–æ–≥–æ –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∞'}</h3>
            <button onclick="closeModal('employee-modal')" class="text-2xl font-bold leading-none p-1 -m-1 text-gray-500 hover:text-gray-700">&times;</button>
        </div>
        <form id="employee-form" class="space-y-4">
            
            <input type="hidden" id="employee-id" value="${isEdit ? employee.id : ''}">
            
            <div>
                <label for="employee-name" class="block text-sm font-medium text-gray-700">–§–ò–û *</label>
                <input type="text" id="employee-name" class="mt-1 w-full p-2 border rounded focus:ring-indigo-500 focus:border-indigo-500" required value="${isEdit ? employee.full_name : ''}">
            </div>
            
            <div>
                <label for="employee-password" class="block text-sm font-medium text-gray-700">–ü–∞—Ä–æ–ª—å ${isEdit ? '' : '*'}</label>
                <input type="text" id="employee-password" class="mt-1 w-full p-2 border rounded focus:ring-indigo-500 focus:border-indigo-500" ${isEdit ? 'placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å"' : 'required'}>
            </div>
            
            <div>
                <label for="employee-location" class="block text-sm font-medium text-gray-700">–§–∏–ª–∏–∞–ª *</label>
                <select id="employee-location" class="mt-1 w-full p-2 border rounded bg-white focus:ring-indigo-500 focus:border-indigo-500" required ${isEdit && employee.role?.name === '–í–ª–∞–¥–µ–ª–µ—Ü' ? 'disabled title="–§–∏–ª–∏–∞–ª –í–ª–∞–¥–µ–ª—å—Ü–∞ –Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å"' : ''}>
                    ${locationsOptions || '<option disabled>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ñ–∏–ª–∏–∞–ª–æ–≤</option>'}
                </select>
            </div>
            
            <div>
                <label for="employee-role" class="block text-sm font-medium text-gray-700">–î–æ–ª–∂–Ω–æ—Å—Ç—å *</label>
                 ${isEdit && employee.role?.name === '–í–ª–∞–¥–µ–ª–µ—Ü'
                     ? `<input type="text" class="mt-1 w-full p-2 border rounded bg-gray-100 cursor-not-allowed" value="–í–ª–∞–¥–µ–ª–µ—Ü" disabled title="–†–æ–ª—å –í–ª–∞–¥–µ–ª—å—Ü–∞ –Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å">
                        <input type="hidden" id="employee-role" value="${employee.role_id}">` // –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ —Å ID —Ä–æ–ª–∏
                     : `<select id="employee-role" class="mt-1 w-full p-2 border rounded bg-white focus:ring-indigo-500 focus:border-indigo-500" required>${rolesOptions}</select>`
                 }
            </div>
             
             ${isEdit ? `
             <div class="border-t pt-4">
                  <label class="flex items-center">
                     <input type="checkbox" id="employee-is-active-modal" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" ${employee.is_active ? 'checked' : ''}>
                     <span class="ml-2 text-sm font-medium text-gray-700">–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –ê–∫—Ç–∏–≤–µ–Ω (–†–∞–∑—Ä–µ—à–µ–Ω –≤—Ö–æ–¥)</span>
                  </label>
             </div>` : ''}
             
            <div class="flex gap-4 mt-6 border-t pt-4">
                <button type="button" onclick="closeModal('employee-modal')" class="w-full bg-gray-200 py-2 rounded hover:bg-gray-300 text-gray-800">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </form>
    `;

    // --- –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å submit –∫ –¢–û–õ–¨–ö–û –ß–¢–û —Å–æ–∑–¥–∞–Ω–Ω–æ–π —Ñ–æ—Ä–º–µ ---
    const formElement = document.getElementById('employee-form');
    if (formElement) {
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Å–ª—É—à–∞—Ç–µ–ª–∏ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ
        const newFormElement = formElement.cloneNode(true);
        formElement.parentNode.replaceChild(newFormElement, formElement);
        newFormElement.addEventListener('submit', handleSaveEmployee);
        console.log("[Modal Listener OK] Added submit to #employee-form");
    } else {
        console.error("!!! openEmployeeModal: Form #employee-form NOT FOUND after innerHTML!");
    }
    // --- –ö–æ–Ω–µ—Ü –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–ª—É—à–∞—Ç–µ–ª—è ---

    openModal('employee-modal'); // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    console.log("[Modal] openEmployeeModal: End");
}


// --- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞) ---
async function handleSaveEmployee(e) {
    e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É
    console.log("[Save] handleSaveEmployee: Start");
    showLoader(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä

    // –°—á–∏—Ç—ã–≤–∞–µ–º ID (–¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ - —Å–æ–∑–¥–∞–Ω–∏–µ/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
    const employeeId = document.getElementById('employee-id')?.value;
    const isEdit = !!employeeId; // true, –µ—Å–ª–∏ ID –µ—Å—Ç—å
    
    // !!! –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–û–ë–ê–í–õ–ï–ù–ò–ï –ü–†–ï–§–ò–ö–°–ê /api !!!
    const url = isEdit ? `/api/employees/${employeeId}` : '/api/employees'; 
    const method = isEdit ? 'PATCH' : 'POST'; 

    // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã
    let payload = {
        full_name: document.getElementById('employee-name')?.value.trim(),
        location_id: parseInt(document.getElementById('employee-location')?.value),
        role_id: parseInt(document.getElementById('employee-role')?.value)
    };
    const password = document.getElementById('employee-password')?.value;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–æ–ª—å, –µ—Å–ª–∏ –æ–Ω –≤–≤–µ–¥–µ–Ω –ò–õ–ò –µ—Å–ª–∏ —ç—Ç–æ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
    if (password || !isEdit) {
        payload.password = password; 
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ (–µ—Å–ª–∏ —á–µ–∫–±–æ–∫—Å –µ—Å—Ç—å)
    if (isEdit) {
        const activeCheckbox = document.getElementById('employee-is-active-modal');
        if (activeCheckbox) payload.is_active = activeCheckbox.checked;
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è: –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
    if (!payload.full_name || isNaN(payload.location_id) || isNaN(payload.role_id) || (!payload.password && !isEdit)) {
        hideLoader();
        alert("–û—à–∏–±–∫–∞: –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (*): –§–ò–û, –ü–∞—Ä–æ–ª—å (–ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏), –§–∏–ª–∏–∞–ª, –î–æ–ª–∂–Ω–æ—Å—Ç—å.");
        console.error("[Save] handleSaveEmployee: Validation failed. Payload:", payload, "isEdit:", isEdit);
        return; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
    }

    try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        console.log(`[Save] handleSaveEmployee: Sending ${method} to ${url}`, payload);
        const result = await apiFetch(url, { method: method, body: JSON.stringify(payload) });
        console.log("[Save] handleSaveEmployee: Server response", result);

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—Ö–∞
        alert(isEdit ? '–î–∞–Ω–Ω—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!' : '–ù–æ–≤—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!');
        closeModal('employee-modal'); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        await fetchAndRenderEmployees(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ

    } catch(err) { // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (–æ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏–ª–∏ –æ—Ç apiFetch)
        console.error("!!! [Save] handleSaveEmployee: Error", err);
        alert(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞: ${err.message}`);
        // –û—Å—Ç–∞–≤–ª—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–∫—Ä—ã—Ç—ã–º –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    } finally {
        // --- –°–∫—Ä—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ ---
        hideLoader();
        console.log("[Save] handleSaveEmployee: End");
    }
}

// --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –≤ —Å–ø–∏—Å–∫–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ (–¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ) ---
// –í—ã–∑—ã–≤–∞–µ—Ç—Å—è —Å–ª—É—à–∞—Ç–µ–ª–µ–º, –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–º –≤ renderEmployeesTab
function handleEmployeeActions(e) {
    // –ò—â–µ–º –±–ª–∏–∂–∞–π—à—É—é –∫–Ω–æ–ø–∫—É –∫ –º–µ—Å—Ç—É –∫–ª–∏–∫–∞
    const editButton = e.target.closest('.edit-employee-btn');
    const toggleStatusButton = e.target.closest('.toggle-status-employee-btn');
    const deleteButton = e.target.closest('.delete-employee-btn');

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
    if (editButton) {
        console.log("[Action] Edit employee button clicked");
        try {
            // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–∞
            const employeeData = JSON.parse(editButton.dataset.employeeJson);
            // –ü—ã—Ç–∞–µ–º—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–º–∏ —Ä–æ–ª–∏ –∏–∑ –∫—ç—à–∞ (–¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –º–æ–¥–∞–ª–∫–µ)
            employeeData.role = companyRoles.find(r => r.id === employeeData.role_id);
            if (!employeeData.role) console.warn("[Action] Role details not found in cache for employee:", employeeData);
            openEmployeeModal(employeeData); // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        } catch (err) {
            console.error("!!! [Action] Error parsing employee data for edit:", err);
            alert("–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.");
        }
        return; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º, —á—Ç–æ–±—ã –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∏ –¥—Ä—É–≥–∏–µ –∫–Ω–æ–ø–∫–∏
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ –£–≤–æ–ª–∏—Ç—å/–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
    if (toggleStatusButton) {
        console.log("[Action] Toggle status employee button clicked");
        const employeeId = toggleStatusButton.dataset.employeeId;
        const employeeName = toggleStatusButton.dataset.employeeName;
        const isActive = toggleStatusButton.dataset.isActive === 'true'; // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç—Ä–æ–∫—É –≤ boolean
        const actionText = isActive ? '–£–≤–æ–ª–∏—Ç—å' : '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
        if (confirm(`${actionText} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ "${employeeName}"?`)) {
            handleToggleEmployeeStatus(employeeId, !isActive); // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é —Å–º–µ–Ω—ã —Å—Ç–∞—Ç—É—Å–∞
        }
        return; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ –ü–æ–ª–Ω–æ–µ –£–¥–∞–ª–µ–Ω–∏–µ
    if (deleteButton) {
        console.log("[Action] Delete employee button clicked");
        const employeeId = deleteButton.dataset.employeeId;
        const employeeName = deleteButton.dataset.employeeName;
         // –î–≤–æ–π–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–ª—è –æ–ø–∞—Å–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏
        if (confirm(`–í–ù–ò–ú–ê–ù–ò–ï!\n\n–í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å –ü–û–õ–ù–û–°–¢–¨–Æ –£–î–ê–õ–ò–¢–¨ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ "${employeeName}"?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ —É–¥–∞–ª–∏—Ç –µ–≥–æ —Å–º–µ–Ω—ã, —Ä–∞—Å—Ö–æ–¥—ã –∏ –æ—Ç–≤—è–∂–µ—Ç –æ—Ç –≤—ã–¥–∞–Ω–Ω—ã—Ö –∏–º –∑–∞–∫–∞–∑–æ–≤.\n\n–î–ï–ô–°–¢–í–ò–ï –ù–ï–û–ë–†–ê–¢–ò–ú–û!`)) {
             if (confirm(`–ü–û–°–õ–ï–î–ù–ï–ï –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï:\n\n–¢–û–ß–ù–û –£–î–ê–õ–ò–¢–¨ "${employeeName}"?`)){
                  handleDeleteEmployee(employeeId, employeeName); // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é —É–¥–∞–ª–µ–Ω–∏—è
             }
        }
        return; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º
    }
}

// --- –°–º–µ–Ω–∞ —Å—Ç–∞—Ç—É—Å–∞ (–£–≤–æ–ª–∏—Ç—å/–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å) —á–µ—Ä–µ–∑ API ---
async function handleToggleEmployeeStatus(employeeId, newStatus /* true or false */) {
     const actionText = newStatus ? '–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' : '—É–≤–æ–ª–µ–Ω';
     console.log(`[Action] handleToggleEmployeeStatus: Setting status ${newStatus} for employee ID ${employeeId}`);
     showLoader(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
     try {
         // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º PATCH –∑–∞–ø—Ä–æ—Å —Ç–æ–ª—å–∫–æ —Å –ø–æ–ª–µ–º is_active
         await apiFetch(`/api/employees/${employeeId}`, {
              method: 'PATCH',
              body: JSON.stringify({ is_active: newStatus })
         });
         console.log(`[Action] handleToggleEmployeeStatus: Success for employee ID ${employeeId}`);
         alert(`–°–æ—Ç—Ä—É–¥–Ω–∏–∫ "${actionText}".`); // –ö—Ä–∞—Ç–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
         await fetchAndRenderEmployees(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
     } catch (err) { // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –æ—Ç apiFetch
          console.error("!!! [Action] handleToggleEmployeeStatus: Error", err);
          alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ ${actionText.slice(0,-1)}–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞: ${err.message}`);
     } finally {
          hideLoader(); // –°–∫—Ä—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
          console.log(`[Action] handleToggleEmployeeStatus: End for employee ID ${employeeId}`);
     }
}

// --- –ü–æ–ª–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ —á–µ—Ä–µ–∑ API ---
async function handleDeleteEmployee(employeeId, employeeName) {
     console.log(`[Delete] handleDeleteEmployee: Start deleting ID ${employeeId} (${employeeName})`);
     
     // –î–≤–æ–π–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–∂–µ –µ—Å—Ç—å –≤ handleEmployeeActions, –Ω–æ –æ—Å—Ç–∞–≤–∏–º –∏ –∑–¥–µ—Å—å
     if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ü–û–õ–ù–û–°–¢–¨–Æ —É–¥–∞–ª–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ "${employeeName}" (ID: ${employeeId})?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ. –°–º–µ–Ω—ã, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –∫ –Ω–µ–º—É, –º–æ–≥—É—Ç –≤—ã–∑–≤–∞—Ç—å –æ—à–∏–±–∫—É (–µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å).`)) {
         alert("–£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.");
         return;
     }

     showLoader(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
     try {
         // –í—ã–∑—ã–≤–∞–µ–º –Ω–æ–≤—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç DELETE
         console.log(`[Delete] Sending DELETE request for employee ID ${employeeId}`);
         await apiFetch(`/api/employees/${employeeId}`, { method: 'DELETE' });
         
         console.log(`[Delete] handleDeleteEmployee: Employee ID ${employeeId} deleted successfully.`);
         alert(`–°–æ—Ç—Ä—É–¥–Ω–∏–∫ "${employeeName}" —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω.`);
         
         await fetchAndRenderEmployees(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤

     } catch (err) { // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –æ—Ç apiFetch (–≤–∫–ª—é—á–∞—è 400 Bad Request, –µ—Å–ª–∏ –µ—Å—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏)
          console.error("!!! [Delete] handleDeleteEmployee: Error", err);
          alert(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ "${employeeName}": ${err.message}`);
     } finally {
          hideLoader(); // –°–∫—Ä—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
          console.log("[Delete] handleDeleteEmployee: End");
     }
}

// === –ö–û–ù–ï–¶ –ú–û–î–£–õ–Ø –ü–ï–†–°–û–ù–ê–õ ===

// =================================================================
// –ú–û–î–£–õ–¨: –†–û–õ–ò –ò –î–û–°–¢–£–ü–´ (–í–ª–∞–¥–µ–ª–µ—Ü) (v4.1 - Rebuild)
// =================================================================

// --- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≤–∫–ª–∞–¥–∫–∏ "–î–æ–ª–∂–Ω–æ—Å—Ç–∏ –∏ –î–æ—Å—Ç—É–ø—ã" ---
// –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ initializeMainAppUI, –µ—Å–ª–∏ —É –í–ª–∞–¥–µ–ª—å—Ü–∞ –µ—Å—Ç—å –ø—Ä–∞–≤–∞ 'manage_roles'
async function renderRolesTab() {
    console.log("[Render] renderRolesTab: Start");
    const pane = document.getElementById('tab-roles');
    if (!pane) {
        console.warn("[Render] renderRolesTab: Pane #tab-roles not found.");
        return; // –í—ã—Ö–æ–¥–∏–º, –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–∫–ª–∞–¥–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω
    }

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π HTML –¥–ª—è –≤–∫–ª–∞–¥–∫–∏
    pane.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="md:col-span-1">
                <div class="bg-white p-6 rounded-lg shadow-md h-fit">
                    <h2 class="text-xl font-semibold mb-4">–î–æ–±–∞–≤–∏—Ç—å –ù–æ–≤—É—é –î–æ–ª–∂–Ω–æ—Å—Ç—å</h2>
                    <form id="add-role-form" class="space-y-3">
                        <label for="new-role-name" class="block text-sm font-medium text-gray-700">–ù–∞–∑–≤–∞–Ω–∏–µ –î–æ–ª–∂–Ω–æ—Å—Ç–∏ *</label>
                        <input type="text" id="new-role-name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–µ–Ω–µ–¥–∂–µ—Ä, –ö–∞—Å—Å–∏—Ä" class="w-full p-2 border rounded" required>
                        <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-2 rounded-lg hover:bg-indigo-700">–°–æ–∑–¥–∞—Ç—å –î–æ–ª–∂–Ω–æ—Å—Ç—å</button>
                    </form>
                </div>
            </div>
            <div class="md:col-span-2">
                 <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold mb-4">–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –î–æ–ª–∂–Ω–æ—Å—Ç–∏</h2>
                    <div id="roles-list" class="space-y-3">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –¥–æ–ª–∂–Ω–æ—Å—Ç–µ–π...</div>
                </div>
            </div>
        </div>
    `;

    // --- –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏ –∫ —ç–ª–µ–º–µ–Ω—Ç–∞–º, —Å–æ–∑–¥–∞–Ω–Ω—ã–º –í–´–®–ï ---
    const addForm = document.getElementById('add-role-form');
    const rolesListDiv = document.getElementById('roles-list');

    if (addForm) {
        // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–π .parentNode?.replaceChild
        const newAddForm = addForm.cloneNode(true);
        addForm.parentNode?.replaceChild(newAddForm, addForm);
        newAddForm.addEventListener('submit', handleAddRole);
        console.log("[Listener OK] Added submit to #add-role-form");
    } else {
        console.error("!!! renderRolesTab: Element #add-role-form NOT FOUND after innerHTML.");
    }

    if (rolesListDiv) {
         // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫ "–ù–∞—Å—Ç—Ä–æ–∏—Ç—å"/"–£–¥–∞–ª–∏—Ç—å"
         const newRolesListDiv = rolesListDiv.cloneNode(false); // –ö–ª–æ–Ω–∏—Ä—É–µ–º –ø—É—Å—Ç–æ–π
         // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º ?. (–∑–Ω–∞–∫ –≤–æ–ø—Ä–æ—Å–∞) –ø–µ—Ä–µ–¥ replaceChild
         rolesListDiv.parentNode?.replaceChild(newRolesListDiv, rolesListDiv);
         newRolesListDiv.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –¥–æ–ª–∂–Ω–æ—Å—Ç–µ–π...'; // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É
         // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –∫ –ù–û–í–û–ú–£ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É
         newRolesListDiv.addEventListener('click', handleRoleActions);
         console.log("[Listener OK] Added click delegate listener to #roles-list");
    } else {
         console.error("!!! renderRolesTab: Element #roles-list NOT FOUND after innerHTML.");
    }
    // --- –ö–æ–Ω–µ—Ü –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–ª—É—à–∞—Ç–µ–ª–µ–π ---

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    await fetchAndRenderRoles();
    console.log("[Render] renderRolesTab: End");
}

// --- –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –†–æ–ª–µ–π –∏ –ü—Ä–∞–≤ ---
async function fetchAndRenderRoles() {
     console.log("[Fetch] fetchAndRenderRoles: Start");
     const listDiv = document.getElementById('roles-list'); // –ò—â–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
     if (!listDiv) return;
     listDiv.innerHTML = '<p class="text-gray-500 animate-pulse">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–ª–∂–Ω–æ—Å—Ç–µ–π...</p>';
     // showLoader(); // –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –ª–æ–∞–¥–µ—Ä

     try {
         // –ó–∞–≥—Ä—É–∂–∞–µ–º –†–æ–ª–∏ –∏ –ü—Ä–∞–≤–∞ –ü–ê–†–ê–õ–õ–ï–õ–¨–ù–û
         console.log("[Fetch] fetchAndRenderRoles: Fetching roles and permissions...");
         // –ò—Å–ø–æ–ª—å–∑—É–µ–º Promise.allSettled –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
         const results = await Promise.allSettled([
              apiFetch('/api/roles'), // –†–æ–ª–∏ —Ç–µ–∫—É—â–µ–π –∫–æ–º–ø–∞–Ω–∏–∏
              // –ü—Ä–∞–≤–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫—ç—à –ø—É—Å—Ç (–æ–Ω–∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ, –Ω–æ —Ñ–∏–ª—å—Ç—Ä—É—é—Ç—Å—è –Ω–∞ –±—ç–∫–µ)
              (!companyPermissions || companyPermissions.length === 0) ? apiFetch('/api/permissions') : Promise.resolve(companyPermissions)
         ]);

         // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
         if (results[0].status === 'fulfilled') {
              companyRoles = results[0].value; // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à —Ä–æ–ª–µ–π
              console.log("[Fetch] fetchAndRenderRoles: Received roles:", companyRoles);
         } else {
               throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–æ–ª–∏: ${results[0].reason?.message || results[0].reason}`);
         }
         if (results[1].status === 'fulfilled') {
              companyPermissions = results[1].value; // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –ø—Ä–∞–≤
              console.log("[Fetch] fetchAndRenderRoles: Received permissions:", companyPermissions);
         } else {
               // –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –µ—Å–ª–∏ –ø—Ä–∞–≤–∞ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å, –Ω–æ –Ω—É–∂–Ω–æ –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏—Ç—å
               console.warn(`[Fetch] fetchAndRenderRoles: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è: ${results[1].reason?.message || results[1].reason}`);
               // –û—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –∫—ç—à –ø—Ä–∞–≤, –µ—Å–ª–∏ –æ–Ω –±—ã–ª
         }


         // –†–µ–Ω–¥–µ—Ä–∏–º —Å–ø–∏—Å–æ–∫ —Ä–æ–ª–µ–π
         if (!companyRoles || companyRoles.length === 0) {
             listDiv.innerHTML = '<p class="text-gray-500">–£ –≤–∞—à–µ–π –∫–æ–º–ø–∞–Ω–∏–∏ –µ—â–µ –Ω–µ—Ç –¥–æ–ª–∂–Ω–æ—Å—Ç–µ–π (–∫—Ä–æ–º–µ "–í–ª–∞–¥–µ–ª–µ—Ü").</p>';
         } else {
             listDiv.innerHTML = companyRoles.map(role => `
                 <div class="p-3 bg-gray-50 rounded-md border flex flex-wrap justify-between items-center gap-2">
                     <p class="font-bold flex-grow text-lg">${role.name}</p>
                     <div class="flex-shrink-0 flex gap-2">
                         ${role.name !== '–í–ª–∞–¥–µ–ª–µ—Ü' ? ` <button data-role-id="${role.id}" data-role-name="${role.name}" class="permissions-btn text-sm bg-blue-200 hover:bg-blue-300 text-blue-800 px-3 py-1 rounded">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –¥–æ—Å—Ç—É–ø—ã</button>
                         <button data-role-id="${role.id}" data-role-name="${role.name}" class="delete-role-btn text-sm bg-red-200 hover:bg-red-300 text-red-800 px-3 py-1 rounded" title="–£–¥–∞–ª–∏—Ç—å –¥–æ–ª–∂–Ω–æ—Å—Ç—å">&times;</button>
                         ` : '<span class="text-sm text-gray-500">(–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Ä–æ–ª—å)</span>'}
                     </div>
                 </div>
             `).join('');
         }
         console.log("[Fetch] fetchAndRenderRoles: Success");
     } catch (e) {
         console.error("[Fetch] fetchAndRenderRoles: Error", e);
         listDiv.innerHTML = `<p class="text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–ª–∂–Ω–æ—Å—Ç–µ–π: ${e.message}</p>`;
     } finally {
         // hideLoader();
     }
}

// --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ñ–æ—Ä–º—ã "–î–æ–±–∞–≤–∏—Ç—å –¥–æ–ª–∂–Ω–æ—Å—Ç—å" ---
async function handleAddRole(e) {
    e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É
    console.log("[Role Action] handleAddRole: Start");
    const nameInput = document.getElementById('new-role-name');
    const roleName = nameInput ? nameInput.value.trim() : null;

    if (!roleName) {
        alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –Ω–æ–≤–æ–π –¥–æ–ª–∂–Ω–æ—Å—Ç–∏.");
        return;
    }
    showLoader(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
    try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º POST –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–æ–ª–∏
        console.log(`[Role Action] Creating role: ${roleName}`);
        await apiFetch('/api/roles', {
            method: 'POST',
            body: JSON.stringify({ name: roleName }) // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∏–º—è
        });
        console.log(`[Role Action] Role "${roleName}" created successfully.`);
        alert(`–î–æ–ª–∂–Ω–æ—Å—Ç—å "${roleName}" —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!`);
        if(nameInput) nameInput.value = ''; // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
        await fetchAndRenderRoles(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ä–æ–ª–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    } catch(err) { // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –æ—Ç apiFetch
        console.error("[Role Action] handleAddRole: Error", err);
        alert(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ–ª–∂–Ω–æ—Å—Ç–∏: ${err.message}`);
    } finally {
        hideLoader(); // –°–∫—Ä—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
        console.log("[Role Action] handleAddRole: End");
    }
}

// --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤ –ø–æ –∫–Ω–æ–ø–∫–∞–º –≤ —Å–ø–∏—Å–∫–µ —Ä–æ–ª–µ–π (–¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ) ---
// –í—ã–∑—ã–≤–∞–µ—Ç—Å—è —Å–ª—É—à–∞—Ç–µ–ª–µ–º, –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–º –≤ renderRolesTab
function handleRoleActions(e) {
     // –ò—â–µ–º –±–ª–∏–∂–∞–π—à—É—é –∫–Ω–æ–ø–∫—É –∫ –º–µ—Å—Ç—É –∫–ª–∏–∫–∞
     const targetButton = e.target.closest('button');
     if (!targetButton) return; // –ö–ª–∏–∫ –Ω–µ –ø–æ –∫–Ω–æ–ø–∫–µ

     const roleId = targetButton.dataset.roleId;
     const roleName = targetButton.dataset.roleName;

     // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–µ–π—Å—Ç–≤–∏–µ –ø–æ –∫–ª–∞—Å—Å—É –∫–Ω–æ–ø–∫–∏
     if (targetButton.classList.contains('permissions-btn')) {
         console.log(`[Role Action] Permissions button clicked for ID: ${roleId} (${roleName})`);
         openPermissionsModal(roleId, roleName); // –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∞–≤
     }
     else if (targetButton.classList.contains('delete-role-btn')) {
         console.log(`[Role Action] Delete button clicked for ID: ${roleId} (${roleName})`);
         // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º
         if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –¥–æ–ª–∂–Ω–æ—Å—Ç—å "${roleName}"?\n\n–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ —Å —ç—Ç–æ–π –¥–æ–ª–∂–Ω–æ—Å—Ç—å—é –ø–æ—Ç–µ—Ä—è—é—Ç –¥–æ—Å—Ç—É–ø, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —ç—Ç–æ–π —Ä–æ–ª–∏.`)) {
             handleDeleteRole(roleId, roleName); // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é —É–¥–∞–ª–µ–Ω–∏—è
         }
     }
}

// --- –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è —Ä–æ–ª–∏ ---
async function handleDeleteRole(roleId, roleName) {
    console.log(`[Delete] handleDeleteRole: Start deleting ID ${roleId} (${roleName})`);
    showLoader();
    try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º DELETE –∑–∞–ø—Ä–æ—Å –Ω–∞ –±—ç–∫–µ–Ω–¥
        await apiFetch(`/api/roles/${roleId}`, { method: 'DELETE' });
        console.log(`[Delete] handleDeleteRole: Role ID ${roleId} deleted successfully.`);
        alert(`–î–æ–ª–∂–Ω–æ—Å—Ç—å "${roleName}" —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞.`);
        await fetchAndRenderRoles(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ä–æ–ª–µ–π
    } catch(err) { // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –æ—Ç apiFetch (–≤–∫–ª—é—á–∞—è 400, –µ—Å–ª–∏ —Ä–æ–ª—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
        console.error("[Delete] handleDeleteRole: Error", err);
        alert(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –¥–æ–ª–∂–Ω–æ—Å—Ç–∏ "${roleName}": ${err.message}`);
    } finally {
        hideLoader(); // –°–∫—Ä—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
        console.log("[Delete] handleDeleteRole: End");
    }
}

// --- –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ ---
async function openPermissionsModal(roleId, roleName) {
    console.log(`[Modal] openPermissionsModal: Start for Role ID ${roleId} (${roleName})`);
    const permissionsModal = document.getElementById('permissions-modal');
    if (!permissionsModal) return console.error("!!! openPermissionsModal: Modal element #permissions-modal not found!");
    const modalContent = permissionsModal.querySelector('.modal-content');
    if (!modalContent) return console.error("!!! openPermissionsModal: Modal content not found!");

    modalContent.innerHTML = '<p class="text-gray-500 animate-pulse">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—É—â–∏—Ö –ø—Ä–∞–≤...</p>';
    openModal('permissions-modal'); // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É —Å—Ä–∞–∑—É —Å –∑–∞–≥–ª—É—à–∫–æ–π
    // showLoader(); // –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –ª–æ–∞–¥–µ—Ä

    try {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫—ç—à–∞ –ø—Ä–∞–≤, –µ—Å–ª–∏ –Ω–µ—Ç - –∑–∞–≥—Ä—É–∂–∞–µ–º
        if (!companyPermissions || companyPermissions.length === 0) {
             console.log("[Modal] openPermissionsModal: Permissions cache empty, fetching...");
             companyPermissions = await apiFetch('/api/permissions');
             console.log("[Modal] openPermissionsModal: Permissions loaded:", companyPermissions);
             if (!companyPermissions || companyPermissions.length === 0) {
                   throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π.");
             }
        }

        // –ü–æ–ª—É—á–∞–µ–º –¢–ï–ö–£–©–ò–ï ID –ø—Ä–∞–≤ –¥–ª—è –≠–¢–û–ô —Ä–æ–ª–∏
        console.log(`[Modal] openPermissionsModal: Fetching current permissions for Role ID ${roleId}...`);
        const currentPermissionIds = await apiFetch(`/api/roles/${roleId}/permissions`); // –ë—ç–∫–µ–Ω–¥ –≤–µ—Ä–Ω–µ—Ç –º–∞—Å—Å–∏–≤ ID
        const currentPermissionIdsSet = new Set(currentPermissionIds || []); // –°–æ–∑–¥–∞–µ–º Set –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
        console.log(`[Modal] openPermissionsModal: Current permission IDs for Role ID ${roleId}:`, currentPermissionIdsSet);


        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –¥–ª—è —á–µ–∫–±–æ–∫—Å–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫—ç—à–∞ companyPermissions
        const permissionsHtml = companyPermissions.map(p => `
            <div class="flex items-center py-1">
                <input id="perm-${p.id}" type="checkbox" value="${p.id}"
                       class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 permission-checkbox"
                       ${currentPermissionIdsSet.has(p.id) ? 'checked' : ''}>
                <label for="perm-${p.id}" class="ml-3 block text-sm font-medium text-gray-700">${p.description}</label>
            </div>
        `).join('');

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º HTML –≤ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        modalContent.innerHTML = `
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-2xl font-bold">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–æ—Å—Ç—É–ø–æ–≤ –¥–ª—è: <span class="text-indigo-600">${roleName}</span></h3>
                <button onclick="closeModal('permissions-modal')" class="text-2xl font-bold leading-none p-1 -m-1">&times;</button>
            </div>
            <form id="permissions-form" data-role-id="${roleId}">
                <div class="space-y-2 max-h-[60vh] overflow-y-auto border rounded p-4 mb-4 bg-gray-50">
                     ${permissionsHtml || '<p class="text-gray-500">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π.</p>'}
                </div>
                <div class="flex gap-4 mt-6 border-t pt-4">
                    <button type="button" onclick="closeModal('permissions-modal')" class="w-full bg-gray-200 py-2 rounded hover:bg-gray-300 text-gray-800">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ü—Ä–∞–≤–∞</button>
                </div>
            </form>
        `;

        // --- –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å submit –∫ –¢–û–õ–¨–ö–û –ß–¢–û —Å–æ–∑–¥–∞–Ω–Ω–æ–π —Ñ–æ—Ä–º–µ ---
        const formElement = document.getElementById('permissions-form');
        if (formElement) {
            const newFormElement = formElement.cloneNode(true);
            formElement.parentNode.replaceChild(newFormElement, formElement);
            newFormElement.addEventListener('submit', handleSavePermissions);
            console.log("[Modal Listener OK] Added submit to #permissions-form");
        } else {
            console.error("!!! openPermissionsModal: Form #permissions-form NOT FOUND after innerHTML!");
        }
        // --- –ö–æ–Ω–µ—Ü –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–ª—É—à–∞—Ç–µ–ª—è ---

    } catch (err) { // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∞–≤
        console.error("[Modal] openPermissionsModal: Error loading permissions", err);
        modalContent.innerHTML = `
             <div class="flex justify-between items-start mb-4">
                 <h3 class="text-2xl font-bold">–û—à–∏–±–∫–∞</h3>
                 <button onclick="closeModal('permissions-modal')" class="text-2xl font-bold leading-none p-1 -m-1">&times;</button>
             </div>
             <p class="text-red-500">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞: ${err.message}</p>
             <div class="mt-4 text-right">
                  <button onclick="closeModal('permissions-modal')" class="bg-gray-200 py-2 px-4 rounded">–ó–∞–∫—Ä—ã—Ç—å</button>
             </div>`;
    } finally {
        // hideLoader(); // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ª–æ–∞–¥–µ—Ä –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
        console.log(`[Modal] openPermissionsModal: End for Role ID ${roleId}`);
    }
}

// --- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ ---
async function handleSavePermissions(e) {
    e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É
    console.log("[Save Permissions] handleSavePermissions: Start");
    const form = e.target;
    const roleId = form.dataset.roleId;
    if (!roleId) {
         alert("–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID —Ä–æ–ª–∏.");
         return;
    }

    // –°–æ–±–∏—Ä–∞–µ–º ID –í–°–ï–• –æ—Ç–º–µ—á–µ–Ω–Ω—ã—Ö —á–µ–∫–±–æ–∫—Å–æ–≤ –≤–Ω—É—Ç—Ä–∏ —Ñ–æ—Ä–º—ã
    const selectedPermissionIds = Array.from(form.querySelectorAll('.permission-checkbox:checked'))
                                     .map(checkbox => parseInt(checkbox.value));

    console.log(`[Save Permissions] Saving permissions for Role ID ${roleId}. Selected IDs:`, selectedPermissionIds);
    showLoader(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä

    try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º PUT –∑–∞–ø—Ä–æ—Å –Ω–∞ –±—ç–∫–µ–Ω–¥ —Å–æ —Å–ø–∏—Å–∫–æ–º ID
        await apiFetch(`/api/roles/${roleId}/permissions`, {
            method: 'PUT',
            body: JSON.stringify({ permission_ids: selectedPermissionIds })
        });
        console.log(`[Save Permissions] Permissions saved successfully for Role ID ${roleId}.`);
        alert('–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!');
        closeModal('permissions-modal'); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞—Ç—å —Å–ø–∏—Å–æ–∫ —Ä–æ–ª–µ–π –Ω–µ –Ω—É–∂–Ω–æ, —Ç–∞–∫ –∫–∞–∫ –º—ã –º–µ–Ω—è–ª–∏ —Ç–æ–ª—å–∫–æ –ø—Ä–∞–≤–∞

    } catch(err) { // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –æ—Ç apiFetch
        console.error("[Save Permissions] handleSavePermissions: Error", err);
        alert(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞: ${err.message}`);
        // –û—Å—Ç–∞–≤–ª—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–∫—Ä—ã—Ç—ã–º –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏
    } finally {
        hideLoader(); // –°–∫—Ä—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
        console.log("[Save Permissions] handleSavePermissions: End");
    }
}

// =================================================================
// –ú–û–î–£–õ–¨: –ö–õ–ò–ï–ù–¢–´ (–í–ª–∞–¥–µ–ª–µ—Ü) (v4.1 - Rebuild)
// =================================================================

companyClients = []; // –ö—ç—à –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ —Ç–µ–∫—É—â–µ–π –∫–æ–º–ø–∞–Ω–∏–∏

// --- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≤–∫–ª–∞–¥–∫–∏ "–ö–ª–∏–µ–Ω—Ç—ã" ---
// –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ initializeMainAppUI, –µ—Å–ª–∏ —É –í–ª–∞–¥–µ–ª—å—Ü–∞ –µ—Å—Ç—å –ø—Ä–∞–≤–∞ 'manage_clients'
// --- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≤–∫–ª–∞–¥–∫–∏ "–ö–ª–∏–µ–Ω—Ç—ã" (–° –ø–æ–¥-–≤–∫–ª–∞–¥–∫–∞–º–∏) ---
async function renderClientsTab() {
    console.log("[Render] renderClientsTab: Start");
    const pane = document.getElementById('tab-clients');
    if (!pane) return;

    pane.innerHTML = `
        <div class="bg-white p-6 rounded-lg shadow-md h-full flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <nav class="-mb-px flex space-x-6" id="clients-subtabs">
                    <button data-subtab="clients-list" class="client-subtab-btn text-indigo-600 border-b-2 border-indigo-600 font-bold pb-2 px-2">üë• –°–ø–∏—Å–æ–∫ –ö–ª–∏–µ–Ω—Ç–æ–≤</button>
                    <button data-subtab="clients-debtors" class="client-subtab-btn text-gray-500 hover:text-gray-700 font-medium pb-2 px-2">üí∏ –î–æ–ª–∂–Ω–∏–∫–∏</button>
                </nav>
                
                <div id="clients-actions-bar" class="flex gap-2">
                    <button id="client-tools-btn" class="bg-gray-100 hover:bg-gray-200 text-gray-800 py-1.5 px-3 rounded text-sm">üõ†Ô∏è –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</button>
                    <button id="add-client-btn" class="bg-indigo-600 text-white font-bold py-1.5 px-3 rounded hover:bg-indigo-700 text-sm">‚ûï –ö–ª–∏–µ–Ω—Ç</button>
                </div>
            </div>

            <div id="subtab-clients-list" class="flex-grow flex flex-col h-full overflow-hidden">
                <div class="mb-3">
                    <input type="search" id="clients-search-input" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏, —Ç–µ–ª–µ—Ñ–æ–Ω—É, –∫–æ–¥—É..." class="w-full p-2 border rounded-lg focus:ring-indigo-500">
                </div>
                <div id="clients-list" class="flex-grow overflow-y-auto pr-2 custom-scrollbar space-y-2">
                    <p class="text-gray-500 animate-pulse">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤...</p>
                </div>
            </div>

            <div id="subtab-clients-debtors" class="hidden flex-grow flex flex-col h-full overflow-hidden">
                 <div class="mb-3 flex justify-between items-center">
                    <input type="search" id="debtors-search-input" placeholder="üîç –ü–æ–∏—Å–∫ –¥–æ–ª–∂–Ω–∏–∫–∞..." class="w-full p-2 border rounded-lg focus:ring-red-500 mr-4">
                    <button id="refresh-debtors-btn" class="text-gray-500 hover:text-indigo-600 text-xl" title="–û–±–Ω–æ–≤–∏—Ç—å">‚Üª</button>
                </div>
                <div id="debtors-list" class="flex-grow overflow-y-auto pr-2 custom-scrollbar space-y-3">
                    <p class="text-gray-500 text-center mt-10">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –¥–æ–ª–∂–Ω–∏–∫–æ–≤...</p>
                </div>
            </div>
        </div>
    `;

    // --- –°–ª—É—à–∞—Ç–µ–ª–∏ ---
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–¥-–≤–∫–ª–∞–¥–æ–∫
    const subtabs = document.getElementById('clients-subtabs');
    subtabs.addEventListener('click', (e) => {
        const btn = e.target.closest('.client-subtab-btn');
        if (!btn) return;
        
        // –°—Ç–∏–ª–∏ –∫–Ω–æ–ø–æ–∫
        document.querySelectorAll('.client-subtab-btn').forEach(b => {
            b.classList.remove('text-indigo-600', 'border-b-2', 'border-indigo-600', 'font-bold');
            b.classList.add('text-gray-500', 'font-medium');
        });
        btn.classList.add('text-indigo-600', 'border-b-2', 'border-indigo-600', 'font-bold');
        btn.classList.remove('text-gray-500', 'font-medium');

        // –í–∏–¥–∏–º–æ—Å—Ç—å –ø–∞–Ω–µ–ª–µ–π
        const target = btn.dataset.subtab;
        document.getElementById('subtab-clients-list').classList.toggle('hidden', target !== 'clients-list');
        document.getElementById('subtab-clients-debtors').classList.toggle('hidden', target !== 'clients-debtors');
        
        // –í–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å–ø–∏—Å–∫–∞)
        document.getElementById('clients-actions-bar').style.visibility = (target === 'clients-list') ? 'visible' : 'hidden';

        // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã–ª–∏ –¥–æ–ª–∂–Ω–∏–∫–æ–≤ ‚Äî –≥—Ä—É–∑–∏–º –∏—Ö
        if (target === 'clients-debtors') {
            fetchAndRenderDebtors();
        }
    });

    // –°–ª—É—à–∞—Ç–µ–ª–∏ –∫–Ω–æ–ø–æ–∫ (—á–µ—Ä–µ–∑ replaceAndListen, –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–ª–∏ –Ω–∞–ø—Ä—è–º—É—é)
    document.getElementById('add-client-btn').addEventListener('click', () => openClientModal());
    document.getElementById('client-tools-btn').addEventListener('click', () => openModal('client-tools-modal'));
    
    // –ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ (–æ–±—ã—á–Ω—ã–π)
    document.getElementById('clients-search-input').addEventListener('input', handleClientsSearch);

    // –ü–æ–∏—Å–∫ –¥–æ–ª–∂–Ω–∏–∫–æ–≤
    document.getElementById('debtors-search-input').addEventListener('input', handleDebtorsSearch);
    document.getElementById('refresh-debtors-btn').addEventListener('click', fetchAndRenderDebtors);

    // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤
    document.getElementById('clients-list').addEventListener('click', handleClientListActions);
    
    // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —Å–ø–∏—Å–∫–∞ –¥–æ–ª–∂–Ω–∏–∫–æ–≤ (—Ä–∞—Å–∫—Ä—ã—Ç–∏–µ, –æ–ø–ª–∞—Ç–∞)
    document.getElementById('debtors-list').addEventListener('click', handleDebtorActions);

    // –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—ã—á–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞
    await fetchAndRenderClients();
}

// --- –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ö–ª–∏–µ–Ω—Ç–æ–≤ ---
async function fetchAndRenderClients() {
    console.log("[Fetch] fetchAndRenderClients: Start");
    const listDiv = document.getElementById('clients-list'); // –ò—â–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    if (!listDiv) return;
    listDiv.innerHTML = '<p class="text-gray-500 animate-pulse">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤...</p>';
    // showLoader(); // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –ª–æ–∞–¥–µ—Ä

    try {
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–ª–∏–µ–Ω—Ç–æ–≤ —Ç–µ–∫—É—â–µ–π –∫–æ–º–ø–∞–Ω–∏–∏
        const clients = await apiFetch('/api/clients');
        companyClients = clients; // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à
        console.log("[Fetch] fetchAndRenderClients: Received clients:", clients);

        if (!clients || clients.length === 0) {
            listDiv.innerHTML = '<p class="text-gray-500">–£ –≤–∞—à–µ–π –∫–æ–º–ø–∞–Ω–∏–∏ –µ—â–µ –Ω–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤.</p>';
        } else {
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
            listDiv.innerHTML = clients.map(c => `
                <div class="client-list-item p-3 bg-gray-50 rounded-md border flex flex-wrap justify-between items-center gap-2"
                     data-client-name="${c.full_name}"
                     data-client-phone="${c.phone}"
                     data-client-code="${(c.client_code_prefix || '') + (c.client_code_num || '')}">
                    <div class="flex-grow min-w-[200px]"> <p class="font-bold text-lg">${c.full_name} (${c.client_code_prefix || ''}${c.client_code_num || '–ù–µ—Ç –∫–æ–¥–∞'})</p>
                        <p class="text-sm text-gray-600">${c.phone} ${c.telegram_chat_id ? '<span class="text-blue-500 font-bold text-xs" title="Telegram –ø—Ä–∏–≤—è–∑–∞–Ω"> (TG)</span>' : ''}</p>
                        <p class="text-xs text-gray-500">–°—Ç–∞—Ç—É—Å: ${c.status || '–†–æ–∑–Ω–∏—Ü–∞'}</p>
                    </div>
                    <div class="flex-shrink-0 flex gap-2">
                        <button data-client-id="${c.id}" class="lk-link-client-btn text-sm bg-blue-100 hover:bg-blue-200 text-blue-800 px-3 py-1 rounded" title="–ü–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –õ–∏—á–Ω—ã–π –ö–∞–±–∏–Ω–µ—Ç">üîó–õ–ö</button>
                        <button data-client-id="${c.id}" data-client-json='${JSON.stringify(c)}' class="edit-client-btn text-sm bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded">–†–µ–¥–∞–∫—Ç.</button>
                        <button data-client-id="${c.id}" data-client-name="${c.full_name}" class="delete-client-btn text-sm bg-red-200 hover:bg-red-300 text-red-800 px-3 py-1 rounded">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                </div>
            `).join('');
            // –°–ª—É—à–∞—Ç–µ–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ #clients-list
        }
        console.log("[Fetch] fetchAndRenderClients: Success");
    } catch (e) {
        console.error("[Fetch] fetchAndRenderClients: Error", e);
        listDiv.innerHTML = `<p class="text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤: ${e.message}</p>`;
    } finally {
        // hideLoader();
    }
}

// --- –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ö–ª–∏–µ–Ω—Ç–∞ (–¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è) ---
function openClientModal(client = null) {
    console.log("[Modal] openClientModal: Start", client);
    const modal = document.getElementById('client-modal');
    if (!modal) return console.error("!!! openClientModal: Modal element #client-modal not found!");
    const modalContent = modal.querySelector('.modal-content');
    if (!modalContent) return console.error("!!! openClientModal: Modal content not found!");

    const isEdit = client !== null; // true, –µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω—ã –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    modalContent.innerHTML = `
        <div class="flex justify-between items-start mb-4">
            <h3 class="text-2xl font-bold">${isEdit ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞' : '–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞'}</h3>
            <button onclick="closeModal('client-modal')" class="text-2xl font-bold leading-none p-1 -m-1">&times;</button>
        </div>
        <form id="client-form-inner" class="space-y-4">
             <input type="hidden" id="modal-client-id" value="${isEdit ? client.id : ''}">
            <div>
                <label for="modal-client-full_name" class="block text-sm font-medium text-gray-700">–§–ò–û *</label>
                <input type="text" id="modal-client-full_name" value="${isEdit ? client.full_name : ''}" class="mt-1 w-full p-2 border rounded" required>
            </div>
            <div>
                <label for="modal-client-phone" class="block text-sm font-medium text-gray-700">–¢–µ–ª–µ—Ñ–æ–Ω *</label>
                <input type="text" id="modal-client-phone" value="${isEdit ? client.phone : ''}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 996555123456 –∏–ª–∏ 0555123456" class="mt-1 w-full p-2 border rounded" required>
            </div>
            <div class="grid grid-cols-3 gap-2">
                <div>
                    <label for="modal-client-prefix" class="block text-sm font-medium text-gray-700">–ü—Ä–µ—Ñ–∏–∫—Å –ö–æ–¥–∞</label>
                    <input type="text" id="modal-client-prefix" value="${isEdit ? (client.client_code_prefix || '') : (currentCompany?.company_code || 'KB')}" class="mt-1 w-full p-2 border rounded uppercase" maxlength="5">
                </div>
                <div class="col-span-2">
                    <label for="modal-client-code" class="block text-sm font-medium text-gray-700">–ù–æ–º–µ—Ä –ö–æ–¥–∞</label>
                    <input type="number" id="modal-client-code" value="${isEdit ? (client.client_code_num || '') : ''}" class="mt-1 w-full p-2 border rounded" placeholder="${isEdit ? '–ú–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å' : '–ê–≤—Ç–æ (–µ—Å–ª–∏ –ø—É—Å—Ç–æ)'}">
                    <p class="text-xs text-gray-500 mt-1">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¥–ª—è –∞–≤—Ç–æ-–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.</p>
                </div>
            </div>
             <div>
                <label for="modal-client-status" class="block text-sm font-medium text-gray-700">–°—Ç–∞—Ç—É—Å –∫–ª–∏–µ–Ω—Ç–∞</label>
                <input type="text" id="modal-client-status" value="${isEdit ? (client.status || '–†–æ–∑–Ω–∏—Ü–∞') : '–†–æ–∑–Ω–∏—Ü–∞'}" class="mt-1 w-full p-2 border rounded" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –†–æ–∑–Ω–∏—Ü–∞, –û–ø—Ç">
            </div>
             ${isEdit ? `
             <div class="text-sm ${client.telegram_chat_id ? 'text-green-600 font-semibold' : 'text-gray-500'}">
                <span class="font-medium">Telegram:</span> ${client.telegram_chat_id ? `–ü—Ä–∏–≤—è–∑–∞–Ω (${client.telegram_chat_id})` : '–ù–µ –ø—Ä–∏–≤—è–∑–∞–Ω (–∫–ª–∏–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –ø—Ä–∏–≤—è–∑–∞—Ç—å —Å–∞–º –≤ –±–æ—Ç–µ)'}
                ${client.telegram_chat_id ? '<button type="button" id="modal-client-unlink-tg" class="ml-2 text-xs text-red-500 underline hover:text-red-700">–û—Ç–≤—è–∑–∞—Ç—å</button>' : ''}
             </div>` : ''}
            <div class="flex gap-4 mt-6 border-t pt-4">
                <button type="button" onclick="closeModal('client-modal')" class="w-full bg-gray-200 py-2 rounded hover:bg-gray-300 text-gray-800">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </form>
    `;

    // --- –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å submit –∫ –¢–û–õ–¨–ö–û –ß–¢–û —Å–æ–∑–¥–∞–Ω–Ω–æ–π —Ñ–æ—Ä–º–µ ---
    const formElement = document.getElementById('client-form-inner');
    if (formElement) {
        const newFormElement = formElement.cloneNode(true);
        formElement.parentNode.replaceChild(newFormElement, formElement);
        newFormElement.addEventListener('submit', handleSaveClient);
        console.log("[Modal Listener OK] Added submit to #client-form-inner");
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ—Ç–≤—è–∑–∫–∏ TG, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
        const unlinkBtn = document.getElementById('modal-client-unlink-tg');
        if (unlinkBtn) {
            unlinkBtn.addEventListener('click', () => handleUnlinkTelegram(client?.id));
        }
    } else {
        console.error("!!! openClientModal: Form #client-form-inner NOT FOUND after innerHTML!");
    }
    // --- –ö–æ–Ω–µ—Ü –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–ª—É—à–∞—Ç–µ–ª—è ---

    openModal('client-modal'); // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    console.log("[Modal] openClientModal: End");
}

// --- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ö–ª–∏–µ–Ω—Ç–∞ (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞) ---

async function handleSaveClient(e) {
    e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É
    console.log("[Save] handleSaveClient: Start");
    showLoader(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä

    // –°—á–∏—Ç—ã–≤–∞–µ–º ID (–¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ - —Å–æ–∑–¥–∞–Ω–∏–µ/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
    const clientId = document.getElementById('modal-client-id')?.value;
    const isEdit = !!clientId; // true, –µ—Å–ª–∏ ID –µ—Å—Ç—å
    
    // !!! –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–û–ë–ê–í–õ–ï–ù–ò–ï –ü–†–ï–§–ò–ö–°–ê /api !!!
    // –°–æ–∑–¥–∞–Ω–∏–µ: /api/clients (POST)
    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: /api/clients/{id} (PATCH)
    const url = isEdit ? `/api/clients/${clientId}` : '/api/clients'; 
    const method = isEdit ? 'PATCH' : 'POST'; 
    // ... (–û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –æ—Å—Ç–∞–µ—Ç—Å—è)
    
    // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–æ–ª–µ–π –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    const payload = {
        full_name: document.getElementById('modal-client-full_name')?.value.trim(),
        phone: document.getElementById('modal-client-phone')?.value.trim(),
        // –ü—Ä–µ—Ñ–∏–∫—Å: –±–µ—Ä–µ–º –≤–≤–µ–¥–µ–Ω–Ω—ã–π –ò–õ–ò –∫–æ–¥ –∫–æ–º–ø–∞–Ω–∏–∏ –ò–õ–ò 'KB'
        client_code_prefix: document.getElementById('modal-client-prefix')?.value.trim().toUpperCase() || (currentCompany?.company_code) || 'KB',
        // –ù–æ–º–µ—Ä –∫–æ–¥–∞: null –µ—Å–ª–∏ –ø—É—Å—Ç–æ –∏–ª–∏ 0
        client_code_num: parseInt(document.getElementById('modal-client-code')?.value) || null,
        // –í—ã —É–∫–∞–∑–∞–ª–∏ "–û–ø—Ç–æ–≤–∏–∫" ‚Äî —Å—Ç–∞—Ç—É—Å –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å
        status: document.getElementById('modal-client-status')?.value.trim() || '–†–æ–∑–Ω–∏—Ü–∞' 
    };

    // –£–¥–∞–ª—è–µ–º –Ω–æ–º–µ—Ä –∫–æ–¥–∞ –∏–∑ payload –ø—Ä–∏ –°–û–ó–î–ê–ù–ò–ò, –µ—Å–ª–∏ –æ–Ω null (—á—Ç–æ–±—ã —Å—Ä–∞–±–æ—Ç–∞–ª–∞ –∞–≤—Ç–æ-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞ –±—ç–∫–µ)
     if (!isEdit && payload.client_code_num === null) {
         delete payload.client_code_num;
     }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è: –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –§–ò–û –∏ –¢–µ–ª–µ—Ñ–æ–Ω–∞
    if (!payload.full_name || !payload.phone) {
         hideLoader();
         alert("–§–ò–û –∏ –¢–µ–ª–µ—Ñ–æ–Ω –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è.");
         return; 
    }

    try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        console.log(`[Save] handleSaveClient: Sending ${method} to ${url}`, payload);
        const result = await apiFetch(url, { method: method, body: JSON.stringify(payload) });
        console.log("[Save] handleSaveClient: Server response", result);

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—Ö–∞
        alert(isEdit ? '–î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!' : '–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!');
        closeModal('client-modal'); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        await fetchAndRenderClients(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ

    } catch(err) { // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (–æ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏–ª–∏ –æ—Ç apiFetch)
        console.error("!!! [Save] handleSaveClient: Error", err);
        alert(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞: ${err.message}`);
        // –û—Å—Ç–∞–≤–ª—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–∫—Ä—ã—Ç—ã–º –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    } finally {
        // --- –°–∫—Ä—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ ---
        hideLoader();
        console.log("[Save] handleSaveClient: End");
    }
}

// --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –≤ —Å–ø–∏—Å–∫–µ –∫–ª–∏–µ–Ω—Ç–æ–≤ (–¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ) ---
// –í—ã–∑—ã–≤–∞–µ—Ç—Å—è —Å–ª—É—à–∞—Ç–µ–ª–µ–º, –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–º –≤ renderClientsTab
function handleClientListActions(e) {
    const targetButton = e.target.closest('button'); // –ò—â–µ–º –±–ª–∏–∂–∞–π—à—É—é –∫–Ω–æ–ø–∫—É
    if (!targetButton) return; // –ö–ª–∏–∫ –Ω–µ –ø–æ –∫–Ω–æ–ø–∫–µ

    const clientId = targetButton.dataset.clientId; // ID –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–∞

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–µ–π—Å—Ç–≤–∏–µ –ø–æ –∫–ª–∞—Å—Å—É –∫–Ω–æ–ø–∫–∏
    if (targetButton.classList.contains('edit-client-btn')) {
        console.log(`[Action] Edit client button clicked for ID: ${clientId}`);
        try {
             // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–∞ –∫–Ω–æ–ø–∫–∏ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
             const clientData = JSON.parse(targetButton.dataset.clientJson);
             openClientModal(clientData); // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        } catch (err) {
             console.error("Error parsing client data for edit:", err);
             // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –≤ –∫—ç—à–µ –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
              const clientToEdit = companyClients.find(c => c.id == clientId);
              if (clientToEdit) {
                  openClientModal(clientToEdit);
              } else {
                  alert("–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.");
              }
        }
    }
    else if (targetButton.classList.contains('delete-client-btn')) {
        console.log(`[Action] Delete client button clicked for ID: ${clientId}`);
        const clientName = targetButton.dataset.clientName;
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
        if (confirm(`–£–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ "${clientName}"?\n\n–í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ! –ó–∞–∫–∞–∑—ã –∫–ª–∏–µ–Ω—Ç–∞ –æ—Å—Ç–∞–Ω—É—Ç—Å—è –≤ —Å–∏—Å—Ç–µ–º–µ, –Ω–æ –±—É–¥—É—Ç –æ—Ç–≤—è–∑–∞–Ω—ã.`)) {
            handleDeleteClient(clientId, clientName); // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é —É–¥–∞–ª–µ–Ω–∏—è
        }
    }
     else if (targetButton.classList.contains('lk-link-client-btn')) {
        console.log(`[Action] LK link button clicked for ID: ${clientId}`);
        handleGenerateLkLink(clientId); // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Å—ã–ª–∫–∏ –õ–ö
    }
}

// --- –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞ ---
async function handleDeleteClient(clientId, clientName) {
    console.log(`[Delete] handleDeleteClient: Start deleting ID ${clientId} (${clientName})`);
    
    // 1. –ü–µ—Ä–≤–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ "${clientName}"?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!`)) {
        return;
    }

    // 2. –ó–∞–ø—Ä–æ—Å –ü–∞—Ä–æ–ª—è (–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
    const password = prompt(`–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –ø–∞—Ä–æ–ª—å –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞ "${clientName}":`);
    if (password === null) return; // –ù–∞–∂–∞—Ç–∞ –û—Ç–º–µ–Ω–∞
    if (!password) {
        alert("–ü–∞—Ä–æ–ª—å –Ω–µ –≤–≤–µ–¥–µ–Ω. –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.");
        return;
    }

    // 3. –ó–∞–ø—Ä–æ—Å –ü—Ä–∏—á–∏–Ω—ã (–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
    const reason = prompt("–£–∫–∞–∂–∏—Ç–µ –ü–†–ò–ß–ò–ù–£ —É–¥–∞–ª–µ–Ω–∏—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):");
    if (reason === null) return; // –ù–∞–∂–∞—Ç–∞ –û—Ç–º–µ–Ω–∞
    if (!reason || reason.trim().length < 3) {
        alert("–ü—Ä–∏—á–∏–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —É–∫–∞–∑–∞–Ω–∞. –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.");
        return;
    }

    showLoader();
    try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º DELETE –∑–∞–ø—Ä–æ—Å —Å –ø–∞—Ä–æ–ª–µ–º –∏ –ø—Ä–∏—á–∏–Ω–æ–π –≤ URL
        const params = new URLSearchParams({
            password: password,
            reason: reason
        });

        await apiFetch(`/api/clients/${clientId}?${params.toString()}`, { method: 'DELETE' });
        
        console.log(`[Delete] handleDeleteClient: Client ID ${clientId} deleted.`);
        alert(`–ö–ª–∏–µ–Ω—Ç "${clientName}" —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω.\n–ü—Ä–∏—á–∏–Ω–∞ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞.`);
        await fetchAndRenderClients(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫

    } catch (err) { 
        console.error("[Delete] handleDeleteClient: Error", err);
        alert(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞: ${err.message}`);
    } finally {
        hideLoader();
    }
}

// --- –§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏ –ø–æ–∫–∞–∑–∞ —Å—Å—ã–ª–∫–∏ –Ω–∞ –õ–ö ---
async function handleGenerateLkLink(clientId) {
     console.log(`[Action] handleGenerateLkLink: Start for Client ID ${clientId}`);
     showLoader();
     try {
         // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º POST –∑–∞–ø—Ä–æ—Å (–∫–∞–∫ —É–∫–∞–∑–∞–Ω–æ –≤ main.py)
         const response = await apiFetch(`/api/clients/${clientId}/generate_lk_link`, { method: 'POST' });
         console.log(`[Action] handleGenerateLkLink: Received link: ${response.link}`);
         // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É –≤ prompt –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
         // prompt() –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –ø–æ–∫–∞–∑ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±—É—Ñ–µ—Ä
         prompt(`–°—Å—ã–ª–∫–∞ –Ω–∞ –õ–∏—á–Ω—ã–π –ö–∞–±–∏–Ω–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞ (–ù–∞–∂–º–∏—Ç–µ Ctrl+C / Cmd+C –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è):`, response.link);
         // navigator.clipboard.writeText(response.link).then(() => alert("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!"), () => alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É.")); // –í–∞—Ä–∏–∞–Ω—Ç —Å –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ–º
     } catch (err) { // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –æ—Ç apiFetch
         console.error("[Action] handleGenerateLkLink: Error", err);
         alert(`–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Å—ã–ª–∫–∏ –Ω–∞ –õ–∏—á–Ω—ã–π –ö–∞–±–∏–Ω–µ—Ç: ${err.message}`);
     } finally {
         hideLoader(); // –°–∫—Ä—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
         console.log(`[Action] handleGenerateLkLink: End for Client ID ${clientId}`);
     }
 }

// --- –§—É–Ω–∫—Ü–∏—è –æ—Ç–≤—è–∑–∫–∏ Telegram ID ---
async function handleUnlinkTelegram(clientId) {
     if (!clientId) return;
     console.log(`[Action] handleUnlinkTelegram: Start for Client ID ${clientId}`);
     if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–≤—è–∑–∞—Ç—å Telegram –∞–∫–∫–∞—É–Ω—Ç —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞?\n–û–Ω —Å–º–æ–∂–µ—Ç –ø—Ä–∏–≤—è–∑–∞—Ç—å –µ–≥–æ —Å–Ω–æ–≤–∞ —á–µ—Ä–µ–∑ –±–æ—Ç–∞.")) {
          showLoader();
          try {
               // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º PATCH –∑–∞–ø—Ä–æ—Å, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—è telegram_chat_id –≤ null
               await apiFetch(`/api/clients/${clientId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ telegram_chat_id: null })
               });
               console.log(`[Action] handleUnlinkTelegram: Success for Client ID ${clientId}`);
               alert("Telegram –∞–∫–∫–∞—É–Ω—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–≤—è–∑–∞–Ω.");
               closeModal('client-modal'); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
               await fetchAndRenderClients(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
          } catch (err) {
               console.error("[Action] handleUnlinkTelegram: Error", err);
               alert(`–û—à–∏–±–∫–∞ –æ—Ç–≤—è–∑–∫–∏ Telegram: ${err.message}`);
          } finally {
               hideLoader();
          }
     }
}


// --- –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ (—Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞) ---
function handleClientsSearch(e) {
    const searchTerm = e.target.value.toLowerCase().trim(); // –ü–æ–ª—É—á–∞–µ–º –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
    console.log(`[Search] handleClientsSearch: Term = "${searchTerm}"`);
    const clientItems = document.querySelectorAll('#clients-list .client-list-item'); // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å–ø–∏—Å–∫–∞

    clientItems.forEach(item => {
        // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–æ–≤ —ç–ª–µ–º–µ–Ω—Ç–∞
        const name = item.dataset.clientName?.toLowerCase() || '';
        const phone = item.dataset.clientPhone?.toLowerCase() || '';
        const code = item.dataset.clientCode?.toLowerCase() || '';

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –ø–æ–ª–µ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
        const isMatch = name.includes(searchTerm) ||
                        phone.includes(searchTerm) ||
                        code.includes(searchTerm);

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–ª–∏ —Å–∫—Ä—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø–æ–∏—Å–∫–∞
        item.style.display = isMatch ? 'flex' : 'none'; // –ò—Å–ø–æ–ª—å–∑—É–µ–º 'flex', —Ç–∞–∫ –∫–∞–∫ –≤ CSS –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è flexbox
    });
    console.log(`[Search] handleClientsSearch: Filtering complete.`);
}


// --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏–∑ Excel ---
// –í—ã–∑—ã–≤–∞–µ—Ç—Å—è —Å–ª—É—à–∞—Ç–µ–ª–µ–º, –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–º –≤ initializeGlobalEventListeners
async function handleClientExcelImport() {
    console.log("[Import] handleClientExcelImport: Start");
    const fileInput = document.getElementById('client-excel-input');
    const resultsDiv = document.getElementById('client-import-results');
    if (!resultsDiv) return console.error("!!! Import Error: resultsDiv #client-import-results not found!");

    resultsDiv.innerHTML = '<p class="text-blue-600 animate-pulse">–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞...</p>';

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–±—Ä–∞–Ω –ª–∏ —Ñ–∞–π–ª
    if (!fileInput || fileInput.files.length === 0) {
        resultsDiv.innerHTML = '<p class="text-red-500">–û—à–∏–±–∫–∞: –í—ã–±–µ—Ä–∏—Ç–µ Excel-—Ñ–∞–π–ª.</p>';
        return;
    }
    const file = fileInput.files[0];
    console.log(`[Import] Selected file: ${file.name}, size: ${file.size} bytes`);
    showLoader(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –ª–æ–∞–¥–µ—Ä

    try {
        // --- –®–∞–≥ 1: –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Excel —Ñ–∞–π–ª–∞ ---
        console.log("[Import] Reading Excel file...");
        const jsonData = await readExcelFile(file); // –ò—Å–ø–æ–ª—å–∑—É–µ–º —É—Ç–∏–ª–∏—Ç—É
        console.log(`[Import] Excel read successfully. Found ${jsonData.length} rows.`);

        if (jsonData.length === 0) {
            resultsDiv.innerHTML = '<p class="text-yellow-600">–§–∞–π–ª –ø—É—Å—Ç –∏–ª–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –ø–µ—Ä–≤–æ–º –ª–∏—Å—Ç–µ.</p>';
            return; // –í—ã—Ö–æ–¥–∏–º, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç
        }

        // --- –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–æ–Ω–æ–∫ (–ò–ó–ú–ï–ù–ï–ù–û) ---
        const firstRow = jsonData[0];
        // –¢–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä—è–µ–º –¢–û–õ–¨–ö–û –Ω–∞–ª–∏—á–∏–µ 'track_code'
        if (!firstRow || !firstRow.hasOwnProperty('track_code')) {
            resultsDiv.innerHTML = '<p class="text-red-500">–û—à–∏–±–∫–∞: –§–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∫–∞–∫ –º–∏–Ω–∏–º—É–º –∫–æ–ª–æ–Ω–∫—É <strong>track_code</strong>.</p>';
            hideLoader(); return;
        }
        console.log("[Import] Required columns found.");

        // --- –®–∞–≥ 3: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ ---
        resultsDiv.innerHTML = `<p class="text-blue-600">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ ${jsonData.length} –∑–∞–ø–∏—Å–µ–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏...</p>`;
        const dataToSend = jsonData.map(row => ({
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∫ —Å—Ç—Ä–æ–∫–µ, —É–¥–∞–ª—è–µ–º –ø—Ä–æ–±–µ–ª—ã, –±–µ—Ä–µ–º null –µ—Å–ª–∏ –ø–æ–ª–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
            full_name: String(row.full_name || '').trim() || null,
            phone: String(row.phone || '').trim() || null,
            // client_code –ø–µ—Ä–µ–¥–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å (—Å—Ç—Ä–æ–∫–æ–π), –±—ç–∫–µ–Ω–¥ —Ä–∞–∑–±–µ—Ä–µ—Ç
            client_code: row.client_code ? String(row.client_code).trim() : null
        })).filter(item => item.full_name && item.phone); // –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –±–µ–∑ –∏–º–µ–Ω–∏ –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞

        if (dataToSend.length === 0) {
             console.warn("[Import] No valid rows found after filtering.");
             resultsDiv.innerHTML = '<p class="text-yellow-600">–ù–µ –Ω–∞–π–¥–µ–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö —Å—Ç—Ä–æ–∫ —Å –§–ò–û –∏ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞.</p>';
             return;
        }
        console.log(`[Import] Prepared ${dataToSend.length} valid records for sending.`);

        // --- –®–∞–≥ 4: –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –ë–≠–ö–ï–ù–î ---
        resultsDiv.innerHTML = `<p class="text-blue-600 animate-pulse">–û—Ç–ø—Ä–∞–≤–∫–∞ ${dataToSend.length} –∑–∞–ø–∏—Å–µ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä... –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è.</p>`;
        const response = await apiFetch('/api/clients/bulk_import', {
            method: 'POST',
            body: JSON.stringify(dataToSend) // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤
        });
        console.log("[Import] Server response:", response);

        // --- –®–∞–≥ 5: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ ---
        let resultHtml = `<p class="text-green-600 font-semibold"><strong>–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω! –£—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ: ${response.created_clients || 0}</strong></p>`;
        // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ –¥—É–±–ª–∏–∫–∞—Ç–∞—Ö)
        if (response.warnings && response.warnings.length > 0) {
             resultHtml += `<p class="text-yellow-600 mt-2 font-semibold"><strong>–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (${response.warnings.length}):</strong></p><ul class="list-disc list-inside text-xs">${response.warnings.map(w => `<li>${w}</li>`).join('')}</ul>`;
        }
        // –î–æ–±–∞–≤–ª—è–µ–º –æ—à–∏–±–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
        if (response.errors && response.errors.length > 0) {
            resultHtml += `<p class="text-red-600 mt-2 font-semibold"><strong>–û—à–∏–±–∫–∏ (${response.errors.length}):</strong></p><ul class="list-disc list-inside text-xs">${response.errors.map(er => `<li>${er}</li>`).join('')}</ul>`;
        }
        resultsDiv.innerHTML = resultHtml; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ

        // --- –®–∞–≥ 6: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–µ ---
        if (response.created_clients > 0) {
             console.log("[Import] Refreshing client list...");
             await fetchAndRenderClients(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
        }

    } catch (error) { // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞ –∏–ª–∏ –∑–∞–ø—Ä–æ—Å–∞ –∫ API
        console.error("!!! [Import] handleClientExcelImport: CRITICAL ERROR", error);
        resultsDiv.innerHTML = `<p class="text-red-500"><b>–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞:</b> ${error.message}</p>`;
    } finally {
        hideLoader(); // –ü—Ä—è—á–µ–º –æ–±—â–∏–π –ª–æ–∞–¥–µ—Ä
        if (fileInput) fileInput.value = ''; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä —Ñ–∞–π–ª–∞ –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ
        console.log("[Import] handleClientExcelImport: End");
    }
}

// === –ö–û–ù–ï–¶ –ú–û–î–£–õ–Ø –ö–õ–ò–ï–ù–¢–´ ===

// =================================================================
// –ú–û–î–£–õ–¨: –ó–ê–ö–ê–ó–´ (–í–ª–∞–¥–µ–ª–µ—Ü) (v4.1 - Rebuild - –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è)
// =================================================================

companyOrders = []; // –ö—ç—à –¥–ª—è –∑–∞–∫–∞–∑–æ–≤ –∫–æ–º–ø–∞–Ω–∏–∏ (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ/—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏)
// let orderStatuses = ["–í –æ–±—Ä–∞–±–æ—Ç–∫–µ", ...]; // –£–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –≥–ª–æ–±–∞–ª—å–Ω–æ
// let availablePartyDates = []; // –£–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –≥–ª–æ–±–∞–ª—å–Ω–æ

// --- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –æ—Å–Ω–æ–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏ –ó–∞–∫–∞–∑–æ–≤ ---
// index.html (–ü–û–õ–ù–û–°–¢–¨–Æ –ó–ê–ú–ï–ù–Ø–ï–¢ renderOrdersTab)

async function renderOrdersTab() {
    console.log("[Render] renderOrdersTab: Start");
    const pane = document.getElementById('tab-orders');
    if (!pane) return;

    // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    try {
        const results = await Promise.allSettled([
            Promise.resolve(orderStatuses),
            (!availablePartyDates || availablePartyDates.length === 0) ? apiFetch('/api/orders/parties') : Promise.resolve(availablePartyDates),
            (!companyLocations || companyLocations.length === 0) ? apiFetch('/api/locations') : Promise.resolve(companyLocations)
        ]);
        if (results[0].status === 'fulfilled') orderStatuses = results[0].value;
        if (results[1].status === 'fulfilled') availablePartyDates = results[1].value;
        if (results[2].status === 'fulfilled') companyLocations = results[2].value;
    } catch (e) { console.warn("Error preloading data:", e); }

    // –§–∏–ª—å—Ç—Ä —Ñ–∏–ª–∏–∞–ª–æ–≤
    let locationFilterHtml = '';
    if (currentUser.role === '–í–ª–∞–¥–µ–ª–µ—Ü' && companyLocations && companyLocations.length > 1) {
        const locationOptions = companyLocations.map(loc => `<option value="${loc.id}" ${loc.id === currentUser.location_id ? 'selected' : ''}>${loc.name}</option>`).join('');
        locationFilterHtml = `
            <div class="p-2 bg-gray-100 rounded-md shadow-sm relative">
                <label class="text-xs font-medium text-gray-700 mr-2">–§–∏–ª–∏–∞–ª:</label>
                <select id="orders-location-filter" class="rounded-md border-gray-300 p-1.5 text-xs bg-white shadow-sm w-36">
                    <option value="">-- –í—Å–µ —Ñ–∏–ª–∏–∞–ª—ã --</option>${locationOptions}
                </select>
            </div>`;
    }

    // HTML
    pane.innerHTML = `
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[calc(100vh-140px)]">
        <div class="lg:col-span-1 space-y-6 overflow-y-auto pr-2 custom-scrollbar">
            <div class="bg-white p-6 rounded-lg shadow-md border">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</h2>
                <form id="add-order-form" class="space-y-4">
                    <div class="relative">
                        <label class="block text-sm font-medium text-gray-700">–ö–ª–∏–µ–Ω—Ç (–ø–æ–∏—Å–∫)</label>
                        <input type="text" id="order-client-search-input" autocomplete="off" placeholder="–ò–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ –∫–æ–¥..." class="mt-1 w-full p-2 border rounded focus:ring-indigo-500 focus:border-indigo-500">
                        <input type="hidden" id="order-selected-client-id">
                        <div id="order-client-search-results" class="absolute hidden top-full left-0 right-0 bg-white border mt-1 rounded-md shadow-lg z-20 max-h-48 overflow-y-auto"></div>
                    </div>
                    <div><label class="block text-sm font-medium text-gray-700">–¢—Ä–µ–∫-–∫–æ–¥</label><input type="text" id="order-track-code" class="mt-1 w-full p-2 border rounded" placeholder="–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –î–æ—Å—Ç–∞–≤–∫–∏"></div>
                    <div><label class="block text-sm font-medium text-gray-700">–î–∞—Ç–∞ –ü–∞—Ä—Ç–∏–∏</label><input type="date" id="order-party-date" class="mt-1 w-full p-2 border rounded"></div>
                    <div><label class="block text-sm font-medium text-gray-700">–¢–∏–ø –∑–∞–∫–∞–∑–∞</label><select id="order-purchase-type" required class="mt-1 w-full p-2 border rounded bg-white"><option value="–î–æ—Å—Ç–∞–≤–∫–∞" selected>–î–æ—Å—Ç–∞–≤–∫–∞</option><option value="–í—ã–∫—É–ø">–í—ã–∫—É–ø</option></select></div>
                    ${currentUser.role === '–í–ª–∞–¥–µ–ª–µ—Ü' && companyLocations.length > 0 ? `<div><label class="block text-sm font-medium text-gray-700">–§–∏–ª–∏–∞–ª *</label><select id="order-location-select" class="mt-1 w-full p-2 border rounded bg-white">${companyLocations.map(loc => `<option value="${loc.id}" ${loc.id === currentUser.location_id ? 'selected' : ''}>${loc.name}</option>`).join('')}</select></div>` : ''}
                    <div id="order-buyout-fields" class="hidden space-y-3 border-t pt-4 mt-4"><h4 class="text-sm font-semibold text-gray-600">–î–∞–Ω–Ω—ã–µ –¥–ª—è –≤—ã–∫—É–ø–∞:</h4><div><label class="block text-xs font-medium text-gray-600">–°—Ç–æ–∏–º–æ—Å—Ç—å (CNY)</label><input type="number" step="any" id="order-buyout-cost" class="mt-1 w-full p-2 border rounded text-sm"></div><div><label class="block text-xs font-medium text-gray-600">–ö—É—Ä—Å (—Å–æ–º/—é–∞–Ω—å)</label><input type="number" step="any" id="order-buyout-rate" class="mt-1 w-full p-2 border rounded text-sm"></div><div><label class="block text-xs font-medium text-gray-600">–ö–æ–º–∏—Å—Å–∏—è (%)</label><input type="number" step="1" id="order-buyout-commission" value="10" class="mt-1 w-full p-2 border rounded text-sm"></div></div>
                    <div><label class="block text-sm font-medium text-gray-700">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label><textarea id="order-comment" class="mt-1 w-full p-2 border rounded h-16" placeholder="–¶–≤–µ—Ç, —Ä–∞–∑–º–µ—Ä..."></textarea></div>
                    <button type="submit" class="w-full bg-green-600 text-white font-bold py-2 rounded hover:bg-green-700 transition-colors">–°–æ–∑–¥–∞—Ç—å –ó–∞–∫–∞–∑</button>
                </form>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md h-fit border">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">–ò–º–ø–æ—Ä—Ç –∑–∞–∫–∞–∑–æ–≤</h2>
                <div class="space-y-3 mb-4"><label class="block text-sm font-medium text-gray-700">–û–±—â–∞—è –î–∞—Ç–∞ –ø–∞—Ä—Ç–∏–∏</label><input type="date" id="import-order-party-date" class="mt-1 w-full p-2 border rounded"></div>
                ${currentUser.role === '–í–ª–∞–¥–µ–ª–µ—Ü' && companyLocations.length > 0 ? `<div class="space-y-3 mb-4"><label class="block text-sm font-medium text-gray-700">–í —Ñ–∏–ª–∏–∞–ª *</label><select id="import-location-select" class="mt-1 w-full p-2 border rounded bg-white">${companyLocations.map(loc => `<option value="${loc.id}" ${loc.id === currentUser.location_id ? 'selected' : ''}>${loc.name}</option>`).join('')}</select></div>` : ''}
                <input type="file" id="order-excel-input" accept=".xlsx, .xls" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 cursor-pointer"/> 
                <button id="import-orders-btn" class="mt-4 w-full bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700 transition-colors">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button> 
                <div id="order-import-results" class="mt-4 text-xs max-h-40 overflow-y-auto border p-2 bg-gray-50 rounded"></div>
            </div>
        </div>

        <div class="lg:col-span-2 bg-white rounded-lg shadow-md border flex flex-col h-full overflow-hidden">
            <div id="orders-action-header" class="bg-white p-4 border-b flex flex-col gap-3 z-10 shadow-sm">
                <div class="flex flex-wrap items-center gap-2">
                    <button id="orders-toggle-select-mode-btn" class="px-3 py-2 bg-gray-100 rounded-md shadow-sm font-bold text-indigo-600 hover:bg-indigo-100 text-sm transition-colors">‚úÖ –í—ã–±—Ä–∞—Ç—å</button>
                    <div class="relative"> <button id="orders-toggle-party-filter-btn" class="px-3 py-2 bg-gray-100 rounded-md shadow-sm font-bold text-indigo-600 hover:bg-indigo-100 text-sm transition-colors">üó≥Ô∏è –ü–∞—Ä—Ç–∏–∏</button> <div id="orders-party-filter-container" class="hidden absolute top-full mt-2 bg-white border rounded-lg shadow-xl p-3 w-72 z-30 flex flex-col gap-2"> <div class="bg-gray-50 p-2 rounded border"> <p class="text-xs text-gray-500 font-bold mb-1">–§–∏–ª—å—Ç—Ä —Å–ø–∏—Å–∫–∞:</p> <div class="flex items-center gap-1 mb-1"> <span class="text-xs text-gray-400">–°:</span> <input type="date" id="party-filter-date-from" class="w-full p-1 border rounded text-xs"> </div> <div class="flex items-center gap-1"> <span class="text-xs text-gray-400">–ü–æ:</span> <input type="date" id="party-filter-date-to" class="w-full p-1 border rounded text-xs"> </div> </div> <p class="font-semibold text-sm text-gray-700">–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä—Ç–∏–∏:</p> <div id="orders-party-list" class="space-y-1 max-h-60 overflow-y-auto mb-2 text-sm border-t border-b py-2"> –ó–∞–≥—Ä—É–∑–∫–∞... </div> <div class="flex gap-2"> <button id="orders-apply-party-filter" class="flex-1 bg-indigo-600 text-white text-xs py-1.5 rounded hover:bg-indigo-700">–û–∫</button> <button id="orders-reset-party-filter" class="flex-1 bg-gray-300 text-black text-xs py-1.5 rounded hover:bg-gray-400">–°–±—Ä–æ—Å</button> </div> </div> </div>
                    <div class="relative"> <button id="orders-toggle-status-filter-btn" class="px-3 py-2 bg-gray-100 rounded-md shadow-sm font-bold text-indigo-600 hover:bg-indigo-100 text-sm transition-colors">üü¢ –°—Ç–∞—Ç—É—Å—ã</button> <div id="orders-status-filter-container" class="hidden absolute top-full mt-2 bg-white border rounded-lg shadow-lg p-3 w-60 z-30"> <div id="orders-status-list" class="space-y-1 max-h-60 overflow-y-auto mb-2 text-sm">–ó–∞–≥—Ä—É–∑–∫–∞...</div> <div class="flex gap-2"> <button id="orders-apply-status-filter" class="flex-1 bg-indigo-600 text-white text-xs py-1.5 rounded hover:bg-indigo-700">–û–∫</button> <button id="orders-reset-status-filter" class="flex-1 bg-gray-300 text-black text-xs py-1.5 rounded hover:bg-gray-400">–°–±—Ä–æ—Å</button> </div> </div> </div>
                    <button id="open-manual-claim-btn" class="px-3 py-2 bg-yellow-100 border border-yellow-300 text-yellow-800 rounded-md shadow-sm font-bold hover:bg-yellow-200 text-sm transition-colors flex items-center gap-2">üôã‚Äç‚ôÇÔ∏è –†—É—á–Ω–æ–µ</button>
                    <button id="open-buyout-cart-btn" class="px-3 py-2 bg-purple-100 border border-purple-300 text-purple-800 rounded-md shadow-sm font-bold hover:bg-purple-200 text-sm transition-colors flex items-center gap-2">üí∞ –í—ã–∫—É–ø</button>
                    <button id="open-mass-track-btn" class="px-3 py-2 bg-blue-100 border border-blue-300 text-blue-800 rounded-md shadow-sm font-bold hover:bg-blue-200 text-sm transition-colors flex items-center gap-2">üìù –¢—Ä–µ–∫–∏</button>
                    ${locationFilterHtml} 
                    <div class="ml-auto flex gap-2">
                        <button id="orders-export-btn" class="px-3 py-2 bg-gray-100 rounded-md shadow-sm font-bold text-green-600 hover:bg-green-100 text-sm" title="–≠–∫—Å–ø–æ—Ä—Ç">üì•</button>
                        <button id="orders-calculate-btn" class="px-3 py-2 bg-gray-100 rounded-md shadow-sm font-bold text-blue-600 hover:bg-blue-100 text-sm" title="–†–∞—Å—Å—á–∏—Ç–∞—Ç—å">üßÆ</button>
                        <button id="refresh-orders-btn" title="–û–±–Ω–æ–≤–∏—Ç—å" class="text-xl text-gray-500 hover:text-indigo-600 px-2">&circlearrowright;</button>
                    </div>
                </div>
                <div class="w-full">
                    <input type="search" id="orders-search-input" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∫–ª–∏–µ–Ω—Ç—É, —Ç–µ–ª–µ—Ñ–æ–Ω—É, —Ç—Ä–µ–∫-–∫–æ–¥—É..." class="w-full p-2.5 border rounded-lg focus:ring-2 focus:ring-indigo-500 shadow-sm">
                </div>
                
                <div id="orders-bulk-action-bar" class="hidden p-2 bg-indigo-50 rounded border border-indigo-200 text-sm animate-fade-in">
                    <div class="flex items-center gap-3 flex-wrap"> 
                        <span id="orders-selected-count" class="font-bold text-indigo-700 text-sm">–í—ã–±—Ä–∞–Ω–æ: 0</span> 
                        
                        <div id="bulk-action-status-group" class="flex items-center gap-1">
                            <select id="orders-bulk-status-select" class="border-gray-300 rounded p-1 text-xs bg-white shadow-sm"></select> 
                            <button id="orders-bulk-update-status-btn" class="bg-indigo-600 text-white font-bold py-1 px-3 rounded text-xs hover:bg-indigo-700">–°—Ç–∞—Ç—É—Å</button> 
                        </div>

                        <div id="bulk-action-date-group" class="flex items-center gap-1">
                            <input type="date" id="orders-bulk-party-date-input" class="p-1 border rounded text-xs bg-white shadow-sm"> 
                            <button id="orders-bulk-update-date-btn" class="bg-orange-500 text-white font-bold py-1 px-3 rounded text-xs hover:bg-orange-600">–î–∞—Ç–∞</button> 
                        </div>
                        
                        <button id="orders-bulk-buyout-btn" class="hidden bg-purple-600 text-white font-bold py-1 px-3 rounded text-xs hover:bg-purple-700 shadow-sm">üí∞ –í—ã–∫—É–ø–∏—Ç—å</button> 
                        <button id="orders-bulk-assign-client-btn" class="bg-teal-600 text-white font-bold py-1 px-3 rounded text-xs hover:bg-teal-700 shadow-sm">üë§ –ö–ª–∏–µ–Ω—Ç</button> 
                        <button id="orders-bulk-delete-btn" class="ml-auto bg-red-600 text-white font-bold py-1 px-3 rounded text-xs hover:bg-red-700 shadow-sm">–£–¥–∞–ª–∏—Ç—å</button> 
                    </div>
                </div>

                <div id="orders-select-all-container" class="hidden flex items-center pt-2"> 
                    <input type="checkbox" id="orders-select-all-checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"> 
                    <label for="orders-select-all-checkbox" class="ml-2 text-sm font-bold text-gray-700 cursor-pointer">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ –≤–∏–¥–∏–º—ã–µ –∑–∞–∫–∞–∑—ã</label> 
                </div>
            </div>
            <div id="orders-list-container" class="flex-grow overflow-y-auto p-4 space-y-3 bg-gray-50 custom-scrollbar"> 
                <p class="text-gray-500 animate-pulse text-center mt-10">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</p> 
            </div>
        </div>
    </div>
    `;

    // --- –°–õ–£–®–ê–¢–ï–õ–ò –°–û–ë–´–¢–ò–ô ---
    const replaceAndListen = (id, event, handler) => {
        const el = document.getElementById(id);
        if (el) {
            const newEl = el.cloneNode(true);
            el.parentNode.replaceChild(newEl, el);
            newEl.addEventListener(event, handler);
        }
    };

    replaceAndListen('add-order-form', 'submit', handleAddOrderSubmit);
    replaceAndListen('order-client-search-input', 'input', handleOrderClientSearch);
    replaceAndListen('order-purchase-type', 'change', toggleOrderBuyoutFields);
    const today = new Date().toISOString().split('T')[0]; 
    if (document.getElementById('order-party-date')) document.getElementById('order-party-date').value = today;
    replaceAndListen('import-orders-btn', 'click', handleOrderExcelImport);
    replaceAndListen('refresh-orders-btn', 'click', fetchAndRenderOrders);
    replaceAndListen('orders-toggle-select-mode-btn', 'click', toggleOrdersSelectMode);
    replaceAndListen('orders-toggle-party-filter-btn', 'click', toggleOrdersPartyFilter);
    replaceAndListen('orders-toggle-status-filter-btn', 'click', toggleOrdersStatusFilter);
    replaceAndListen('orders-apply-party-filter', 'click', applyOrdersFiltersAndFetch);
    replaceAndListen('orders-reset-party-filter', 'click', resetOrdersPartyFilter);
    replaceAndListen('orders-apply-status-filter', 'click', applyOrdersFiltersAndFetch);
    replaceAndListen('orders-reset-status-filter', 'click', resetOrdersStatusFilter);
    replaceAndListen('orders-export-btn', 'click', handleExportOrders);
    replaceAndListen('orders-calculate-btn', 'click', openCalculateModal);
    replaceAndListen('orders-location-filter', 'change', fetchAndRenderOrders);
    replaceAndListen('open-manual-claim-btn', 'click', openManualClaimModal);
    setupUnclaimedFilterButton();
    setupAssignClientButton();
    replaceAndListen('orders-search-input', 'input', handleOrdersSearch);
    replaceAndListen('orders-select-all-checkbox', 'change', handleOrdersSelectAll);
    replaceAndListen('orders-bulk-update-status-btn', 'click', handleBulkUpdateStatus);
    replaceAndListen('orders-bulk-update-date-btn', 'click', handleBulkUpdatePartyDate);
    replaceAndListen('orders-bulk-delete-btn', 'click', handleBulkDeleteOrders);
    replaceAndListen('orders-bulk-buyout-btn', 'click', openBuyoutModal);
    replaceAndListen('open-buyout-cart-btn', 'click', handleOpenBuyoutCart);
    replaceAndListen('open-mass-track-btn', 'click', handleOpenMassTracks);

    // –°–ø–∏—Å–æ–∫ (–î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)
    const listContainer = document.getElementById('orders-list-container');
    if (listContainer) {
         const newListContainer = listContainer.cloneNode(false);
         listContainer.parentNode.replaceChild(newListContainer, listContainer);
         newListContainer.innerHTML = '<p class="text-gray-500 animate-pulse text-center mt-10">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</p>';
         
         // !!! –í–ê–ñ–ù–û: –£–±–µ–¥–∏—Å—å, —á—Ç–æ handleOrderCheckboxChange - —ç—Ç–æ –ù–û–í–ê–Ø –≤–µ—Ä—Å–∏—è
         newListContainer.addEventListener('change', handleOrderCheckboxChange); 
         newListContainer.addEventListener('click', handleOrderListClick);
    }

    populateStatusFilter(); 
    populatePartyFilter(); 
    await fetchAndRenderOrders();
}


// –†–µ–Ω–¥–µ—Ä–∏—Ç HTML –¥–ª—è –û–î–ù–û–ì–û –∑–∞–∫–∞–∑–∞ –≤ —Å–ø–∏—Å–∫–µ (–±–µ–∑ –æ–±–µ—Ä—Ç–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞)
function renderOrderListItem(order) {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–ª—É—á–∞–π –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞ (–º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ –ø–æ—Å–ª–µ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏)
    const client = order.client || { full_name: '?', phone: '?', client_code_prefix: '', client_code_num: '?' };
    const clientCode = `${client.client_code_prefix || ''}${client.client_code_num || '?'}`;
    const statusColor = getStatusColor(order.status); // –ü–æ–ª—É—á–∞–µ–º —Ü–≤–µ—Ç –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞

    // Data-–∞—Ç—Ä–∏–±—É—Ç—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ —ç—Ç–æ–º—É –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –∑–∞–∫–∞–∑—É
    const itemSearchData = `
         data-track="${order.track_code?.toLowerCase() || ''}"
         data-client-name="${client.full_name?.toLowerCase() || ''}"
         data-client-phone="${client.phone || ''}"
         data-client-code="${clientCode.toLowerCase()}"
         data-comment="${(order.comment || '').toLowerCase()}"
     `;

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML —Å–∞–º–æ–≥–æ –∑–∞–∫–∞–∑–∞
    return `
        <div class="order-list-item border rounded-lg p-3 hover:bg-gray-50 transition-colors duration-100 shadow-sm" ${itemSearchData}>
            <div class="flex flex-wrap justify-between items-start gap-2 mb-2">
                 <div class="flex items-center gap-3">
                      <input type="checkbox" data-order-id="${order.id}" class="order-checkbox hidden h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                      <div>
                           <span class="font-bold text-md text-gray-800 break-all">${order.track_code || 'N/A'}</span>
                           <span class="ml-2 px-2 py-0.5 rounded-full text-xs font-semibold ${statusColor}">${order.status || '?'}</span>
                      </div>
                 </div>
                 ${order.party_date ? `<span class="text-xs text-gray-500 font-medium">${order.party_date}</span>` : ''}
            </div>

            <div class="text-xs text-gray-700 space-y-1 pl-8">
                ${order.comment ? `<p><strong class="font-medium">–ö–æ–º–º–µ–Ω—Ç:</strong> ${order.comment}</p>` : ''}
                ${order.purchase_type === '–í—ã–∫—É–ø' ? `
                    <p class="text-purple-700"><strong class="font-medium">–í—ã–∫—É–ø:</strong> ${order.buyout_item_cost_cny || '?'} CNY | –ö—É—Ä—Å(–ö): ${order.buyout_rate_for_client || '?'} | –ö–æ–º: ${order.buyout_commission_percent}% ${order.buyout_actual_rate ? `| –ö—É—Ä—Å(–†): ${order.buyout_actual_rate}` : ''}</p>
                ` : ''}
                ${order.calculated_final_cost_som ? `<p class="text-blue-700 font-semibold"><strong class="font-medium">–†–∞—Å—á–µ—Ç:</strong> ${order.calculated_final_cost_som.toFixed(0)} —Å–æ–º (${order.calculated_weight_kg || '?'} –∫–≥ @ ${order.calculated_price_per_kg_usd || '?'} USD, ${order.calculated_exchange_rate_usd || '?'} —Å–æ–º/USD)</p>` : ''}
                 ${order.status === '–í—ã–¥–∞–Ω' && order.issued_at ? `<p class="text-green-700 font-bold"><strong class="font-medium">–í—ã–¥–∞–Ω (${new Date(order.issued_at).toLocaleDateString()}):</strong> ${order.final_cost_som?.toFixed(0) || '?'} —Å–æ–º (${order.weight_kg || '?'} –∫–≥)</p>` : ''}
            </div>

             <div class="mt-2 flex justify-end">
                <button data-order-id="${order.id}" class="edit-order-btn text-xs bg-gray-200 hover:bg-gray-300 text-gray-800 px-2 py-1 rounded transition-colors duration-150">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
             </div>
        </div>
    `;
}

// --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è CSS –∫–ª–∞—Å—Å–æ–≤ —Ü–≤–µ—Ç–∞ —Å—Ç–∞—Ç—É—Å–∞ ---
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫—É —Å Tailwind CSS –∫–ª–∞—Å—Å–∞–º–∏ –¥–ª—è —Ñ–æ–Ω–∞ –∏ —Ç–µ–∫—Å—Ç–∞
function getStatusColor(status) {
    switch (status) {
        case '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ':
            return 'bg-gray-100 text-gray-800'; // –°–µ—Ä—ã–π
        case '–û–∂–∏–¥–∞–µ—Ç –≤—ã–∫—É–ø–∞':
            return 'bg-yellow-100 text-yellow-800'; // –ñ–µ–ª—Ç—ã–π
        case '–í—ã–∫—É–ø–ª–µ–Ω':
            return 'bg-purple-100 text-purple-800'; // –§–∏–æ–ª–µ—Ç–æ–≤—ã–π
        case '–ù–∞ —Å–∫–ª–∞–¥–µ –≤ –ö–∏—Ç–∞–µ':
            return 'bg-orange-100 text-orange-800'; // –û—Ä–∞–Ω–∂–µ–≤—ã–π
        case '–í –ø—É—Ç–∏':
            return 'bg-blue-100 text-blue-800'; // –°–∏–Ω–∏–π
        case '–ù–∞ —Å–∫–ª–∞–¥–µ –≤ –ö–†':
            return 'bg-teal-100 text-teal-800'; // –ë–∏—Ä—é–∑–æ–≤—ã–π
        case '–ì–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ':
            return 'bg-lime-100 text-lime-800'; // –õ–∞–π–º–æ–≤—ã–π
        case '–í—ã–¥–∞–Ω':
            return 'bg-green-100 text-green-800'; // –ó–µ–ª–µ–Ω—ã–π
        default: // –î–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤
            return 'bg-gray-100 text-gray-800';
    }
}


// --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ñ–æ—Ä–º—ã –î–æ–±–∞–≤–ª–µ–Ω–∏—è –ó–∞–∫–∞–∑–∞ ---

// –ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ (—Å debounce)
function handleOrderClientSearch(e) {
    const input = e.target; // –ü–æ–ª–µ –≤–≤–æ–¥–∞, –∫—É–¥–∞ –ø–µ—á–∞—Ç–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    const resultsDiv = document.getElementById('order-client-search-results'); // Div –¥–ª—è –ø–æ–∫–∞–∑–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    const selectedClientIdInput = document.getElementById('order-selected-client-id'); // –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è ID
    const searchTerm = input.value; // –¢–µ–∫—Å—Ç, –≤–≤–µ–¥–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º

    // –ï—Å–ª–∏ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞ –ø—É—Å—Ç–æ–µ –∏–ª–∏ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ, —Å–∫—Ä—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º ID
    if (!searchTerm || searchTerm.length < 1) { // –ò—â–µ–º —Ö–æ—Ç—è –±—ã –æ—Ç 1 —Å–∏–º–≤–æ–ª–∞
        if(resultsDiv) resultsDiv.innerHTML = '';
        if(resultsDiv) resultsDiv.classList.add('hidden');
        if(selectedClientIdInput) selectedClientIdInput.value = ''; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º ID –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
        return; // –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏
    }

    // --- –ú–µ—Ö–∞–Ω–∏–∑–º "Debounce" ---
    // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –ø–µ—á–∞—Ç–∞—Ç—å
    clearTimeout(input.debounceTimer);
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π —Ç–∞–π–º–µ—Ä: –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–∏—Å–∫ —á–µ—Ä–µ–∑ 300 –º—Å –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π –Ω–∞–∂–∞—Ç–æ–π –∫–ª–∞–≤–∏—à–∏
    input.debounceTimer = setTimeout(async () => {
        console.log(`[Client Search] Searching for: "${searchTerm}"`);
        if(!resultsDiv || !selectedClientIdInput) return; // –î–æ–ø. –ø—Ä–æ–≤–µ—Ä–∫–∞

        resultsDiv.innerHTML = '<div class="p-2 text-sm text-gray-500 animate-pulse">–ü–æ–∏—Å–∫...</div>'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–æ–∏—Å–∫–∞
        resultsDiv.classList.remove('hidden'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

        try {
            // –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ API –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤
            const clients = await apiFetch(`/api/clients/search?q=${encodeURIComponent(searchTerm)}`);
            console.log(`[Client Search] Found ${clients.length} clients.`);

            if (clients.length > 0) {
                // –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç—ã –Ω–∞–π–¥–µ–Ω—ã, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –¥–ª—è —Å–ø–∏—Å–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                 resultsDiv.innerHTML = clients.map(c => `
                    <div class="p-2 hover:bg-gray-100 cursor-pointer text-sm search-result-item"
                         data-client-id="${c.id}"
                         data-client-name="${c.full_name} (${c.client_code_prefix || ''}${c.client_code_num || '–ù–µ—Ç –∫–æ–¥–∞'})">
                        ${c.full_name} (${c.client_code_prefix || ''}${c.client_code_num || '–ù–µ—Ç –∫–æ–¥–∞'}) - ${c.phone}
                    </div>
                 `).join('');

                 // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–∞ –Ω–∞ –∫–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                 resultsDiv.querySelectorAll('.search-result-item').forEach(item => {
                     item.addEventListener('click', () => {
                         const clientId = item.dataset.clientId;
                         const clientName = item.dataset.clientName;
                         console.log(`[Client Search] Client selected: ID=${clientId}, Name=${clientName}`);
                         input.value = clientName; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∏–º—è –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
                         selectedClientIdInput.value = clientId; // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –∫–ª–∏–µ–Ω—Ç–∞ –≤ —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ
                         resultsDiv.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                         resultsDiv.classList.add('hidden'); // –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                     });
                 });
            } else {
                 // –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
                 resultsDiv.innerHTML = '<div class="p-2 text-sm text-gray-500">–ö–ª–∏–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</div>';
            }
        } catch (error) { // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ
             console.error("[Client Search] Error:", error);
             resultsDiv.innerHTML = `<div class="p-2 text-sm text-red-500">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: ${error.message}</div>`;
        }
    }, 300); // –ó–∞–¥–µ—Ä–∂–∫–∞ debounce –≤ 300 –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥
}

// –ü–æ–∫–∞–∑–∞—Ç—å/–°–∫—Ä—ã—Ç—å –ø–æ–ª—è –í—ã–∫—É–ø–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ —Ç–∏–ø–∞ –∑–∞–∫–∞–∑–∞ –≤ —Ñ–æ—Ä–º–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
function toggleOrderBuyoutFields(e) {
    const purchaseType = e.target.value; // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–∏–ø ("–î–æ—Å—Ç–∞–≤–∫–∞" –∏–ª–∏ "–í—ã–∫—É–ø")
    const buyoutFieldsDiv = document.getElementById('order-buyout-fields'); // –ù–∞—Ö–æ–¥–∏–º div —Å –ø–æ–ª—è–º–∏ –≤—ã–∫—É–ø–∞

    if (!buyoutFieldsDiv) return; // –í—ã—Ö–æ–¥–∏–º, –µ—Å–ª–∏ div –Ω–µ –Ω–∞–π–¥–µ–Ω

    if (purchaseType === '–í—ã–∫—É–ø') {
        console.log("[Add Order Form] Purchase type changed to '–í—ã–∫—É–ø'. Showing buyout fields.");
        buyoutFieldsDiv.classList.remove('hidden'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—è
    } else {
        console.log("[Add Order Form] Purchase type changed to '–î–æ—Å—Ç–∞–≤–∫–∞'. Hiding buyout fields.");
        buyoutFieldsDiv.classList.add('hidden'); // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª—è
    }
}

// --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –†–µ–Ω–¥–µ—Ä–∏—Ç —Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ (–ê–ö–ö–û–†–î–ï–û–ù + –ì–†–£–ü–ü–û–í–´–ï –ì–ê–õ–û–ß–ö–ò) ---
function renderOrderListFromCache() {
    console.log("[Render Cache] renderOrderListFromCache: Start");
    const listContainer = document.getElementById('orders-list-container');
    if (!listContainer) return console.error("!!! listContainer not found!");

    const orders = companyOrders;

    if (!orders || orders.length === 0) {
        listContainer.innerHTML = '<p class="text-gray-500 text-center py-10">–ó–∞–∫–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>';
    } else {
        // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞
        const groupedOrders = orders.reduce((acc, order) => {
            const clientId = order.client?.id || 'unknown';
            if (!acc[clientId]) {
                acc[clientId] = { client: order.client, orders: [] };
            }
            acc[clientId].orders.push(order);
            return acc;
        }, {});

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥
        listContainer.innerHTML = Object.values(groupedOrders).map(group => {
            group.orders.sort((a, b) => b.id - a.id);
            
            const client = group.client || { full_name: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–ª–∏–µ–Ω—Ç', phone: '', client_code_prefix: '', client_code_num: '' };
            const clientCode = `${client.client_code_prefix || ''}${client.client_code_num || '?'}`;
            const clientId = client.id || 'unk';
            
            const ordersHtml = group.orders.map(o => renderOrderListItem(o)).join('');
            
            const groupSearchData = `
                data-client-name="${client.full_name?.toLowerCase() || ''}"
                data-client-phone="${client.phone || ''}"
                data-client-code="${clientCode.toLowerCase()}"
                data-tracks="${group.orders.map(o => o.track_code?.toLowerCase() || '').join(' ')}"
            `;

            return `
                <div class="client-order-group border rounded-lg mb-3 shadow-sm bg-white overflow-hidden" ${groupSearchData}>
                    <div class="bg-gray-50 p-3 flex justify-between items-center cursor-pointer hover:bg-gray-100 transition-colors"
                         onclick="toggleOrderGroup('group-${clientId}', this)">
                         
                         <div class="flex items-center gap-3">
                            <input type="checkbox" class="client-group-checkbox h-5 w-5 rounded border-gray-400 text-indigo-600 focus:ring-indigo-500 hidden"
                                   onclick="event.stopPropagation(); toggleClientGroupSelection(this, 'group-${clientId}')">
                            
                            <div class="arrow-icon transform transition-transform duration-200 text-gray-400">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                            <div>
                                <p class="font-bold text-gray-800 text-sm sm:text-base">${client.full_name} <span class="text-indigo-600">(${clientCode})</span></p>
                                <p class="text-xs text-gray-500">${client.phone || ''}</p>
                            </div>
                         </div>
                         
                         <span class="bg-indigo-100 text-indigo-800 text-xs font-bold px-2 py-1 rounded-full">
                            ${group.orders.length} –∑–∞–∫.
                         </span>
                    </div>

                    <div id="group-${clientId}" class="hidden border-t border-gray-100 bg-white">
                        <div class="p-2 space-y-2 bg-gray-50/50">
                             ${ordersHtml}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    hideBulkActionBar(); // –ü—Ä–∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∏—Å–∫, –µ—Å–ª–∏ –±—ã–ª
    const searchInput = document.getElementById('orders-search-input');
    if (searchInput && searchInput.value) {
        handleOrdersSearch({ target: searchInput });
    }
    
    // –í–∞–∂–Ω–æ: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –≥—Ä—É–ø–ø–æ–≤—ã–µ –≥–∞–ª–æ—á–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
    toggleOrdersSelectMode(true); // true = —Ç–æ–ª—å–∫–æ –æ–±–Ω–æ–≤–∏—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç—å, –Ω–µ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞ (–ó–∞–∫–∞–∑—ã)
function toggleOrderGroup(groupId, headerElement) {
    const listDiv = document.getElementById(groupId);
    const arrow = headerElement.querySelector('svg').parentElement;
    
    if (listDiv.classList.contains('hidden')) {
        listDiv.classList.remove('hidden'); // –ü–æ–∫–∞–∑–∞—Ç—å
        arrow.classList.add('rotate-180');  // –ü–æ–≤–µ—Ä–Ω—É—Ç—å —Å—Ç—Ä–µ–ª–∫—É
    } else {
        listDiv.classList.add('hidden');    // –°–∫—Ä—ã—Ç—å
        arrow.classList.remove('rotate-180'); // –í–µ—Ä–Ω—É—Ç—å —Å—Ç—Ä–µ–ª–∫—É
    }
}

// --- –ò–ó–ú–ï–ù–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∑–∞–∫–∞–∑—ã —Å API –∏ –≤—ã–∑—ã–≤–∞–µ—Ç renderOrderListFromCache ---
async function fetchAndRenderOrders(filters = {}) {
    console.log("[Fetch] fetchAndRenderOrders: Start");
    const listContainer = document.getElementById('orders-list-container');
    if (!listContainer) return console.error("!!! fetchAndRenderOrders: listContainer #orders-list-container not found!");
    listContainer.innerHTML = '<p class="text-gray-500 animate-pulse">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</p>';
    showLoader();

    // –°–æ–±–∏—Ä–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –∏–∑ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    const params = new URLSearchParams();

    // --- –î–û–ë–ê–í–ò–¢–¨ –≠–¢–û–¢ –ë–õ–û–ö ---
    // –î–æ–±–∞–≤–ª—è–µ–º ID –∫–æ–º–ø–∞–Ω–∏–∏ –í –õ–Æ–ë–û–ú –°–õ–£–ß–ê–ï (–æ–Ω –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –Ω–∞ –±—ç–∫–µ–Ω–¥–µ)
    if (currentCompany && currentCompany.id) {
        params.append('company_id', currentCompany.id);
        console.log("[Fetch Orders] –î–æ–±–∞–≤–ª–µ–Ω company_id:", currentCompany.id);
    } else if (currentUser && !currentUser.is_super_admin) {
        // –ï—Å–ª–∏ currentCompany –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω (–º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ –¥–ª—è –í–ª–∞–¥–µ–ª—å—Ü–∞/–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∞, –Ω–æ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
        console.error("!!! [Fetch Orders] –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –∫–æ–º–ø–∞–Ω–∏–∏ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –∑–∞–∫–∞–∑–æ–≤!");
        listContainer.innerHTML = '<p class="text-red-500">–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –∫–æ–º–ø–∞–Ω–∏–∏.</p>';
        hideLoader();
        return; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
    }
    // --- –ö–û–ù–ï–¶ –î–û–ë–ê–í–õ–ï–ù–ò–Ø ---

    // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ –¥–∞—Ç–∞–º
    const selectedParties = Array.from(document.querySelectorAll('#orders-party-list input:checked')).map(cb => cb.value);
    selectedParties.forEach(date => params.append('party_dates', date));

    // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
    const selectedStatuses = Array.from(document.querySelectorAll('#orders-status-list input:checked')).map(cb => cb.value);
    selectedStatuses.forEach(status => params.append('statuses', status));

    // –ï—Å–ª–∏ —Ñ–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º –ø—É—Å—Ç –ò —ç—Ç–æ –Ω–µ –°—É–ø–µ—Ä–ê–¥–º–∏–Ω (—Ç.–µ. –æ–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å CRM)
    // —Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "–í—ã–¥–∞–Ω"
    if (selectedStatuses.length === 0 && currentUser && !currentUser.is_super_admin && orderStatuses.length > 0) {
        orderStatuses.filter(s => s !== '–í—ã–¥–∞–Ω').forEach(status => params.append('statuses', status));
    }

    if (filterUnclaimedOnly) {
        params.append('unclaimed_only', 'true');
    }

    // –ü–µ—Ä–µ–¥–∞—á–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ location_id –¥–ª—è –í–ª–∞–¥–µ–ª—å—Ü–∞
    if (currentUser.role === '–í–ª–∞–¥–µ–ª–µ—Ü') {
        const locationFilterSelect = document.getElementById('orders-location-filter');
        if (locationFilterSelect && locationFilterSelect.value) {
            params.append('location_id', locationFilterSelect.value);
            console.log("[Fetch Orders] Filtering by location_id:", locationFilterSelect.value);
        } else {
             console.log("[Fetch Orders] Owner viewing all locations.");
        }
    }

    const url = `/api/orders?${params.toString()}`;
    console.log("[Fetch] fetchAndRenderOrders: Requesting with params:", params.toString());

    try {
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∑–∞–∫–∞–∑—ã
        const orders = await apiFetch(url);
        companyOrders = orders; // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –Ω–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞
        console.log("[Fetch] fetchAndRenderOrders: Received and cached orders:", orders.length);

        // –í–´–ó–´–í–ê–ï–ú –ù–û–í–£–Æ –§–£–ù–ö–¶–ò–Æ –î–õ–Ø –†–ï–ù–î–ï–†–ò–ù–ì–ê –ò–ó –ö–≠–®–ê
        renderOrderListFromCache();

    } catch (e) {
        console.error("!!! [Fetch] fetchAndRenderOrders: Error", e);
        listContainer.innerHTML = `<p class="text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –∑–∞–∫–∞–∑–æ–≤: ${e.message}</p>`;
        companyOrders = []; // –û—á–∏—â–∞–µ–º –∫—ç—à –ø—Ä–∏ –æ—à–∏–±–∫–µ
    } finally {
        hideLoader();
        console.log("[Fetch] fetchAndRenderOrders: End");
    }
}


// --- –ò–ó–ú–ï–ù–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ ---
async function handleAddOrderSubmit(e) {
    e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã
    console.log("[Add Order] handleAddOrderSubmit: Start");
    showLoader(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏

    // –ü–æ–ª—É—á–∞–µ–º ID –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ —Å–∫—Ä—ã—Ç–æ–≥–æ –ø–æ–ª—è
    const clientId = document.getElementById('order-selected-client-id')?.value;
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–±—Ä–∞–Ω –ª–∏ –∫–ª–∏–µ–Ω—Ç
    if (!clientId) {
        hideLoader(); // –ü—Ä—è—á–µ–º –ª–æ–∞–¥–µ—Ä –ø–µ—Ä–µ–¥ alert
        alert('–û—à–∏–±–∫–∞: –ö–ª–∏–µ–Ω—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω –∏–∑ –ø–æ–∏—Å–∫–∞.');
        console.warn("[Add Order] Submit failed: Client not selected.");
        return; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
    }

    // –°—á–∏—Ç—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã
    let track_code = document.getElementById('order-track-code')?.value.trim(); // –°—á–∏—Ç—ã–≤–∞–µ–º —Ç—Ä–µ–∫-–∫–æ–¥ –∏ —É–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã
    const purchase_type = document.getElementById('order-purchase-type')?.value; // –ü–æ–ª—É—á–∞–µ–º —Ç–∏–ø –∑–∞–∫–∞–∑–∞
    const party_date = document.getElementById('order-party-date')?.value || null; // –î–∞—Ç–∞ –ø–∞—Ä—Ç–∏–∏ (–∏–ª–∏ null, –µ—Å–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞)
    const comment = document.getElementById('order-comment')?.value.trim() || null; // –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–∏–ª–∏ null, –µ—Å–ª–∏ –ø—É—Å—Ç–æ–π)

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ç—Ä–µ–∫-–∫–æ–¥, –µ—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ –ò —Ç–∏–ø –∑–∞–∫–∞–∑–∞ "–í—ã–∫—É–ø"
    if (!track_code && purchase_type === '–í—ã–∫—É–ø') {
        const timestamp = Date.now(); // –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
        track_code = `PENDING-${timestamp}`; // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–¥ –≤–∏–¥–∞ PENDING-1678886400000
        console.log("[Add Order] –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ç—Ä–µ–∫-–∫–æ–¥ –¥–ª—è –≤—ã–∫—É–ø–∞:", track_code);
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ç—Ä–µ–∫-–∫–æ–¥ –ü–û–°–õ–ï –≤–æ–∑–º–æ–∂–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    if (!track_code) {
        hideLoader();
        alert("–¢—Ä–µ–∫-–∫–æ–¥ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è (–¥–ª—è —Ç–∏–ø–∞ '–î–æ—Å—Ç–∞–≤–∫–∞').");
        console.warn("[Add Order] Submit failed: Track code is missing for '–î–æ—Å—Ç–∞–≤–∫–∞'.");
        return; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º
    }

    // –°–æ–±–∏—Ä–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π payload
    const payload = {
       client_id: parseInt(clientId),
       track_code: track_code,
       party_date: party_date,
       purchase_type: purchase_type,
       comment: comment,
       company_id: currentCompany.id, // <-- –î–û–ë–ê–í–¨ –≠–¢–£ –°–¢–†–û–ö–£
       // location_id –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∏–∂–µ
    };

    // –î–æ–±–∞–≤–ª—è–µ–º location_id –¥–ª—è –í–ª–∞–¥–µ–ª—å—Ü–∞
    if (currentUser.role === '–í–ª–∞–¥–µ–ª–µ—Ü') {
        const locationSelect = document.getElementById('order-location-select');
        if (locationSelect && locationSelect.value) {
            payload.location_id = parseInt(locationSelect.value);
        } else if (currentUser.location_id) {
             payload.location_id = currentUser.location_id;
        } else {
             console.warn("[Add Order] Owner location_id could not be determined.");
        }
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—è –≤—ã–∫—É–ø–∞, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    if (payload.purchase_type === '–í—ã–∫—É–ø') {
        payload.buyout_item_cost_cny = parseFloat(document.getElementById('order-buyout-cost')?.value) || null;
        payload.buyout_rate_for_client = parseFloat(document.getElementById('order-buyout-rate')?.value) || null;
        payload.buyout_commission_percent = parseFloat(document.getElementById('order-buyout-commission')?.value) || 10.0;
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    console.log("[Add Order] Sending payload to server:", payload);
    try {
        const newOrder = await apiFetch('/api/orders', {
            method: 'POST',
            body: JSON.stringify(payload)
        });
        console.log("[Add Order] Server response (new order):", newOrder);
        alert(`–ó–∞–∫–∞–∑ #${newOrder.id} (${newOrder.track_code}) —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!`);

        const addOrderForm = document.getElementById('add-order-form');
        if(addOrderForm) addOrderForm.reset();

        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º/–æ—á–∏—â–∞–µ–º –ø–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è –º–µ—Ç–æ–¥–æ–º reset()
        const clientSearchInput = document.getElementById('order-client-search-input');
        if (clientSearchInput) clientSearchInput.value = '';
        const selectedClientIdInput = document.getElementById('order-selected-client-id');
        if (selectedClientIdInput) selectedClientIdInput.value = '';
        const buyoutFieldsDiv = document.getElementById('order-buyout-fields');
        if (buyoutFieldsDiv) buyoutFieldsDiv.classList.add('hidden');
        console.log("[Add Order] Form reset complete.");

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –ø–∞—Ä—Ç–∏–∏ –ø–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞
        const today = new Date().toISOString().split('T')[0];
        const partyDateInput = document.getElementById('order-party-date');
        if (partyDateInput) partyDateInput.value = today;
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä —Ñ–∏–ª–∏–∞–ª–∞ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∏–ª–∏–∞–ª –í–ª–∞–¥–µ–ª—å—Ü–∞ (–µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å)
        const locationSelect = document.getElementById('order-location-select');
        if (locationSelect && currentUser.location_id) {
             locationSelect.value = currentUser.location_id;
        }

        // --- –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨ ---
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑ –í –ù–ê–ß–ê–õ–û –∫—ç—à–∞
        companyOrders.unshift(newOrder); // newOrder - —ç—Ç–æ –æ—Ç–≤–µ—Ç –æ—Ç –±—ç–∫–µ–Ω–¥–∞
        console.log("[Add Order] –ù–æ–≤—ã–π –∑–∞–∫–∞–∑ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫—ç—à companyOrders.");

        // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –ò–ó –û–ë–ù–û–í–õ–ï–ù–ù–û–ì–û –ö–≠–®–ê
        renderOrderListFromCache();
        console.log("[Add Order] –°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞–Ω –∏–∑ –∫—ç—à–∞.");

        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∞—Ç—ã –ø–∞—Ä—Ç–∏–π (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π, –µ—Å–ª–∏ —ç—Ç–æ –±—ã–ª–∞ –Ω–æ–≤–∞—è –¥–∞—Ç–∞)
        try {
            availablePartyDates = await apiFetch('/api/orders/parties');
            populatePartyFilter(); // –û–±–Ω–æ–≤–ª—è–µ–º HTML —Ñ–∏–ª—å—Ç—Ä–∞ –¥–∞—Ç
            console.log("[Add Order] –§–∏–ª—å—Ç—Ä –¥–∞—Ç –ø–∞—Ä—Ç–∏–π –æ–±–Ω–æ–≤–ª–µ–Ω.");
        } catch(partyError) {
            console.warn("[Add Order] –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞—Ç—ã –ø–∞—Ä—Ç–∏–π –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞:", partyError);
        }
        // --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–Ø ---

    } catch (err) {
        console.error("!!! [Add Order] –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞:", err);
        alert(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞: ${err.message}`);
    } finally {
        hideLoader();
        console.log("[Add Order] handleAddOrderSubmit: End");
    }
}

// === –ö–û–ù–ï–¶ –§–£–ù–ö–¶–ò–ô –î–õ–Ø –§–û–†–ú–´ –î–û–ë–ê–í–õ–ï–ù–ò–Ø –ó–ê–ö–ê–ó–ê ===

// --- –ù–û–í–´–ô –ë–õ–û–ö: –õ–æ–≥–∏–∫–∞ –¥–ª—è "–ù–µ–≤–æ—Å—Ç—Ä–µ–±–æ–≤–∞–Ω–Ω—ã—Ö" –∑–∞–∫–∞–∑–æ–≤ ---

// –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Ñ–ª–∞–≥ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞
let filterUnclaimedOnly = false;

// –§–∏–ª—å—Ç—Ä "–ù–µ–≤–æ—Å—Ç—Ä–µ–±–æ–≤–∞–Ω–Ω—ã–µ"
// –§–∏–ª—å—Ç—Ä "–ù–µ–≤–æ—Å—Ç—Ä–µ–±–æ–≤–∞–Ω–Ω—ã–µ"
function setupUnclaimedFilterButton() {
     const btn = document.getElementById('orders-filter-unclaimed-btn');
     if (btn) {
         btn.replaceWith(btn.cloneNode(true)); // –û—á–∏—Å—Ç–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª—è
         // –ò–°–ü–†–ê–í–õ–ï–ù–û: –¢–µ–ø–µ—Ä—å –º—ã –≤—ã–∑—ã–≤–∞–µ–º handleFilterUnclaimed
         document.getElementById('orders-filter-unclaimed-btn').addEventListener('click', handleFilterUnclaimed);
         console.log("[Listener OK] Added click to #orders-filter-unclaimed-btn via setup function.");
     }
}


// –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–Ω–∞—á–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞"
function setupAssignClientButton() {
     const btn = document.getElementById('orders-bulk-assign-client-btn');
     if(btn) {
         btn.replaceWith(btn.cloneNode(true));
         document.getElementById('orders-bulk-assign-client-btn').addEventListener('click', openAssignClientModal);
     }
}

// –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ "–ù–∞–∑–Ω–∞—á–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞"
function openAssignClientModal() {
    const selectedIds = Array.from(document.querySelectorAll('.order-checkbox:checked')).map(cb => cb.dataset.orderId);
    if (selectedIds.length === 0) {
        alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∑–∞–∫–∞–∑—ã –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è.");
        return;
    }

    // –°–±—Ä–æ—Å –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    document.getElementById('assign-client-info').textContent = `–í—ã–±—Ä–∞–Ω–æ –∑–∞–∫–∞–∑–æ–≤: ${selectedIds.length}`;
    document.getElementById('assign-client-search-input').value = '';
    document.getElementById('assign-client-search-results').innerHTML = '';
    document.getElementById('assign-client-selected-id').value = '';
    document.getElementById('assign-client-selected-info').classList.add('hidden');
    document.getElementById('assign-client-save-btn').disabled = true;

    // --- –ù–û–í–´–ô –ö–û–î: –ó–∞–ø–æ–ª–Ω—è–µ–º select —Å—Ç–∞—Ç—É—Å–æ–≤ ---
        const statusSelect = document.getElementById('assign-client-new-status');
        if (statusSelect) {
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –≤—Å–µ–º–∏ —Å—Ç–∞—Ç—É—Å–∞–º–∏, –∫—Ä–æ–º–µ "–í—ã–¥–∞–Ω" (—Ç.–∫. –º—ã –Ω–∞–∑–Ω–∞—á–∞–µ–º, –∞ –Ω–µ –≤—ã–¥–∞–µ–º)
            statusSelect.innerHTML = orderStatuses
                .filter(s => s !== '–í—ã–¥–∞–Ω')
                .map(s => `<option value="${s}" ${s === '–í –ø—É—Ç–∏' ? 'selected' : ''}>${s}</option>`)
                .join('');
            // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—ã–±–∏—Ä–∞–µ–º "–í –ø—É—Ç–∏", –∫–∞–∫ —Ç—ã –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–ª
        }
        // --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ö–û–î–ê ---

    // –ü—Ä–∏–≤—è–∑–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª–µ–π
    const searchInput = document.getElementById('assign-client-search-input');
    const searchResults = document.getElementById('assign-client-search-results');
    const selectedIdInput = document.getElementById('assign-client-selected-id');
    const selectedInfo = document.getElementById('assign-client-selected-info');
    const saveBtn = document.getElementById('assign-client-save-btn');

// –ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞
const newSearchInput = searchInput.cloneNode(true);
searchInput.parentNode.replaceChild(newSearchInput, searchInput);
newSearchInput.addEventListener('input', (e) => {
    handleGenericClientSearch(e.target, searchResults, (client) => {
        e.target.value = ''; 
        searchResults.classList.add('hidden');
        selectedIdInput.value = client.id; 
        selectedInfo.textContent = `–í—ã–±—Ä–∞–Ω –∫–ª–∏–µ–Ω—Ç: ${client.full_name} (${client.client_code_prefix || ''}${client.client_code_num || '?'})`;
        selectedInfo.classList.remove('hidden');
        // –í–∞–∂–Ω–æ: newSaveBtn –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω, –µ—Å–ª–∏ saveBtn –µ—â–µ –Ω–µ –±—ã–ª –æ–±—Ä–∞–±–æ—Ç–∞–Ω.
        // –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –ø—Ä–æ—Å—Ç–æ –Ω–∞–π–¥–µ–º –∫–Ω–æ–ø–∫—É –∏ –≤–∫–ª—é—á–∏–º –µ–µ.
        document.getElementById('assign-client-save-btn').disabled = false;
    });
});

// –ö–Ω–æ–ø–∫–∞ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
const newSaveBtn = saveBtn.cloneNode(true);
saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
newSaveBtn.addEventListener('click', () => handleSaveClientAssignment(selectedIds));

    openModal('assign-client-modal');
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞
async function handleSaveClientAssignment(orderIds) {
    const clientId = document.getElementById('assign-client-selected-id').value;
    const newStatus = document.getElementById('assign-client-new-status').value; // <-- –î–û–ë–ê–í–ò–¢–¨
    if (!clientId) {
        alert("–û—à–∏–±–∫–∞: –ö–ª–∏–µ–Ω—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω.");
        return;
    }

    console.log(`[Assign Client] –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ ${orderIds.length} –∑–∞–∫–∞–∑–æ–≤ –∫–ª–∏–µ–Ω—Ç—É ID: ${clientId}`);
    showLoader();

    try {
        // –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç, —á—Ç–æ –∏ 'update_status'
        const response = await apiFetch('/api/orders/bulk_action', {
            method: 'POST',
            body: JSON.stringify({
                action: 'assign_client', // <-- –ù–û–í–û–ï –î–ï–ô–°–¢–í–ò–ï
                order_ids: orderIds.map(id => parseInt(id)),
                client_id: parseInt(clientId), // <-- –ù–û–í–´–ô –ü–ê–†–ê–ú–ï–¢–†
                new_status: newStatus
            })
        });

        alert(response.message || '–ó–∞–∫–∞–∑—ã —É—Å–ø–µ—à–Ω–æ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã!');
        closeModal('assign-client-modal');
        toggleOrdersSelectMode(); // –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ä–µ–∂–∏–º–∞ –≤—ã–±–æ—Ä–∞
        await fetchAndRenderOrders(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫

    } catch (err) {
        alert(`–û—à–∏–±–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è: ${err.message}`);
    } finally {
        hideLoader();
    }
}

// --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ë–õ–û–ö–ê ---

// --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ò–º–ø–æ—Ä—Ç–∞ –ó–∞–∫–∞–∑–æ–≤ ---

async function handleOrderExcelImport() {
    console.log("[Import Orders] handleOrderExcelImport: Start");
    const fileInput = document.getElementById('order-excel-input');
    const resultsDiv = document.getElementById('order-import-results');
    const partyDateInput = document.getElementById('import-order-party-date');
    const partyDate = partyDateInput ? partyDateInput.value : null;

    // --- –î–û–ë–ê–í–õ–ï–ù–ò–ï: –°—á–∏—Ç—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π location_id –∏–∑ select'–∞ –∏–º–ø–æ—Ä—Ç–∞ ---
    let importLocationId = null;
    if (currentUser.role === '–í–ª–∞–¥–µ–ª–µ—Ü') {
        const locationSelect = document.getElementById('import-location-select');
        if (locationSelect && locationSelect.value) {
            importLocationId = parseInt(locationSelect.value); // –í–ª–∞–¥–µ–ª–µ—Ü –≤—ã–±—Ä–∞–ª
             console.log("[Import Orders] Owner selected location_id for import:", importLocationId);
        } else if (currentUser.location_id) {
             // –ò—Å–ø–æ–ª—å–∑—É–µ–º location_id –í–ª–∞–¥–µ–ª—å—Ü–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ select –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω
             importLocationId = currentUser.location_id; 
             console.log("[Import Orders] Owner using default location_id for import:", importLocationId);
        } else {
             // –ï—Å–ª–∏ —É –í–ª–∞–¥–µ–ª—å—Ü–∞ –Ω–µ—Ç location_id –∏ –Ω–µ—Ç select'–∞, –±—ç–∫–µ–Ω–¥ –Ω–∞–∑–Ω–∞—á–∏—Ç –ø–µ—Ä–≤—ã–π
             console.warn("[Import Orders] Owner location_id for import could not be determined. Backend will assign default.");
        }
    }
    // –î–ª—è –æ–±—ã—á–Ω–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ location_id –±—É–¥–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –Ω–∞ –±—ç–∫–µ–Ω–¥–µ
    // --- –ö–û–ù–ï–¶ –î–û–ë–ê–í–õ–ï–ù–ò–Ø ---

    if (!resultsDiv) return console.error("!!! Import Orders Error: resultsDiv #order-import-results not found!");
    resultsDiv.innerHTML = '<p class="text-blue-600 animate-pulse">–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞...</p>';

    if (!fileInput || fileInput.files.length === 0) {
        resultsDiv.innerHTML = '<p class="text-red-500">–û—à–∏–±–∫–∞: –í—ã–±–µ—Ä–∏—Ç–µ Excel-—Ñ–∞–π–ª –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞.</p>';
        return;
    }
    const file = fileInput.files[0];
    console.log(`[Import Orders] Selected file: ${file.name}, size: ${file.size} bytes`);
    showLoader(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –ª–æ–∞–¥–µ—Ä

    try {
        // --- –®–∞–≥ 1: –ß—Ç–µ–Ω–∏–µ Excel ---
        console.log("[Import Orders] Reading Excel file...");
        const jsonData = await readExcelFile(file); 
        console.log(`[Import Orders] Excel read successfully. Found ${jsonData.length} rows.`);

        if (!jsonData || jsonData.length === 0) {
            resultsDiv.innerHTML = '<p class="text-yellow-600">–§–∞–π–ª –ø—É—Å—Ç.</p>';
            hideLoader(); return; 
        }

        // --- –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–æ–Ω–æ–∫ ---
        const firstRow = jsonData[0];
        if (!firstRow || !firstRow.hasOwnProperty('track_code')) {
          resultsDiv.innerHTML = '<p class="text-red-500">–û—à–∏–±–∫–∞: –§–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∫–∞–∫ –º–∏–Ω–∏–º—É–º –∫–æ–ª–æ–Ω–∫—É <strong>track_code</strong>.</p>';
          hideLoader(); return;
        }
        console.log("[Import Orders] Required columns found.");

        // --- –®–∞–≥ 3: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö ---
        resultsDiv.innerHTML = `<p class="text-blue-600">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ ${jsonData.length} –∑–∞–ø–∏—Å–µ–π...</p>`;
        const dataToSend = jsonData.map(row => ({
            track_code: String(row.track_code || '').trim() || null,
            client_code: row.client_code ? String(row.client_code).trim() : null,
            phone: row.phone ? String(row.phone).trim() : null,
            comment: row.comment ? String(row.comment).trim() : null,
            purchase_type: String(row.purchase_type || '–î–æ—Å—Ç–∞–≤–∫–∞').trim(),
            buyout_item_cost_cny: parseFloat(row.buyout_item_cost_cny) || null,
            buyout_rate_for_client: parseFloat(row.buyout_rate_for_client) || null,
            buyout_commission_percent: parseFloat(row.buyout_commission_percent) || 10.0
        })).filter(item => item.track_code); // –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –±–µ–∑ —Ç—Ä–µ–∫-–∫–æ–¥–∞

        if (dataToSend.length === 0) {
            resultsDiv.innerHTML = '<p class="text-yellow-600">–ù–µ—Ç —Å—Ç—Ä–æ–∫ —Å —Ç—Ä–µ–∫-–∫–æ–¥–æ–º –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞.</p>';
            hideLoader(); return;
        }
        console.log(`[Import Orders] Prepared ${dataToSend.length} valid records for sending.`);

        // --- –®–∞–≥ 4: –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –ë–≠–ö–ï–ù–î ---
        // –§–æ—Ä–º–∏—Ä—É–µ–º payload —Å –¥–∞—Ç–æ–π –ø–∞—Ä—Ç–∏–∏, —Å–ø–∏—Å–∫–æ–º –∑–∞–∫–∞–∑–æ–≤ –ò location_id
        const payload = {
            party_date: partyDate, 
            orders_data: dataToSend, 
            location_id: importLocationId // <-- –ü–ï–†–ï–î–ê–ï–ú location_id
        };
        resultsDiv.innerHTML = `<p class="text-blue-600 animate-pulse">–û—Ç–ø—Ä–∞–≤–∫–∞ ${dataToSend.length} –∑–∞–∫–∞–∑–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä...</p>`;
        console.log("[Import Orders] Sending payload to /api/orders/bulk_import:", payload);

        const response = await apiFetch('/api/orders/bulk_import', {
            method: 'POST',
            body: JSON.stringify(payload) 
        });
        console.log("[Import Orders] Server response:", response);

        // --- –®–∞–≥ 5: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ ---
        let resultHtml = `<p class="text-green-600 font-semibold"><strong>${response.message}</strong></p>`; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–µ created_clients
        if (response.warnings && response.warnings.length > 0) {
            resultHtml += `<p class="text-yellow-600 mt-2 font-semibold"><strong>–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (${response.warnings.length}):</strong></p><ul class="list-disc list-inside text-xs">${response.warnings.map(w => `<li>${w}</li>`).join('')}</ul>`;
        }
        if (response.errors && response.errors.length > 0) {
            resultHtml += `<p class="text-red-600 mt-2 font-semibold"><strong>–û—à–∏–±–∫–∏ (${response.errors.length}):</strong></p><ul class="list-disc list-inside text-xs">${response.errors.map(er => `<li>${er}</li>`).join('')}</ul>`;
        }
        resultsDiv.innerHTML = resultHtml; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç

        // --- –®–∞–≥ 6: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –∏ –¥–∞—Ç –ø–∞—Ä—Ç–∏–π (–ò–°–ü–†–ê–í–õ–ï–ù –ü–û–†–Ø–î–û–ö) ---
        if (response.created_clients > 0 || partyDate || importLocationId) { 
            console.log("[Import Orders] Refreshing party dates filter FIRST...");

            // 1. –°–ù–ê–ß–ê–õ–ê –ø–æ–ª—É—á–∞–µ–º –Ω–æ–≤—ã–µ –¥–∞—Ç—ã
            availablePartyDates = await apiFetch('/api/orders/parties');

            // 2. –ü–û–¢–û–ú –æ–±–Ω–æ–≤–ª—è–µ–º (–∏ "—á–µ–∫–∞–µ–º") —Ñ–∏–ª—å—Ç—Ä –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
            populatePartyFilter(); 
            console.log("[Import Orders] Party filter updated. Refreshing orders list NOW...");

            // 3. –¢–ï–ü–ï–†–¨ –∑–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–∫–∞–∑—ã. –û–Ω–∏ –Ω–µ –∏—Å—á–µ–∑–Ω—É—Ç, —Ç.–∫. —Ñ–∏–ª—å—Ç—Ä –æ–±–Ω–æ–≤–ª–µ–Ω.
            await fetchAndRenderOrders(); 
        }

    } catch (error) { // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞ –∏–ª–∏ API
        console.error("!!! [Import Orders] CRITICAL ERROR", error);
        resultsDiv.innerHTML = `<p class="text-red-500"><b>–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –∑–∞–∫–∞–∑–æ–≤:</b> ${error.message}</p>`;
    } finally {
        hideLoader(); // –ü—Ä—è—á–µ–º –ª–æ–∞–¥–µ—Ä
        if (fileInput) fileInput.value = ''; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä —Ñ–∞–π–ª–∞
        console.log("[Import Orders] handleOrderExcelImport: End");
    }
}


// --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –§–∏–ª—å—Ç—Ä–æ–≤ ---

// –ó–∞–ø–æ–ª–Ω—è–µ—Ç HTML —Å–ø–∏—Å–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ (–û–ë–ù–û–í–õ–ï–ù–û: –ì–∞–ª–æ—á–∫–∏ —Å–Ω—è—Ç—ã)
function populateStatusFilter() {
    console.log("[Filters] populateStatusFilter: Start");
    const listDiv = document.getElementById('orders-status-list');
    if (!listDiv) return;

    if (!orderStatuses || orderStatuses.length === 0) {
        listDiv.innerHTML = '<p class="text-xs text-red-500">–ù–µ—Ç —Å—Ç–∞—Ç—É—Å–æ–≤.</p>';
        return;
    }

    listDiv.innerHTML = orderStatuses.map(s => `
        <div class="flex items-center py-1 hover:bg-gray-50">
            <input type="checkbox" id="status-filter-${s.replace(/\s+/g, '-')}" value="${s}"
                   class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 status-filter-checkbox">
            <label for="status-filter-${s.replace(/\s+/g, '-')}" class="ml-2 text-sm text-gray-700 w-full cursor-pointer">${s}</label>
        </div>
    `).join('');
}

// –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–∞—Ä—Ç–∏–π
let allPartyDataCache = []; 

// 1. –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ (—Å —É—á–µ—Ç–æ–º –ê—Ä—Ö–∏–≤–∞)
function populatePartyFilter() {
    console.log("[Filters] populatePartyFilter: Start");
    const listDiv = document.getElementById('orders-party-list');
    if (!listDiv) return;

    // availablePartyDates —Ç–µ–ø–µ—Ä—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º –æ–±—ä–µ–∫—Ç–æ–≤ [{date: '...', is_completed: true}, ...]
    // –ï—Å–ª–∏ API –µ—â–µ –Ω–µ –æ–±–Ω–æ–≤–ª–µ–Ω, —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–∞—Å—Å–∏–≤ —Å—Ç—Ä–æ–∫. –ü—Ä–æ–≤–µ—Ä–∏–º.
    let parties = availablePartyDates; 
    if (!parties || parties.length === 0) {
        listDiv.innerHTML = '<p class="text-sm text-gray-500 p-2">–î–∞—Ç –ø–∞—Ä—Ç–∏–π –Ω–µ—Ç.</p>';
        return;
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à –¥–ª—è –±—ã—Å—Ç—Ä–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
    allPartyDataCache = parties;

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML
    renderPartyCheckboxes(parties);
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏ –Ω–∞ –∏–Ω–ø—É—Ç—ã –¥–∞—Ç (–¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏)
    const dateFromInput = document.getElementById('party-filter-date-from');
    const dateToInput = document.getElementById('party-filter-date-to');
    
    if (dateFromInput) dateFromInput.addEventListener('input', filterPartyListByRange);
    if (dateToInput) dateToInput.addEventListener('input', filterPartyListByRange);
}

// 2. –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —á–µ–∫–±–æ–∫—Å–æ–≤
function renderPartyCheckboxes(items) {
    const listDiv = document.getElementById('orders-party-list');
    
    // –†–∞–∑–¥–µ–ª—è–µ–º –Ω–∞ –ê–∫—Ç–∏–≤–Ω—ã–µ –∏ –ê—Ä—Ö–∏–≤–Ω—ã–µ
    const activeParties = [];
    const archivedParties = [];

    items.forEach(p => {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç (–µ—Å–ª–∏ –±—ç–∫–µ–Ω–¥ –µ—â–µ —Å—Ç–∞—Ä—ã–π –∏ —à–ª–µ—Ç —Å—Ç—Ä–æ–∫–∏)
        const dateStr = p.date || p; 
        const isCompleted = p.is_completed || false;
        
        const html = `
            <div class="flex items-center py-1 hover:bg-gray-50 party-item" data-date="${dateStr}">
                <input type="checkbox" id="party-filter-${dateStr}" value="${dateStr}"
                       class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 party-filter-checkbox">
                <label for="party-filter-${dateStr}" class="ml-2 text-sm w-full cursor-pointer flex justify-between">
                    <span class="${isCompleted ? 'text-gray-400 line-through' : 'text-gray-700'}">${dateStr}</span>
                    ${isCompleted ? '<span class="text-[10px] bg-gray-200 text-gray-500 px-1 rounded">–ê—Ä—Ö–∏–≤</span>' : ''}
                </label>
            </div>
        `;
        
        if (isCompleted) archivedParties.push(html);
        else activeParties.push(html);
    });

    let finalHtml = "";
    
    // –°–Ω–∞—á–∞–ª–∞ –ê–∫—Ç–∏–≤–Ω—ã–µ
    if (activeParties.length > 0) {
        finalHtml += activeParties.join('');
    } else {
        finalHtml += '<p class="text-xs text-gray-400 p-1">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–∞—Ä—Ç–∏–π –≤ —ç—Ç–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ.</p>';
    }

    // –ü–æ—Ç–æ–º –ê—Ä—Ö–∏–≤–Ω—ã–µ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    if (archivedParties.length > 0) {
        finalHtml += `
            <div class="mt-2 pt-2 border-t border-gray-200">
                <p class="text-xs text-gray-400 font-bold mb-1 uppercase">üóÑ –ê—Ä—Ö–∏–≤ (–í—Å–µ –≤—ã–¥–∞–Ω—ã)</p>
                ${archivedParties.join('')}
            </div>
        `;
    }
    
    listDiv.innerHTML = finalHtml;
}

// 3. –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞ (–°–∫—Ä—ã–≤–∞–µ—Ç –ª–∏—à–Ω–∏–µ —á–µ–∫–±–æ–∫—Å—ã)
function filterPartyListByRange() {
    const fromVal = document.getElementById('party-filter-date-from').value;
    const toVal = document.getElementById('party-filter-date-to').value;
    
    const fromDate = fromVal ? new Date(fromVal) : null;
    const toDate = toVal ? new Date(toVal) : null;

    // –§–∏–ª—å—Ç—Ä—É–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –º–∞—Å—Å–∏–≤ –¥–∞–Ω–Ω—ã—Ö
    const filteredData = allPartyDataCache.filter(p => {
        const pDateStr = p.date || p;
        const pDate = new Date(pDateStr);
        
        if (fromDate && pDate < fromDate) return false;
        if (toDate && pDate > toDate) return false;
        return true;
    });

    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫
    renderPartyCheckboxes(filteredData);
}


// –ü–æ–∫–∞–∑–∞—Ç—å/–°–∫—Ä—ã—Ç—å –≤—ã–ø–∞–¥–∞—é—â–µ–µ –æ–∫–Ω–æ —Ñ–∏–ª—å—Ç—Ä–∞ —Å—Ç–∞—Ç—É—Å–æ–≤
function toggleOrdersStatusFilter() {
    console.log("[Filters] toggleOrdersStatusFilter called.");
    const statusContainer = document.getElementById('orders-status-filter-container');
    const partyContainer = document.getElementById('orders-party-filter-container');
    if (!statusContainer) return;

    // –ü–µ—Ä–µ–∑–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ —Å—Ç–∞—Ç—É—Å–æ–≤ –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º (–Ω–∞ —Å–ª—É—á–∞–π –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    if (statusContainer.classList.contains('hidden')) {
        populateStatusFilter();
    }
    statusContainer.classList.toggle('hidden'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º
    // –°–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–æ–π —Ñ–∏–ª—å—Ç—Ä, –µ—Å–ª–∏ –æ–Ω –±—ã–ª –æ—Ç–∫—Ä—ã—Ç
    if(partyContainer) partyContainer.classList.add('hidden');
}

// –ü–æ–∫–∞–∑–∞—Ç—å/–°–∫—Ä—ã—Ç—å –≤—ã–ø–∞–¥–∞—é—â–µ–µ –æ–∫–Ω–æ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–∞—Ä—Ç–∏–π (—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –¥–∞—Ç)
async function toggleOrdersPartyFilter() {
     console.log("[Filters] toggleOrdersPartyFilter called.");
     const partyContainer = document.getElementById('orders-party-filter-container');
     const statusContainer = document.getElementById('orders-status-filter-container');
     if (!partyContainer) return;

     const listDiv = document.getElementById('orders-party-list');
     if (!listDiv) return;

     // –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–∫—Ä—ã—Ç, –∑–Ω–∞—á–∏—Ç –º—ã –µ–≥–æ –æ—Ç–∫—Ä—ã–≤–∞–µ–º
     if (partyContainer.classList.contains('hidden')) {
          console.log("[Filters] Opening party filter. Refreshing dates...");
          listDiv.innerHTML = '<p class="text-sm text-gray-500 animate-pulse">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞—Ç...</p>';
          showLoader(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –ª–æ–∞–¥–µ—Ä –Ω–∞ –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞
          try {
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ê–ö–¢–£–ê–õ–¨–ù–´–ï –¥–∞—Ç—ã –ø–∞—Ä—Ç–∏–π —Å —Å–µ—Ä–≤–µ—Ä–∞
                const freshPartyDates = await apiFetch('/api/orders/parties');
                availablePartyDates = freshPartyDates; // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à
                console.log("[Filters] Fresh party dates received:", availablePartyDates);
                populatePartyFilter(); // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ —Å–≤–µ–∂–∏–º–∏ –¥–∞—Ç–∞–º–∏
                partyContainer.classList.remove('hidden'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
          } catch(e) { // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞—Ç
                console.error("!!! [Filters] Error refreshing party dates:", e);
                listDiv.innerHTML = `<p class="text-sm text-red-500">–û—à–∏–±–∫–∞: ${e.message}</p>`;
                // –û—Å—Ç–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–∏–¥–∏–º—ã–º, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
                partyContainer.classList.remove('hidden');
          } finally {
               hideLoader(); // –°–∫—Ä—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
          }
     } else {
          // –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —É–∂–µ –±—ã–ª –æ—Ç–∫—Ä—ã—Ç, –ø—Ä–æ—Å—Ç–æ —Å–∫—Ä—ã–≤–∞–µ–º –µ–≥–æ
          console.log("[Filters] Closing party filter.");
          partyContainer.classList.add('hidden');
     }
     // –°–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–æ–π —Ñ–∏–ª—å—Ç—Ä (—Å—Ç–∞—Ç—É—Å–æ–≤), –µ—Å–ª–∏ –æ–Ω –±—ã–ª –æ—Ç–∫—Ä—ã—Ç
     if(statusContainer) statusContainer.classList.add('hidden');
}

// –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã (–∑–∞–∫—Ä—ã–≤–∞–µ—Ç –æ–∫–Ω–∞ –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤)
function applyOrdersFiltersAndFetch() {
    console.log("[Filters] applyOrdersFiltersAndFetch called.");
    // –°–∫—Ä—ã–≤–∞–µ–º –æ–±–∞ –æ–∫–Ω–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    document.getElementById('orders-status-filter-container')?.classList.add('hidden');
    document.getElementById('orders-party-filter-container')?.classList.add('hidden');
    // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –∑–∞–∫–∞–∑–æ–≤ (–æ–Ω–∞ —Å–∞–º–∞ —Å—á–∏—Ç–∞–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã)
    fetchAndRenderOrders();
}

// –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä —Å—Ç–∞—Ç—É—Å–æ–≤ (–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ)
function resetOrdersStatusFilter() {
     document.querySelectorAll('.status-filter-checkbox').forEach(cb => {
         cb.checked = false; // –°–Ω–∏–º–∞–µ–º –≥–∞–ª–æ—á–∫–∏
     });
     applyOrdersFiltersAndFetch(); // –ü—Ä–∏–º–µ–Ω—è–µ–º (–ø–æ–∫–∞–∂–µ—Ç "–≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ" –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
}

// –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä –ø–∞—Ä—Ç–∏–π (–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ)
function resetOrdersPartyFilter() {
     document.querySelectorAll('.party-filter-checkbox').forEach(cb => {
         cb.checked = false; // –°–Ω–∏–º–∞–µ–º –≥–∞–ª–æ—á–∫–∏
     });
     applyOrdersFiltersAndFetch(); // –ü—Ä–∏–º–µ–Ω—è–µ–º (–ø–æ–∫–∞–∂–µ—Ç –≤—Å–µ –¥–∞—Ç—ã)
}

// --- –§—É–Ω–∫—Ü–∏—è –ü–æ–∏—Å–∫–∞ –ø–æ –∑–∞–∫–∞–∑–∞–º (–û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –¥–ª—è –ê–∫–∫–æ—Ä–¥–µ–æ–Ω–∞) ---
function handleOrdersSearch(e) {
    const searchTerm = e.target.value.toLowerCase().trim();
    
    // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –≥—Ä—É–ø–ø—ã –∫–ª–∏–µ–Ω—Ç–æ–≤
    document.querySelectorAll('#orders-list-container .client-order-group').forEach(group => {
        // –î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –≥—Ä—É–ø–ø—ã
        const clientName = (group.dataset.clientName || '').toLowerCase();
        const clientPhone = (group.dataset.clientPhone || '').toLowerCase();
        const clientCode = (group.dataset.clientCode || '').toLowerCase();

        // –°–æ–≤–ø–∞–¥–∞–µ—Ç –ª–∏ —Å–∞–º –∫–ª–∏–µ–Ω—Ç —Å –ø–æ–∏—Å–∫–æ–º?
        const clientMatch = clientName.includes(searchTerm) || 
                            clientPhone.includes(searchTerm) || 
                            clientCode.includes(searchTerm);

        // –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–æ–º
        const groupBody = group.querySelector('[id^="group-"]'); // –í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
        const arrow = group.querySelector('.arrow-icon'); // –°—Ç—Ä–µ–ª–∫–∞
        const orderItems = group.querySelectorAll('.order-list-item'); // –ó–∞–∫–∞–∑—ã –≤–Ω—É—Ç—Ä–∏

        // --- –°–¶–ï–ù–ê–†–ò–ô 1: –ü–æ–∏—Å–∫ –ø—É—Å—Ç–æ–π (–°–±—Ä–æ—Å) ---
        if (searchTerm === '') {
            group.style.display = 'block'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥—Ä—É–ø–ø—É
            
            // –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ (–≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π –≤–∏–¥)
            if (groupBody) groupBody.classList.add('hidden');
            if (arrow) arrow.classList.remove('rotate-180');
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –≤—Å–µ–º –∑–∞–∫–∞–∑–∞–º –≤–Ω—É—Ç—Ä–∏ (–Ω–∞ —Å–ª—É—á–∞–π –æ—Ç–∫—Ä—ã—Ç–∏—è)
            orderItems.forEach(item => item.style.display = 'block');
            return; // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–π –≥—Ä—É–ø–ø–µ
        }

        // --- –°–¶–ï–ù–ê–†–ò–ô 2: –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è ---
        let hasVisibleOrderInGroup = false;

        orderItems.forEach(item => {
            const itemTrack = (item.dataset.track || '').toLowerCase();
            const itemComment = (item.dataset.comment || '').toLowerCase();
            
            // –ó–∞–∫–∞–∑ –≤–∏–¥–µ–Ω, –µ—Å–ª–∏:
            // 1. –ú—ã –Ω–∞—à–ª–∏ —Å–∞–º–æ–≥–æ –ö–õ–ò–ï–ù–¢–ê (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –µ–≥–æ –∑–∞–∫–∞–∑—ã)
            // 2. –ò–õ–ò —Å–æ–≤–ø–∞–ª –¢–†–ï–ö/–ö–û–ú–ú–ï–ù–¢–ê–†–ò–ô –∑–∞–∫–∞–∑–∞
            const itemMatch = itemTrack.includes(searchTerm) || itemComment.includes(searchTerm);

            if (clientMatch || itemMatch) {
                item.style.display = 'block';
                hasVisibleOrderInGroup = true;
            } else {
                item.style.display = 'none';
            }
        });

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç—å—é –ì–†–£–ü–ü–´
        if (hasVisibleOrderInGroup) {
            group.style.display = 'block';
            // –ê–í–¢–û-–†–ê–°–ö–†–´–¢–ò–ï: –ï—Å–ª–∏ –Ω–∞—à–ª–∏ —á—Ç–æ-—Ç–æ –≤–Ω—É—Ç—Ä–∏, —Ä–∞—Å–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫
            if (groupBody) groupBody.classList.remove('hidden');
            if (arrow) arrow.classList.add('rotate-180');
        } else {
            group.style.display = 'none';
        }
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–∞ "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ" (—Ç.–∫. –≤–∏–¥–∏–º–æ—Å—Ç—å –∑–∞–∫–∞–∑–æ–≤ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å)
    updateSelectAllCheckboxState();
}

// --- –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ "–ù–µ–≤–æ—Å—Ç—Ä–µ–±–æ–≤–∞–Ω–Ω—ã–µ" (–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–ª–∏–µ–Ω—Ç) ---
// (–í—Å—Ç–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ handleOrdersSearch)
function handleFilterUnclaimed() {
    // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –∏—â–µ—Ç –∑–∞–∫–∞–∑—ã, –∫–æ—Ç–æ—Ä—ã–µ —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω—ã –ø–æ–¥ 'unknown'
    // (—Ç.–µ. `client_id` —É –Ω–∏—Ö `null`), –∏ –∫–æ—Ç–æ—Ä—ã–º `renderOrderListFromCache`
    // –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç `full_name: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–ª–∏–µ–Ω—Ç'`.
    
    const searchString = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–ª–∏–µ–Ω—Ç";
    console.log(`[Filter] handleFilterUnclaimed: Filtering by '${searchString}'`);
    
    // 1. –ù–∞—Ö–æ–¥–∏–º –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞
    const searchInput = document.getElementById('orders-search-input');
    if (!searchInput) return;

    // 2. –í–ø–∏—Å—ã–≤–∞–µ–º –≤ –Ω–µ–≥–æ "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–ª–∏–µ–Ω—Ç"
    searchInput.value = searchString; 

    // 3. –í—ã–∑—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏–µ 'input', —á—Ç–æ–±—ã –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é handleOrdersSearch
    // handleOrdersSearch –Ω–∞–π–¥–µ—Ç –≥—Ä—É–ø–ø—É —Å `data-client-name="–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–ª–∏–µ–Ω—Ç"`
    searchInput.dispatchEvent(new Event('input', { bubbles: true }));
    
    // 4. (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –°–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª–∏
    document.getElementById('orders-status-filter-container')?.classList.add('hidden');
    document.getElementById('orders-party-filter-container')?.classList.add('hidden');
}

// --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∏ —Å–±—Ä–æ—Å–∏—Ç—å –ø–æ–∏—Å–∫ ---
// (–í—Å—Ç–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ handleFilterUnclaimed)
async function handleRefreshOrders() {
    console.log("[Refresh] handleRefreshOrders: Clearing search and fetching orders.");
    // 1. –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞
    const searchInput = document.getElementById('orders-search-input');
    if (searchInput) {
        searchInput.value = "";
        // –í—ã–∑—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏–µ 'input', —á—Ç–æ–±—ã —Å–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é
        searchInput.dispatchEvent(new Event('input', { bubbles: true }));
    }
    
    // 2. (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã —Å—Ç–∞—Ç—É—Å–æ–≤ –∏ –ø–∞—Ä—Ç–∏–π
    // resetOrdersStatusFilter(); // –≠—Ç–æ –≤—ã–∑–æ–≤–µ—Ç –¥–≤–æ–π–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É, –Ω–µ –Ω–∞–¥–æ
    // resetOrdersPartyFilter(); // –≠—Ç–æ –≤—ã–∑–æ–≤–µ—Ç –¥–≤–æ–π–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É, –Ω–µ –Ω–∞–¥–æ
    
    // 3. –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞
    await fetchAndRenderOrders();
}

// --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ú–∞—Å—Å–æ–≤—ã—Ö –î–µ–π—Å—Ç–≤–∏–π ---

// –°–∫—Ä—ã–≤–∞–µ—Ç –ø–∞–Ω–µ–ª—å –º–∞—Å—Å–æ–≤—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç –≤—Å–µ —á–µ–∫–±–æ–∫—Å—ã
function hideBulkActionBar() {
    console.log("[Bulk Actions] Hiding bulk action bar and resetting selection.");
    const actionBar = document.getElementById('orders-bulk-action-bar');
    const selectAllCheckbox = document.getElementById('orders-select-all-checkbox');

    if (actionBar) actionBar.classList.add('hidden'); // –°–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
    if (selectAllCheckbox) selectAllCheckbox.checked = false; // –°–Ω–∏–º–∞–µ–º –≥–∞–ª–æ—á–∫—É "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ"
    // –°–Ω–∏–º–∞–µ–º –≥–∞–ª–æ—á–∫–∏ —Å–æ –≤—Å–µ—Ö —á–µ–∫–±–æ–∫—Å–æ–≤ –∑–∞–∫–∞–∑–æ–≤
    document.querySelectorAll('.order-checkbox').forEach(cb => cb.checked = false);
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —á–µ–∫–±–æ–∫—Å–∞ "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ –≤–∏–¥–∏–º—ã–µ"
function handleOrdersSelectAll(e) {
    const isChecked = e.target.checked; // –ü–æ–ª—É—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥–ª–∞–≤–Ω–æ–≥–æ —á–µ–∫–±–æ–∫—Å–∞
    console.log(`[Bulk Actions] Select all checkbox changed to: ${isChecked}`);
    // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —á–µ–∫–±–æ–∫—Å—ã –∑–∞–∫–∞–∑–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –í–ò–î–ò–ú–´ –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç
    document.querySelectorAll('#orders-list-container .order-list-item:not([style*="display: none"]) .order-checkbox').forEach(cb => {
        cb.checked = isChecked; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–º —Ç–æ –∂–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    });
    updateBulkActionBar(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∏ –≤–∏–¥–∏–º–æ—Å—Ç—å –ø–∞–Ω–µ–ª–∏ –º–∞—Å—Å–æ–≤—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
}

// index.html (–í–Ω—É—Ç—Ä–∏ –ú–û–î–£–õ–¨: –ó–ê–ö–ê–ó–´)

// --- –ü–û–õ–ù–û–°–¢–¨–Æ –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø (v2.0 Debug) ---
function handleOrderCheckboxChange(e) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∏–∫ –±—ã–ª –∏–º–µ–Ω–Ω–æ –ø–æ —á–µ–∫–±–æ–∫—Å—É –∑–∞–∫–∞–∑–∞
    if (e.target.classList.contains('order-checkbox')) {
        const bar = document.getElementById('orders-bulk-action-bar');
        const selected = document.querySelectorAll('.order-checkbox:checked');
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        const statusGroup = document.getElementById('bulk-action-status-group');
        const dateGroup = document.getElementById('bulk-action-date-group');
        const buyoutBtn = document.getElementById('orders-bulk-buyout-btn');
        const assignBtn = document.getElementById('orders-bulk-assign-client-btn');
        const countSpan = document.getElementById('orders-selected-count');

        if (selected.length > 0) {
            bar.classList.remove('hidden');
            if (countSpan) countSpan.textContent = `–í—ã–±—Ä–∞–Ω–æ: ${selected.length}`;
            
            // 1. –ò—â–µ–º –∑–∞–∫–∞–∑—ã –≤ –∫—ç—à–µ
            const selectedOrders = Array.from(selected).map(cb => {
                // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∑–∞–∫–∞–∑ –ø–æ ID (–ø—Ä–µ–≤—Ä–∞—â–∞–µ–º –≤—Å—ë –≤ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏)
                const searchId = String(cb.value || cb.dataset.orderId);
                return companyOrders.find(o => String(o.id) === searchId);
            }).filter(item => item !== undefined);

            // --- –õ–û–ì–ò–ö–ê –î–ò–ê–ì–ù–û–°–¢–ò–ö–ò (–°–º–æ—Ç—Ä–µ—Ç—å F12 Console) ---
            console.log(`[Debug] –í—ã–±—Ä–∞–Ω–æ –∑–∞–∫–∞–∑–æ–≤: ${selectedOrders.length}`);
            selectedOrders.forEach(o => {
                console.log(` -> ID: ${o.id}, –¢—Ä–µ–∫: ${o.track_code}, –°—Ç–∞—Ç—É—Å (raw): '${o.status}'`);
            });
            // --------------------------------------------------

            // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ (–ú—è–≥–∫–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ: some = —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω)
            // –ò—â–µ–º, –µ—Å—Ç—å –ª–∏ –≤ —Å–ø–∏—Å–∫–µ —Ö–æ—Ç—å –æ–¥–∏–Ω –∑–∞–∫–∞–∑, –∫–æ—Ç–æ—Ä—ã–π –∂–¥–µ—Ç –≤—ã–∫—É–ø–∞
            const hasAwaitingBuyout = selectedOrders.some(o => {
                const s = String(o.status || '').trim().toLowerCase();
                // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å '–æ–∂–∏–¥–∞–µ—Ç –≤—ã–∫—É–ø–∞'
                return s === '–æ–∂–∏–¥–∞–µ—Ç –≤—ã–∫—É–ø–∞';
            });

            console.log("[Debug] –ï—Å—Ç—å –ª–∏ '–û–∂–∏–¥–∞–µ—Ç –≤—ã–∫—É–ø–∞'?:", hasAwaitingBuyout);

            // 3. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç—å—é –∫–Ω–æ–ø–æ–∫
            
            // –ö–Ω–æ–ø–∫–∞ –í–´–ö–£–ü–ò–¢–¨ (–ü–æ–∫–∞–∑—ã–≤–∞–µ–º, –µ—Å–ª–∏ –µ—Å—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –∑–∞–∫–∞–∑—ã)
            if (buyoutBtn) {
                if (hasAwaitingBuyout) {
                    buyoutBtn.classList.remove('hidden');
                    // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤–∏–∑—É–∞–ª—å–Ω—ã–π –∞–∫—Ü–µ–Ω—Ç
                    buyoutBtn.classList.add('ring-2', 'ring-purple-300'); 
                } else {
                    buyoutBtn.classList.add('hidden');
                    buyoutBtn.classList.remove('ring-2', 'ring-purple-300');
                }
            }

            // –û—Å—Ç–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –í–°–ï–ì–î–ê, —á—Ç–æ–±—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–µ –ø—Ä—ã–≥–∞–ª
            // (–ë—ç–∫–µ–Ω–¥ —Å–∞–º –∑–∞–ø—Ä–µ—Ç–∏—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è)
            if (assignBtn) assignBtn.classList.remove('hidden');
            if (statusGroup) statusGroup.classList.remove('hidden');
            if (dateGroup) dateGroup.classList.remove('hidden');

        } else {
            // –ù–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ
            bar.classList.add('hidden');
        }
    }
    updateSelectAllCheckboxState();
}

// –û–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–∞ "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ" (–æ—Ç–º–µ—á–µ–Ω/–Ω–µ –æ—Ç–º–µ—á–µ–Ω/–ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π)
function updateSelectAllCheckboxState() {
     const selectAllCheckbox = document.getElementById('orders-select-all-checkbox');
     if (!selectAllCheckbox) return;

     // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –í–ò–î–ò–ú–´–ï —á–µ–∫–±–æ–∫—Å—ã –∑–∞–∫–∞–∑–æ–≤
     const allVisibleCheckboxes = Array.from(
          document.querySelectorAll('#orders-list-container .order-list-item:not([style*="display: none"]) .order-checkbox')
     );

     if (allVisibleCheckboxes.length === 0) {
          // –ï—Å–ª–∏ –≤–∏–¥–∏–º—ã—Ö —á–µ–∫–±–æ–∫—Å–æ–≤ –Ω–µ—Ç, —Å–Ω–∏–º–∞–µ–º –≥–∞–ª–æ—á–∫—É –∏ –¥–µ–ª–∞–µ–º –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–º? (–ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ —Å–Ω–∏–º–∞–µ–º)
          selectAllCheckbox.checked = false;
          selectAllCheckbox.indeterminate = false;
          return;
     }

     const checkedVisibleCount = allVisibleCheckboxes.filter(cb => cb.checked).length; // –°—á–∏—Ç–∞–µ–º –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ —Å—Ä–µ–¥–∏ –≤–∏–¥–∏–º—ã—Ö

     if (checkedVisibleCount === 0) {
          // –ï—Å–ª–∏ –Ω–∏ –æ–¥–∏–Ω –Ω–µ –æ—Ç–º–µ—á–µ–Ω
          selectAllCheckbox.checked = false;
          selectAllCheckbox.indeterminate = false; // –ù–µ—Ç –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
     } else if (checkedVisibleCount === allVisibleCheckboxes.length) {
          // –ï—Å–ª–∏ –í–°–ï –≤–∏–¥–∏–º—ã–µ –æ—Ç–º–µ—á–µ–Ω—ã
          selectAllCheckbox.checked = true;
          selectAllCheckbox.indeterminate = false; // –ù–µ—Ç –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
     } else {
          // –ï—Å–ª–∏ –æ—Ç–º–µ—á–µ–Ω–∞ —Ç–æ–ª—å–∫–æ –ß–ê–°–¢–¨ –≤–∏–¥–∏–º—ã—Ö
          selectAllCheckbox.checked = false; // –ì–∞–ª–æ—á–∫—É —Å–Ω–∏–º–∞–µ–º
          selectAllCheckbox.indeterminate = true; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (—Ç–∏—Ä–µ)
     }
     console.log(`[Bulk Actions] Select all state updated: checked=${selectAllCheckbox.checked}, indeterminate=${selectAllCheckbox.indeterminate}`);
}


// –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—á–µ—Ç—á–∏–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç/—Å–∫—Ä—ã–≤–∞–µ—Ç –ø–∞–Ω–µ–ª—å –º–∞—Å—Å–æ–≤—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
function updateBulkActionBar() {
    // –°—á–∏—Ç–∞–µ–º –í–°–ï –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ —á–µ–∫–±–æ–∫—Å—ã (–¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω–∏ —Å–∫—Ä—ã—Ç—ã –ø–æ–∏—Å–∫–æ–º)
    const selectedCheckboxes = document.querySelectorAll('.order-checkbox:checked');
    const count = selectedCheckboxes.length;
    const actionBar = document.getElementById('orders-bulk-action-bar');
    const countSpan = document.getElementById('orders-selected-count');

    console.log(`[Bulk Actions] updateBulkActionBar: Selected count = ${count}`);

    if (count > 0 && actionBar) {
        // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∑–∞–∫–∞–∑, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
        actionBar.classList.remove('hidden');
        if(countSpan) countSpan.textContent = `–í—ã–±—Ä–∞–Ω–æ: ${count}`; // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
    } else if (actionBar) {
        // –ï—Å–ª–∏ –Ω–∏ –æ–¥–∏–Ω –Ω–µ –≤—ã–±—Ä–∞–Ω, —Å–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
        actionBar.classList.add('hidden');
    }
}

// –í—ã–ø–æ–ª–Ω–∏—Ç—å –º–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
async function handleBulkUpdateStatus() {
    const selectedCheckboxes = Array.from(document.querySelectorAll('.order-checkbox:checked'));
    const selectedIds = selectedCheckboxes.map(cb => parseInt(cb.dataset.orderId));
    const bulkStatusSelect = document.getElementById('orders-bulk-status-select');
    const newStatus = bulkStatusSelect ? bulkStatusSelect.value : null;

    if (selectedIds.length === 0) { alert("–ù–µ –≤—ã–±—Ä–∞–Ω—ã –∑–∞–∫–∞–∑—ã."); return; }
    if (!newStatus) { alert("–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å."); return; }

    let password = null;
    let reason = null;

    // --- –ü–†–û–í–ï–†–ö–ê –ù–ê –û–¢–ö–ê–¢ ---
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å—Ä–µ–¥–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑—ã —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "–ì–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ"
    // –ù–∞–º –Ω—É–∂–Ω–æ –Ω–∞–π—Ç–∏ —ç—Ç–∏ –∑–∞–∫–∞–∑—ã –≤ –∫—ç—à–µ companyOrders
    const riskyOrders = selectedIds.filter(id => {
        const order = companyOrders.find(o => o.id === id);
        return order && order.status === "–ì–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ";
    });

    // –ï—Å–ª–∏ –µ—Å—Ç—å "–ì–æ—Ç–æ–≤—ã–µ", –∞ –º—ã –º–µ–Ω—è–µ–º –∏—Ö –Ω–∞ "–í –ø—É—Ç–∏" (–∏–ª–∏ –¥—Ä—É–≥–æ–π –æ—Ç–∫–∞—Ç)
    if (riskyOrders.length > 0 && newStatus !== "–ì–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ" && newStatus !== "–í—ã–¥–∞–Ω") {
        const confirmMsg = `üõë –í–ù–ò–ú–ê–ù–ò–ï! –û–¢–ö–ê–¢ –°–¢–ê–¢–£–°–ê!\n\n–°—Ä–µ–¥–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –µ—Å—Ç—å ${riskyOrders.length} –∑–∞–∫–∞–∑(–æ–≤), –≥–æ—Ç–æ–≤—ã—Ö –∫ –≤—ã–¥–∞—á–µ.\n–í—ã –ø—ã—Ç–∞–µ—Ç–µ—Å—å –≤–µ—Ä–Ω—É—Ç—å –∏—Ö –Ω–∞–∑–∞–¥.\n\n–í–≤–µ–¥–∏—Ç–µ –ü–ê–†–û–õ–¨ –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò:`;
        password = prompt(confirmMsg);
        if (password === null) return;

        reason = prompt("üìù –£–∫–∞–∂–∏—Ç–µ –ü–†–ò–ß–ò–ù–£ –º–∞—Å—Å–æ–≤–æ–≥–æ –æ—Ç–∫–∞—Ç–∞ (–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):");
        if (reason === null) return;
        if (!reason || reason.trim().length < 3) {
            alert("–ü—Ä–∏—á–∏–Ω–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞."); return;
        }
    }
    // -------------------------

    console.log(`[Bulk] Updating ${selectedIds.length} orders to '${newStatus}'.`);
    showLoader();

    try {
        const response = await apiFetch('/api/orders/bulk_action', {
            method: 'POST',
            body: JSON.stringify({
                action: 'update_status',
                order_ids: selectedIds,
                new_status: newStatus,
                password: password, // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º, –µ—Å–ª–∏ –±—ã–ª –≤–≤–µ–¥–µ–Ω
                reason: reason      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º, –µ—Å–ª–∏ –±—ã–ª–∞ –≤–≤–µ–¥–µ–Ω–∞
            })
        });
        
        alert(response.message || `–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω.`);
        await fetchAndRenderOrders();

    } catch (err) {
        console.error("Error:", err);
        alert(`–û—à–∏–±–∫–∞: ${err.message}`);
    } finally {
        hideLoader();
    }
}

// –í—ã–ø–æ–ª–Ω–∏—Ç—å –º–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞—Ç—ã –ø–∞—Ä—Ç–∏–∏
async function handleBulkUpdatePartyDate() {
    // –ü–æ–ª—É—á–∞–µ–º ID –≤—Å–µ—Ö –æ—Ç–º–µ—á–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤
    const selectedIds = Array.from(document.querySelectorAll('.order-checkbox:checked'))
                           .map(cb => parseInt(cb.dataset.orderId));
    // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É –∏–∑ –ø–æ–ª—è –≤–≤–æ–¥–∞
    const partyDateInput = document.getElementById('orders-bulk-party-date-input');
    const newDate = partyDateInput ? partyDateInput.value : null;

    // –ü—Ä–æ–≤–µ—Ä–∫–∏
    if (selectedIds.length === 0) {
        alert("–ù–µ –≤—ã–±—Ä–∞–Ω—ã –∑–∞–∫–∞–∑—ã –¥–ª—è —Å–º–µ–Ω—ã –¥–∞—Ç—ã –ø–∞—Ä—Ç–∏–∏."); return;
    }
    if (!newDate) {
        alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤—É—é –¥–∞—Ç—É –ø–∞—Ä—Ç–∏–∏."); return;
    }

    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–∞—Ä–æ–ª—å –í–ª–∞–¥–µ–ª—å—Ü–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (—Ç.–∫. —ç—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö)
    const ownerPassword = prompt(`–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –ø–∞—Ä–æ–ª—å –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å–º–µ–Ω—ã –¥–∞—Ç—ã –ø–∞—Ä—Ç–∏–∏ –Ω–∞ ${newDate} –¥–ª—è ${selectedIds.length} –∑–∞–∫–∞–∑–æ–≤:`);
    if (ownerPassword === null) { // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª –û—Ç–º–µ–Ω–∞
         console.log("[Bulk Action] –°–º–µ–Ω–∞ –¥–∞—Ç—ã –ø–∞—Ä—Ç–∏–∏ –æ—Ç–º–µ–Ω–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.");
         return;
    }
    if (ownerPassword === "") { // –ü–∞—Ä–æ–ª—å –Ω–µ –≤–≤–µ–¥–µ–Ω
         alert("–ü–∞—Ä–æ–ª—å –Ω–µ –≤–≤–µ–¥–µ–Ω. –°–º–µ–Ω–∞ –¥–∞—Ç—ã –æ—Ç–º–µ–Ω–µ–Ω–∞.");
         return;
    }


    console.log(`[Bulk Action] handleBulkUpdatePartyDate: Attempting to set date '${newDate}' for ${selectedIds.length} orders.`);
    showLoader(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä

    try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –±—ç–∫–µ–Ω–¥
        const response = await apiFetch('/api/orders/bulk_action', {
            method: 'POST',
            body: JSON.stringify({
                action: 'update_party_date', // –£–∫–∞–∑—ã–≤–∞–µ–º –¥–µ–π—Å—Ç–≤–∏–µ
                order_ids: selectedIds,      // –ü–µ—Ä–µ–¥–∞–µ–º –º–∞—Å—Å–∏–≤ ID
                new_party_date: newDate,     // –ü–µ—Ä–µ–¥–∞–µ–º –Ω–æ–≤—É—é –¥–∞—Ç—É
                password: ownerPassword      // –ü–µ—Ä–µ–¥–∞–µ–º –≤–≤–µ–¥–µ–Ω–Ω—ã–π –ø–∞—Ä–æ–ª—å
            })
        });
        console.log("[Bulk Action] handleBulkUpdatePartyDate: Server response:", response);
        alert(response.message || `–î–∞—Ç–∞ –ø–∞—Ä—Ç–∏–∏ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–ª—è ${selectedIds.length} –∑–∞–∫–∞–∑–æ–≤.`);

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤
        await fetchAndRenderOrders();
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –∏ —Ñ–∏–ª—å—Ç—Ä –¥–∞—Ç –ø–∞—Ä—Ç–∏–π
        console.log("[Bulk Action] Refreshing party dates after update...");
        availablePartyDates = await apiFetch('/api/orders/parties');
        populatePartyFilter();

    } catch (err) { // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (–≤–∫–ª—é—á–∞—è –Ω–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å - 403)
        console.error("!!! [Bulk Action] handleBulkUpdatePartyDate: Error", err);
        alert(`–û—à–∏–±–∫–∞ –º–∞—Å—Å–æ–≤–æ–π —Å–º–µ–Ω—ã –¥–∞—Ç—ã –ø–∞—Ä—Ç–∏–∏: ${err.message}`);
    } finally {
        hideLoader(); // –°–∫—Ä—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
        console.log("[Bulk Action] handleBulkUpdatePartyDate: End");
    }
}

// –í—ã–ø–æ–ª–Ω–∏—Ç—å –º–∞—Å—Å–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤
async function handleBulkDeleteOrders() {
    // –ü–æ–ª—É—á–∞–µ–º ID –≤—Å–µ—Ö –æ—Ç–º–µ—á–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤
    const selectedIds = Array.from(document.querySelectorAll('.order-checkbox:checked'))
                           .map(cb => parseInt(cb.dataset.orderId));

    if (selectedIds.length === 0) {
        alert("–ù–µ –≤—ã–±—Ä–∞–Ω—ã –∑–∞–∫–∞–∑—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è."); return;
    }

    // 1. –ó–∞–ø—Ä–æ—Å –ü–∞—Ä–æ–ª—è
    const ownerPassword = prompt(`–í–ù–ò–ú–ê–ù–ò–ï! –í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å —É–¥–∞–ª–∏—Ç—å ${selectedIds.length} –∑–∞–∫–∞–∑(–æ–≤). –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –ù–ï–û–ë–†–ê–¢–ò–ú–û.\n\n–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –ø–∞—Ä–æ–ª—å –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:`);
    if (ownerPassword === null) return;
    if (ownerPassword === "") {
         alert("–ü–∞—Ä–æ–ª—å –Ω–µ –≤–≤–µ–¥–µ–Ω. –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.");
         return;
    }

    // 2. –ó–∞–ø—Ä–æ—Å –ü—Ä–∏—á–∏–Ω—ã (–ù–û–í–û–ï)
    const reason = prompt("–£–∫–∞–∂–∏—Ç–µ –ü–†–ò–ß–ò–ù–£ —É–¥–∞–ª–µ–Ω–∏—è —ç—Ç–∏—Ö –∑–∞–∫–∞–∑–æ–≤ (–¥–ª—è –æ—Ç—á–µ—Ç–∞):");
    if (reason === null) return;
    if (!reason || reason.trim().length < 3) {
        alert("–ü—Ä–∏—á–∏–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞. –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.");
        return;
    }

    console.log(`[Bulk Action] Deleting ${selectedIds.length} orders. Reason: ${reason}`);
    showLoader();

    try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –±—ç–∫–µ–Ω–¥
        const response = await apiFetch('/api/orders/bulk_action', {
            method: 'POST',
            body: JSON.stringify({
                action: 'delete',
                order_ids: selectedIds,
                password: ownerPassword,
                reason: reason // <--- –ü–µ—Ä–µ–¥–∞–µ–º –ø—Ä–∏—á–∏–Ω—É
            })
        });
        
        alert(response.message || `–£—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ ${selectedIds.length} –∑–∞–∫–∞–∑–æ–≤.`);

        await fetchAndRenderOrders();
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –∏ —Ñ–∏–ª—å—Ç—Ä –¥–∞—Ç –ø–∞—Ä—Ç–∏–π
        availablePartyDates = await apiFetch('/api/orders/parties');
        populatePartyFilter();

    } catch (err) {
        console.error("!!! [Bulk Action] Error", err);
        alert(`–û—à–∏–±–∫–∞ –º–∞—Å—Å–æ–≤–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è: ${err.message}`);
    } finally {
        hideLoader();
    }
}

// --- –§–£–ù–ö–¶–ò–Ø: –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤–≤–æ–¥–∞ –∫—É—Ä—Å–∞ –≤—ã–∫—É–ø–∞ ---
function openBuyoutModal() {
    const modal = document.getElementById('buyout-modal');
    const selectedCheckboxes = document.querySelectorAll('.order-checkbox:checked');
    const selectedOrders = Array.from(selectedCheckboxes).map(cb => companyOrders.find(o => o.id == cb.dataset.orderId));

    if (selectedOrders.length === 0) return; // –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π

    const ordersHtml = selectedOrders.map(o => `<li class="text-sm">${o.track_code} - ${o.buyout_item_cost_cny ?? '?'} CNY</li>`).join('');

    modal.querySelector('.modal-content').innerHTML = `
        <div class="flex justify-between items-start mb-4">
            <h3 class="text-2xl font-bold">–ú–∞—Å—Å–æ–≤—ã–π –≤—ã–∫—É–ø (${selectedOrders.length} –∑–∞–∫–∞–∑–æ–≤)</h3>
            <button onclick="closeModal('buyout-modal')" class="text-2xl font-bold leading-none p-1 -m-1">&times;</button>
        </div>
        <p class="text-sm mb-2">–í—ã–±—Ä–∞–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–∫–∞–∑—ã (—Å—Ç–∞—Ç—É—Å –±—É–¥–µ—Ç –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ "–í—ã–∫—É–ø–ª–µ–Ω"):</p>
        <ul class="list-disc list-inside mb-4 max-h-40 overflow-y-auto p-2 bg-gray-50 rounded-md">${ordersHtml}</ul>
        <form id="buyout-form">
            <div>
                <label for="buyout-actual-rate-input" class="block text-sm font-medium text-gray-700">–í–≤–µ–¥–∏—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–π –∫—É—Ä—Å –≤—ã–∫—É–ø–∞ (—Å–æ–º/—é–∞–Ω—å) *</label>
                <input type="number" step="any" id="buyout-actual-rate-input" class="mt-1 w-full p-2 border rounded" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 12.55">
            </div>
            <div class="flex gap-4 mt-6 border-t pt-4">
                <button type="button" onclick="closeModal('buyout-modal')" class="w-full bg-gray-200 py-2 rounded hover:bg-gray-300">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="w-full bg-purple-600 text-white py-2 rounded hover:bg-purple-700">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–∫—É–ø</button>
            </div>
        </form>
    `;
    openModal('buyout-modal');
    document.getElementById('buyout-form').addEventListener('submit', handleBulkBuyout);
}


// --- –§–£–ù–ö–¶–ò–Ø: –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—ã–∫—É–ø–∞ ---
async function handleBulkBuyout(e) {
    e.preventDefault();
    const rateInput = document.getElementById('buyout-actual-rate-input');
    const rate = parseFloat(rateInput?.value);
    
    if (isNaN(rate) || rate <= 0) {
        alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π –∫—É—Ä—Å.");
        return;
    }
    
    const ids = Array.from(document.querySelectorAll('.order-checkbox:checked')).map(cb => parseInt(cb.dataset.orderId));
    
    showLoader(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä

    try {
        const url = '/api/orders/bulk_action'; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —ç–Ω–¥–ø–æ–∏–Ω—Ç –º–∞—Å—Å–æ–≤—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
        const payload = { 
            action: 'buyout', 
            order_ids: ids, 
            buyout_actual_rate: rate 
        };

        const r = await apiFetch(url, {
            method: 'POST',
            body: JSON.stringify(payload)
        });

        console.log("[Bulk Buyout] Server response:", r);
        alert(r.message || `–í—ã–∫—É–ø —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω –¥–ª—è ${ids.length} –∑–∞–∫–∞–∑–æ–≤!`);
        
        closeModal('buyout-modal');
        await fetchAndRenderOrders(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å—Ç–∞—Ç—É—Å "–í—ã–∫—É–ø–ª–µ–Ω"
        toggleOrdersSelectMode(); // –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ä–µ–∂–∏–º–∞ –≤—ã–±–æ—Ä–∞

    } catch (err) {
        console.error("!!! [Bulk Buyout] Error:", err);
        alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –º–∞—Å—Å–æ–≤–æ–º –≤—ã–∫—É–ø–µ: ${err.message}`);
    } finally {
        hideLoader(); // –°–∫—Ä—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
    }
}
// === –ö–û–ù–ï–¶ –§–£–ù–ö–¶–ò–ô –ü–û–ò–°–ö–ê –ò –ú–ê–°–°–û–í–´–• –î–ï–ô–°–¢–í–ò–ô ===

// --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ó–∞–∫–∞–∑–∞ ---

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –≤ —Å–ø–∏—Å–∫–µ –∑–∞–∫–∞–∑–æ–≤ (–¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)
// –ò—â–µ—Ç –∫–Ω–æ–ø–∫—É 'edit-order-btn' –∏ –≤—ã–∑—ã–≤–∞–µ—Ç openEditOrderModal
function handleOrderListClick(e) {
    // –ò—â–µ–º –±–ª–∏–∂–∞–π—à–∏–π —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π —ç–ª–µ–º–µ–Ω—Ç —Å –∫–ª–∞—Å—Å–æ–º 'edit-order-btn'
    const editButton = e.target.closest('.edit-order-btn');
    // –ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –Ω–∞–π–¥–µ–Ω–∞, –ø–æ–ª—É—á–∞–µ–º ID –∑–∞–∫–∞–∑–∞ –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    if (editButton) {
        const orderId = editButton.dataset.orderId;
        console.log(`[Order Action] Edit button clicked for Order ID: ${orderId}`);
        openEditOrderModal(orderId); // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–∫–∏
    }
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –¥—Ä—É–≥–∏—Ö –∫–Ω–æ–ø–æ–∫ –≤–Ω—É—Ç—Ä–∏ –∑–∞–∫–∞–∑–∞, –µ—Å–ª–∏ –æ–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è
}

// –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ó–∞–∫–∞–∑–∞
// index.html (–ü–û–õ–ù–û–°–¢–¨–Æ –ó–ê–ú–ï–ù–Ø–ï–¢ openEditOrderModal)

function openEditOrderModal(orderId) {
    console.log(`[Modal] openEditOrderModal: Start for Order ID ${orderId}`);
    // –ù–∞—Ö–æ–¥–∏–º –¥–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞ –≤ –∫—ç—à–µ companyOrders –ø–æ ID
    const order = companyOrders.find(o => o.id == orderId); // –ò—Å–ø–æ–ª—å–∑—É–µ–º '=='

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞–π–¥–µ–Ω –ª–∏ –∑–∞–∫–∞–∑ –∏ –µ—Å—Ç—å –ª–∏ —É –Ω–µ–≥–æ –∫–ª–∏–µ–Ω—Ç
    if (!order) {
        console.error(`!!! openEditOrderModal: Order with ID ${orderId} not found in cache.`);
        alert("–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –¥–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.");
        return;
    }
     if (!order.client) {
         console.error(`!!! openEditOrderModal: Client data missing for Order ID ${orderId}.`);
         alert("–û—à–∏–±–∫–∞: –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è —ç—Ç–æ–≥–æ –∑–∞–∫–∞–∑–∞.");
         return;
     }

    const modal = document.getElementById('edit-order-modal');
    if (!modal) return console.error("!!! openEditOrderModal: Modal element #edit-order-modal not found!");
    const modalContent = modal.querySelector('.modal-content');
    if (!modalContent) return console.error("!!! openEditOrderModal: Modal content not found!");

    // --- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –¥–ª—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ ---

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ–ø—Ü–∏–∏ –¥–ª—è select'–∞ —Å—Ç–∞—Ç—É—Å–æ–≤
     const statusOptions = orderStatuses.map(s =>
         `<option value="${s}" ${order.status === s ? 'selected' : ''}>${s}</option>`
     ).join('');

    // --- HTML –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∏–ª–∏–∞–ª–∞ (—Ç–æ–ª—å–∫–æ –í–ª–∞–¥–µ–ª–µ—Ü) ---
    let locationSelectHtml = '';
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª—å –ò –Ω–∞–ª–∏—á–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∏–ª–∏–∞–ª–æ–≤
    if (currentUser.role === '–í–ª–∞–¥–µ–ª–µ—Ü' && companyLocations && companyLocations.length > 0) {
        const locationOptions = companyLocations.map(loc =>
            // –û—Ç–º–µ—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ñ–∏–ª–∏–∞–ª –∑–∞–∫–∞–∑–∞
            `<option value="${loc.id}" ${loc.id === order.location_id ? 'selected' : ''}>${loc.name}</option>`
        ).join('');
        locationSelectHtml = `
            <div>
                <label for="modal-order-location" class="block text-sm font-medium text-gray-700">–§–∏–ª–∏–∞–ª</label>
                <select id="modal-order-location" class="mt-1 w-full p-2 border rounded bg-white focus:ring-indigo-500 focus:border-indigo-500">
                    ${locationOptions}
                </select>
            </div>
        `;
    } else {
         // –î–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –∏–ª–∏ –µ—Å–ª–∏ —Ñ–∏–ª–∏–∞–ª–æ–≤ –Ω–µ—Ç, –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π
         const currentLocationName = companyLocations.find(loc => loc.id === order.location_id)?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π';
         locationSelectHtml = `
             <div>
                <label class="block text-sm font-medium text-gray-700">–§–∏–ª–∏–∞–ª</label>
                <input type="text" class="mt-1 w-full p-2 border rounded bg-gray-100 cursor-not-allowed" value="${currentLocationName}" readonly title="–§–∏–ª–∏–∞–ª –∑–∞–∫–∞–∑–∞">
             </div>
         `;
    }
    // --- –ö–û–ù–ï–¶ HTML –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∏–ª–∏–∞–ª–∞ ---

    // –ü–æ–ª—è –≤—ã–∫—É–ø–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
    let buyoutHtml = '';
    if (order.purchase_type === '–í—ã–∫—É–ø') {
        buyoutHtml = `
            <h4 class="text-md font-semibold mt-4 border-t pt-4 text-gray-700">–î–∞–Ω–Ω—ã–µ –¥–ª—è –í—ã–∫—É–ø–∞</h4>
             <div class="grid grid-cols-2 gap-4">
                 <div>
                     <label for="modal-order-buyout-cost" class="block text-sm font-medium text-gray-600">–°—Ç–æ–∏–º–æ—Å—Ç—å (CNY)</label>
                     <input type="number" step="any" id="modal-order-buyout-cost" class="mt-1 w-full p-2 border rounded text-sm" value="${order.buyout_item_cost_cny || ''}">
                 </div>
                 <div>
                     <label for="modal-order-buyout-commission" class="block text-sm font-medium text-gray-600">–ö–æ–º–∏—Å—Å–∏—è (%)</label>
                     <input type="number" step="1" id="modal-order-buyout-commission" value="${order.buyout_commission_percent ?? 10}" class="mt-1 w-full p-2 border rounded text-sm">
                 </div>
                 <div>
                     <label for="modal-order-buyout-rate" class="block text-sm font-medium text-gray-600">–ö—É—Ä—Å –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞</label>
                     <input type="number" step="any" id="modal-order-buyout-rate" class="mt-1 w-full p-2 border rounded text-sm" value="${order.buyout_rate_for_client || ''}">
                 </div>
                  <div>
                     <label for="modal-order-buyout-actual-rate" class="block text-sm font-medium text-gray-600">–†–µ–∞–ª—å–Ω—ã–π –∫—É—Ä—Å</label>
                     <input type="number" step="any" id="modal-order-buyout-actual-rate" class="mt-1 w-full p-2 border rounded text-sm" value="${order.buyout_actual_rate || ''}">
                 </div>
            </div>
        `;
    }

    // –°–æ–±–∏—Ä–∞–µ–º –≤–µ—Å—å HTML –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    modalContent.innerHTML = `
        <div class="flex justify-between items-start mb-4">
            <h3 class="text-2xl font-bold text-gray-800">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ó–∞–∫–∞–∑ #${order.id}</h3>
            <button onclick="closeModal('edit-order-modal')" class="text-2xl font-bold leading-none p-1 -m-1 text-gray-500 hover:text-gray-700">&times;</button>
        </div>
        <form id="edit-order-form" data-order-id="${orderId}" class="space-y-4">
             <div class="grid grid-cols-2 gap-4">
                 <div>
                     <label for="modal-order-track-code" class="block text-sm font-medium text-gray-700">–¢—Ä–µ–∫-–∫–æ–¥ *</label>
                     <input type="text" id="modal-order-track-code" class="mt-1 w-full p-2 border rounded focus:ring-indigo-500 focus:border-indigo-500" required value="${order.track_code || ''}">
                 </div>
                 <div>
                     <label for="modal-order-status" class="block text-sm font-medium text-gray-700">–°—Ç–∞—Ç—É—Å</label>
                     <select id="modal-order-status" class="mt-1 w-full p-2 border rounded bg-white focus:ring-indigo-500 focus:border-indigo-500">${statusOptions}</select>
                 </div>
            </div>
             <div class="grid grid-cols-2 gap-4">
                 <div>
                     <label for="modal-order-party-date" class="block text-sm font-medium text-gray-700">–î–∞—Ç–∞ –ü–∞—Ä—Ç–∏–∏</label>
                     <input type="date" id="modal-order-party-date" class="mt-1 w-full p-2 border rounded focus:ring-indigo-500 focus:border-indigo-500" value="${order.party_date || ''}">
                 </div>
                 ${locationSelectHtml}
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">–¢–∏–ø –∑–∞–∫–∞–∑–∞</label>
                <input type="text" id="modal-order-purchase-type" class="mt-1 w-full p-2 border rounded bg-gray-100 cursor-not-allowed" value="${order.purchase_type || '?'}" readonly title="–¢–∏–ø –∑–∞–∫–∞–∑–∞ –Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è">
            </div>
            <div>
                <label for="modal-order-client-search" class="block text-sm font-medium text-gray-700">–ö–ª–∏–µ–Ω—Ç</label>
                <div class="relative">
                     <input type="text" id="modal-order-client-search" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥ –¥–ª—è —Å–º–µ–Ω—ã –∫–ª–∏–µ–Ω—Ç–∞..."
                            class="mt-1 w-full p-2 border rounded focus:ring-indigo-500 focus:border-indigo-500"
                            value="${order.client.full_name} (${order.client.client_code_prefix || ''}${order.client.client_code_num || '–ù–µ—Ç –∫–æ–¥–∞'})">
                     <input type="hidden" id="modal-order-new-client-id" value="${order.client.id}">
                     <div id="modal-order-client-results" class="absolute hidden top-full left-0 right-0 bg-white border mt-1 rounded-md shadow-lg z-20 max-h-48 overflow-y-auto"></div>
                </div>
            </div>
            <div>
                <label for="modal-order-comment" class="block text-sm font-medium text-gray-700">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                <textarea id="modal-order-comment" class="mt-1 w-full p-2 border rounded h-16 focus:ring-indigo-500 focus:border-indigo-500" placeholder="–¶–≤–µ—Ç, —Ä–∞–∑–º–µ—Ä...">${order.comment || ''}</textarea>
            </div>

            ${buyoutHtml} 

            <div class="flex gap-4 mt-6 border-t pt-4">
                <button type="button" onclick="closeModal('edit-order-modal')" class="w-full bg-gray-200 py-2 rounded hover:bg-gray-300 text-gray-800">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ò–∑–º–µ–Ω–µ–Ω–∏—è</button>
            </div>
        </form>
    `;

    // --- –ü–†–ò–í–Ø–ó–ö–ê –°–õ–£–®–ê–¢–ï–õ–ï–ô –ü–û–°–õ–ï –ì–ï–ù–ï–†–ê–¶–ò–ò HTML ---

    // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å submit –∫ —Ñ–æ—Ä–º–µ
    const formElement = document.getElementById('edit-order-form');
    if (formElement) {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º replaceWith –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö —Å–ª—É—à–∞—Ç–µ–ª–µ–π
        const newFormElement = formElement.cloneNode(true);
        formElement.parentNode.replaceChild(newFormElement, formElement);
        newFormElement.addEventListener('submit', handleSaveOrderChanges);
        console.log("[Modal Listener OK] Added submit to #edit-order-form");
    } else {
        console.error("!!! openEditOrderModal: Form #edit-order-form NOT FOUND!");
    }

    // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å input –∫ –ø–æ–ª—é –ø–æ–∏—Å–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞
    const clientSearchInput = document.getElementById('modal-order-client-search');
    if (clientSearchInput) {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º replaceWith –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö —Å–ª—É—à–∞—Ç–µ–ª–µ–π
        const newClientSearchInput = clientSearchInput.cloneNode(true);
        clientSearchInput.parentNode.replaceChild(newClientSearchInput, clientSearchInput);
        newClientSearchInput.addEventListener('input', (e) => {
            const resultsDiv = document.getElementById('modal-order-client-results');
            const selectedIdInput = document.getElementById('modal-order-new-client-id');
            handleGenericClientSearch(e.target, resultsDiv, (client) => {
                e.target.value = `${client.full_name} (${client.client_code_prefix || ''}${client.client_code_num || '–ù–µ—Ç –∫–æ–¥–∞'})`;
                if(selectedIdInput) selectedIdInput.value = client.id;
            });
        });
        console.log("[Modal Listener OK] Added input listener to #modal-order-client-search");
    } else {
        console.error("!!! openEditOrderModal: Input #modal-order-client-search NOT FOUND!");
    }
    // --- –ö–û–ù–ï–¶ –ü–†–ò–í–Ø–ó–ö–ò –°–õ–£–®–ê–¢–ï–õ–ï–ô ---

    openModal('edit-order-modal');
    console.log(`[Modal] openEditOrderModal: End for Order ID ${orderId}`);
}
// --- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ó–∞–∫–∞–∑–∞ (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è) ---
// index.html (–ü–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–º–µ–Ω—è–µ—Ç handleSaveOrderChanges)

// index.html (–ü–û–õ–ù–û–°–¢–¨–Æ –ó–ê–ú–ï–ù–Ø–ï–¢ handleSaveOrderChanges)

async function handleSaveOrderChanges(e) {
    e.preventDefault(); 
    console.log("[Save Order Changes] Start");
    showLoader(); 
    
    const form = e.target;
    const orderId = form.dataset.orderId; 
    const orderIdInt = parseInt(orderId);

    // 1. –ù–∞—Ö–æ–¥–∏–º –ò–°–•–û–î–ù–´–ô –∑–∞–∫–∞–∑ –≤ –∫—ç—à–µ, —á—Ç–æ–±—ã —Å—Ä–∞–≤–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã
    const originalOrder = companyOrders.find(o => o.id === orderIdInt);
    if (!originalOrder) {
        hideLoader();
        alert("–û—à–∏–±–∫–∞: –ò—Å—Ö–æ–¥–Ω—ã–π –∑–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∫—ç—à–µ (–ø–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É).");
        return;
    }

    const newClientId = document.getElementById('modal-order-new-client-id')?.value;
    if (!newClientId) { 
        hideLoader(); alert("–û—à–∏–±–∫–∞: –ö–ª–∏–µ–Ω—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω."); return; 
    }

    // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    const payload = {
        track_code: document.getElementById('modal-order-track-code')?.value.trim(),
        status: document.getElementById('modal-order-status')?.value,
        party_date: document.getElementById('modal-order-party-date')?.value || null, 
        client_id: parseInt(newClientId), 
        comment: document.getElementById('modal-order-comment')?.value.trim() || null, 
        buyout_item_cost_cny: parseFloat(document.getElementById('modal-order-buyout-cost')?.value) || null,
        buyout_commission_percent: parseFloat(document.getElementById('modal-order-buyout-commission')?.value) || 10.0, 
        buyout_rate_for_client: parseFloat(document.getElementById('modal-order-buyout-rate')?.value) || null,
        buyout_actual_rate: parseFloat(document.getElementById('modal-order-buyout-actual-rate')?.value) || null,
    };

    if (currentUser.role === '–í–ª–∞–¥–µ–ª–µ—Ü') {
        const locationSelect = document.getElementById('modal-order-location');
        if (locationSelect && locationSelect.value) payload.location_id = parseInt(locationSelect.value); 
    }

    if (!payload.track_code) { hideLoader(); alert("–¢—Ä–µ–∫-–∫–æ–¥ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º."); return; }

    // --- –ü–†–û–í–ï–†–ö–ê –ù–ê –û–¢–ö–ê–¢ –°–¢–ê–¢–£–°–ê (–ò–°–ü–†–ê–í–õ–ï–ù–û) ---
    let password = null;
    let reason = null;
    
    // –û—á–∏—â–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –æ—Ç –ø—Ä–æ–±–µ–ª–æ–≤ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
    const currentStatus = originalOrder.status.trim();
    const newStatusRaw = payload.status.trim();

    console.log(`[Security Check] Old: '${currentStatus}', New: '${newStatusRaw}'`);

    // –£—Å–ª–æ–≤–∏–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è –∑–∞—â–∏—Ç—ã:
    // 1. –°—Ç–∞—Ä—ã–π —Å—Ç–∞—Ç—É—Å –ë–´–õ "–ì–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ"
    // 2. –ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å –ù–ï "–ì–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ" –ò –ù–ï "–í—ã–¥–∞–Ω"
    if (currentStatus === "–ì–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ" && newStatusRaw !== "–ì–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ" && newStatusRaw !== "–í—ã–¥–∞–Ω") {
        
        console.warn("üö® DETECTED STATUS ROLLBACK!");
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å
        const confirmMsg = "üõë –í–ù–ò–ú–ê–ù–ò–ï! –û–¢–ö–ê–¢ –°–¢–ê–¢–£–°–ê!\n\n–í—ã –ø—ã—Ç–∞–µ—Ç–µ—Å—å —É–±—Ä–∞—Ç—å —Å—Ç–∞—Ç—É—Å '–ì–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ'.\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ —Ç—Ä–µ–±—É–µ—Ç –æ–±—ä—è—Å–Ω–µ–Ω–∏—è –∏ –ø–∞—Ä–æ–ª—è.\n\n–í–≤–µ–¥–∏—Ç–µ –ü–ê–†–û–õ–¨ –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò:";
        password = prompt(confirmMsg);
        
        if (password === null) { 
            hideLoader(); return; // –ù–∞–∂–∞—Ç–∞ –æ—Ç–º–µ–Ω–∞
        }

        reason = prompt("üìù –£–∫–∞–∂–∏—Ç–µ –ü–†–ò–ß–ò–ù–£ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):");
        if (reason === null) { 
            hideLoader(); return; 
        }
        
        if (!reason || reason.trim().length < 3) {
            hideLoader();
            alert("‚ùå –û—à–∏–±–∫–∞: –ü—Ä–∏—á–∏–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞. –ò–∑–º–µ–Ω–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.");
            return;
        }
    }

    // –§–æ—Ä–º–∏—Ä—É–µ–º URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (–µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å)
    let url = `/api/orders/${orderId}`;
    const params = new URLSearchParams();
    if (password) params.append('password', password);
    if (reason) params.append('reason', reason);
    
    if (password || reason) {
        url += `?${params.toString()}`;
    }

    try {
        const updatedOrder = await apiFetch(url, {
            method: 'PATCH',
            body: JSON.stringify(payload)
        });
        
        alert(`–ó–∞–∫–∞–∑ #${orderId} —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!`);
        closeModal('edit-order-modal'); 

        // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à
        const indexToUpdate = companyOrders.findIndex(o => o.id === orderIdInt);
        if (indexToUpdate !== -1) companyOrders[indexToUpdate] = updatedOrder;
        
        renderOrderListFromCache();

    } catch (err) { 
        console.error("!!! Error:", err);
        alert(`–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ${err.message}`);
    } finally {
        hideLoader(); 
    }
}


// --- –û–±—â–∏–µ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞ –∏ –≠–∫—Å–ø–æ—Ä—Ç) ---

// –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –ù–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö)
// inputElement - –ø–æ–ª–µ –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞
// resultsDivElement - div –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
// onSelectCallback - —Ñ—É–Ω–∫—Ü–∏—è, –≤—ã–∑—ã–≤–∞–µ–º–∞—è –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –∫–ª–∏–µ–Ω—Ç–∞ (–ø–æ–ª—É—á–∞–µ—Ç –æ–±—ä–µ–∫—Ç client)
function handleGenericClientSearch(inputElement, resultsDivElement, onSelectCallback) {
     if (!inputElement || !resultsDivElement || !onSelectCallback) {
          console.error("[Client Search Util] Missing arguments for handleGenericClientSearch.");
          return;
     }
     const searchTerm = inputElement.value; // –¢–µ–∫—É—â–∏–π —Ç–µ–∫—Å—Ç –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞

     // –°–∫—Ä—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, –µ—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ
     if (!searchTerm || searchTerm.length < 1) {
         resultsDivElement.innerHTML = '';
         resultsDivElement.classList.add('hidden');
         return;
     }

     // Debounce: –∂–¥–µ–º 300–º—Å –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤–≤–æ–¥–∞ –ø–µ—Ä–µ–¥ –ø–æ–∏—Å–∫–æ–º
     clearTimeout(inputElement.debounceTimer); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä
     inputElement.debounceTimer = setTimeout(async () => {
         console.log(`[Client Search Util] Searching for: "${searchTerm}"`);
         resultsDivElement.innerHTML = '<div class="p-2 text-sm text-gray-500 animate-pulse">–ü–æ–∏—Å–∫...</div>'; // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä
         resultsDivElement.classList.remove('hidden'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º
         try {
             // –ó–∞–ø—Ä–æ—Å –∫ API
             const clients = await apiFetch(`/api/clients/search?q=${encodeURIComponent(searchTerm)}`);
             console.log(`[Client Search Util] Found ${clients.length} clients.`);

             if (clients && clients.length > 0) {
                 // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –¥–ª—è –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
                 resultsDivElement.innerHTML = clients.map(c => `
                     <div class="p-2 hover:bg-indigo-50 cursor-pointer text-sm search-result-item border-b last:border-b-0"
                          data-client-json='${JSON.stringify(c)}'>
                         ${c.full_name} (${c.client_code_prefix || ''}${c.client_code_num || '–ù–µ—Ç –∫–æ–¥–∞'}) - ${c.phone}
                     </div>
                 `).join('');
                 // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–∞ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º
                 resultsDivElement.querySelectorAll('.search-result-item').forEach(item => {
                     item.addEventListener('click', () => {
                         try {
                              const clientData = JSON.parse(item.dataset.clientJson); // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                              console.log(`[Client Search Util] Client selected:`, clientData);
                              onSelectCallback(clientData); // –í—ã–∑—ã–≤–∞–µ–º callback —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º –∫–ª–∏–µ–Ω—Ç–æ–º
                              resultsDivElement.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                              resultsDivElement.classList.add('hidden'); // –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫
                         } catch (e) {
                              console.error("[Client Search Util] Error parsing client data from click:", e);
                              alert("–û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ –∫–ª–∏–µ–Ω—Ç–∞.");
                         }
                     });
                 });
             } else {
                 resultsDivElement.innerHTML = '<div class="p-2 text-sm text-gray-500">–ö–ª–∏–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</div>';
             }
         } catch (error) { // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø–æ–∏—Å–∫–∞
             console.error("[Client Search Util] Error:", error);
             resultsDivElement.innerHTML = `<div class="p-2 text-sm text-red-500">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: ${error.message}</div>`;
         }
     }, 300); // –ó–∞–¥–µ—Ä–∂–∫–∞ debounce
 }

// –§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –≤ Excel
function handleExportOrders() {
     console.log("[Export Orders] handleExportOrders: Start");
     // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–π –∫—ç—à –∑–∞–∫–∞–∑–æ–≤ (companyOrders), –∫–æ—Ç–æ—Ä—ã–π –æ—Ç—Ä–∞–∂–∞–µ—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
     if (!companyOrders || companyOrders.length === 0) {
         alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏–ª–∏ –æ—Ç—Ñ–∏–ª—å—Ç—Ä—É–π—Ç–µ –∑–∞–∫–∞–∑—ã.');
         return;
     }
     // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ XLSX
     if (typeof XLSX === 'undefined') {
         alert("–û—à–∏–±–∫–∞: –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ XLSX –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞.");
         return;
     }

     console.log(`[Export Orders] Preparing to export ${companyOrders.length} orders...`);
     showLoader(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä –Ω–∞ –≤—Ä–µ–º—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ —Ñ–∞–π–ª–∞

     try {
         // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –ª–∏—Å—Ç–∞ Excel
         const dataToExport = companyOrders.map(order => ({
             '–î–∞—Ç–∞ –ü–∞—Ä—Ç–∏–∏': order.party_date || '',
             '–¢—Ä–µ–∫-–∫–æ–¥': order.track_code || '',
             '–°—Ç–∞—Ç—É—Å': order.status || '',
             '–ö–ª–∏–µ–Ω—Ç –§–ò–û': order.client?.full_name || '?',
             '–ö–ª–∏–µ–Ω—Ç –¢–µ–ª–µ—Ñ–æ–Ω': order.client?.phone || '?',
             '–ö–ª–∏–µ–Ω—Ç –ö–æ–¥': `${order.client?.client_code_prefix || ''}${order.client?.client_code_num || ''}`,
             '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π': order.comment || '',
             '–¢–∏–ø': order.purchase_type || '',
             '–¶–µ–Ω–∞ CNY': order.buyout_item_cost_cny ?? '', // –ò—Å–ø–æ–ª—å–∑—É–µ–º ?? –¥–ª—è –ø—É—Å—Ç—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –≤–º–µ—Å—Ç–æ null/undefined
             '–ö—É—Ä—Å –ö–ª–∏–µ–Ω—Ç': order.buyout_rate_for_client ?? '',
             '–ö–æ–º–∏—Å—Å–∏—è %': order.buyout_commission_percent ?? '',
             '–†–µ–∞–ª. –ö—É—Ä—Å': order.buyout_actual_rate ?? '',
             '–†–∞—Å—á–µ—Ç –í–µ—Å': order.calculated_weight_kg ?? '',
             '–†–∞—Å—á–µ—Ç –°—É–º–º–∞': order.calculated_final_cost_som ?? '',
             '–î–∞—Ç–∞ –í—ã–¥–∞—á–∏': order.issued_at ? new Date(order.issued_at).toLocaleString('ru-RU') : '', // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É
             '–§–∞–∫—Ç –í–µ—Å': order.weight_kg ?? '',
             '–§–∞–∫—Ç –°—É–º–º–∞': order.final_cost_som ?? ''
             // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª—é–±—ã–µ –¥—Ä—É–≥–∏–µ –ø–æ–ª—è –∏–∑ –æ–±—ä–µ–∫—Ç–∞ order
         }));
         console.log("[Export Orders] Data prepared for sheet.");

         // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –ª–∏—Å—Ç Excel –∏–∑ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
         const worksheet = XLSX.utils.json_to_sheet(dataToExport);
         console.log("[Export Orders] Worksheet created.");

         // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∫–Ω–∏–≥—É Excel
         const workbook = XLSX.utils.book_new();

         // –î–æ–±–∞–≤–ª—è–µ–º –ª–∏—Å—Ç –≤ –∫–Ω–∏–≥—É
         XLSX.utils.book_append_sheet(workbook, worksheet, '–ó–∞–∫–∞–∑—ã'); // –ò–º—è –ª–∏—Å—Ç–∞ "–ó–∞–∫–∞–∑—ã"
         console.log("[Export Orders] Worksheet appended to workbook.");

         // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞ —Å –¥–∞—Ç–æ–π –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ–º –∫–æ–º–ø–∞–Ω–∏–∏
         const today = new Date().toISOString().split('T')[0];
         const companyName = currentCompany ? currentCompany.name.replace(/\s+/g, '_') : 'SuperAdmin';
         const filename = `–≠–∫—Å–ø–æ—Ä—Ç_–ó–∞–∫–∞–∑–æ–≤_${companyName}_${today}.xlsx`;
         console.log(`[Export Orders] Generated filename: ${filename}`);

         // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –±—Ä–∞—É–∑–µ—Ä–æ–º
         XLSX.writeFile(workbook, filename);
         console.log("[Export Orders] Download initiated.");
         alert(`–≠–∫—Å–ø–æ—Ä—Ç ${companyOrders.length} –∑–∞–∫–∞–∑–æ–≤ –≤ —Ñ–∞–π–ª "${filename}" –Ω–∞—á–∞—Ç.`);

     } catch (e) { // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ Excel
          console.error("!!! [Export Orders] Error creating Excel file:", e);
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å Excel —Ñ–∞–π–ª –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞. –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏.");
     } finally {
          hideLoader(); // –°–∫—Ä—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
          console.log("[Export Orders] handleExportOrders: End");
     }
 }
// === –ö–û–ù–ï–¶ –ú–û–î–£–õ–Ø –ó–ê–ö–ê–ó–´ ===

// =================================================================
// –ú–û–î–£–õ–¨: –í–´–î–ê–ß–ê (Issuance) (v4.1 - Rebuild)
// =================================================================

// index.html (–ü–û–õ–ù–û–°–¢–¨–Æ –ó–ê–ú–ï–ù–Ø–ï–¢ renderIssueTab)

// index.html (–ü–û–õ–ù–û–°–¢–¨–Æ –ó–ê–ú–ï–ù–Ø–ï–¢ renderIssueTab)

async function renderIssueTab() {
    console.log("[Render] renderIssueTab: Start");
    const pane = document.getElementById('tab-issue');
    if (!pane) {
         console.warn("[Render] renderIssueTab: Pane #tab-issue not found.");
         return;
    }

    // --- –ì–ï–ù–ï–†–ò–†–£–ï–ú HTML –î–õ–Ø –§–ò–õ–¨–¢–†–ê –§–ò–õ–ò–ê–õ–û–í (–¢–û–õ–¨–ö–û –î–õ–Ø –í–õ–ê–î–ï–õ–¨–¶–ê) ---
    let locationFilterHtml = '';
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, –µ—Å–ª–∏ –í–ª–∞–¥–µ–ª–µ—Ü –ò —Ñ–∏–ª–∏–∞–ª–æ–≤ –ë–û–õ–¨–®–ï –æ–¥–Ω–æ–≥–æ –ò —Ñ–∏–ª–∏–∞–ª—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã
    if (currentUser.role === '–í–ª–∞–¥–µ–ª–µ—Ü' && companyLocations && companyLocations.length > 1) {
        const locationOptions = companyLocations.map(loc =>
            // –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –≤—ã–±–∏—Ä–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∏–ª–∏–∞–ª –í–ª–∞–¥–µ–ª—å—Ü–∞, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
            `<option value="${loc.id}" ${loc.id === currentUser.location_id ? 'selected' : ''}>${loc.name}</option>`
        ).join('');

        locationFilterHtml = `
            <div class="p-2 bg-gray-100 rounded-md shadow-sm relative">
                <label for="issue-location-filter" class="text-xs font-medium text-gray-700 mr-2">–§–∏–ª–∏–∞–ª:</label>
                <select id="issue-location-filter" class="rounded-md border-gray-300 p-1.5 text-xs bg-white shadow-sm w-36">
                    <option value="">-- –í—Å–µ —Ñ–∏–ª–∏–∞–ª—ã --</option>
                    ${locationOptions}
                </select>
            </div>
        `;
        console.log("[Render] renderIssueTab: Location filter HTML generated.");
    } else {
         console.warn("[Render] renderIssueTab: Location filter NOT generated. Role:", currentUser.role, "Locations:", companyLocations?.length);
    }
    // --- –ö–û–ù–ï–¶ –ì–ï–ù–ï–†–ê–¶–ò–ò –§–ò–õ–¨–¢–†–ê ---

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π HTML –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ "–í—ã–¥–∞—á–∞"
    pane.innerHTML = `
        <div id="issue-container" class="bg-white rounded-lg shadow-md h-[calc(100vh-140px)] flex flex-col border overflow-hidden">
            <div class="p-6 border-b bg-white z-10">
                <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">–ó–∞–∫–∞–∑—ã, –≥–æ—Ç–æ–≤—ã–µ –∫ –≤—ã–¥–∞—á–µ</h2>
                    <div class="flex items-center gap-4 flex-wrap"> 
                        ${locationFilterHtml} 
                        <button id="show-issued-history-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded text-sm">–ò—Å—Ç–æ—Ä–∏—è –≤—ã–¥–∞–Ω–Ω—ã—Ö</button>
                        <button id="refresh-issue-list-btn" title="–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫" class="text-2xl ml-auto text-gray-500 hover:text-indigo-600">&circlearrowright;</button> 
                    </div>
                </div>
                <div>
                    <input type="search" id="issue-search-input" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∫–ª–∏–µ–Ω—Ç—É, —Ç–µ–ª–µ—Ñ–æ–Ω—É, —Ç—Ä–µ–∫-–∫–æ–¥—É..." class="w-full p-2 border rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                </div>
            </div>

            <div id="issue-list" class="flex-grow overflow-y-auto p-6 space-y-4 custom-scrollbar bg-gray-50">
                <p class="text-gray-500 animate-pulse text-center">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è –≤—ã–¥–∞—á–∏...</p>
            </div>
        </div>
    `;

    // --- –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏ ---
    const containerDiv = document.getElementById('issue-container');
    if (containerDiv) {
        document.getElementById('show-issued-history-btn')?.addEventListener('click', showIssuedHistory);
        document.getElementById('refresh-issue-list-btn')?.addEventListener('click', fetchAndRenderIssueList);
        document.getElementById('issue-search-input')?.addEventListener('input', handleIssueSearch);
        
        // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –∫ —Ñ–∏–ª—å—Ç—Ä—É —Ñ–∏–ª–∏–∞–ª–æ–≤, –ï–°–õ–ò –û–ù –ë–´–õ –°–û–ó–î–ê–ù
        const locationFilterSelect = document.getElementById('issue-location-filter');
        if (locationFilterSelect) {
            const newSelect = locationFilterSelect.cloneNode(true);
            locationFilterSelect.parentNode?.replaceChild(newSelect, locationFilterSelect);
            newSelect.addEventListener('change', fetchAndRenderIssueList); 
            console.log("[Listener OK] Added change to #issue-location-filter");
        }
        
        // –°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ (–¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)
        const issueListDiv = document.getElementById('issue-list');
        if (issueListDiv) {
            const newListDiv = issueListDiv.cloneNode(false); 
            issueListDiv.parentNode?.replaceChild(newListDiv, issueListDiv);
            newListDiv.innerHTML = '<p class="text-gray-500 animate-pulse">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</p>'; 
            newListDiv.addEventListener('change', handleIssueCheckboxChange);
            newListDiv.addEventListener('click', handleIssueListClick);
            console.log("[Listener OK] Added delegate listeners to #issue-list");
        }

        await fetchAndRenderIssueList(); 
        
    } else {
        console.error("!!! renderIssueTab: #issue-container not found.");
    }
    console.log("[Render] renderIssueTab: End");
}


async function fetchAndRenderIssueList() {
    console.log("[Fetch] fetchAndRenderIssueList: Start");
    const listDiv = document.getElementById('issue-list');
    if (!listDiv) return;

    listDiv.innerHTML = '<p class="text-gray-500 animate-pulse">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</p>';
    showLoader();

    // --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –°—á–∏—Ç—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π location_id –¥–ª—è –í–ª–∞–¥–µ–ª—å—Ü–∞ ---
    const params = new URLSearchParams();
    if (currentUser.role === '–í–ª–∞–¥–µ–ª–µ—Ü') {
        const locationFilterSelect = document.getElementById('issue-location-filter');
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ select —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ò –≤ –Ω–µ–º –≤—ã–±—Ä–∞–Ω–æ –ù–ï –ø—É—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ("-- –í—Å–µ —Ñ–∏–ª–∏–∞–ª—ã --")
        if (locationFilterSelect && locationFilterSelect.value) {
            params.append('location_id', locationFilterSelect.value);
            console.log("[Fetch Issue List] Filtering by location_id:", locationFilterSelect.value);
        } else {
             console.log("[Fetch Issue List] Owner viewing all locations.");
        }
    }
    // –û–±—ã—á–Ω—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –ù–ï –ø–µ—Ä–µ–¥–∞–µ—Ç location_id, –±—ç–∫–µ–Ω–¥ –æ—Ç—Ñ–∏–ª—å—Ç—Ä—É–µ—Ç —Å–∞–º
    const url = `/api/orders/ready_for_issue?${params.toString()}`; // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫ URL
    console.log("[Fetch Issue List] Requesting URL:", url);
    // --- –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø ---

    try {
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∑–∞–∫–∞–∑—ã —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "–ì–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ"
        const ordersReady = await apiFetch(url); // –ò—Å–ø–æ–ª—å–∑—É–µ–º URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏

        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –∫–ª–∏–µ–Ω—Ç—É (–∫–æ–¥ –æ—Å—Ç–∞–µ—Ç—Å—è)
        const ordersByClient = ordersReady.reduce((acc, order) => {
            const client_id = order.client?.id || 'unknown';
            if (!acc[client_id]) {
                acc[client_id] = { client: order.client, orders: [] };
            }
            acc[client_id].orders.push(order);
            return acc;
        }, {});

        listDiv.innerHTML = ''; // –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–¥ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–æ–º
        if (Object.keys(ordersByClient).length === 0) {
            listDiv.innerHTML = '<p class="text-gray-500">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤, –≥–æ—Ç–æ–≤—ã—Ö –∫ –≤—ã–¥–∞—á–µ (—Å —É—á–µ—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–∞).</p>';
            return;
        }

        // –†–µ–Ω–¥–µ—Ä–∏–º –≥—Ä—É–ø–ø—ã
        for (const clientId in ordersByClient) {
            const group = ordersByClient[clientId];
            const client = group.client || { full_name: '?', phone: '?', client_code_prefix: '', client_code_num: '?' };
            const clientCode = `${client.client_code_prefix || ''}${client.client_code_num || '?'}`;

            const ordersHtml = group.orders.map(o => `
                <li class="flex items-center gap-2 p-2 border-b last:border-0 hover:bg-white transition-colors">
                    <input type="checkbox" class="issue-order-checkbox h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                           data-order-id="${o.id}" data-client-id="${clientId}" data-track-code="${o.track_code}">
                    <span class="font-mono text-gray-700">${o.track_code}</span>
                    ${o.comment ? `<span class="text-xs bg-yellow-100 px-1 rounded text-gray-600 truncate max-w-[100px]">${o.comment}</span>` : ''}
                    ${o.calculated_final_cost_som ? `<span class="text-xs font-bold text-green-600 ml-auto whitespace-nowrap">${o.calculated_final_cost_som.toFixed(0)} —Å.</span>` : ''}
                </li>
            `).join('');

            const clientDiv = document.createElement('div');
            clientDiv.className = 'client-group bg-white rounded-lg shadow-sm border mb-3 overflow-hidden'; // –£–±—Ä–∞–ª p-4
            
            // –î–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–∏—Å–∫–∞
            clientDiv.dataset.clientName = client.full_name?.toLowerCase() || '';
            clientDiv.dataset.clientCode = clientCode.toLowerCase();
            clientDiv.dataset.clientPhone = client.phone || '';
            clientDiv.dataset.trackCodes = group.orders.map(o => o.track_code?.toLowerCase() || '').join(',');

            // HTML –ê–ö–ö–û–†–î–ï–û–ù–ê –í–´–î–ê–ß–ò (–ë–µ–∑ inline-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤)
            clientDiv.innerHTML = `
                <div class="issue-group-header bg-gray-50 p-3 flex flex-wrap justify-between items-center gap-2 cursor-pointer select-none hover:bg-gray-100 transition-colors"
                     data-client-id="${clientId}">
                    
                    <div class="flex items-center gap-3 pointer-events-none"> <input type="checkbox" class="select-all-client-orders h-5 w-5 rounded border-gray-400 text-indigo-600 focus:ring-indigo-500 pointer-events-auto"
                               data-client-id="${clientId}">
                        
                        <div class="flex items-center gap-2">
                            <div class="arrow-icon transform transition-transform duration-200 text-gray-400">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-800 text-sm sm:text-base">${client.full_name} <span class="text-indigo-600">(${clientCode})</span></h3>
                                <p class="text-xs text-gray-500">${client.phone}</p>
                            </div>
                        </div>
                    </div>

                    <button class="issue-btn bg-green-500 text-white font-bold py-1.5 px-3 rounded hover:bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed text-xs transition-colors pointer-events-auto"
                            data-client-id="${clientId}" disabled>
                        –í—ã–¥–∞—Ç—å
                    </button>
                </div>

                <div class="issue-list-body hidden bg-gray-50/30 border-t">
                    <ul class="space-y-0 px-4 py-2">
                        ${ordersHtml}
                    </ul>
                </div>
            `;
            listDiv.appendChild(clientDiv);
        }
        console.log("[Fetch] fetchAndRenderIssueList: Render complete.");

    } catch (error) {
        listDiv.innerHTML = `<p class="text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</p>`;
    } finally {
        hideLoader();
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞ (–í—ã–¥–∞—á–∞)
function toggleIssueGroup(header) {
    const body = header.nextElementSibling; // –°–ª–µ–¥—É—é—â–∏–π —ç–ª–µ–º–µ–Ω—Ç - —ç—Ç–æ —Å–ø–∏—Å–æ–∫
    const arrow = header.querySelector('.arrow-icon');
    
    if (body.classList.contains('hidden')) {
        body.classList.remove('hidden');
        arrow.classList.add('rotate-180');
    } else {
        body.classList.add('hidden');
        arrow.classList.remove('rotate-180');
    }
}

// --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —á–µ–∫–±–æ–∫—Å–æ–≤ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ –í—ã–¥–∞—á–∞ ---
function handleIssueCheckboxChange(e) {
    const target = e.target;
    let clientId = target.dataset.clientId;

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ" –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞
    if (target.classList.contains('select-all-client-orders')) {
        const isChecked = target.checked;
        document.querySelectorAll(`.issue-order-checkbox[data-client-id="${clientId}"]`).forEach(cb => cb.checked = isChecked);
    } 
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–¥–∏–Ω–æ—á–Ω–æ–≥–æ —á–µ–∫–±–æ–∫—Å–∞ (–æ–±–Ω–æ–≤–ª—è–µ–º "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ", –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
    else if (target.classList.contains('issue-order-checkbox')) {
        clientId = target.dataset.clientId; // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
        const allCheckboxes = document.querySelectorAll(`.issue-order-checkbox[data-client-id="${clientId}"]`);
        const checkedCount = document.querySelectorAll(`.issue-order-checkbox[data-client-id="${clientId}"]:checked`).length;
        const selectAll = document.querySelector(`.select-all-client-orders[data-client-id="${clientId}"]`);
        
        if (selectAll) {
             if (checkedCount === 0) {
                 selectAll.checked = false;
                 selectAll.indeterminate = false;
             } else if (checkedCount === allCheckboxes.length) {
                 selectAll.checked = true;
                 selectAll.indeterminate = false;
             } else {
                 selectAll.checked = false;
                 selectAll.indeterminate = true;
             }
        }
    } else {
         return; // –í—ã—Ö–æ–¥–∏–º, –µ—Å–ª–∏ –∫–ª–∏–∫ –Ω–µ –ø–æ —á–µ–∫–±–æ–∫—Å—É
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ "–í—ã–¥–∞—Ç—å" –¥–ª—è —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
    const issueBtn = document.querySelector(`.issue-btn[data-client-id="${clientId}"]`);
    if (issueBtn) {
        const anyChecked = document.querySelector(`.issue-order-checkbox[data-client-id="${clientId}"]:checked`);
        issueBtn.disabled = !anyChecked; // –ö–Ω–æ–ø–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞, –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Ö–æ—Ç—è –±—ã 1 –∑–∞–∫–∞–∑
    }
}

// --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–µ "–í—ã–¥–∞—Ç—å" ---
// –ï–¥–∏–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤ –≤ —Å–ø–∏—Å–∫–µ –í—ã–¥–∞—á–∏
function handleIssueListClick(e) {
    const target = e.target;
    
    // 1. –ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ "–í–´–î–ê–¢–¨"
    const issueBtn = target.closest('.issue-btn');
    if (issueBtn) {
        e.stopPropagation(); // –í–∞–∂–Ω–æ! –ß—Ç–æ–±—ã –Ω–µ —Å–≤–µ—Ä–Ω—É–ª—Å—è –∞–∫–∫–æ—Ä–¥–µ–æ–Ω
        if (!issueBtn.disabled) {
            const clientId = issueBtn.dataset.clientId;
            const selectedCheckboxes = document.querySelectorAll(`.issue-order-checkbox[data-client-id="${clientId}"]:checked`);
            const ordersToIssue = Array.from(selectedCheckboxes).map(cb => ({
                id: parseInt(cb.dataset.orderId),
                track_code: cb.dataset.trackCode
            }));

            if (ordersToIssue.length > 0) {
                renderIssueModal(ordersToIssue);
            }
        }
        return;
    }

    // 2. –ö–ª–∏–∫ –ø–æ –ß–µ–∫–±–æ–∫—Å—É "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ —É –∫–ª–∏–µ–Ω—Ç–∞"
    if (target.classList.contains('select-all-client-orders')) {
        e.stopPropagation(); // –ß—Ç–æ–±—ã –Ω–µ —Å–≤–µ—Ä–Ω—É–ª—Å—è –∞–∫–∫–æ—Ä–¥–µ–æ–Ω
        // –õ–æ–≥–∏–∫–∞ —á–µ–∫–±–æ–∫—Å–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤ 'change' event listener, –∑–¥–µ—Å—å –ø—Ä–æ—Å—Ç–æ —Å—Ç–æ–ø–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ
        return;
    }

    // 3. –ö–ª–∏–∫ –ø–æ –®–∞–ø–∫–µ (–ê–∫–∫–æ—Ä–¥–µ–æ–Ω)
    const header = target.closest('.issue-group-header');
    if (header) {
        const body = header.nextElementSibling;
        const arrow = header.querySelector('.arrow-icon');
        
        if (body.classList.contains('hidden')) {
            body.classList.remove('hidden');
            arrow.classList.add('rotate-180');
        } else {
            body.classList.add('hidden');
            arrow.classList.remove('rotate-180');
        }
    }
}

// --- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ú–æ–¥–∞–ª—å–Ω–æ–≥–æ –û–∫–Ω–∞ –í—ã–¥–∞—á–∏ ---
async function renderIssueModal(ordersToIssue) {
    console.log("[Render Issue Modal] Start rendering for orders:", ordersToIssue);
    // –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç—ã –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    const issueModal = document.getElementById('issue-modal');
    // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if (!issueModal) {
        console.error("!!! renderIssueModal: Modal element #issue-modal not found!");
        return;
    }
    const modalContent = issueModal.querySelector('.modal-content');
    // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if (!modalContent) {
        console.error("!!! renderIssueModal: Modal content container (.modal-content) not found!");
        return;
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    modalContent.innerHTML = '<p class="text-center p-8 animate-pulse">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–¥–∞—á–∏...</p>';
    openModal('issue-modal'); // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    showLoader(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –ª–æ–∞–¥–µ—Ä

    try {
        // --- –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–æ–≤ –∏–∑ –∫—ç—à–∞ ---
        // –°–æ–∑–¥–∞–µ–º Map –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–æ–ª–Ω—ã–º –¥–∞–Ω–Ω—ã–º –ø–æ ID –∑–∞–∫–∞–∑–∞
        const fullOrderDataMap = new Map();
        // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ —Å–ø–∏—Å–∫—É ID –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è –≤—ã–¥–∞—á–∏
        ordersToIssue.forEach(o => {
            // –ò—â–µ–º –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞ –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–º –∫—ç—à–µ companyOrders
            const fullData = companyOrders.find(co => co.id === o.id);
            // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–∞–π–¥–µ–Ω—ã, –¥–æ–±–∞–≤–ª—è–µ–º –∏—Ö –≤ Map
            if (fullData) {
                fullOrderDataMap.set(o.id, fullData);
            } else {
                // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ–º, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –∫—ç—à–µ
                console.warn(`[Render Issue Modal] Full data for Order ID ${o.id} not found in cache.`);
            }
        });

        // --- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—É—é (—Ä–∞—Å—á–µ—Ç–Ω—É—é) —Å—É–º–º—É ---
        let preCalculatedTotal = 0;
        // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –Ω–∞–π–¥–µ–Ω–Ω—ã–º –ø–æ–ª–Ω—ã–º –¥–∞–Ω–Ω—ã–º –∑–∞–∫–∞–∑–æ–≤
        fullOrderDataMap.forEach(o => {
            // –°—É–º–º–∏—Ä—É–µ–º –ø—Ä–µ–¥—Ä–∞—Å—á–∏—Ç–∞–Ω–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å (calculated_final_cost_som), –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
            preCalculatedTotal += o.calculated_final_cost_som || 0;
        });
        console.log(`[Render Issue Modal] Pre-calculated total: ${preCalculatedTotal}`);

        // --- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –¥–ª—è —Å–ø–∏—Å–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –° –ü–†–ï–î–ó–ê–ü–û–õ–ù–ï–ù–ù–´–ú –í–ï–°–û–ú ---
        const ordersHtml = ordersToIssue.map(o => {
            // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —ç—Ç–æ–≥–æ –∑–∞–∫–∞–∑–∞ –∏–∑ —Å–æ–∑–¥–∞–Ω–Ω–æ–π Map
            const orderData = fullOrderDataMap.get(o.id);
            // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–µ–¥—Ä–∞—Å—á–∏—Ç–∞–Ω–Ω—ã–π –≤–µ—Å (calculated_weight_kg) –∏–ª–∏ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            const calculatedWeight = orderData?.calculated_weight_kg ?? ''; // –ò—Å–ø–æ–ª—å–∑—É–µ–º ?? '' –¥–ª—è value

            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º HTML –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–∞ —Å–ø–∏—Å–∫–∞
            return `
            <div class="flex justify-between items-center border-b pb-2 mb-2">
                <span class="font-semibold text-sm">${o.track_code}</span>
                <input type="number" step="any" placeholder="–í–µ—Å (–∫–≥)"
                       class="issue-weight-input w-24 p-1 border rounded text-sm"
                       data-order-id="${o.id}"
                       value="${calculatedWeight}" /* <-- –í–°–¢–ê–í–õ–ï–ù–û –ó–ù–ê–ß–ï–ù–ò–ï –í–ï–°–ê */
                       required> </div>
            `;
        }).join(''); // –°–æ–µ–¥–∏–Ω—è–µ–º HTML –≤—Å–µ—Ö –∑–∞–∫–∞–∑–æ–≤
        // --- –ö–û–ù–ï–¶ –ì–ï–ù–ï–†–ê–¶–ò–ò HTML –°–ü–ò–°–ö–ê –ó–ê–ö–ê–ó–û–í ---

        // --- –ü–æ–ª—É—á–∞–µ–º –∫—É—Ä—Å—ã –∏ —Ü–µ–Ω—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ---
        let defaultPrice = 5.5; // –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        let defaultRate = 87.5; // –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        // –ü—ã—Ç–∞–µ–º—Å—è –≤–∑—è—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –¢–ï–ö–£–©–ï–ô –ê–ö–¢–ò–í–ù–û–ô —Å–º–µ–Ω—ã (–µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å)
        if (activeShift) {
             defaultPrice = activeShift.price_per_kg_usd || defaultPrice;
             defaultRate = activeShift.exchange_rate_usd || defaultRate;
             console.log("[Render Issue Modal] Using values from active shift:", defaultPrice, defaultRate);
        } else {
             console.log("[Render Issue Modal] Active shift not found, using default values.");
        }

        // --- –°–æ–±–∏—Ä–∞–µ–º HTML –≤—Å–µ–≥–æ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ ---
        modalContent.innerHTML = `
            <div class="flex justify-between items-start mb-4">
                 <h3 class="text-2xl font-bold">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –≤—ã–¥–∞—á–∏ (${ordersToIssue.length} –∑–∞–∫.)</h3>
                 <button onclick="closeModal('issue-modal')" class="text-2xl font-bold leading-none p-1 -m-1">&times;</button>
            </div>
            <form id="issue-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div class="p-3 bg-blue-50 rounded-lg">
                            <label for="total-weight-input" class="block text-sm font-medium">–û–±—â–∏–π –≤–µ—Å (–∫–≥)</label>
                            <input type="number" step="any" id="total-weight-input" placeholder="–î–ª—è –∞–≤—Ç–æ-—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è" class="mt-1 w-full p-2 border rounded-md">
                        </div>
                        <div class="max-h-60 overflow-y-auto pr-2">${ordersHtml}</div> <div class="p-3 bg-gray-100 rounded-lg space-y-2">
                            <div>
                                <label for="issue-price-per-kg" class="block text-sm">–¶–µ–Ω–∞ –∑–∞ –∫–≥ ($) *</label>
                                <input type="number" step="0.1" id="issue-price-per-kg" value="${defaultPrice}" class="w-full p-2 border rounded" required>
                            </div>
                            <div>
                                <label for="issue-exchange-rate" class="block text-sm">–ö—É—Ä—Å USD (—Å–æ–º) *</label>
                                <input type="number" step="0.1" id="issue-exchange-rate" value="${defaultRate}" class="w-full p-2 border rounded" required>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label for="payment-method-select" class="block text-sm font-medium">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</label>
                            <select id="payment-method-select" class="w-full mt-1 p-2 border rounded-md bg-white">
                                <option value="cash">–ù–∞–ª–∏—á–Ω—ã–µ</option>
                                <option value="card">–ö–∞—Ä—Ç–æ–π</option>
                                <option value="mixed">–°–º–µ—à–∞–Ω–Ω—ã–π</option>
                            </select>
                        </div>
                        <div id="payment-fields-container" class="space-y-3">
                            </div>
                        <div class="p-4 bg-indigo-50 rounded-lg text-right space-y-2">
                            ${preCalculatedTotal > 0 ? `<div class="text-sm text-gray-600">–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è —Å—É–º–º–∞: ${preCalculatedTotal.toFixed(2)} —Å–æ–º</div>` : ''}
                            <div class="text-lg">–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ (—Ñ–∞–∫—Ç): <span id="total-cost-display" class="font-bold">0.00 —Å–æ–º</span></div>
                            <div class="text-md">–í—Å–µ–≥–æ –æ–ø–ª–∞—á–µ–Ω–æ: <span id="total-paid-display" class="font-bold">0.00 —Å–æ–º</span></div>
                            <div class="text-xl text-green-600">–°–¥–∞—á–∞: <span id="change-display" class="font-bold">0.00 —Å–æ–º</span></div>
                        </div>
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-4 border-t pt-4"> <button type="button" onclick="closeModal('issue-modal')" class="bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-6 rounded-lg">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">–í—ã–¥–∞—Ç—å</button>
                </div>
            </form>
        `;

        // --- –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –ª–æ–≥–∏–∫—É —Ä–∞—Å—á–µ—Ç–∞ –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫ —Å–æ–∑–¥–∞–Ω–Ω—ã–º —ç–ª–µ–º–µ–Ω—Ç–∞–º ---
        setupIssueModalLogic(); // <--- –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ä–∞—Å—á–µ—Ç—ã –∏ —Å–ª—É—à–∞—Ç–µ–ª–∏ –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª–∫–∏
        console.log("[Render Issue Modal] Logic attached.");

    } catch (error) { // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ –æ–∫–Ω–∞
         console.error("!!! [Render Issue Modal] Error preparing modal:", error);
         // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
         modalContent.innerHTML = `
              <div class="flex justify-between items-start mb-4">
                 <h3 class="text-2xl font-bold text-red-700">–û—à–∏–±–∫–∞</h3>
                 <button onclick="closeModal('issue-modal')" class="text-2xl font-bold">&times;</button>
              </div>
              <p class="text-red-600">–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –æ–∫–Ω–æ –≤—ã–¥–∞—á–∏: ${error.message}</p>
              <div class="mt-6 text-right">
                  <button onclick="closeModal('issue-modal')" class="bg-gray-300 py-2 px-4 rounded">–ó–∞–∫—Ä—ã—Ç—å</button>
              </div>`;
    } finally {
         // –í –ª—é–±–æ–º —Å–ª—É—á–∞–µ —Å–∫—Ä—ã–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –ª–æ–∞–¥–µ—Ä
         hideLoader();
         console.log("[Render Issue Modal] End.");
    }
}

// --- –õ–æ–≥–∏–∫–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤—ã–¥–∞—á–∏ (—Ä–∞—Å—á–µ—Ç, –ø–æ–ª—è –æ–ø–ª–∞—Ç—ã) ---
function setupIssueModalLogic() {
    const form = document.getElementById('issue-form');
    const paymentMethodSelect = document.getElementById('payment-method-select');
    const paymentFieldsContainer = document.getElementById('payment-fields-container');
    const totalWeightInput = document.getElementById('total-weight-input');
    const individualWeightInputs = document.querySelectorAll('.issue-weight-input');
    const priceInput = document.getElementById('issue-price-per-kg');
    const rateInput = document.getElementById('issue-exchange-rate');
    let totalCost = 0; // –ì–ª–æ–±–∞–ª—å–Ω–∞—è (–≤ —Ä–∞–º–∫–∞—Ö –º–æ–¥–∞–ª–∫–∏) –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –∏—Ç–æ–≥–æ–≤–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏

    const updateTotals = () => {
        const price = parseFloat(priceInput.value) || 0;
        const rate = parseFloat(rateInput.value) || 0;
        let totalWeight = 0;
        individualWeightInputs.forEach(input => { totalWeight += parseFloat(input.value) || 0; });
        totalCost = totalWeight * price * rate;
        document.getElementById('total-cost-display').textContent = `${totalCost.toFixed(2)} —Å–æ–º`;
        updatePaymentFields(); // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–ø–ª–∞—Ç—É, —Ç.–∫. –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –∏—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞
    };

    const updatePaymentFields = () => {
        const method = paymentMethodSelect.value;
        let cashPaid = parseFloat(document.getElementById('issue-paid-cash')?.value) || 0;
        let cardPaid = parseFloat(document.getElementById('issue-paid-card')?.value) || 0;
        
        // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ –æ–ø–ª–∞—Ç–∞ –∫–∞—Ä—Ç–æ–π, –ø–æ–ª–µ –∫–∞—Ä—Ç—ã –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        if (method === 'card') {
            cardPaid = totalCost;
            cashPaid = 0; // –ù–∞–ª–∏—á–Ω—ã—Ö –Ω–µ—Ç
             const cardInput = document.getElementById('issue-paid-card');
             if (cardInput) cardInput.value = cardPaid.toFixed(2);
        }
        
        let totalPaid = cashPaid + cardPaid;
        let change = totalPaid > totalCost ? totalPaid - totalCost : 0;
        
        document.getElementById('total-paid-display').textContent = `${totalPaid.toFixed(2)} —Å–æ–º`;
        document.getElementById('change-display').textContent = `${change.toFixed(2)} —Å–æ–º`;
    };

    const renderPaymentFields = () => {
        const method = paymentMethodSelect.value;
        paymentFieldsContainer.innerHTML = '';
        const cashField = `<div><label class="block text-sm">–ù–∞–ª–∏—á–Ω—ã–º–∏ (—Å–æ–º)</label><input type="number" id="issue-paid-cash" value="0" step="any" class="w-full p-2 border rounded"></div>`;
        // –ü–æ–ª–µ –∫–∞—Ä—Ç—ã –¥–µ–ª–∞–µ–º readonly —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ –æ–ø–ª–∞—Ç–∞ –¢–û–õ–¨–ö–û –∫–∞—Ä—Ç–æ–π
        const cardField = `<div><label class="block text-sm">–ö–∞—Ä—Ç–æ–π (—Å–æ–º)</label><input type="number" id="issue-paid-card" value="0.00" step="any" class="w-full p-2 border rounded" ${method === 'card' ? 'readonly' : ''}></div>`;
        // –¢–∏–ø—ã –∫–∞—Ä—Ç - TODO: –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ config –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ?
        const cardTypes = ["MBank", "Optima", "DemirBank", "–î—Ä—É–≥–æ–µ"]; 
        const cardTypeField = `<div><label class="block text-sm">–¢–∏–ø –∫–∞—Ä—Ç—ã</label><select id="issue-card-type" class="w-full p-2 border rounded bg-white">${cardTypes.map(t => `<option value="${t}">${t}</option>`).join('')}</select></div>`;

        if (method === 'cash') paymentFieldsContainer.innerHTML = cashField;
        if (method === 'card') paymentFieldsContainer.innerHTML = cardField + cardTypeField;
        if (method === 'mixed') paymentFieldsContainer.innerHTML = cashField + cardField + cardTypeField;

        // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏ –∫ –ø–æ–ª—è–º –æ–ø–ª–∞—Ç—ã –ü–û–°–õ–ï –∏—Ö —Å–æ–∑–¥–∞–Ω–∏—è
        document.getElementById('issue-paid-cash')?.addEventListener('input', () => {
            // –í —Å–º–µ—à–∞–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ –∞–≤—Ç–æ-–∑–∞–ø–æ–ª–Ω—è–µ–º –∫–∞—Ä—Ç—É –æ—Å—Ç–∞—Ç–∫–æ–º
            if (method === 'mixed') {
                const cashAmount = parseFloat(document.getElementById('issue-paid-cash').value) || 0;
                const remainder = totalCost - cashAmount;
                document.getElementById('issue-paid-card').value = (remainder > 0 ? remainder : 0).toFixed(2);
            }
            updatePaymentFields(); // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â—É—é –æ–ø–ª–∞—Ç—É –∏ —Å–¥–∞—á—É
        });
        document.getElementById('issue-paid-card')?.addEventListener('input', updatePaymentFields);
        
        updateTotals(); // –í—ã–∑—ã–≤–∞–µ–º –æ–¥–∏–Ω —Ä–∞–∑ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ —Ä–∞—Å—á–µ—Ç–∞ –ø—Ä–∏ card/cash
    };

    renderPaymentFields(); // –†–µ–Ω–¥–µ—Ä–∏–º –ø–æ–ª—è –æ–ø–ª–∞—Ç—ã –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    paymentMethodSelect.addEventListener('change', renderPaymentFields); // –ü–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä–∏–≤–∞–µ–º –ø—Ä–∏ —Å–º–µ–Ω–µ —Å–ø–æ—Å–æ–±–∞
    [priceInput, rateInput].forEach(el => el.addEventListener('input', updateTotals)); // –°–ª—É—à–∞—Ç–µ–ª–∏ —Ü–µ–Ω—ã/–∫—É—Ä—Å–∞
    
    // –°–ª—É—à–∞—Ç–µ–ª—å –æ–±—â–µ–≥–æ –≤–µ—Å–∞
    totalWeightInput.addEventListener('input', () => {
        const totalWeight = parseFloat(totalWeightInput.value) || 0;
        if (totalWeight >= 0 && individualWeightInputs.length > 0) {
            const weightPerItem = (totalWeight / individualWeightInputs.length).toFixed(3);
            individualWeightInputs.forEach(input => { input.value = weightPerItem; });
        } else { individualWeightInputs.forEach(input => { input.value = ''; }); }
        updateTotals(); // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∏—Ç–æ–≥
    });
    
    // –°–ª—É—à–∞—Ç–µ–ª–∏ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö –≤–µ—Å–æ–≤
    individualWeightInputs.forEach(input => {
        input.addEventListener('input', () => {
            totalWeightInput.value = ''; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –æ–±—â–∏–π –≤–µ—Å
            updateTotals(); // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∏—Ç–æ–≥
        });
    });
    
    // –°–ª—É—à–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    form.addEventListener('submit', handleIssueSubmit);
}

// --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã –≤—ã–¥–∞—á–∏ ---
async function handleIssueSubmit(e) {
    e.preventDefault();
    const ordersPayload = Array.from(document.querySelectorAll('.issue-weight-input')).map(input => ({
        order_id: parseInt(input.dataset.orderId),
        weight_kg: parseFloat(input.value)
    }));
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–µ—Å–∞
    if (ordersPayload.some(o => !o.weight_kg || o.weight_kg <= 0)) {
        alert('–û—à–∏–±–∫–∞: –í–µ—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–∫–∞–∑–∞–Ω (–±–æ–ª—å—à–µ –Ω—É–ª—è) –¥–ª—è –≤—Å–µ—Ö –∑–∞–∫–∞–∑–æ–≤.');
        return;
    }
    
    const method = document.getElementById('payment-method-select').value;
    const paidCash = (method === 'cash' || method === 'mixed') ? (parseFloat(document.getElementById('issue-paid-cash')?.value) || 0) : 0;
    const paidCard = (method === 'card' || method === 'mixed') ? (parseFloat(document.getElementById('issue-paid-card')?.value) || 0) : 0;
    
    // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É–º–º—ã –æ–ø–ª–∞—Ç—ã (–º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å, —Å—Ä–∞–≤–Ω–∏–≤ —Å totalCost)
    if (paidCash < 0 || paidCard < 0) {
        alert("–°—É–º–º—ã –æ–ø–ª–∞—Ç—ã –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º–∏."); return;
    }

    const payload = {
        orders: ordersPayload,
        price_per_kg_usd: parseFloat(document.getElementById('issue-price-per-kg').value),
        exchange_rate_usd: parseFloat(document.getElementById('issue-exchange-rate').value),
        paid_cash: paidCash,
        paid_card: paidCard,
        card_payment_type: (method === 'card' || method === 'mixed') ? document.getElementById('issue-card-type')?.value : null
    };

    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ü–µ–Ω—ã –∏ –∫—É—Ä—Å–∞
    if (!payload.price_per_kg_usd || payload.price_per_kg_usd <= 0 || !payload.exchange_rate_usd || payload.exchange_rate_usd <= 0) {
        alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Ü–µ–Ω—É –∏ –∫—É—Ä—Å."); return;
    }

    showLoader(); 
    try {
        const response = await apiFetch('/api/orders/issue', { // –ò—Å–ø–æ–ª—å–∑—É–µ–º /api
            method: 'POST',
            body: JSON.stringify(payload)
        });
        
        alert(response.message || '–ó–∞–∫–∞–∑—ã —É—Å–ø–µ—à–Ω–æ –≤—ã–¥–∞–Ω—ã!');
        closeModal('issue-modal');
        await fetchAndRenderIssueList(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –≥–æ—Ç–æ–≤—ã—Ö –∫ –≤—ã–¥–∞—á–µ
        
    } catch (error) {
        alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–¥–∞—á–µ: ${error.message}`);
    } finally {
        hideLoader(); 
    }
}

// --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ò—Å—Ç–æ—Ä–∏–∏ –í—ã–¥–∞–Ω–Ω—ã—Ö ---

// index.html (–ü–û–õ–ù–û–°–¢–¨–Æ –ó–ê–ú–ï–ù–Ø–ï–¢ showIssuedHistory)

async function showIssuedHistory() {
    const issuedHistoryModal = document.getElementById('issued-history-modal');
    const modalContent = issuedHistoryModal.querySelector('.modal-content');
    const today = new Date().toISOString().split('T')[0];

    // --- HTML –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ —Ñ–∏–ª–∏–∞–ª–æ–≤ (—Ç–æ–ª—å–∫–æ –í–ª–∞–¥–µ–ª–µ—Ü) ---
    let locationFilterHistoryHtml = '';
    if (currentUser.role === '–í–ª–∞–¥–µ–ª–µ—Ü' && companyLocations && companyLocations.length > 1) {
        const locationOptions = companyLocations.map(loc =>
            `<option value="${loc.id}" ${loc.id === currentUser.location_id ? 'selected' : ''}>${loc.name}</option>`
        ).join('');
        locationFilterHistoryHtml = `
            <div class="flex-shrink-0">
                <label for="history-location-filter" class="block text-sm font-medium text-gray-700">–§–∏–ª–∏–∞–ª:</label>
                <select id="history-location-filter" class="mt-1 p-2 border rounded-md bg-white text-sm w-40">
                    <option value="">-- –í—Å–µ —Ñ–∏–ª–∏–∞–ª—ã --</option>
                    ${locationOptions}
                </select>
            </div>
        `;
    }
    // --- –ö–û–ù–ï–¶ HTML –§–ò–õ–¨–¢–†–ê ---

    modalContent.innerHTML = `
        <div class="flex justify-between items-center mb-4">
             <h3 class="text-2xl font-bold">–ò—Å—Ç–æ—Ä–∏—è –≤—ã–¥–∞–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</h3>
             <button onclick="closeModal('issued-history-modal')" class="text-2xl font-bold">&times;</button>
        </div>
        <div class="flex flex-wrap gap-4 items-end p-4 bg-gray-50 rounded-lg mb-4 border">
            
            <div> <label for="history-start-date" class="block text-sm font-medium">–°</label> <input type="date" id="history-start-date" value="${today}" class="mt-1 p-2 border rounded-md"> </div>
            <div> <label for="history-end-date" class="block text-sm font-medium">–ü–æ</label> <input type="date" id="history-end-date" value="${today}" class="mt-1 p-2 border rounded-md"> </div>
            
            ${locationFilterHistoryHtml}
            
            <button id="filter-history-btn" class="bg-blue-600 text-white py-2 px-4 rounded-md ml-auto">–ü–æ–∫–∞–∑–∞—Ç—å</button>
        </div>
        <div id="history-content" class="overflow-y-auto max-h-[60vh]">
            <p class="animate-pulse">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</p>
        </div>
    `;
    openModal('issued-history-modal');

    // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –∫ –∫–Ω–æ–ø–∫–µ "–ü–æ–∫–∞–∑–∞—Ç—å" –∏ —Ñ–∏–ª—å—Ç—Ä—É —Ñ–∏–ª–∏–∞–ª–æ–≤
    document.getElementById('filter-history-btn')?.addEventListener('click', fetchAndRenderHistory);
    document.getElementById('history-location-filter')?.addEventListener('change', fetchAndRenderHistory); // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å
    
    // –°—Ä–∞–∑—É –∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∑–∞ —Å–µ–≥–æ–¥–Ω—è
    await fetchAndRenderHistory();
}

// index.html (–ü–û–õ–ù–û–°–¢–¨–Æ –ó–ê–ú–ï–ù–Ø–ï–¢ fetchAndRenderHistory)

async function fetchAndRenderHistory() {
    const contentDiv = document.getElementById('history-content');
    const startDate = document.getElementById('history-start-date')?.value;
    const endDate = document.getElementById('history-end-date')?.value;
    if (!contentDiv || !startDate || !endDate) return;

    contentDiv.innerHTML = '<p class="animate-pulse">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</p>';
    showLoader(); 

    // --- –î–û–ë–ê–í–õ–ï–ù–ò–ï: –°—á–∏—Ç—ã–≤–∞–µ–º –∏ –ø–µ—Ä–µ–¥–∞–µ–º location_id ---
    const params = new URLSearchParams({
        start_date: startDate,
        end_date: endDate
    });
    if (currentUser.role === '–í–ª–∞–¥–µ–ª–µ—Ü') {
        const locationSelect = document.getElementById('history-location-filter');
        if (locationSelect && locationSelect.value) {
            params.append('location_id', locationSelect.value);
            console.log("[Fetch History] Filtering history by location_id:", locationSelect.value);
        }
    }
    const url = `/api/orders/issued?${params.toString()}`;
    console.log("[Fetch History] Requesting URL:", url);
    // --- –ö–û–ù–ï–¶ –î–û–ë–ê–í–õ–ï–ù–ò–Ø ---

    try {
        const issuedOrders = await apiFetch(url); // –ò—Å–ø–æ–ª—å–∑—É–µ–º URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏

        if (!issuedOrders || issuedOrders.length === 0) {
            contentDiv.innerHTML = '<p class="text-gray-500">–í—ã–¥–∞–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –∑–∞ —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥ (—Å —É—á–µ—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–∞) –Ω–µ—Ç.</p>';
            return;
        }

        const tableRows = issuedOrders.map(o => `
            <tr class="border-b hover:bg-gray-50 text-sm">
                <td class="p-2">${new Date(o.issued_at).toLocaleString()}</td>
                <td class="p-2">${o.client?.full_name || '?'} (${o.client?.client_code_prefix || ''}${o.client?.client_code_num || '?'})</td>
                <td class="p-2">${o.track_code}</td>
                <td class="p-2">${o.weight_kg?.toFixed(3) || '-'} –∫–≥</td>
                <td class="p-2">${o.final_cost_som?.toFixed(2) || '-'} —Å–æ–º</td>
                <td class="p-2">
                    <button class="revert-status-btn text-xs bg-yellow-400 hover:bg-yellow-500 text-yellow-900 px-2 py-1 rounded" 
                            data-order-id="${o.id}">–í–µ—Ä–Ω—É—Ç—å</button>
                </td>
            </tr>
        `).join('');

        contentDiv.innerHTML = `
            <div class="mb-4">
                 <input type="search" id="history-search-input" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∫–ª–∏–µ–Ω—Ç—É, —Ç—Ä–µ–∫-–∫–æ–¥—É..." class="w-full p-2 border rounded-lg">
            </div>
            <div class="overflow-y-auto max-h-[50vh]">
                <table class="w-full text-left" id="history-table">
                    <thead class="bg-gray-100 sticky top-0">
                        <tr class="text-xs font-semibold uppercase text-gray-600">
                           <th class="p-2">–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏</th>
                           <th class="p-2">–ö–ª–∏–µ–Ω—Ç</th>
                           <th class="p-2">–¢—Ä–µ–∫-–∫–æ–¥</th>
                           <th class="p-2">–í–µ—Å</th>
                           <th class="p-2">–°—É–º–º–∞</th>
                           <th class="p-2">–î–µ–π—Å—Ç–≤–∏–µ</th>
                        </tr>
                    </thead>
                    <tbody>${tableRows}</tbody>
                </table>
            </div>
        `;

        // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏
        document.getElementById('history-search-input')?.addEventListener('input', handleHistorySearch);
        contentDiv.querySelector('#history-table tbody')?.addEventListener('click', e => {
            const revertBtn = e.target.closest('.revert-status-btn');
            if (revertBtn) {
                const orderId = revertBtn.dataset.orderId;
                
                if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤–µ—Ä–Ω—É—Ç—å —ç—Ç–æ—Ç –∑–∞–∫–∞–∑?')) return;

                // 1. –ó–∞–ø—Ä–æ—Å –ü–∞—Ä–æ–ª—è
                const password = prompt("üîí –í–≤–µ–¥–∏—Ç–µ –≤–∞—à –ø–∞—Ä–æ–ª—å –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤–æ–∑–≤—Ä–∞—Ç–∞:");
                if (password === null) return;
                if (!password) { alert("–ü–∞—Ä–æ–ª—å –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω."); return; }

                // 2. –ó–∞–ø—Ä–æ—Å –ü—Ä–∏—á–∏–Ω—ã
                const reason = prompt("üìù –£–∫–∞–∂–∏—Ç–µ –ü–†–ò–ß–ò–ù–£ –≤–æ–∑–≤—Ä–∞—Ç–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):");
                if (reason === null) return;
                if (!reason || reason.trim().length < 3) {
                    alert("–ü—Ä–∏—á–∏–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —É–∫–∞–∑–∞–Ω–∞. –í–æ–∑–≤—Ä–∞—Ç –æ—Ç–º–µ–Ω–µ–Ω.");
                    return;
                }

                // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–ø—Ä–∞–≤–∫–∏
                handleRevertStatus(orderId, password, reason);
            }
        });

    } catch (error) {
        contentDiv.innerHTML = `<p class="text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏: ${error.message}</p>`;
    } finally {
        hideLoader(); 
    }
}

// –ü–æ–∏—Å–∫ –ø–æ –∏—Å—Ç–æ—Ä–∏–∏ –≤—ã–¥–∞–Ω–Ω—ã—Ö
function handleHistorySearch(e) {
    const searchTerm = e.target.value.toLowerCase().trim();
    document.querySelectorAll('#history-table tbody tr').forEach(row => {
        const rowContent = row.textContent?.toLowerCase() || '';
        row.style.display = rowContent.includes(searchTerm) ? '' : 'none';
    });
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ —Å—Ç–∞—Ç—É—Å–∞
async function handleRevertStatus(orderId, password, reason) {
    console.log(`[Revert] Reverting order ID: ${orderId}`);
    showLoader(); 
    try {
        const payload = {
            password: password,
            revert_reason: reason
        };

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º JSON body, –∞ –Ω–µ query params –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        await apiFetch(`/api/orders/${orderId}/revert_status`, { 
            method: 'PATCH',
            body: JSON.stringify(payload) 
        });

        alert('–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ —É—Å–ø–µ—à–Ω–æ –≤–æ–∑–≤—Ä–∞—â–µ–Ω –Ω–∞ "–ì–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ"!');
        await fetchAndRenderHistory(); // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É –∏—Å—Ç–æ—Ä–∏–∏

    } catch (error) {
        console.error("Revert Error:", error);
        alert(`–û—à–∏–±–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ —Å—Ç–∞—Ç—É—Å–∞: ${error.message}`); // –¢–µ–ø–µ—Ä—å –ø–æ–∫–∞–∂–µ—Ç —Ä–µ–∞–ª—å–Ω—É—é –æ—à–∏–±–∫—É (–Ω–∞–ø—Ä. "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å")
    } finally {
        hideLoader(); 
    }
}



// --- –ü–æ–∏—Å–∫ –ø–æ —Å–ø–∏—Å–∫—É –ì–æ—Ç–æ–≤—ã—Ö –∫ –í—ã–¥–∞—á–µ ---
function handleIssueSearch(e) {
    const searchTerm = e.target.value.toLowerCase().trim();
    document.querySelectorAll('#issue-list .client-group').forEach(group => {
        const name = group.dataset.clientName || '';
        const code = group.dataset.clientCode || '';
        const phone = group.dataset.clientPhone || '';
        const tracks = group.dataset.trackCodes || '';

        const isMatch = name.includes(searchTerm) || 
                        code.includes(searchTerm) || 
                        phone.includes(searchTerm) || 
                        tracks.includes(searchTerm);
        
        group.style.display = isMatch ? 'block' : 'none';
    });
}

// === –ö–û–ù–ï–¶ –ú–û–î–£–õ–Ø –í–´–î–ê–ß–ê ===

// =================================================================
// –ú–û–î–£–õ–¨: –†–ê–°–•–û–î–´ (–í–ª–∞–¥–µ–ª–µ—Ü/–ö–∞—Å—Å–∏—Ä) (v4.1 - Rebuild)
// =================================================================

// --- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≤–∫–ª–∞–¥–∫–∏ "–†–∞—Å—Ö–æ–¥—ã" ---
async function renderExpensesTab() {
    console.log("[Render] renderExpensesTab: Start");
    const today = new Date().toISOString().split('T')[0]; // –°–µ–≥–æ–¥–Ω—è—à–Ω—è—è –¥–∞—Ç–∞ –¥–ª—è –ø–æ–ª–µ–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    const pane = document.getElementById('tab-expenses'); // –ù–∞—Ö–æ–¥–∏–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–∫–ª–∞–¥–∫–∏
    // –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ –≤ HTML –∏–ª–∏ –ø—Ä–∞–≤–∞—Ö), –≤—ã—Ö–æ–¥–∏–º
    if (!pane) {
        console.warn("[Render] renderExpensesTab: Pane #tab-expenses not found.");
        return;
    }

    // --- –î–û–ë–ê–í–ò–¢–¨: HTML –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ —Ñ–∏–ª–∏–∞–ª–æ–≤ (—Ç–æ–ª—å–∫–æ –í–ª–∞–¥–µ–ª–µ—Ü) ---
    let locationFilterHtml = ''; // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –í–ª–∞–¥–µ–ª–µ—Ü
    // –ò –µ—Å–ª–∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∫—ç—à —Ñ–∏–ª–∏–∞–ª–æ–≤ companyLocations –∑–∞–≥—Ä—É–∂–µ–Ω –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –±–æ–ª—å—à–µ –æ–¥–Ω–æ–≥–æ —Ñ–∏–ª–∏–∞–ª–∞
    if (currentUser.role === '–í–ª–∞–¥–µ–ª–µ—Ü' && companyLocations && companyLocations.length > 1) {
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º <option> –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∏–ª–∏–∞–ª–∞
        const locationOptions = companyLocations.map(loc =>
            // –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –≤—ã–±–∏—Ä–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∏–ª–∏–∞–ª –í–ª–∞–¥–µ–ª—å—Ü–∞, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
            `<option value="${loc.id}" ${loc.id === currentUser.location_id ? 'selected' : ''}>${loc.name}</option>`
        ).join(''); // –°–æ–µ–¥–∏–Ω—è–µ–º –≤—Å–µ <option> –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É

        // –§–æ—Ä–º–∏—Ä—É–µ–º HTML –¥–ª—è select'–∞
        locationFilterHtml = `
            <div>
                <label for="expenses-location-filter" class="block text-sm font-medium text-gray-700">–§–∏–ª–∏–∞–ª:</label>
                <select id="expenses-location-filter" class="mt-1 p-2 border rounded-md bg-white text-sm w-full">
                    <option value="">-- –í—Å–µ —Ä–∞—Å—Ö–æ–¥—ã --</option> ${locationOptions} </select>
            </div>
        `;
        console.log("[Render Expenses] –§–∏–ª—å—Ç—Ä —Ñ–∏–ª–∏–∞–ª–æ–≤ –¥–ª—è –í–ª–∞–¥–µ–ª—å—Ü–∞ –¥–æ–±–∞–≤–ª–µ–Ω.");
    } else {
         console.log("[Render Expenses] –§–∏–ª—å—Ç—Ä —Ñ–∏–ª–∏–∞–ª–æ–≤ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.");
    }
    // --- –ö–û–ù–ï–¶ –î–û–ë–ê–í–õ–ï–ù–ò–Ø –§–ò–õ–¨–¢–†–ê –§–ò–õ–ò–ê–õ–û–í ---


    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π HTML –¥–ª—è –≤—Å–µ–π –≤–∫–ª–∞–¥–∫–∏ "–†–∞—Å—Ö–æ–¥—ã"
    pane.innerHTML = `
        <div id="expenses-container" class="bg-white p-6 rounded-lg shadow-md">
            <div class="flex flex-wrap justify-between items-center gap-4 mb-4 border-b pb-4">
                <h2 class="text-2xl font-bold text-gray-800">–£—á–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤</h2>
                <button id="add-expense-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 text-sm">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</button>
            </div>

            <div class="flex flex-wrap gap-4 items-end p-4 bg-gray-50 rounded-lg mb-4 border">
                <div>
                    <label for="expense-start-date" class="block text-sm font-medium text-gray-700">–°</label>
                    <input type="date" id="expense-start-date" value="${today}" class="mt-1 p-2 border rounded-md">
                </div>
                <div>
                    <label for="expense-end-date" class="block text-sm font-medium text-gray-700">–ü–æ</label>
                    <input type="date" id="expense-end-date" value="${today}" class="mt-1 p-2 border rounded-md">
                </div>
                ${locationFilterHtml}
                <button id="filter-expenses-btn" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 ml-auto">–ü–æ–∫–∞–∑–∞—Ç—å</button> </div>

            <div class="mb-4">
                <input type="search" id="expenses-search-input" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ —Ç–∏–ø—É, —Å—É–º–º–µ, –ø—Ä–∏–º–µ—á–∞–Ω–∏—é..." class="w-full p-2 border rounded-lg">
            </div>

            <div id="expenses-list" class="space-y-3">
                <p class="text-gray-500">–ù–∞–∂–º–∏—Ç–µ "–ü–æ–∫–∞–∑–∞—Ç—å", —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞—Å—Ö–æ–¥—ã –∑–∞ –ø–µ—Ä–∏–æ–¥.</p>
            </div>
        </div>
    `;

    // --- –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏ –∫ —ç–ª–µ–º–µ–Ω—Ç–∞–º, –∫–æ—Ç–æ—Ä—ã–µ –º—ã –¢–û–õ–¨–ö–û –ß–¢–û —Å–æ–∑–¥–∞–ª–∏ ---
    // –ù–∞—Ö–æ–¥–∏–º –≥–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–∫–ª–∞–¥–∫–∏
    const containerDiv = document.getElementById('expenses-container');
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞–π–¥–µ–Ω –ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
    if (containerDiv) {
        // –ö–Ω–æ–ø–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥"
        const addBtn = document.getElementById('add-expense-btn');
        // –ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –Ω–∞–π–¥–µ–Ω–∞, –¥–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –∫–ª–∏–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–∫—Ä–æ–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        if (addBtn) addBtn.addEventListener('click', () => openExpenseModal());

        // –ö–Ω–æ–ø–∫–∞ "–ü–æ–∫–∞–∑–∞—Ç—å" (–¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –¥–∞—Ç—ã –∏ —Ñ–∏–ª–∏–∞–ª–∞)
        const filterBtn = document.getElementById('filter-expenses-btn');
        // –ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –Ω–∞–π–¥–µ–Ω–∞, –¥–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –∫–ª–∏–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–∑–æ–≤–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É –∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ä–∞—Å—Ö–æ–¥–æ–≤
        if (filterBtn) filterBtn.addEventListener('click', fetchAndRenderExpenses);

        // –ü–æ–ª–µ –ø–æ–∏—Å–∫–∞
        const searchInput = document.getElementById('expenses-search-input');
        // –ï—Å–ª–∏ –ø–æ–ª–µ –Ω–∞–π–¥–µ–Ω–æ, –¥–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –≤–≤–æ–¥–∞, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –£–ñ–ï –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫
        if (searchInput) searchInput.addEventListener('input', handleExpensesSearch);

        // –°–ø–∏—Å–æ–∫ —Ä–∞—Å—Ö–æ–¥–æ–≤ (–¥–ª—è –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∫–ª–∏–∫–æ–≤ –ø–æ –∫–Ω–æ–ø–∫–∞–º "–ò–∑–º–µ–Ω–∏—Ç—å", "–£–¥–∞–ª–∏—Ç—å")
        const listDiv = document.getElementById('expenses-list');
        // –ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –Ω–∞–π–¥–µ–Ω, –¥–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –∫–ª–∏–∫–∞ –Ω–∞ –≤–µ—Å—å —Å–ø–∏—Å–æ–∫
        if (listDiv) listDiv.addEventListener('click', handleExpenseActions);

        // –î–û–ë–ê–í–ò–¢–¨ –°–õ–£–®–ê–¢–ï–õ–¨ –î–õ–Ø –ù–û–í–û–ì–û –§–ò–õ–¨–¢–†–ê –§–ò–õ–ò–ê–õ–û–í
        const locationFilterSelect = document.getElementById('expenses-location-filter');
        // –ï—Å–ª–∏ select —Ñ–∏–ª–∏–∞–ª–æ–≤ –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω –ò –Ω–∞–π–¥–µ–Ω
        if (locationFilterSelect) {
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å —Å–æ–±—ã—Ç–∏—è 'change' (—Å–º–µ–Ω–∞ –≤—ã–±–æ—Ä–∞)
            locationFilterSelect.addEventListener('change', fetchAndRenderExpenses);
            console.log("[Listener OK] Added change to #expenses-location-filter");
        }
        // –ö–û–ù–ï–¶ –î–û–ë–ê–í–õ–ï–ù–ò–Ø

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞—Å—Ö–æ–¥—ã –∑–∞ —Å–µ–≥–æ–¥–Ω—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ –≤–∫–ª–∞–¥–∫–∏
        await fetchAndRenderExpenses();

    } else {
        // –ï—Å–ª–∏ –≥–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω, –≤—ã–≤–æ–¥–∏–º –æ—à–∏–±–∫—É –≤ –∫–æ–Ω—Å–æ–ª—å
        console.error("!!! renderExpensesTab: #expenses-container not found.");
    }

    console.log("[Render] renderExpensesTab: End");
}


// --- –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –†–∞—Å—Ö–æ–¥–æ–≤ ---
// index.html (–ó–ê–ú–ï–ù–ò–¢–¨ –≠–¢–û–ô –§–£–ù–ö–¶–ò–ï–ô –°–¢–ê–†–£–Æ fetchAndRenderExpenses)

// --- –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –†–∞—Å—Ö–æ–¥–æ–≤ ---
async function fetchAndRenderExpenses() {
    console.log("[Fetch] fetchAndRenderExpenses: Start");
    // –ù–∞—Ö–æ–¥–∏–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –∫—É–¥–∞ –±—É–¥–µ–º –≤—ã–≤–æ–¥–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ä–∞—Å—Ö–æ–¥–æ–≤
    const listDiv = document.getElementById('expenses-list');
    // –ù–∞—Ö–æ–¥–∏–º –ø–æ–ª—è —Å –¥–∞—Ç–∞–º–∏ –Ω–∞—á–∞–ª–∞ –∏ –∫–æ–Ω—Ü–∞ –ø–µ—Ä–∏–æ–¥–∞
    const startDateInput = document.getElementById('expense-start-date');
    const endDateInput = document.getElementById('expense-end-date');

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞–π–¥–µ–Ω—ã –ª–∏ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
    if (!listDiv || !startDateInput || !endDateInput) {
        console.error("!!! fetchAndRenderExpenses: Critical elements not found (listDiv or date inputs).");
        return; // –í—ã—Ö–æ–¥–∏–º, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
    }
    // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –¥–∞—Ç
    const startDate = startDateInput.value;
    const endDate = endDateInput.value;
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞—Ç—ã –≤—ã–±—Ä–∞–Ω—ã
    if (!startDate || !endDate) {
        listDiv.innerHTML = '<p class="text-yellow-500">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞ –∏ –∫–æ–Ω—Ü–∞ –ø–µ—Ä–∏–æ–¥–∞.</p>';
        return; // –í—ã—Ö–æ–¥–∏–º, –µ—Å–ª–∏ –¥–∞—Ç—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É "–ó–∞–≥—Ä—É–∑–∫–∞..."
    listDiv.innerHTML = '<p class="text-gray-500 animate-pulse">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤...</p>';
    showLoader(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏

    // --- –î–û–ë–ê–í–ò–¢–¨: –°—á–∏—Ç—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π location_id (–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –í–ª–∞–¥–µ–ª–µ—Ü) ---
    // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç URLSearchParams –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∫ URL
    const params = new URLSearchParams({
        start_date: startDate, // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞
        end_date: endDate     // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞—Ç—É –∫–æ–Ω—Ü–∞
    });
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –í–ª–∞–¥–µ–ª—å—Ü–µ–º
    if (currentUser.role === '–í–ª–∞–¥–µ–ª–µ—Ü') {
        // –ù–∞—Ö–æ–¥–∏–º select –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∏–ª–∏–∞–ª–∞
        const locationSelect = document.getElementById('expenses-location-filter');
        // –ï—Å–ª–∏ select —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ò –≤ –Ω–µ–º –≤—ã–±—Ä–∞–Ω–æ –∫–∞–∫–æ–µ-—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ (–Ω–µ –ø—É—Å—Ç–∞—è –æ–ø—Ü–∏—è "-- –í—Å–µ —Ä–∞—Å—Ö–æ–¥—ã --")
        if (locationSelect && locationSelect.value) {
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä location_id –∫ –∑–∞–ø—Ä–æ—Å—É
            params.append('location_id', locationSelect.value);
            console.log("[Fetch Expenses] Filtering by location_id:", locationSelect.value);
        } else {
             // –ï—Å–ª–∏ –í–ª–∞–¥–µ–ª–µ—Ü –≤—ã–±—Ä–∞–ª "-- –í—Å–µ —Ä–∞—Å—Ö–æ–¥—ã --" –∏–ª–∏ select'–∞ –Ω–µ—Ç
             console.log("[Fetch Expenses] Owner viewing all locations' expenses.");
        }
    }
    // –î–ª—è –æ–±—ã—á–Ω–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ location_id –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º, –±—ç–∫–µ–Ω–¥ –æ—Ç—Ñ–∏–ª—å—Ç—Ä—É–µ—Ç —Å–∞–º
    // –§–æ—Ä–º–∏—Ä—É–µ–º URL –∑–∞–ø—Ä–æ—Å–∞ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ (?start_date=...&end_date=...&location_id=...)
    const url = `/api/expenses?${params.toString()}`;
    console.log("[Fetch Expenses] Requesting URL:", url);
    // --- –ö–û–ù–ï–¶ –î–û–ë–ê–í–õ–ï–ù–ò–Ø ---

    try {
        // –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ API —Å –ø–æ–º–æ—â—å—é –Ω–∞—à–µ–π –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ apiFetch
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
        const expenses = await apiFetch(url);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–µ—Ä–Ω—É–ª –ª–∏ –±—ç–∫–µ–Ω–¥ –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫
        if (!expenses || expenses.length === 0) {
            listDiv.innerHTML = '<p class="text-gray-500">–†–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ (—Å —É—á–µ—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–∞) –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</p>';
        } else {
            // –ï—Å–ª–∏ —Ä–∞—Å—Ö–æ–¥—ã –µ—Å—Ç—å, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
            listDiv.innerHTML = expenses.map(exp => {

                // --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –∏–º–µ–Ω–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ ---
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é - "–û–±—â–∏–π", –µ—Å–ª–∏ —Ä–∞—Å—Ö–æ–¥ –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ —Å–º–µ–Ω–µ.
                let employeeName = '–û–±—â–∏–π (–í–ª–∞–¥–µ–ª–µ—Ü)'; // –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É —Ä–∞—Å—Ö–æ–¥–∞ —Å–≤—è–∑—å —Å–æ —Å–º–µ–Ω–æ–π (shift),
                // –µ—Å—Ç—å –ª–∏ —É —Å–º–µ–Ω—ã —Å–≤—è–∑—å —Å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–º (employee),
                // –∏ –µ—Å—Ç—å –ª–∏ —É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –∏–º—è (full_name)
                if (exp.shift && exp.shift.employee && exp.shift.employee.full_name) {
                    employeeName = exp.shift.employee.full_name; // –ï—Å–ª–∏ –≤—Å–µ –µ—Å—Ç—å, –±–µ—Ä–µ–º –∏–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –∏–∑ —Å–º–µ–Ω—ã
                }
                // --- –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø ---

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ—Ç —Ä–∞—Å—Ö–æ–¥
                // –í–ª–∞–¥–µ–ª–µ—Ü –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ª—é–±—ã–µ —Ä–∞—Å—Ö–æ–¥—ã
                // –°–æ—Ç—Ä—É–¥–Ω–∏–∫ –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ä–∞—Å—Ö–æ–¥—ã –∏–∑ –ê–ö–¢–ò–í–ù–û–ô —Å–º–µ–Ω—ã (shift.end_time === null)
                const canEdit = (currentUser.role === '–í–ª–∞–¥–µ–ª–µ—Ü') ||
                                (exp.shift && exp.shift.end_time === null);

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ —É–¥–∞–ª—è—Ç—å —ç—Ç–æ—Ç —Ä–∞—Å—Ö–æ–¥
                // –¢–æ–ª—å–∫–æ –í–ª–∞–¥–µ–ª–µ—Ü –º–æ–∂–µ—Ç —É–¥–∞–ª—è—Ç—å, –∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ä–∞—Å—Ö–æ–¥ –Ω–µ –∏–∑ –∑–∞–∫—Ä—ã—Ç–æ–π —Å–º–µ–Ω—ã
                const canDelete = (currentUser.role === '–í–ª–∞–¥–µ–ª–µ—Ü') &&
                                (exp.shift === null || exp.shift.end_time === null);

                // –§–æ—Ä–º–∏—Ä—É–µ–º HTML-—Ä–∞–∑–º–µ—Ç–∫—É –¥–ª—è –æ–¥–Ω–æ–≥–æ —Ä–∞—Å—Ö–æ–¥–∞
                return `
                    <div class="p-3 bg-gray-50 rounded-md border flex flex-wrap justify-between items-center gap-2 expense-item"
                         data-notes="${(exp.notes || '').toLowerCase()}" data-type="${(exp.expense_type?.name || '').toLowerCase()}"> <div class="flex-grow min-w-[200px]">
                            <p class="font-bold text-lg">
                                ${exp.expense_type?.name || '–¢–∏–ø –Ω–µ —É–∫–∞–∑–∞–Ω'} ‚Äî <span class="text-red-600">${exp.amount.toFixed(2)} —Å–æ–º</span>
                            </p>
                            <p class="text-sm text-gray-700">${exp.notes || '–ë–µ–∑ –ø—Ä–∏–º–µ—á–∞–Ω–∏—è'}</p>
                            <p class="text-xs text-gray-500">
                                ${new Date(exp.created_at).toLocaleString('ru-RU')} | –°–æ—Ç—Ä—É–¥–Ω–∏–∫: ${employeeName}
                            </p>
                        </div>

                        <div class="flex-shrink-0 flex gap-2">
                            ${canEdit ? `
                            <button data-expense-json='${JSON.stringify(exp)}' class="edit-expense-btn text-sm bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded">
                                –ò–∑–º–µ–Ω–∏—Ç—å
                            </button>
                            ` : ''} ${canDelete ? `
                            <button data-expense-id="${exp.id}"
                                    data-expense-name="${exp.expense_type?.name || '–†–∞—Å—Ö–æ–¥'}" class="delete-expense-btn text-sm bg-red-200 hover:bg-red-300 text-red-800 px-3 py-1 rounded">
                                –£–¥–∞–ª–∏—Ç—å
                            </button>
                            ` : ''} </div>
                    </div>
                `;
            }).join(''); // –°–æ–µ–¥–∏–Ω—è–µ–º HTML –≤—Å–µ—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤ –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É
        }
        console.log("[Fetch] fetchAndRenderExpenses: Success");
    } catch (e) {
        // –ï—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ API
        console.error("!!! [Fetch] fetchAndRenderExpenses: Error", e);
        listDiv.innerHTML = `<p class="text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤: ${e.message}</p>`;
    } finally {
        // –í –ª—é–±–æ–º —Å–ª—É—á–∞–µ (—É—Å–ø–µ—Ö –∏–ª–∏ –æ—à–∏–±–∫–∞) —Å–∫—Ä—ã–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        hideLoader();
    }
}

// --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–µ–π—Å—Ç–≤–∏–π (–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, –£–¥–∞–ª–µ–Ω–∏–µ) ---
function handleExpenseActions(e) {
    const editBtn = e.target.closest('.edit-expense-btn');
    const deleteBtn = e.target.closest('.delete-expense-btn');
    
    if (editBtn) {
        try {
            const expenseData = JSON.parse(editBtn.dataset.expenseJson);
            openExpenseModal(expenseData); // TODO: –°–æ–∑–¥–∞—Ç—å openExpenseModal
            // alert(`–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∞: ${expenseData.id}. –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞.`);
        } catch (e) {
            console.error("Error parsing expense data:", e);
        }
    } else if (deleteBtn) {
        const expenseId = deleteBtn.dataset.expenseId;
        const expenseName = deleteBtn.dataset.expenseName;
        if (confirm(`–£–¥–∞–ª–∏—Ç—å —Ä–∞—Å—Ö–æ–¥ "${expenseName}"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –ù–ï–û–ë–†–ê–¢–ò–ú–û –∏ —Ç—Ä–µ–±—É–µ—Ç –ø–∞—Ä–æ–ª—è –í–ª–∞–¥–µ–ª—å—Ü–∞!`)) {
            const password = prompt("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –í–ª–∞–¥–µ–ª—å—Ü–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è:");
            if (password) {
                handleDeleteExpense(expenseId, password);
            } else if (password !== null) {
                alert("–£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ: –ø–∞—Ä–æ–ª—å –Ω–µ –≤–≤–µ–¥–µ–Ω.");
            }
        }
    }
}

// --- –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–∞ ---
async function handleDeleteExpense(expenseId, password) {
    console.log(`[Delete] handleDeleteExpense: Deleting ID ${expenseId}`);
    showLoader();
    try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º DELETE –∑–∞–ø—Ä–æ—Å (–ø–∞—Ä–æ–ª—å –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –∫–∞–∫ Query –ø–∞—Ä–∞–º–µ—Ç—Ä)
        await apiFetch(`/api/expenses/${expenseId}?password=${encodeURIComponent(password)}`, { 
            method: 'DELETE' 
        });
        alert("–†–∞—Å—Ö–æ–¥ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!");
        await fetchAndRenderExpenses(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
    } catch (err) {
        console.error("!!! [Delete] handleDeleteExpense: Error", err);
        alert(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–∞: ${err.message}`);
    } finally {
        hideLoader();
    }
}

// --- –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ –ø–æ —Ä–∞—Å—Ö–æ–¥–∞–º ---
function handleExpensesSearch(e) {
    const searchTerm = e.target.value.toLowerCase().trim();
    document.querySelectorAll('#expenses-list .expense-item').forEach(item => {
        const itemType = item.dataset.type || '';
        const itemNotes = item.dataset.notes || '';
        const itemContent = item.textContent?.toLowerCase() || '';

        const isMatch = itemType.includes(searchTerm) || itemNotes.includes(searchTerm) || itemContent.includes(searchTerm);
        item.style.display = isMatch ? 'flex' : 'none';
    });
}

// --- –§—É–Ω–∫—Ü–∏—è: –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–∞ ---
// index.html (–ü–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–º–µ–Ω—è–µ—Ç openExpenseModal)

async function openExpenseModal(expense = null) {
    // –ü—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ –∞–∫—Ç–∏–≤–Ω—É—é —Å–º–µ–Ω—É –¥–ª—è –°–û–¢–†–£–î–ù–ò–ö–ê –æ—Å—Ç–∞–≤–∏–º –Ω–∞ –±—ç–∫–µ–Ω–¥–µ.
    // –í–ª–∞–¥–µ–ª–µ—Ü –º–æ–∂–µ—Ç –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –≤—Å–µ–≥–¥–∞.
    
    const expenseModal = document.getElementById('expense-modal');
    const modalContent = expenseModal.querySelector('.modal-content');
    const isEdit = expense !== null; // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∫–∞ –Ω–µ –º–µ–Ω—è–µ–º
    
    modalContent.innerHTML = '<p class="text-center p-8">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>';
    openModal('expense-modal');
    showLoader(); 

    try {
        // --- –ó–ê–ì–†–£–ñ–ê–ï–ú –î–ê–ù–ù–´–ï –ü–ê–†–ê–õ–õ–ï–õ–¨–ù–û ---
        const [typesData, activeShiftsData] = await Promise.allSettled([
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–∏–ø—ã —Ä–∞—Å—Ö–æ–¥–æ–≤ (–∏–∑ –∫—ç—à–∞ –∏–ª–∏ API)
            (companyExpenseTypes.length > 0) ? Promise.resolve(companyExpenseTypes) : apiFetch('/api/expense_types'),
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –í–°–ï –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–º–µ–Ω—ã –∫–æ–º–ø–∞–Ω–∏–∏ (–¥–ª—è –í–ª–∞–¥–µ–ª—å—Ü–∞)
            (currentUser.role === '–í–ª–∞–¥–µ–ª–µ—Ü') ? fetchActiveShiftsForCompany() : Promise.resolve([]) 
        ]);

        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–∏–ø—ã —Ä–∞—Å—Ö–æ–¥–æ–≤
        if (typesData.status === 'fulfilled') {
            companyExpenseTypes = typesData.value;
        } else {
            throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–∏–ø—ã —Ä–∞—Å—Ö–æ–¥–æ–≤: ${typesData.reason?.message || typesData.reason}`);
        }
        
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–º–µ–Ω—ã (—Ç–æ–ª—å–∫–æ –¥–ª—è –í–ª–∞–¥–µ–ª—å—Ü–∞)
        let activeShifts = [];
        if (activeShiftsData.status === 'fulfilled') {
            activeShifts = activeShiftsData.value;
        } else {
            // –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–º–µ–Ω –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–∞, –í–ª–∞–¥–µ–ª–µ—Ü —Å–º–æ–∂–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –æ–±—â–∏–π —Ä–∞—Å—Ö–æ–¥
            console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–º–µ–Ω—ã –¥–ª—è –≤—ã–±–æ—Ä–∞:", activeShiftsData.reason);
        }
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ–ø—Ü–∏–∏ –¥–ª—è –¢–∏–ø–æ–≤ –†–∞—Å—Ö–æ–¥–æ–≤
        const typesOptions = companyExpenseTypes
            .map(t => `<option value="${t.id}" ${isEdit && expense.expense_type_id === t.id ? 'selected' : ''}>${t.name}</option>`)
            .join('');

        // --- –ì–ï–ù–ï–†–ò–†–£–ï–ú –í–´–ü–ê–î–ê–Æ–©–ò–ô –°–ü–ò–°–û–ö –°–ú–ï–ù –î–õ–Ø –í–õ–ê–î–ï–õ–¨–¶–ê ---
        let shiftSelectorHtml = '';
        if (currentUser.role === '–í–ª–∞–¥–µ–ª–µ—Ü') {
            if (activeShifts.length > 0) {
                // –ï—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–º–µ–Ω—ã, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –≤—ã–±–æ—Ä
                const shiftOptions = activeShifts.map(shift => {
                    const locationName = companyLocations.find(loc => loc.id === shift.location_id)?.name || `–§–∏–ª–∏–∞–ª ${shift.location_id}`;
                    const employeeName = shift.employee?.full_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω';
                    return `<option value="${shift.id}">–°–º–µ–Ω–∞ #${shift.id} (${locationName} - ${employeeName})</option>`;
                }).join('');
                
                shiftSelectorHtml = `
                    <div>
                        <label for="expense-shift-select" class="block text-sm font-medium text-gray-700">–ü—Ä–∏–≤—è–∑–∞—Ç—å –∫ —Å–º–µ–Ω–µ:</label>
                        <select id="expense-shift-select" name="shift_id" class="mt-1 w-full p-2 border rounded bg-white">
                            <option value="">-- –û–±—â–∏–π —Ä–∞—Å—Ö–æ–¥ (–±–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏) --</option>
                            ${shiftOptions}
                        </select>
                    </div>
                `;
            } else {
                // –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–º–µ–Ω –Ω–µ—Ç, —Å–æ–æ–±—â–∞–µ–º –æ–± —ç—Ç–æ–º
                shiftSelectorHtml = `<p class="text-sm text-gray-500">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–º–µ–Ω –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏. –†–∞—Å—Ö–æ–¥ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –∫–∞–∫ –æ–±—â–∏–π.</p>`;
            }
        } else {
            // –î–ª—è –æ–±—ã—á–Ω–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º ID –µ–≥–æ —Ç–µ–∫—É—â–µ–π —Å–º–µ–Ω—ã
             shiftSelectorHtml = `<p class="text-sm text-gray-600">–°–º–µ–Ω–∞ ID: ${activeShift?.id ?? 'N/A'}</p>`;
        }
        // --- –ö–û–ù–ï–¶ –ì–ï–ù–ï–†–ê–¶–ò–ò –°–ü–ò–°–ö–ê –°–ú–ï–ù ---

        modalContent.innerHTML = `
            <div class="flex justify-between items-start">
                <h3 class="text-2xl font-bold mb-4">${isEdit ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å—Ö–æ–¥' : '–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥'}</h3>
                <button onclick="closeModal('expense-modal')" class="text-2xl font-bold">&times;</button>
            </div>
            <form id="expense-form" data-expense-id="${isEdit ? expense.id : ''}" class="space-y-4">
                
                ${shiftSelectorHtml}
                
                <div>
                    <label class="block text-sm font-medium text-gray-700">–¢–∏–ø —Ä–∞—Å—Ö–æ–¥–∞ *</label>
                    <select name="expense_type_id" class="mt-1 w-full p-2 border rounded bg-white" required>${typesOptions}</select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">–°—É–º–º–∞ (—Å–æ–º) *</label>
                    <input type="number" step="0.01" name="amount" class="mt-1 w-full p-2 border rounded" value="${isEdit ? expense.amount : ''}" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</label>
                    <textarea name="notes" class="mt-1 w-full p-2 border rounded">${isEdit ? expense.notes || '' : ''}</textarea>
                </div>
                <div class="flex gap-4 mt-6">
                    <button type="button" onclick="closeModal('expense-modal')" class="w-full bg-gray-200 py-2 rounded">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="w-full bg-green-600 text-white py-2 rounded">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        `;
        
        // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ submit –∫ —Ñ–æ—Ä–º–µ
        document.getElementById('expense-form')?.addEventListener('submit', handleSaveExpense);
        
    } catch(err) {
        alert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–∞—Å—Ö–æ–¥–∞: ${err.message}`);
        closeModal('expense-modal');
    } finally {
        hideLoader();
    }
}

// --- –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–∞ ---
// index.html (–ü–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–º–µ–Ω—è–µ—Ç handleSaveExpense)

async function handleSaveExpense(e) {
    e.preventDefault();
    const form = e.target;
    const expenseId = form.dataset.expenseId; // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —Å expense-id
    const isEdit = !!expenseId;
    
    const url = isEdit ? `/api/expenses/${expenseId}` : '/api/expenses'; 
    const method = isEdit ? 'PATCH' : 'POST'; 
    
    const payload = {
        expense_type_id: parseInt(form.elements.expense_type_id.value),
        amount: parseFloat(form.elements.amount.value),
        notes: form.elements.notes.value || null
        // shift_id –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∏–∂–µ, –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω
    };

    // --- –î–û–ë–ê–í–õ–ï–ù–ò–ï SHIFT_ID –î–õ–Ø –í–õ–ê–î–ï–õ–¨–¶–ê ---
    if (currentUser.role === '–í–ª–∞–¥–µ–ª–µ—Ü' && !isEdit) { // –î–æ–±–∞–≤–ª—è–µ–º shift_id —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –°–û–ó–î–ê–ù–ò–ò –í–ª–∞–¥–µ–ª—å—Ü–µ–º
        const shiftSelect = document.getElementById('expense-shift-select');
        if (shiftSelect && shiftSelect.value) { // –ï—Å–ª–∏ select —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –≤—ã–±—Ä–∞–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ (–Ω–µ –ø—É—Å—Ç–æ–µ)
            payload.shift_id = parseInt(shiftSelect.value); 
        } else {
            payload.shift_id = null; // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ "-- –û–±—â–∏–π —Ä–∞—Å—Ö–æ–¥ --" –∏–ª–∏ —Å–º–µ–Ω –Ω–µ –±—ã–ª–æ
        }
    }
    // –î–ª—è –æ–±—ã—á–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ shift_id –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –Ω–∞ –±—ç–∫–µ–Ω–¥–µ
    // –ü—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ shift_id –Ω–µ –º–µ–Ω—è–µ–º —á–µ—Ä–µ–∑ —ç—Ç—É —Ñ–æ—Ä–º—É
    // --- –ö–û–ù–ï–¶ –î–û–ë–ê–í–õ–ï–ù–ò–Ø SHIFT_ID ---

    if (isNaN(payload.amount) || payload.amount <= 0 || isNaN(payload.expense_type_id)) {
        alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Ä–∞—Å—Ö–æ–¥–∞.");
        return;
    }

    showLoader(); 
    try {
        const response = await apiFetch(url, {
            method: method,
            body: JSON.stringify(payload)
        });
        
        alert(isEdit ? '–†–∞—Å—Ö–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω!' : '–†–∞—Å—Ö–æ–¥ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!');
        closeModal('expense-modal');
        await fetchAndRenderExpenses(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ
        
    } catch (err) {
        alert(`–û—à–∏–±–∫–∞: ${err.message}`);
    } finally {
        hideLoader();
    }
}

// index.html (–ü–û–õ–ù–û–°–¢–¨–Æ –ó–ê–ú–ï–ù–Ø–ï–¢ –ú–û–î–£–õ–¨: –û–¢–ß–ï–¢–´)

// =================================================================
// –ú–û–î–£–õ–¨: –û–¢–ß–ï–¢–´ (v4.1 - Rebuild)
// =================================================================

// --- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≥–ª–∞–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏ "–û—Ç—á–µ—Ç—ã" (—Å–æ–∑–¥–∞–µ—Ç –ø–æ–¥-–≤–∫–ª–∞–¥–∫–∏) ---
function renderReportsTab() {
    console.log("[Render] renderReportsTab: Start");
    const pane = document.getElementById('tab-reports');
    if (!pane) return;

    const userPerms = new Set(currentUser.permissions || []);
    let subTabsHtml = '';
    let subContentHtml = '';
    let firstSubTabName = null; // –ò–º—è –ø–µ—Ä–≤–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ–π –ø–æ–¥-–≤–∫–ª–∞–¥–∫–∏

    // –°–æ–∑–¥–∞–µ–º –ø–æ–¥-–≤–∫–ª–∞–¥–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–∞–≤
    // –û—Ç—á–µ—Ç –ø–æ —Å–º–µ–Ω–µ
    if (userPerms.has('view_shift_report')) {
        subTabsHtml += '<button data-subtab="shift-report" class="report-subtab-btn tab-btn">–û—Ç—á–µ—Ç –ø–æ —Å–º–µ–Ω–µ</button>';
        subContentHtml += '<div id="subtab-shift-report" class="report-subtab-pane tab-pane"></div>';
        if (!firstSubTabName) firstSubTabName = 'shift-report';
    }
    // –°–≤–æ–¥–Ω—ã–π –æ—Ç—á–µ—Ç
    if (userPerms.has('view_full_reports')) {
        subTabsHtml += '<button data-subtab="summary-report" class="report-subtab-btn tab-btn">–°–≤–æ–¥–Ω—ã–π –æ—Ç—á–µ—Ç</button>';
        subContentHtml += '<div id="subtab-summary-report" class="report-subtab-pane tab-pane"></div>';
        if (!firstSubTabName) firstSubTabName = 'summary-report';

        // --- –î–û–ë–ê–í–ò–¢–¨ –≠–¢–û–¢ –ë–õ–û–ö ---
        // –û—Ç—á–µ—Ç –ø–æ –≤—ã–∫—É–ø—É (–¥–æ–±–∞–≤–ª—è–µ–º —Å—é–¥–∞ –∂–µ, —Ç–∞–∫ –∫–∞–∫ —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –ø–æ–ª–Ω—ã–µ –æ—Ç—á–µ—Ç—ã)
        subTabsHtml += '<button data-subtab="buyout-report" class="report-subtab-btn tab-btn">–û—Ç—á–µ—Ç –ø–æ –≤—ã–∫—É–ø—É</button>';
        subContentHtml += '<div id="subtab-buyout-report" class="report-subtab-pane tab-pane"></div>';
        if (!firstSubTabName) firstSubTabName = 'buyout-report';
        // --- –ö–û–ù–ï–¶ –î–û–ë–ê–í–õ–ï–ù–ò–Ø ---
    }

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –¥–ª—è –ø–æ–¥-–≤–∫–ª–∞–¥–æ–∫ –∏ –∏—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
    pane.innerHTML = `
        <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-8" id="reports-subtabs">
                ${subTabsHtml.replaceAll('class="tab-btn"', 'class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700"')}
            </nav>
        </div>
        <div id="reports-subtab-content" class="mt-6">
            ${subContentHtml}
        </div>
    `;

    // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –∫ –ø–æ–¥-–≤–∫–ª–∞–¥–∫–∞–º
    const subtabsContainer = document.getElementById('reports-subtabs');
    if (subtabsContainer) {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º replaceWith/cloneNode –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö —Å–ª—É—à–∞—Ç–µ–ª–µ–π (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
        const newSubtabsContainer = subtabsContainer.cloneNode(true);
        subtabsContainer.parentNode?.replaceChild(newSubtabsContainer, subtabsContainer);
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –∫ –Ω–æ–≤–æ–º—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É
        newSubtabsContainer.addEventListener('click', e => {
            const tabButton = e.target.closest('.report-subtab-btn');
            if (tabButton) {
                activateReportSubTab(tabButton.dataset.subtab); // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–æ–¥-–≤–∫–ª–∞–¥–∫—É
            }
        });
        console.log("[Listener OK] Added click delegate to #reports-subtabs");
    }

    // –†–µ–Ω–¥–µ—Ä–∏–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –í–°–ï–• –ø–æ–¥-–≤–∫–ª–∞–¥–æ–∫ (–æ–Ω–∏ —Ç–µ–ø–µ—Ä—å —Ç–æ—á–Ω–æ –Ω–∞–π–¥—É—Ç—Å—è)
    if (document.getElementById('subtab-shift-report')) {
        renderShiftReportSubTab();
    }
    if (document.getElementById('subtab-summary-report')) {
        renderSummaryReportSubTab();
    }
    // --- –î–û–ë–ê–í–ò–¢–¨ –í–´–ó–û–í –†–ï–ù–î–ï–†–ò–ù–ì–ê –î–õ–Ø –ù–û–í–û–ô –í–ö–õ–ê–î–ö–ò ---
    if (document.getElementById('subtab-buyout-report')) {
        renderBuyoutReportSubTab(); // –í—ã–∑—ã–≤–∞–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
    }
    // --- –ö–û–ù–ï–¶ –î–û–ë–ê–í–õ–ï–ù–ò–Ø ---

    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–µ—Ä–≤—É—é –¥–æ—Å—Ç—É–ø–Ω—É—é –ø–æ–¥-–≤–∫–ª–∞–¥–∫—É
    if (firstSubTabName) {
        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã DOM —É—Å–ø–µ–ª –æ–±–Ω–æ–≤–∏—Ç—å—Å—è –ø–µ—Ä–µ–¥ –∞–∫—Ç–∏–≤–∞—Ü–∏–µ–π
        setTimeout(() => activateReportSubTab(firstSubTabName), 0);
    } else {
        console.warn("[Render Reports] No sub-tabs available to activate.");
    }
    console.log("[Render] renderReportsTab: End");
}

// --- –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥-–≤–∫–ª–∞–¥–æ–∫ ---
function activateReportSubTab(tabName) {
    const tabsContainer = document.getElementById('reports-subtabs');
    const contentContainer = document.getElementById('reports-subtab-content');
    if (!tabsContainer || !contentContainer) return;

    tabsContainer.querySelectorAll('.report-subtab-btn').forEach(btn => {
        btn.classList.remove('border-indigo-500', 'text-indigo-600');
        btn.classList.add('border-transparent', 'text-gray-500');
    });
    
    const activeBtn = tabsContainer.querySelector(`[data-subtab="${tabName}"]`);
    if (activeBtn) {
        activeBtn.classList.add('border-indigo-500', 'text-indigo-600');
        activeBtn.classList.remove('border-transparent', 'text-gray-500');
    }

    contentContainer.querySelectorAll('.report-subtab-pane').forEach(pane => {
        pane.classList.add('hidden');
    });
    
    const activePane = document.getElementById(`subtab-${tabName}`);
    if (activePane) {
        activePane.classList.remove('hidden');
    }
}

// --- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ø–æ–¥-–≤–∫–ª–∞–¥–∫–∏ "–û—Ç—á–µ—Ç –ø–æ —Å–º–µ–Ω–µ" ---
function renderShiftReportSubTab() {
    const pane = document.getElementById('subtab-shift-report');
    if (!pane) return;

    // --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: HTML –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ —Ñ–∏–ª–∏–∞–ª–æ–≤ (—Ç–æ–ª—å–∫–æ –í–ª–∞–¥–µ–ª–µ—Ü) ---
    // (companyLocations —Ç–µ–ø–µ—Ä—å –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ initializeMainAppUI)
    let locationFilterHtml = '';
    if (currentUser.role === '–í–ª–∞–¥–µ–ª–µ—Ü' && companyLocations && companyLocations.length > 1) {
        const locationOptions = companyLocations.map(loc =>
            // –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –≤—ã–±–∏—Ä–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∏–ª–∏–∞–ª –í–ª–∞–¥–µ–ª—å—Ü–∞
            `<option value="${loc.id}" ${loc.id === currentUser.location_id ? 'selected' : ''}>${loc.name}</option>`
        ).join('');
        
        locationFilterHtml = `
            <div class="flex-shrink-0">
                <label for="shift-report-location-filter" class="text-xs font-medium text-gray-700">–§–∏–ª–∏–∞–ª:</label>
                <select id="shift-report-location-filter" class="rounded-md border-gray-300 p-1.5 text-sm bg-white shadow-sm w-40">
                    ${locationOptions}
                </select>
            </div>
        `;
        console.log("[Render ShiftReport] –§–∏–ª—å—Ç—Ä —Ñ–∏–ª–∏–∞–ª–æ–≤ –¥–æ–±–∞–≤–ª–µ–Ω.");
    }
    // --- –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø ---

    pane.innerHTML = `
        <div class="bg-white p-6 rounded-lg shadow-md max-w-2xl mx-auto">
            <div class="flex flex-wrap justify-between items-center gap-4 mb-4 border-b pb-4">
                <h2 class="text-2xl font-bold">–û—Ç—á–µ—Ç –ø–æ —Ç–µ–∫—É—â–µ–π —Å–º–µ–Ω–µ</h2>
                <div class="flex items-center gap-4">
                    ${locationFilterHtml} 
                    <button id="refresh-report-btn" title="–û–±–Ω–æ–≤–∏—Ç—å –æ—Ç—á–µ—Ç" class="text-2xl text-gray-500 hover:text-indigo-600">&circlearrowright;</button>
                </div>
            </div>
            <div id="shift-report-content" class="space-y-3">
                <p class="animate-pulse">–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á–µ—Ç–∞...</p>
            </div>
        </div>
    `;
    
    document.getElementById('refresh-report-btn')?.addEventListener('click', fetchAndRenderCurrentShiftReport);
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –∫ –Ω–æ–≤–æ–º—É —Ñ–∏–ª—å—Ç—Ä—É (–µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å)
    document.getElementById('shift-report-location-filter')?.addEventListener('change', fetchAndRenderCurrentShiftReport);

    fetchAndRenderCurrentShiftReport(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Ä–µ–Ω–¥–µ—Ä–µ
}

// --- –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á–µ—Ç–∞ –ø–æ –¢–ï–ö–£–©–ï–ô —Å–º–µ–Ω–µ ---
async function fetchAndRenderCurrentShiftReport() {
    const contentDiv = document.getElementById('shift-report-content');
    if (!contentDiv) return;
    contentDiv.innerHTML = '<p class="animate-pulse">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–∞...</p>';
    showLoader();

    // --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–æ–π URL –≤—ã–∑—ã–≤–∞—Ç—å ---
    let url = ''; 
    
    if (currentUser.role === '–í–ª–∞–¥–µ–ª–µ—Ü') {
        const locationSelect = document.getElementById('shift-report-location-filter');
        let locationIdToFetch = currentUser.location_id; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ñ–∏–ª–∏–∞–ª –í–ª–∞–¥–µ–ª—å—Ü–∞

        if (locationSelect && locationSelect.value) {
            // –ï—Å–ª–∏ –í–ª–∞–¥–µ–ª–µ—Ü –≤—ã–±—Ä–∞–ª —Ñ–∏–ª–∏–∞–ª –≤ —Å–ø–∏—Å–∫–µ
            locationIdToFetch = locationSelect.value;
        }
        
        if (locationIdToFetch) {
             url = `/api/reports/shift/location/${locationIdToFetch}`;
        } else {
             // –ï—Å–ª–∏ –í–ª–∞–¥–µ–ª–µ—Ü –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ —Ñ–∏–ª–∏–∞–ª—É –∏ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–ª
             contentDiv.innerHTML = `<p class="text-yellow-500 font-semibold">–û—à–∏–±–∫–∞: –í–ª–∞–¥–µ–ª–µ—Ü –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ —Ñ–∏–ª–∏–∞–ª—É. –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª–∏–∞–ª –∏–∑ —Å–ø–∏—Å–∫–∞ (–µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å).</p>`;
             hideLoader();
             return;
        }
        
    } else {
        // –û–±—ã—á–Ω—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ (–Ω–µ –í–ª–∞–¥–µ–ª–µ—Ü)
        url = '/api/reports/shift/current'; // –ë—ç–∫–µ–Ω–¥ —Å–∞–º –Ω–∞–π–¥–µ—Ç –µ–≥–æ —Å–º–µ–Ω—É
    }
    
    console.log("[Shift Report] Requesting URL:", url);
    // --- –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø ---

    try {
        const report = await apiFetch(url); 

        contentDiv.innerHTML = `
        <div class="bg-gray-50 p-4 rounded-xl border border-gray-100 mb-6">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                <div class="flex items-center space-x-3">
                    <div class="p-2 bg-white rounded-full shadow-sm text-gray-500">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                    </div>
                    <div>
                        <p class="text-xs text-gray-400 uppercase font-bold tracking-wide">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</p>
                        <p class="font-semibold text-gray-800">${report.employee_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="p-2 bg-white rounded-full shadow-sm text-gray-500">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    </div>
                    <div>
                        <p class="text-xs text-gray-400 uppercase font-bold tracking-wide">–§–∏–ª–∏–∞–ª</p>
                        <p class="font-semibold text-gray-800">${report.location_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                    </div>
                </div>
                <div class="flex items-center space-x-3 sm:col-span-2 border-t border-gray-200 pt-3 mt-1">
                    <div class="p-2 bg-white rounded-full shadow-sm text-gray-500">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                    <div>
                        <p class="text-xs text-gray-400 uppercase font-bold tracking-wide">–í—Ä–µ–º—è –æ—Ç–∫—Ä—ã—Ç–∏—è</p>
                        <p class="font-medium text-gray-700">${new Date(report.shift_start_time).toLocaleString('ru-RU')}</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="space-y-4">
            
            <div class="flex justify-between items-center p-3 rounded-lg hover:bg-gray-50 transition">
                <span class="text-gray-600 font-medium">üèÅ –ù–∞–ª–∏—á–Ω—ã–µ –Ω–∞ –Ω–∞—á–∞–ª–æ</span>
                <span class="text-lg font-bold text-gray-800">${report.starting_cash.toFixed(2)} <span class="text-xs font-normal text-gray-400">—Å–æ–º</span></span>
            </div>

            <div class="pl-4 border-l-4 border-green-400 space-y-4">
                
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <span class="block text-gray-700 font-bold">üì• –ü—Ä–∏—Ö–æ–¥ –ù–∞–ª–∏—á–Ω—ã–º–∏</span>
                        <span class="text-lg font-bold text-green-600">+${report.cash_income.toFixed(2)} —Å.</span>
                    </div>
                    <div class="bg-green-50 p-2 rounded text-xs text-gray-600 space-y-1">
                        <div class="flex justify-between">
                            <span>üì¶ –í—ã–¥–∞—á–∞ —Ç–æ–≤–∞—Ä–æ–≤:</span>
                            <span class="font-medium">+${(report.cash_from_orders || 0).toFixed(2)} —Å.</span>
                        </div>
                        <div class="flex justify-between border-t border-green-100 pt-1">
                            <span>üí∏ –û–ø–ª–∞—Ç–∞ –¥–æ–ª–≥–æ–≤:</span>
                            <span class="font-medium">+${(report.cash_from_debts || 0).toFixed(2)} —Å.</span>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="flex justify-between items-center mb-1">
                        <span class="block text-gray-700 font-bold">üí≥ –ü—Ä–∏—Ö–æ–¥ –ö–∞—Ä—Ç–æ–π</span>
                        <span class="text-lg font-bold text-blue-600">+${report.card_income.toFixed(2)} —Å.</span>
                    </div>
                    <div class="bg-blue-50 p-2 rounded text-xs text-gray-600 space-y-1">
                        <div class="flex justify-between">
                            <span>üì¶ –í—ã–¥–∞—á–∞ —Ç–æ–≤–∞—Ä–æ–≤:</span>
                            <span class="font-medium">+${(report.card_from_orders || 0).toFixed(2)} —Å.</span>
                        </div>
                        <div class="flex justify-between border-t border-blue-100 pt-1">
                            <span>üí∏ –û–ø–ª–∞—Ç–∞ –¥–æ–ª–≥–æ–≤:</span>
                            <span class="font-medium">+${(report.card_from_debts || 0).toFixed(2)} —Å.</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pl-4 border-l-4 border-red-400 space-y-3">
                <div class="flex justify-between items-center">
                    <span class="text-gray-700 font-medium">üì§ –†–∞—Å—Ö–æ–¥—ã (–æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ)</span>
                    <span class="text-lg font-bold text-red-600">-${report.total_expenses.toFixed(2)} —Å.</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-700 font-medium">‚Ü©Ô∏è –í–æ–∑–≤—Ä–∞—Ç—ã</span>
                    <span class="text-lg font-bold text-yellow-600">-${report.total_returns.toFixed(2)} —Å.</span>
                </div>
            </div>
        </div>

        <div class="mt-8 p-5 bg-indigo-50 rounded-xl border border-indigo-100">
            <div class="flex justify-between items-end">
                <div class="text-indigo-900">
                    <p class="text-xs font-bold uppercase tracking-widest opacity-60">–†–∞—Å—á–µ—Ç–Ω—ã–π –∏—Ç–æ–≥</p>
                    <p class="text-xl font-bold">–í –ö–ê–°–°–ï (–ù–∞–ª):</p>
                </div>
                <div class="text-3xl font-extrabold text-indigo-700">
                    ${report.calculated_cash.toFixed(2)} <span class="text-lg font-medium text-indigo-400">—Å–æ–º</span>
                </div>
            </div>
        </div>
    `;
    } catch (e) {
        // –ï—Å–ª–∏ 404 - —Å–º–µ–Ω—ã –Ω–µ—Ç, –µ—Å–ª–∏ 403 - –Ω–µ—Ç –ø—Ä–∞–≤
        contentDiv.innerHTML = `<p class="text-red-500 font-semibold">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—á–µ—Ç–∞: ${e.message}</p>`;
    } finally {
        hideLoader();
    }
}

// --- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ø–æ–¥-–≤–∫–ª–∞–¥–∫–∏ "–°–≤–æ–¥–Ω—ã–π –æ—Ç—á–µ—Ç" ---
function renderSummaryReportSubTab() {
    console.log("[Render] renderSummaryReportSubTab: Start");
    const pane = document.getElementById('subtab-summary-report'); // –ù–∞—Ö–æ–¥–∏–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ–¥-–≤–∫–ª–∞–¥–∫–∏
    // –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω, –≤—ã—Ö–æ–¥–∏–º
    if (!pane) {
         console.warn("[Render] renderSummaryReportSubTab: Pane #subtab-summary-report not found.");
         return;
    }
    const today = new Date().toISOString().split('T')[0]; // –°–µ–≥–æ–¥–Ω—è—à–Ω—è—è –¥–∞—Ç–∞

    // --- HTML –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ —Ñ–∏–ª–∏–∞–ª–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è –í–ª–∞–¥–µ–ª—å—Ü–∞) ---
    let locationFilterHtml = ''; // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –í–ª–∞–¥–µ–ª–µ—Ü –ò –µ—Å—Ç—å –±–æ–ª—å—à–µ –æ–¥–Ω–æ–≥–æ —Ñ–∏–ª–∏–∞–ª–∞ –≤ –∫—ç—à–µ
    if (currentUser.role === '–í–ª–∞–¥–µ–ª–µ—Ü' && companyLocations && companyLocations.length > 1) {
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º <option> –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∏–ª–∏–∞–ª–∞
        const locationOptions = companyLocations.map(loc =>
            // –ê—Ç—Ä–∏–±—É—Ç value —Å–æ–¥–µ—Ä–∂–∏—Ç ID, —Ç–µ–∫—Å—Ç - –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–∏–ª–∏–∞–ª–∞
            `<option value="${loc.id}">${loc.name}</option>`
        ).join('');
        // –§–æ—Ä–º–∏—Ä—É–µ–º HTML –¥–ª—è select'–∞
        locationFilterHtml = `
            <div>
                <label for="summary-location-filter" class="block text-sm font-medium text-gray-700">–§–∏–ª–∏–∞–ª:</label>
                <select id="summary-location-filter" class="mt-1 p-2 border rounded-md bg-white text-sm w-full">
                    <option value="">-- –í—Å–µ —Ñ–∏–ª–∏–∞–ª—ã --</option> ${locationOptions} </select>
            </div>
        `;
        console.log("[Render Summary] –§–∏–ª—å—Ç—Ä —Ñ–∏–ª–∏–∞–ª–æ–≤ –¥–ª—è –í–ª–∞–¥–µ–ª—å—Ü–∞ –¥–æ–±–∞–≤–ª–µ–Ω.");
    } else {
         console.log("[Render Summary] –§–∏–ª—å—Ç—Ä —Ñ–∏–ª–∏–∞–ª–æ–≤ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.");
    }
    // --- –ö–û–ù–ï–¶ HTML –§–ò–õ–¨–¢–†–ê ---

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π HTML –¥–ª—è –ø–æ–¥-–≤–∫–ª–∞–¥–∫–∏
    pane.innerHTML = `
        <div class="bg-white p-6 rounded-lg shadow-md max-w-3xl mx-auto">
            <h2 class="text-2xl font-bold mb-4">–°–≤–æ–¥–Ω—ã–π –æ—Ç—á–µ—Ç</h2>
            <div class="flex flex-wrap gap-4 items-end p-4 bg-gray-50 rounded-lg mb-4 border">
                <div>
                    <label for="summary-start-date" class="block text-sm font-medium">–°</label>
                    <input type="date" id="summary-start-date" value="${today}" class="mt-1 p-2 border rounded-md">
                </div>
                <div>
                    <label for="summary-end-date" class="block text-sm font-medium">–ü–æ</label>
                    <input type="date" id="summary-end-date" value="${today}" class="mt-1 p-2 border rounded-md">
                </div>
                ${locationFilterHtml}
                <button id="generate-summary-report-btn" class="bg-blue-600 text-white py-2 px-4 rounded-md ml-auto">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
            <div id="summary-report-content">
                <p class="text-gray-500">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –∏ –Ω–∞–∂–º–∏—Ç–µ "–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å".</p>
            </div>
        </div>
    `;

    // --- –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏ –∫ –¢–û–õ–¨–ö–û –ß–¢–û —Å–æ–∑–¥–∞–Ω–Ω—ã–º —ç–ª–µ–º–µ–Ω—Ç–∞–º ---
    // –ö–Ω–æ–ø–∫–∞ "–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å"
    const generateBtn = document.getElementById('generate-summary-report-btn');
    if (generateBtn) {
        generateBtn.addEventListener('click', fetchAndRenderSummaryReport);
        console.log("[Listener OK] Added click to #generate-summary-report-btn");
    }

    // –§–∏–ª—å—Ç—Ä —Ñ–∏–ª–∏–∞–ª–æ–≤ (–µ—Å–ª–∏ –æ–Ω –±—ã–ª —Å–æ–∑–¥–∞–Ω)
    const locationSelect = document.getElementById('summary-location-filter');
    if (locationSelect) {
         // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å 'change', –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å `fetchAndRenderSummaryReport`
         // –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –æ—Ç—á–µ—Ç—É –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è —Å—Ä–∞–∑—É –ø—Ä–∏ —Å–º–µ–Ω–µ —Ñ–∏–ª–∏–∞–ª–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫—É "–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å")
        locationSelect.addEventListener('change', fetchAndRenderSummaryReport);
        console.log("[Listener OK] Added change to #summary-location-filter");
    }

    console.log("[Render] renderSummaryReportSubTab: End");
}

// --- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ø–æ–¥-–≤–∫–ª–∞–¥–∫–∏ "–û—Ç—á–µ—Ç –ø–æ –≤—ã–∫—É–ø—É" ---
function renderBuyoutReportSubTab() {
    console.log("[Render] renderBuyoutReportSubTab: Start");
    const pane = document.getElementById('subtab-buyout-report'); // –ù–∞—Ö–æ–¥–∏–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    if (!pane) {
        console.warn("[Render] renderBuyoutReportSubTab: Pane #subtab-buyout-report not found.");
        return;
    }
    const today = new Date().toISOString().split('T')[0]; // –°–µ–≥–æ–¥–Ω—è—à–Ω—è—è –¥–∞—Ç–∞

    // –§–∏–ª—å—Ç—Ä —Ñ–∏–ª–∏–∞–ª–æ–≤ (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –°–≤–æ–¥–Ω–æ–º—É –æ—Ç—á–µ—Ç—É)
    let locationFilterHtml = '';
    if (currentUser.role === '–í–ª–∞–¥–µ–ª–µ—Ü' && companyLocations && companyLocations.length > 1) {
        const locationOptions = companyLocations.map(loc =>
            `<option value="${loc.id}">${loc.name}</option>`
        ).join('');
        locationFilterHtml = `
            <div>
                <label for="buyout-location-filter" class="block text-sm font-medium text-gray-700">–§–∏–ª–∏–∞–ª:</label>
                <select id="buyout-location-filter" class="mt-1 p-2 border rounded-md bg-white text-sm w-full">
                    <option value="">-- –í—Å–µ —Ñ–∏–ª–∏–∞–ª—ã --</option>
                    ${locationOptions}
                </select>
            </div>
        `;
    }

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –¥–ª—è –ø–æ–¥-–≤–∫–ª–∞–¥–∫–∏
    pane.innerHTML = `
        <div class="bg-white p-6 rounded-lg shadow-md"> <h2 class="text-2xl font-bold mb-4">–û—Ç—á–µ—Ç –ø–æ –≤—ã–∫—É–ø–∞–º –∏ –∫—É—Ä—Å–æ–≤–æ–π —Ä–∞–∑–Ω–∏—Ü–µ</h2>
            <div class="flex flex-wrap gap-4 items-end p-4 bg-gray-50 rounded-lg mb-4 border">
                <div>
                    <label for="buyout-start-date" class="block text-sm font-medium">–°</label>
                    <input type="date" id="buyout-start-date" value="${today}" class="mt-1 p-2 border rounded-md">
                </div>
                <div>
                    <label for="buyout-end-date" class="block text-sm font-medium">–ü–æ</label>
                    <input type="date" id="buyout-end-date" value="${today}" class="mt-1 p-2 border rounded-md">
                </div>
                ${locationFilterHtml} <button id="generate-buyout-report-btn" class="bg-blue-600 text-white py-2 px-4 rounded-md ml-auto">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
            <div class="mb-4">
                <input type="search" id="buyout-report-search-input" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∫–ª–∏–µ–Ω—Ç—É, —Ç—Ä–µ–∫-–∫–æ–¥—É..." class="w-full p-2 border rounded-lg">
            </div>
            <div id="buyout-report-content" class="overflow-x-auto"> <p class="text-gray-500">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –∏ –Ω–∞–∂–º–∏—Ç–µ "–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å".</p>
            </div>
        </div>
    `;

    // --- –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏ ---
    const generateBtn = document.getElementById('generate-buyout-report-btn');
    if (generateBtn) {
        generateBtn.addEventListener('click', fetchAndRenderBuyoutReport);
        console.log("[Listener OK] Added click to #generate-buyout-report-btn");
    }
    const searchInput = document.getElementById('buyout-report-search-input');
    if (searchInput) {
        searchInput.addEventListener('input', handleBuyoutReportSearch); // –ù—É–∂–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è handleBuyoutReportSearch
        console.log("[Listener OK] Added input to #buyout-report-search-input");
    }
    const locationSelect = document.getElementById('buyout-location-filter');
    if (locationSelect) {
        locationSelect.addEventListener('change', fetchAndRenderBuyoutReport);
        console.log("[Listener OK] Added change to #buyout-location-filter");
    }

    console.log("[Render] renderBuyoutReportSubTab: End");
    // –ù–µ –∑–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç—á–µ—Ç —Å—Ä–∞–∑—É, –∂–¥–µ–º –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ "–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å"
}

// --- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ø–æ–¥-–≤–∫–ª–∞–¥–∫–∏ "–û—Ç—á–µ—Ç –ø–æ –≤—ã–∫—É–ø—É" ---
function renderBuyoutReportSubTab() {
    console.log("[Render] renderBuyoutReportSubTab: Start");
    const pane = document.getElementById('subtab-buyout-report'); // –ù–∞—Ö–æ–¥–∏–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    if (!pane) {
        console.warn("[Render] renderBuyoutReportSubTab: Pane #subtab-buyout-report not found.");
        return;
    }
    const today = new Date().toISOString().split('T')[0]; // –°–µ–≥–æ–¥–Ω—è—à–Ω—è—è –¥–∞—Ç–∞

    // –§–∏–ª—å—Ç—Ä —Ñ–∏–ª–∏–∞–ª–æ–≤ (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –°–≤–æ–¥–Ω–æ–º—É –æ—Ç—á–µ—Ç—É)
    let locationFilterHtml = '';
    if (currentUser.role === '–í–ª–∞–¥–µ–ª–µ—Ü' && companyLocations && companyLocations.length > 1) {
        const locationOptions = companyLocations.map(loc =>
            `<option value="${loc.id}">${loc.name}</option>`
        ).join('');
        locationFilterHtml = `
            <div>
                <label for="buyout-location-filter" class="block text-sm font-medium text-gray-700">–§–∏–ª–∏–∞–ª:</label>
                <select id="buyout-location-filter" class="mt-1 p-2 border rounded-md bg-white text-sm w-full">
                    <option value="">-- –í—Å–µ —Ñ–∏–ª–∏–∞–ª—ã --</option>
                    ${locationOptions}
                </select>
            </div>
        `;
    }

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –¥–ª—è –ø–æ–¥-–≤–∫–ª–∞–¥–∫–∏
    pane.innerHTML = `
        <div class="bg-white p-6 rounded-lg shadow-md"> <h2 class="text-2xl font-bold mb-4">–û—Ç—á–µ—Ç –ø–æ –≤—ã–∫—É–ø–∞–º –∏ –∫—É—Ä—Å–æ–≤–æ–π —Ä–∞–∑–Ω–∏—Ü–µ</h2>
            <div class="flex flex-wrap gap-4 items-end p-4 bg-gray-50 rounded-lg mb-4 border">
                <div>
                    <label for="buyout-start-date" class="block text-sm font-medium">–°</label>
                    <input type="date" id="buyout-start-date" value="${today}" class="mt-1 p-2 border rounded-md">
                </div>
                <div>
                    <label for="buyout-end-date" class="block text-sm font-medium">–ü–æ</label>
                    <input type="date" id="buyout-end-date" value="${today}" class="mt-1 p-2 border rounded-md">
                </div>
                ${locationFilterHtml} <button id="generate-buyout-report-btn" class="bg-blue-600 text-white py-2 px-4 rounded-md ml-auto">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
            <div class="mb-4">
                <input type="search" id="buyout-report-search-input" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∫–ª–∏–µ–Ω—Ç—É, —Ç—Ä–µ–∫-–∫–æ–¥—É..." class="w-full p-2 border rounded-lg">
            </div>
            <div id="buyout-report-content" class="overflow-x-auto"> <p class="text-gray-500">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –∏ –Ω–∞–∂–º–∏—Ç–µ "–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å".</p>
            </div>
        </div>
    `;

    // --- –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏ ---
    const generateBtn = document.getElementById('generate-buyout-report-btn');
    if (generateBtn) {
        generateBtn.addEventListener('click', fetchAndRenderBuyoutReport);
        console.log("[Listener OK] Added click to #generate-buyout-report-btn");
    }
    const searchInput = document.getElementById('buyout-report-search-input');
    if (searchInput) {
        searchInput.addEventListener('input', handleBuyoutReportSearch); // –ù—É–∂–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è handleBuyoutReportSearch
        console.log("[Listener OK] Added input to #buyout-report-search-input");
    }
    const locationSelect = document.getElementById('buyout-location-filter');
    if (locationSelect) {
        locationSelect.addEventListener('change', fetchAndRenderBuyoutReport);
        console.log("[Listener OK] Added change to #buyout-location-filter");
    }

    console.log("[Render] renderBuyoutReportSubTab: End");
    // –ù–µ –∑–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç—á–µ—Ç —Å—Ä–∞–∑—É, –∂–¥–µ–º –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ "–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å"
}

// --- –ó–∞–≥—Ä—É–∑–∫–∞ –°–≤–æ–¥–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞ (–û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê) ---
async function fetchAndRenderSummaryReport() {
    console.log("[Fetch] fetchAndRenderSummaryReport: Start");
    
    const contentDiv = document.getElementById('summary-report-content');
    const startDateInput = document.getElementById('summary-start-date');
    const endDateInput = document.getElementById('summary-end-date');

    if (!contentDiv || !startDateInput || !endDateInput) {
        console.error("!!! fetchAndRenderSummaryReport: Critical elements not found.");
        return;
    }

    const startDate = startDateInput.value;
    const endDate = endDateInput.value;

    if (!startDate || !endDate) {
        contentDiv.innerHTML = '<p class="text-yellow-500">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞ –∏ –∫–æ–Ω—Ü–∞ –ø–µ—Ä–∏–æ–¥–∞.</p>';
        return;
    }

    contentDiv.innerHTML = '<p class="animate-pulse">–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞...</p>';
    showLoader();

    // --- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞ ---
    const params = new URLSearchParams({
        start_date: startDate,
        end_date: endDate
    });

    // –§–∏–ª—å—Ç—Ä –ø–æ —Ñ–∏–ª–∏–∞–ª—É (–¥–ª—è –í–ª–∞–¥–µ–ª—å—Ü–∞)
    const locationSelect = document.getElementById('summary-location-filter');
    if (locationSelect && locationSelect.value) {
        params.append('location_id', locationSelect.value);
        console.log("[Fetch Summary] Filtering by location_id:", locationSelect.value);
    }

    const url = `/api/reports/summary?${params.toString()}`;
    
    try {
        const response = await apiFetch(url);
        const summary = response.summary;

        // --- –ì–ï–ù–ï–†–ê–¶–ò–Ø –°–ü–ò–°–ö–ê –†–ê–°–•–û–î–û–í ---
        // –ò—Å–∫–ª—é—á–∞–µ–º "–í–æ–∑–≤—Ä–∞—Ç" –∏–∑ —Å–ø–∏—Å–∫–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤, —Ç–∞–∫ –∫–∞–∫ –æ–Ω —Ç–µ–ø–µ—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ –±–ª–æ–∫–µ –î–æ—Ö–æ–¥–æ–≤
        // (–§–∏–ª—å—Ç—Ä—É–µ–º –∫–ª—é—á–∏ —Å–ª–æ–≤–∞—Ä—è expenses_by_type)
        let expensesHtml = Object.entries(summary.expenses_by_type || {})
            .filter(([type]) => !type.toLowerCase().includes('–≤–æ–∑–≤—Ä–∞—Ç')) 
            .map(([type, amount]) => `
                <div class="flex justify-between text-sm text-gray-700 ml-4 border-b border-gray-100 last:border-0 py-1">
                    <span>- ${type}:</span>
                    <span class="font-medium">${amount.toFixed(2)} —Å–æ–º</span>
                </div>
            `).join('');
        
        if (!expensesHtml) expensesHtml = '<p class="text-sm text-gray-500 ml-4 italic">–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤ –Ω–µ—Ç.</p>';

        // --- –ì–ï–ù–ï–†–ê–¶–ò–Ø –°–ü–ò–°–ö–ê –°–ú–ï–ù ---
        let shiftsHtml = '<h3 class="text-xl font-bold mt-6 mb-2 text-gray-800">–ó–∞–∫—Ä—ã—Ç—ã–µ —Å–º–µ–Ω—ã –∑–∞ –ø–µ—Ä–∏–æ–¥</h3>';
        if (!summary.shifts || summary.shifts.length === 0) {
            shiftsHtml += '<p class="text-gray-500 text-sm">–ó–∞–∫—Ä—ã—Ç—ã—Ö —Å–º–µ–Ω –∑–∞ —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</p>';
        } else {
            shiftsHtml += summary.shifts.map(shift => {
                const employeeName = shift.employee?.full_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω';
                const locationName = shift.location?.name || '–§–∏–ª–∏–∞–ª ?';
                const startTimeStr = shift.start_time ? new Date(shift.start_time).toLocaleString('ru-RU') : '?';
                const endTimeStr = shift.end_time ? new Date(shift.end_time).toLocaleString('ru-RU') : '–ê–ö–¢–ò–í–ù–ê';

                return `
                    <div class="p-3 border rounded-lg hover:bg-gray-50 flex justify-between items-center text-sm mb-2 bg-white shadow-sm"> 
                        <div>
                            <p class="font-bold text-gray-800">${employeeName} <span class="text-gray-500 font-normal">@ ${locationName}</span></p>
                            <p class="text-xs text-gray-500">${startTimeStr} ‚Äî ${endTimeStr}</p>
                        </div>
                        <button class="view-shift-report-btn bg-blue-50 text-blue-600 hover:bg-blue-100 hover:text-blue-800 font-semibold text-xs px-3 py-1.5 rounded transition-colors" 
                                data-shift-id="${shift.id}">
                            –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                        </button>
                    </div>
                `;
            }).join('');
        }

        // --- –ò–¢–û–ì–û–í–´–ô HTML –û–¢–ß–ï–¢–ê ---
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–µ –ø–æ–ª—è –∏–∑ –±—ç–∫–µ–Ω–¥–∞ (gross_income, net_revenue, total_returns)
        // –ï—Å–ª–∏ –±—ç–∫–µ–Ω–¥ –∏—Ö –µ—â–µ –Ω–µ –ø—Ä–∏—Å—ã–ª–∞–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–æ–ª–ª–±—ç–∫–∏ (0)
        const grossIncome = summary.gross_income || summary.total_income || 0;
        const totalReturns = summary.total_returns || 0;
        const netRevenue = summary.net_revenue || (grossIncome - totalReturns);
        const opExpenses = summary.total_operational_expenses || summary.total_expenses || 0;

        contentDiv.innerHTML = `
            <div class="border rounded-xl p-6 mb-6 bg-white shadow-md space-y-6"> 
                
                <div>
                    <h3 class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-3">–í—ã—Ä—É—á–∫–∞</h3>
                    
                    <div class="flex justify-between text-gray-600 mb-1">
                        <span>–û–±—â–∏–π –ø—Ä–∏—Ö–æ–¥:</span>
                        <span class="font-mono text-gray-800">${grossIncome.toFixed(2)} —Å–æ–º</span>
                    </div>
                    <div class="flex justify-between text-xs text-gray-400 ml-4 mb-2">
                        <span>(–ù–∞–ª: ${(summary.total_cash_income || 0).toFixed(2)} / –ö–∞—Ä—Ç–∞: ${(summary.total_card_income || 0).toFixed(2)})</span>
                    </div>
                    
                    <div class="flex justify-between text-red-500 mb-2">
                        <span>- –í–æ–∑–≤—Ä–∞—Ç—ã (–æ—Ç–º–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂):</span>
                        <span class="font-mono">-${totalReturns.toFixed(2)} —Å–æ–º</span>
                    </div>
                    
                    <div class="flex justify-between text-indigo-700 font-bold text-lg pt-3 border-t border-dashed border-gray-300">
                        <span>= –ß–ò–°–¢–ê–Ø –í–´–†–£–ß–ö–ê:</span>
                        <span>${netRevenue.toFixed(2)} —Å–æ–º</span>
                    </div>
                </div>

                <div class="pt-2">
                    <h3 class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-3">–†–∞—Å—Ö–æ–¥—ã –ö–æ–º–ø–∞–Ω–∏–∏</h3>
                    
                    <div class="flex justify-between text-gray-800 mb-2 font-medium">
                        <span>–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã:</span>
                        <span class="font-mono text-red-600">-${opExpenses.toFixed(2)} —Å–æ–º</span>
                    </div>
                    
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-100">
                        ${expensesHtml}
                    </div>
                </div>

                <div class="border-t-2 border-gray-200 pt-5 mt-2"> 
                    <div class="flex justify-between items-end">
                        <span class="text-gray-600 font-bold text-lg">–ß–ò–°–¢–ê–Ø –ü–†–ò–ë–´–õ–¨:</span>
                        <span class="text-3xl font-extrabold ${summary.net_profit >= 0 ? 'text-green-600' : 'text-red-600'}">
                            ${summary.net_profit.toFixed(2)} —Å–æ–º
                        </span>
                    </div>
                </div>
            </div>

            <div class="mt-8"> 
                ${shiftsHtml} 
            </div>
        `;

        // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏ –∫ –∫–Ω–æ–ø–∫–∞–º "–ü–æ–¥—Ä–æ–±–Ω–µ–µ"
        contentDiv.querySelectorAll('.view-shift-report-btn').forEach(btn => {
            // –ö–ª–æ–Ω–∏—Ä—É–µ–º –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö —Å–ª—É—à–∞—Ç–µ–ª–µ–π (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            newBtn.addEventListener('click', (e) => {
                const shiftId = e.target.dataset.shiftId;
                showPastShiftReportModal(shiftId);
            });
        });

        console.log("[Fetch Summary] Report rendered successfully.");

    } catch (e) {
        console.error("!!! [Fetch Summary] Error:", e);
        contentDiv.innerHTML = `<div class="p-4 bg-red-50 text-red-600 rounded-lg border border-red-200">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–≤–æ–¥–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞: ${e.message}</div>`;
    } finally {
        hideLoader();
        console.log("[Fetch] fetchAndRenderSummaryReport: End");
    }
}

// --- –ó–∞–≥—Ä—É–∑–∫–∞ –∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –û—Ç—á–µ—Ç–∞ –ø–æ –≤—ã–∫—É–ø—É ---
async function fetchAndRenderBuyoutReport() {
    console.log("[Fetch] fetchAndRenderBuyoutReport: Start");
    const contentDiv = document.getElementById('buyout-report-content');
    const startDateInput = document.getElementById('buyout-start-date');
    const endDateInput = document.getElementById('buyout-end-date');
    if (!contentDiv || !startDateInput || !endDateInput) return; // –ü—Ä–æ–≤–µ—Ä–∫–∞

    const startDate = startDateInput.value;
    const endDate = endDateInput.value;
    if (!startDate || !endDate) {
        contentDiv.innerHTML = '<p class="text-yellow-500">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—ã.</p>';
        return;
    }

    contentDiv.innerHTML = '<p class="animate-pulse">–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –ø–æ –≤—ã–∫—É–ø—É...</p>';
    showLoader();

    // --- –§–æ—Ä–º–∏—Ä—É–µ–º URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ ---
    const params = new URLSearchParams({
        start_date: startDate,
        end_date: endDate
    });
    // –î–æ–±–∞–≤–ª—è–µ–º location_id (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –°–≤–æ–¥–Ω–æ–º—É –æ—Ç—á–µ—Ç—É)
    const locationSelect = document.getElementById('buyout-location-filter');
    if (locationSelect && locationSelect.value) {
        params.append('location_id', locationSelect.value);
        console.log("[Fetch Buyout] Filtering by location_id:", locationSelect.value);
    } else if (currentUser.role === '–í–ª–∞–¥–µ–ª–µ—Ü') {
        console.log("[Fetch Buyout] Owner viewing buyout for ALL locations.");
    }
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –†–ï–ê–õ–¨–ù–´–ô URL —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞
    const url = `/api/reports/buyout?${params.toString()}`;
    console.log("[Fetch Buyout] Requesting URL:", url);
    // --- –ö–æ–Ω–µ—Ü —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è URL ---

    try {
        // --- –ó–ê–ü–†–û–° –ö API ---
        const response = await apiFetch(url); // –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å
        // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ—Ç–≤–µ—Ç–∞ –±—ç–∫–µ–Ω–¥–∞
        const { items, total_profit } = response.report;
        // --- –ö–û–ù–ï–¶ –ó–ê–ü–†–û–°–ê –ö API ---


        if (!items || items.length === 0) {
            contentDiv.innerHTML = '<p class="text-gray-500">–ó–∞–∫–∞–∑–æ–≤ –Ω–∞ –≤—ã–∫—É–ø –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ (—Å —É—á–µ—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–∞) –Ω–µ—Ç.</p>';
            return;
        }

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
        const rowsHtml = items.map(item => `
            <tr class="border-b text-sm hover:bg-gray-50 buyout-report-row">
                <td class="p-2 whitespace-nowrap">${new Date(item.created_at).toLocaleDateString('ru-RU')}</td>
                <td class="p-2">${item.client_name || '?'}</td>
                <td class="p-2">${item.track_code || '?'}</td>
                <td class="p-2 text-right">${item.item_cost_cny?.toFixed(2) || '-'}</td>
                <td class="p-2 text-right">${item.rate_for_client?.toFixed(2) || '-'}</td>
                <td class="p-2 text-right font-semibold">${item.price_for_client?.toFixed(2) || '-'}</td>
                <td class="p-2 text-right">${item.actual_rate?.toFixed(2) || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                <td class="p-2 text-right">${item.actual_cost?.toFixed(2) || '-'}</td>
                <td class="p-2 text-right font-bold ${item.profit >= 0 ? 'text-green-600' : 'text-red-600'}">${item.profit?.toFixed(2) || '0.00'}</td>
            </tr>
        `).join('');

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –≤—Å–µ–π —Ç–∞–±–ª–∏—Ü—ã –∏ –∏—Ç–æ–≥–æ–≤–æ–π —Å—É–º–º—ã
        contentDiv.innerHTML = `
            <table class="w-full min-w-[900px]"> <thead class="bg-gray-100 sticky top-0"> <tr class="text-left text-xs font-bold uppercase text-gray-600">
                        <th class="p-2">–î–∞—Ç–∞</th>
                        <th class="p-2">–ö–ª–∏–µ–Ω—Ç</th>
                        <th class="p-2">–¢—Ä–µ–∫</th>
                        <th class="p-2 text-right">–¶–µ–Ω–∞(CNY)</th>
                        <th class="p-2 text-right">–ö—É—Ä—Å(–∫–ª–∏–µ–Ω—Ç)</th>
                        <th class="p-2 text-right">–¶–µ–Ω–∞(–∫–ª–∏–µ–Ω—Ç)</th>
                        <th class="p-2 text-right">–†–µ–∞–ª. –∫—É—Ä—Å</th>
                        <th class="p-2 text-right">–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å</th>
                        <th class="p-2 text-right">–ü—Ä–∏–±—ã–ª—å</th>
                    </tr>
                </thead>
                <tbody>${rowsHtml}</tbody>
            </table>
            <div class="mt-4 text-right border-t pt-4">
                <span class="text-lg font-bold">–ò—Ç–æ–≥–æ–≤–∞—è –ø—Ä–∏–±—ã–ª—å –æ—Ç –∫—É—Ä—Å–æ–≤–æ–π —Ä–∞–∑–Ω–∏—Ü—ã:</span>
                <span id="buyout-total-profit" class="text-xl font-bold ${total_profit >= 0 ? 'text-green-700' : 'text-red-700'}">${total_profit.toFixed(2)} —Å–æ–º</span>
            </div>
        `;
        console.log("[Fetch Buyout] Report rendered with REAL data.");

    } catch (e) { // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
        console.error("!!! [Fetch Buyout] Error fetching or rendering buyout report:", e);
        contentDiv.innerHTML = `<p class="text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—á–µ—Ç–∞ –ø–æ –≤—ã–∫—É–ø—É: ${e.message}</p>`;
    } finally {
        // –°–∫—Ä—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
        hideLoader();
        console.log("[Fetch] fetchAndRenderBuyoutReport: End");
    }
}

// --- –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ –ø–æ –û—Ç—á–µ—Ç—É –æ –≤—ã–∫—É–ø–µ ---
function handleBuyoutReportSearch(e) {
    const searchTerm = e.target.value.toLowerCase().trim();
    console.log(`[Search Buyout] Term: "${searchTerm}"`);
    let visibleProfit = 0; // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ –ø—Ä–∏–±—ã–ª–∏ –≤–∏–¥–∏–º—ã—Ö —Å—Ç—Ä–æ–∫

    // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã (–∫—Ä–æ–º–µ —à–∞–ø–∫–∏)
    document.querySelectorAll('#buyout-report-content table tbody tr.buyout-report-row').forEach(row => {
        const rowContent = row.textContent?.toLowerCase() || ''; // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –≤—Å–µ–π —Å—Ç—Ä–æ–∫–∏
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Å—Ç—Ä–æ–∫–∞ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
        const isMatch = rowContent.includes(searchTerm);
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–ª–∏ —Å–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É
        row.style.display = isMatch ? '' : 'none';
        // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –≤–∏–¥–∏–º–∞, –¥–æ–±–∞–≤–ª—è–µ–º –µ–µ –ø—Ä–∏–±—ã–ª—å –∫ –æ–±—â–µ–π –≤–∏–¥–∏–º–æ–π –ø—Ä–∏–±—ã–ª–∏
        if (isMatch) {
            // –ù–∞—Ö–æ–¥–∏–º —è—á–µ–π–∫—É —Å –ø—Ä–∏–±—ã–ª—å—é (–ø–æ—Å–ª–µ–¥–Ω—è—è td)
            const profitCell = row.querySelector('td:last-child');
            if (profitCell) {
                visibleProfit += parseFloat(profitCell.textContent) || 0; // –î–æ–±–∞–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
            }
        }
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏—Ç–æ–≥–æ–≤–æ–π –ø—Ä–∏–±—ã–ª–∏ –¢–û–õ–¨–ö–û –¥–ª—è –≤–∏–¥–∏–º—ã—Ö —Å—Ç—Ä–æ–∫
    const totalProfitSpan = document.getElementById('buyout-total-profit');
    if (totalProfitSpan) {
        totalProfitSpan.textContent = `${visibleProfit.toFixed(2)} —Å–æ–º`; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—É–º–º—É –≤–∏–¥–∏–º—ã—Ö
        // –ú–µ–Ω—è–µ–º —Ü–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∑–Ω–∞–∫–∞
        totalProfitSpan.classList.toggle('text-green-700', visibleProfit >= 0);
        totalProfitSpan.classList.toggle('text-red-700', visibleProfit < 0);
    }
    console.log(`[Search Buyout] Filtering complete. Visible profit: ${visibleProfit.toFixed(2)}`);
}

// --- –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å –æ—Ç—á–µ—Ç–æ–º –ø–æ –ü–†–û–®–õ–û–ô —Å–º–µ–Ω–µ ---
async function showPastShiftReportModal(shiftId) {
    // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ #shift-report-modal —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ HTML
    const modal = document.getElementById('shift-report-modal'); 
    if (!modal) return console.error("–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ #shift-report-modal –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!");
    const contentDiv = modal.querySelector('.modal-content');
    if (!contentDiv) return console.error("–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä .modal-content –Ω–µ –Ω–∞–π–¥–µ–Ω!");
    
    contentDiv.innerHTML = '<p class="animate-pulse">–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á–µ—Ç–∞ –ø–æ —Å–º–µ–Ω–µ...</p>';
    openModal('shift-report-modal');
    showLoader(); 

    try {
        const report = await apiFetch(`/api/reports/shift/${shiftId}`);

        contentDiv.innerHTML = `
            <div class="flex justify-between items-start">
                <h3 class="text-2xl font-bold mb-4">–û—Ç—á–µ—Ç –ø–æ —Å–º–µ–Ω–µ ‚Ññ${report.shift_id}</h3>
                <button onclick="closeModal('shift-report-modal')" class="text-2xl font-bold">&times;</button>
            </div>
            <div class="text-sm text-gray-500">
                <p><strong>–°–æ—Ç—Ä—É–¥–Ω–∏–∫:</strong> ${report.employee_name}</p>
                <p><strong>–§–∏–ª–∏–∞–ª:</strong> ${report.location_name}</p>
                <p><strong>–ü–µ—Ä–∏–æ–¥:</strong> ${new Date(report.shift_start_time).toLocaleString()} - ${report.shift_end_time ? new Date(report.shift_end_time).toLocaleString() : '–ê–ö–¢–ò–í–ù–ê'}</p>
            </div>
            <div class="border-t pt-4 mt-4 space-y-2 text-lg">
                <div class="flex justify-between"><span>–ù–∞–ª–∏—á–Ω—ã–µ –Ω–∞ –Ω–∞—á–∞–ª–æ:</span> <span class="font-semibold">${report.starting_cash.toFixed(2)} —Å–æ–º</span></div>
                <div class="flex justify-between text-green-600"><span>–ü—Ä–∏—Ö–æ–¥ –Ω–∞–ª–∏—á–Ω—ã–º–∏ (+):</span> <span class="font-semibold">${report.cash_income.toFixed(2)} —Å–æ–º</span></div>
                <div class="flex justify-between text-blue-600"><span>–ü—Ä–∏—Ö–æ–¥ –ø–æ –∫–∞—Ä—Ç–µ (+):</span> <span class="font-semibold">${report.card_income.toFixed(2)} —Å–æ–º</span></div>
                <div class="flex justify-between text-red-600"><span>–†–∞—Å—Ö–æ–¥—ã (–æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ) (-):</span> <span class="font-semibold">${report.total_expenses.toFixed(2)} —Å–æ–º</span></div>
                <div class="flex justify-between text-yellow-600"><span>–í–æ–∑–≤—Ä–∞—Ç—ã (-):</span> <span class="font-semibold">${report.total_returns.toFixed(2)} —Å–æ–º</span></div>
            </div>
            <div class="border-t pt-4 mt-4 space-y-2">
                <div class="flex justify-between text-xl font-bold"><span>–ò—Ç–æ–≥–æ –≤ –∫–∞—Å—Å–µ (—Ä–∞—Å—á–µ—Ç):</span><span>${report.calculated_cash.toFixed(2)} —Å–æ–º</span></div>
                <div class="flex justify-between text-lg"><span>–í –∫–∞—Å—Å–µ –ø–æ —Ñ–∞–∫—Ç—É (–ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏):</span><span class="font-semibold">${report.actual_closing_cash?.toFixed(2) || '–°–º–µ–Ω–∞ –Ω–µ –∑–∞–∫—Ä—ã—Ç–∞'} —Å–æ–º</span></div>
                ${report.discrepancy !== null ? `
                    <div class="flex justify-between text-xl font-bold ${report.discrepancy === 0 ? 'text-green-600' : 'text-red-600'}">
                        <span>–†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ:</span>
                        <span>${report.discrepancy.toFixed(2)} —Å–æ–º</span>
                    </div>
                ` : ''}
            </div>
        `;
    } catch (e) {
        contentDiv.innerHTML = `<p class="text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—á–µ—Ç–∞: ${e.message}</p>`;
    } finally {
        hideLoader();
    }
}
// === –ö–û–ù–ï–¶ –ú–û–î–£–õ–Ø –û–¢–ß–ï–¢–´ ===

// === –ù–ê–ß–ê–õ–û: –õ–æ–≥–∏–∫–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –†–∞—Å—á–µ—Ç–∞ (–ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è) ===

// --- –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–∞—Å—á–µ—Ç–∞ ---
function openCalculateModal() {
    console.log("[Calculate Modal] –û—Ç–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞ —Ä–∞—Å—á–µ—Ç–∞...");
    const calculateModal = document.getElementById('calculate-modal');
    if (!calculateModal) return; // –ü—Ä–æ–≤–µ—Ä–∫–∞

    // --- –°–±—Ä–æ—Å –æ–∫–Ω–∞ –≤ –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ---
    // –®–∞–≥ 1 (–ü–æ–∏—Å–∫)
    const searchInput = document.getElementById('calc-client-search-input');
    if(searchInput) searchInput.value = '';
    const searchResults = document.getElementById('calc-client-search-results');
    if(searchResults) searchResults.innerHTML = '';
    if(searchResults) searchResults.classList.add('hidden'); // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Å–∫—Ä—ã—Ç
    const clientInfo = document.getElementById('calc-selected-client-info');
    if(clientInfo) clientInfo.classList.add('hidden');
    const clientIdInput = document.getElementById('calc-selected-client-id');
    if(clientIdInput) clientIdInput.value = '';

    // –®–∞–≥ 2 (–ó–∞–∫–∞–∑—ã)
    const step2 = document.getElementById('calc-step-2-orders');
    if(step2) step2.classList.add('hidden');
    const ordersList = document.getElementById('calc-orders-list');
    if(ordersList) ordersList.innerHTML = '<p class="text-gray-500">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞.</p>';
    const selectAllCheckbox = document.getElementById('calc-select-all-orders');
    if(selectAllCheckbox) selectAllCheckbox.checked = false;

    // –®–∞–≥ 3 (–†–∞—Å—á–µ—Ç)
    const step3 = document.getElementById('calc-step-3-calculation');
    if(step3) step3.classList.add('hidden');
    const totalWeightInput = document.getElementById('calc-total-weight-input');
    if(totalWeightInput) totalWeightInput.value = '';
    const individualWeights = document.getElementById('calc-individual-weights');
    if(individualWeights) individualWeights.innerHTML = '';
    const totalCostDisplay = document.getElementById('calc-total-cost-display');
    if(totalCostDisplay) totalCostDisplay.textContent = '0.00 —Å–æ–º';

    // –®–∞–≥ 4 (–î–µ–π—Å—Ç–≤–∏—è)
    const step4 = document.getElementById('calc-step-4-actions');
    if(step4) step4.classList.add('hidden');

    // --- –ü–æ–¥–≥—Ä—É–∑–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –∫—É—Ä—Å–æ–≤ –∏ —Ü–µ–Ω—ã ---
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ–π —Å–º–µ–Ω—ã (–µ—Å–ª–∏ –µ—Å—Ç—å) –∏–ª–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    const defaultPriceInput = document.getElementById('calc-price-per-kg');
    const defaultRateInput = document.getElementById('calc-exchange-rate');
    if (defaultPriceInput) {
         defaultPriceInput.value = activeShift?.price_per_kg_usd || 5.5; // –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    }
    if (defaultRateInput) {
         defaultRateInput.value = activeShift?.exchange_rate_usd || 87.5; // –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    }

    // --- –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ ---
    const statusSelect = document.getElementById('calc-new-status-select');
    if (statusSelect) {
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏—é "–ù–µ –º–µ–Ω—è—Ç—å" –∏ –≤—Å–µ —Å—Ç–∞—Ç—É—Å—ã –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π orderStatuses
        statusSelect.innerHTML = '<option value="">-- –ù–µ –º–µ–Ω—è—Ç—å --</option>' +
                                  orderStatuses.map(s => `<option value="${s}">${s}</option>`).join('');
    }

    // --- –ü—Ä–∏–≤—è–∑–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª–µ–π (–í–ê–ñ–ù–û –¥–µ–ª–∞—Ç—å —ç—Ç–æ –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–µ–π) ---
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º replaceAndListen –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
    const replaceAndListenCalc = (id, event, handler) => {
        const element = document.getElementById(id);
        if (element) {
            const newElement = element.cloneNode(true);
            element.parentNode?.replaceChild(newElement, element);
            newElement.addEventListener(event, handler);
            console.log(`[Calc Listener OK] Added ${event} to #${id}`);
        } else {
             console.warn(`!!! Calculate Modal: Element #${id} NOT FOUND during listener attachment.`);
        }
    };

    replaceAndListenCalc('calc-client-search-input', 'input', handleCalcClientSearch);
    replaceAndListenCalc('calc-select-all-orders', 'change', handleCalcSelectAllOrders);
    replaceAndListenCalc('save-calculation-btn', 'click', saveCalculation); // –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è

    // –°–ª—É—à–∞—Ç–µ–ª–∏ –¥–ª—è –ø–æ–ª–µ–π —Ä–∞—Å—á–µ—Ç–∞ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ handleCalculationCheckboxChange

    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    openModal('calculate-modal');
    console.log("[Calculate Modal] –û–∫–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ.");
}

// --- –ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞ –í–ù–£–¢–†–ò –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–∞—Å—á–µ—Ç–∞ ---
function handleCalcClientSearch(e) {
    const input = e.target;
    const resultsDiv = document.getElementById('calc-client-search-results');
    const selectedIdInput = document.getElementById('calc-selected-client-id');
    const clientInfoDiv = document.getElementById('calc-selected-client-info');

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –ø–æ–∏—Å–∫–∞
    handleGenericClientSearch(input, resultsDiv, (client) => {
        // Callback-—Ñ—É–Ω–∫—Ü–∏—è, –≤—ã–∑—ã–≤–∞–µ–º–∞—è –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –∫–ª–∏–µ–Ω—Ç–∞
        input.value = ''; // –û—á–∏—â–∞–µ–º –ø–æ–∏—Å–∫
        if(resultsDiv) resultsDiv.classList.add('hidden'); // –°–∫—Ä—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        if(selectedIdInput) selectedIdInput.value = client.id; // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID
        if(clientInfoDiv) { // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –∫–ª–∏–µ–Ω—Ç–µ
             clientInfoDiv.textContent = `–í—ã–±—Ä–∞–Ω –∫–ª–∏–µ–Ω—Ç: ${client.full_name} (${client.client_code_prefix || ''}${client.client_code_num || '–ù–µ—Ç –∫–æ–¥–∞'})`;
             clientInfoDiv.classList.remove('hidden');
        }
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∑–∞–∫–∞–∑–æ–≤ —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
        loadClientOrdersForCalculation(client.id);
    });
}

// --- –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤ –∫–ª–∏–µ–Ω—Ç–∞ –î–õ–Ø –†–ê–°–ß–ï–¢–ê ---
async function loadClientOrdersForCalculation(clientId) {
    console.log(`[Calculate Modal] –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ ID: ${clientId}`);
    const ordersListDiv = document.getElementById('calc-orders-list');
    const step2Div = document.getElementById('calc-step-2-orders');
    const step3Div = document.getElementById('calc-step-3-calculation');
    const step4Div = document.getElementById('calc-step-4-actions');

    if (!ordersListDiv || !step2Div || !step3Div || !step4Div) return; // –ü—Ä–æ–≤–µ—Ä–∫–∞

    ordersListDiv.innerHTML = '<p class="text-gray-500 animate-pulse">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</p>';
    step2Div.classList.remove('hidden'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ –≤—ã–±–æ—Ä–∞ –∑–∞–∫–∞–∑–æ–≤
    step3Div.classList.add('hidden');    // –°–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫ —Ä–∞—Å—á–µ—Ç–∞
    step4Div.classList.add('hidden');    // –°–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π

    try {
        // –§–æ—Ä–º–∏—Ä—É–µ–º URL –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤ –¢–û–õ–¨–ö–û —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –∏ –ù–ï –≤—ã–¥–∞–Ω–Ω—ã—Ö
        const params = new URLSearchParams({ client_id: clientId });

        // --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–û–ë–ê–í–õ–Ø–ï–ú ID –ö–û–ú–ü–ê–ù–ò–ò ---
        if (!currentCompany || !currentCompany.id) {
            console.error("!!! [Calculate Modal] –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –∫–æ–º–ø–∞–Ω–∏–∏ (currentCompany.id) –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –∑–∞–∫–∞–∑–æ–≤!");
            ordersListDiv.innerHTML = '<p class="text-red-500">–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –∫–æ–º–ø–∞–Ω–∏–∏.</p>';
            return; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
        }
        params.append('company_id', currentCompany.id);
        // --- –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø ---

        // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ —Å—Ç–∞—Ç—É—Å—ã, –∫—Ä–æ–º–µ "–í—ã–¥–∞–Ω"
        orderStatuses.filter(s => s !== '–í—ã–¥–∞–Ω').forEach(s => params.append('statuses', s));

        // –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ API (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —ç–Ω–¥–ø–æ–∏–Ω—Ç GET /api/orders)
        // –¢–µ–ø–µ—Ä—å URL –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å client_id, company_id –∏ statuses
        const clientOrders = await apiFetch(`/api/orders?${params.toString()}`);

        if (!clientOrders || clientOrders.length === 0) {
            ordersListDiv.innerHTML = '<p class="text-gray-500">–£ —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ (–∫—Ä–æ–º–µ –≤—ã–¥–∞–Ω–Ω—ã—Ö).</p>';
            return;
        }

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –¥–ª—è —Å–ø–∏—Å–∫–∞ –∑–∞–∫–∞–∑–æ–≤ —Å —á–µ–∫–±–æ–∫—Å–∞–º–∏
        ordersListDiv.innerHTML = clientOrders.map(order => `
            <div class="flex items-center justify-between py-1">
                <div class="flex items-center">
                    <input type="checkbox" id="calc-order-${order.id}" value="${order.id}"
                           class="calc-order-checkbox h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                           data-track-code="${order.track_code}"
                           data-order-json='${JSON.stringify(order)}'> <label for="calc-order-${order.id}" class="ml-3 block text-sm text-gray-900">
                        ${order.track_code} <span class="text-xs text-gray-500">(${order.status})</span>
                    </label>
                </div>
                <span class="text-xs text-blue-600">
                    ${order.calculated_weight_kg ? `–í–µ—Å: ${order.calculated_weight_kg} –∫–≥` : ''}
                    ${order.calculated_final_cost_som ? ` / –¶–µ–Ω–∞: ${order.calculated_final_cost_som.toFixed(0)} —Å–æ–º` : ''}
                </span>
            </div>
        `).join('');

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞ —á–µ–∫–±–æ–∫—Å—ã –∑–∞–∫–∞–∑–æ–≤ –ü–û–°–õ–ï –∏—Ö —Å–æ–∑–¥–∞–Ω–∏—è
        ordersListDiv.querySelectorAll('.calc-order-checkbox').forEach(cb => {
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Å–ª—É—à–∞—Ç–µ–ª—å –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ
            const newCb = cb.cloneNode(true);
            cb.parentNode.replaceChild(newCb, cb);
            newCb.addEventListener('change', handleCalculationCheckboxChange);
        });
        console.log(`[Calculate Modal] –ó–∞–∫–∞–∑—ã (${clientOrders.length}) –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω—ã.`);

    } catch (error) {
        console.error("!!! [Calculate Modal] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤:", error);
        ordersListDiv.innerHTML = `<p class="text-red-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤: ${error.message}</p>`;
    }
}

// --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —á–µ–∫–±–æ–∫—Å–∞ "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ" –≤ –æ–∫–Ω–µ —Ä–∞—Å—á–µ—Ç–∞ ---
function handleCalcSelectAllOrders(e) {
    const isChecked = e.target.checked;
    console.log(`[Calculate Modal] Select all checkbox changed to: ${isChecked}`);
    // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —á–µ–∫–±–æ–∫—Å—ã –∑–∞–∫–∞–∑–æ–≤ –í–ù–£–¢–†–ò –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê
    document.querySelectorAll('#calc-orders-list .calc-order-checkbox').forEach(cb => {
        cb.checked = isChecked; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ –∂–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    });
    // –í—ã–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –±–ª–æ–∫ —Ä–∞—Å—á–µ—Ç–∞ –∏ –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª—è
    handleCalculationCheckboxChange();
}

// --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ª—é–±–æ–≥–æ —á–µ–∫–±–æ–∫—Å–∞ –∑–∞–∫–∞–∑–∞ –≤ –æ–∫–Ω–µ —Ä–∞—Å—á–µ—Ç–∞ ---
function handleCalculationCheckboxChange() {
    // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –û–¢–ú–ï–ß–ï–ù–ù–´–ï —á–µ–∫–±–æ–∫—Å—ã –∑–∞–∫–∞–∑–æ–≤ –≤ –º–æ–¥–∞–ª–∫–µ
    const checkedCheckboxes = document.querySelectorAll('#calc-orders-list .calc-order-checkbox:checked');
    const calculationDiv = document.getElementById('calc-step-3-calculation');
    const actionsDiv = document.getElementById('calc-step-4-actions');
    const individualWeightsDiv = document.getElementById('calc-individual-weights');

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ
    if (checkedCheckboxes.length > 0) {
        console.log(`[Calculate Modal] ${checkedCheckboxes.length} orders selected. Showing calculation steps.`);
        // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∑–∞–∫–∞–∑, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫–∏ —Ä–∞—Å—á–µ—Ç–∞ –∏ –∫–Ω–æ–ø–æ–∫
        if(calculationDiv) calculationDiv.classList.remove('hidden');
        if(actionsDiv) actionsDiv.classList.remove('hidden');
        if(!individualWeightsDiv) return; // –í—ã—Ö–æ–¥–∏–º, –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤–µ—Å–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–æ–ª—è –¥–ª—è –≤–≤–æ–¥–∞ –≤–µ—Å–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –í–´–ë–†–ê–ù–ù–´–• –∑–∞–∫–∞–∑–æ–≤
        individualWeightsDiv.innerHTML = ''; // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –ø–æ–ª—è
        checkedCheckboxes.forEach(cb => {
            const orderId = cb.value;
            const trackCode = cb.dataset.trackCode;
            let orderData = {};
            try { // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞ –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–∞
                 orderData = JSON.parse(cb.dataset.orderJson);
            } catch(e) { console.warn("Could not parse order data from checkbox", e); }
            // –ë–µ—Ä–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –≤–µ—Å (calculated_weight_kg), –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
            const prefilledWeight = orderData?.calculated_weight_kg || '';

            // –î–æ–±–∞–≤–ª—è–µ–º HTML –¥–ª—è –ø–æ–ª—è –≤–≤–æ–¥–∞ –≤–µ—Å–∞
            individualWeightsDiv.innerHTML += `
                <div class="flex justify-between items-center border-b pb-1 mb-1"> <span class="font-semibold text-sm">${trackCode}</span>
                    <input type="number" step="any" placeholder="–í–µ—Å (–∫–≥)"
                           class="calc-weight-input w-24 p-1 border rounded text-sm"
                           data-order-id="${orderId}" value="${prefilledWeight}" required>
                </div>
            `;
        });

        // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏ –¥–ª—è –¢–û–õ–¨–ö–û –ß–¢–û —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –ø–æ–ª–µ–π —Ä–∞—Å—á–µ—Ç–∞
        addCalculationListeners();
        // –°—Ä–∞–∑—É –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å —Å –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        updateCalculationTotals();

    } else {
        console.log("[Calculate Modal] No orders selected. Hiding calculation steps.");
        // –ï—Å–ª–∏ –Ω–∏ –æ–¥–∏–Ω –∑–∞–∫–∞–∑ –Ω–µ –≤—ã–±—Ä–∞–Ω, —Å–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫–∏ –∏ –æ—á–∏—â–∞–µ–º –ø–æ–ª—è –≤–µ—Å–∞
        if(calculationDiv) calculationDiv.classList.add('hidden');
        if(actionsDiv) actionsDiv.classList.add('hidden');
        if(individualWeightsDiv) individualWeightsDiv.innerHTML = '';
    }
     // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–∞ "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ"
     updateCalcSelectAllCheckboxState();
}

// –û–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–∞ "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ" –í–ù–£–¢–†–ò –û–ö–ù–ê –†–ê–°–ß–ï–¢–ê
function updateCalcSelectAllCheckboxState() {
     const selectAllCheckbox = document.getElementById('calc-select-all-orders');
     if (!selectAllCheckbox) return;

     const allCheckboxes = document.querySelectorAll('#calc-orders-list .calc-order-checkbox');
     const checkedCount = document.querySelectorAll('#calc-orders-list .calc-order-checkbox:checked').length;

     if (allCheckboxes.length === 0) {
         selectAllCheckbox.checked = false;
         selectAllCheckbox.indeterminate = false;
     } else if (checkedCount === 0) {
         selectAllCheckbox.checked = false;
         selectAllCheckbox.indeterminate = false;
     } else if (checkedCount === allCheckboxes.length) {
         selectAllCheckbox.checked = true;
         selectAllCheckbox.indeterminate = false;
     } else {
         selectAllCheckbox.checked = false;
         selectAllCheckbox.indeterminate = true;
     }
}

// --- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–ª—É—à–∞—Ç–µ–ª–µ–π –∫ –ø–æ–ª—è–º —Ä–∞—Å—á–µ—Ç–∞ (–≤–µ—Å, —Ü–µ–Ω–∞, –∫—É—Ä—Å) ---
// –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ handleCalculationCheckboxChange –ü–û–°–õ–ï —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª–µ–π –≤–µ—Å–∞
function addCalculationListeners() {
    console.log("[Calculate Modal] Adding listeners to calculation inputs.");
    // –û–±—â–∏–π –≤–µ—Å (–∏—Å–ø–æ–ª—å–∑—É–µ–º replaceAndListenCalc –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏)
    const replaceAndListenCalc = (id, event, handler) => {
        const element = document.getElementById(id);
        if (element) {
            const newElement = element.cloneNode(true);
            element.parentNode?.replaceChild(newElement, element);
            newElement.addEventListener(event, handler);
        }
    };
    replaceAndListenCalc('calc-total-weight-input', 'input', handleTotalWeightChange);

    // –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –≤–µ—Å–∞ (–Ω–∞—Ö–æ–¥–∏–º –í–°–ï –∏ –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å)
    document.querySelectorAll('.calc-weight-input').forEach(input => {
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Å–ª—É—à–∞—Ç–µ–ª—å –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ
        const newInput = input.cloneNode(true);
        input.parentNode?.replaceChild(newInput, input);
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –∫ –Ω–æ–≤–æ–º—É —ç–ª–µ–º–µ–Ω—Ç—É
        newInput.addEventListener('input', () => {
             // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –æ–±—â–∏–π –≤–µ—Å, –µ—Å–ª–∏ –Ω–∞—á–∞–ª–∏ –≤–≤–æ–¥–∏—Ç—å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π
            const totalWeightInp = document.getElementById('calc-total-weight-input');
            if(totalWeightInp) totalWeightInp.value = '';
            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É
            updateCalculationTotals();
        });
    });

    // –¶–µ–Ω–∞ –∏ –∫—É—Ä—Å
    replaceAndListenCalc('calc-price-per-kg', 'input', updateCalculationTotals);
    replaceAndListenCalc('calc-exchange-rate', 'input', updateCalculationTotals);
}

// --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ–±—â–µ–≥–æ –≤–µ—Å–∞ (–¥–ª—è –∞–≤—Ç–æ-—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è) ---
function handleTotalWeightChange() {
    const totalWeightInput = document.getElementById('calc-total-weight-input');
    const totalWeight = parseFloat(totalWeightInput?.value) || 0; // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
    const individualInputs = document.querySelectorAll('.calc-weight-input');

    console.log(`[Calculate Modal] Total weight changed: ${totalWeight}`);

    // –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–µ—Å, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω >= 0 –∏ –µ—Å—Ç—å –ø–æ–ª—è –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
    if (totalWeight >= 0 && individualInputs.length > 0) {
        const weightPerItem = (totalWeight / individualInputs.length).toFixed(3); // –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ—Ä–æ–≤–Ω—É, 3 –∑–Ω–∞–∫–∞ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π
        console.log(`[Calculate Modal] Auto-distributing weight: ${weightPerItem} kg per item.`);
        individualInputs.forEach(input => { input.value = weightPerItem; });
    } else if (totalWeight < 0) {
         console.warn("[Calculate Modal] Total weight cannot be negative.");
         if(totalWeightInput) totalWeightInput.value = ''; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
         individualInputs.forEach(input => { input.value = ''; }); // –û—á–∏—â–∞–µ–º –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ
    } else {
        // –ï—Å–ª–∏ –æ–±—â–∏–π –≤–µ—Å —É–±—Ä–∞–ª–∏ –∏–ª–∏ 0, –æ—á–∏—â–∞–µ–º –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ
        console.log("[Calculate Modal] Clearing individual weights.");
        individualInputs.forEach(input => { input.value = ''; });
    }
    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ
    updateCalculationTotals();
}

// --- –ü–µ—Ä–µ—Å—á–µ—Ç –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏—Ç–æ–≥–æ–≤–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ ---
function updateCalculationTotals() {
    const priceInput = document.getElementById('calc-price-per-kg');
    const rateInput = document.getElementById('calc-exchange-rate');
    const totalCostDisplay = document.getElementById('calc-total-cost-display');

    // –ü—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    if (!priceInput || !rateInput || !totalCostDisplay) {
         console.error("!!! updateCalculationTotals: Missing required elements.");
         return;
    }

    const price = parseFloat(priceInput.value) || 0;
    const rate = parseFloat(rateInput.value) || 0;
    let currentTotalWeight = 0;
    // –°—É–º–º–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –í–°–ï–• –ø–æ–ª–µ–π –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ –≤–µ—Å–∞
    document.querySelectorAll('.calc-weight-input').forEach(input => {
        currentTotalWeight += parseFloat(input.value) || 0;
    });

    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å
    const totalCost = currentTotalWeight * price * rate;
    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç, —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É—è –¥–æ 2 –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π
    totalCostDisplay.textContent = `${totalCost.toFixed(2)} —Å–æ–º`;
    // console.log(`[Calculate Modal] Totals updated: Weight=${currentTotalWeight.toFixed(3)}, Price=${price}, Rate=${rate}, TotalCost=${totalCost.toFixed(2)}`);
}

// --- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–∞—Å—á–µ—Ç–∞ (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∫–Ω–æ–ø–∫–æ–π "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å") ---
async function saveCalculation() {
    console.log("[Calculate Modal] saveCalculation: Start");
    // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ —á–µ–∫–±–æ–∫—Å—ã –∑–∞–∫–∞–∑–æ–≤
    const selectedCheckboxes = document.querySelectorAll('#calc-orders-list .calc-order-checkbox:checked');
    // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è —Ü–µ–Ω—ã –∏ –∫—É—Ä—Å–∞
    const pricePerKgInput = document.getElementById('calc-price-per-kg');
    const exchangeRateInput = document.getElementById('calc-exchange-rate');
    const pricePerKg = parseFloat(pricePerKgInput?.value);
    const exchangeRate = parseFloat(exchangeRateInput?.value);
    // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å (–∏–ª–∏ null, –µ—Å–ª–∏ "-- –ù–µ –º–µ–Ω—è—Ç—å --")
    const statusSelect = document.getElementById('calc-new-status-select');
    const newStatus = statusSelect?.value || null;

    // --- –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –≤–µ—Å—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞ ---
    const ordersPayloadItems = []; // –ú–∞—Å—Å–∏–≤ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ –±—ç–∫–µ–Ω–¥
    let hasInvalidWeight = false; // –§–ª–∞–≥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –≤–µ—Å–∞
    selectedCheckboxes.forEach(cb => {
        const orderId = parseInt(cb.value);
        // –ù–∞—Ö–æ–¥–∏–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤–µ—Å–∞
        const weightInput = document.querySelector(`.calc-weight-input[data-order-id="${orderId}"]`);
        const weight = parseFloat(weightInput?.value);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤–µ—Å –≤–≤–µ–¥–µ–Ω –∏ –æ–Ω –±–æ–ª—å—à–µ –Ω—É–ª—è
        if (!weight || weight <= 0) {
            hasInvalidWeight = true; // –°—Ç–∞–≤–∏–º —Ñ–ª–∞–≥, –µ—Å–ª–∏ –≤–µ—Å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω
            if(weightInput) weightInput.classList.add('border-red-500'); // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –Ω–µ–≤–µ—Ä–Ω–æ–µ –ø–æ–ª–µ
        } else {
            if(weightInput) weightInput.classList.remove('border-red-500'); // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É
        }
        // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞ –≤ –º–∞—Å—Å–∏–≤ (–¥–∞–∂–µ –µ—Å–ª–∏ –≤–µ—Å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–∞–±–æ—Ç–∞–ª–∞)
        ordersPayloadItems.push({ order_id: orderId, weight_kg: weight || 0 });
    });

    // --- –ü—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π ---
    if (ordersPayloadItems.length === 0) {
        alert('–ù–µ –≤—ã–±—Ä–∞–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞.');
        return;
    }
    if (hasInvalidWeight) {
        alert('–û—à–∏–±–∫–∞: –í–µ—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–∫–∞–∑–∞–Ω (–±–æ–ª—å—à–µ –Ω—É–ª—è) –¥–ª—è –≤—Å–µ—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥—Å–≤–µ—á–µ–Ω–Ω—ã–µ –ø–æ–ª—è.');
        return;
    }
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ü–µ–Ω—É –∏ –∫—É—Ä—Å
    let validationError = false;
    if (!pricePerKg || pricePerKg <= 0) {
        alert('–û—à–∏–±–∫–∞: –£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ü–µ–Ω—É –∑–∞ –∫–≥ (–±–æ–ª—å—à–µ –Ω—É–ª—è).');
        if(pricePerKgInput) pricePerKgInput.classList.add('border-red-500');
        validationError = true;
    } else {
         if(pricePerKgInput) pricePerKgInput.classList.remove('border-red-500');
    }
    if (!exchangeRate || exchangeRate <= 0) {
        alert('–û—à–∏–±–∫–∞: –£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∫—É—Ä—Å USD (–±–æ–ª—å—à–µ –Ω—É–ª—è).');
        if(exchangeRateInput) exchangeRateInput.classList.add('border-red-500');
        validationError = true;
    } else {
         if(exchangeRateInput) exchangeRateInput.classList.remove('border-red-500');
    }
    if(validationError) return; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º, –µ—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏

    // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è API
    const payload = {
        orders: ordersPayloadItems,      // –°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ —Å –≤–µ—Å–æ–º
        price_per_kg_usd: pricePerKg,    // –¶–µ–Ω–∞
        exchange_rate_usd: exchangeRate, // –ö—É—Ä—Å
        new_status: newStatus            // –ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å (–∏–ª–∏ null)
    };

    console.log("[Calculate Modal] –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ /api/orders/calculate:", payload);
    showLoader(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏

    try {
        // –í—ã–ø–æ–ª–Ω—è–µ–º POST –∑–∞–ø—Ä–æ—Å –∫ –Ω–æ–≤–æ–º—É —ç–Ω–¥–ø–æ–∏–Ω—Ç—É
        const response = await apiFetch('/api/orders/calculate', {
            method: 'POST',
            body: JSON.stringify(payload)
        });

        console.log("[Calculate Modal] Server response:", response);
        alert(response.message || '–†–∞—Å—á–µ—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
        closeModal('calculate-modal'); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–µ "–ó–∞–∫–∞–∑—ã"
        // –í—ã–∑—ã–≤–∞–µ–º fetchAndRenderOrders, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ (–≤–∫–ª—é—á–∞—è –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã –∏ —Ä–∞—Å—á–µ—Ç—ã)
        await fetchAndRenderOrders();
        console.log("[Calculate Modal] –°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–µ –æ–±–Ω–æ–≤–ª–µ–Ω.");

    } catch (error) { // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –æ—Ç API
        console.error("!!! [Calculate Modal] –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ä–∞—Å—á–µ—Ç–∞:", error);
        alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ä–∞—Å—á–µ—Ç–∞: ${error.message}`);
        // –û—Å—Ç–∞–≤–ª—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–∫—Ä—ã—Ç—ã–º –ø—Ä–∏ –æ—à–∏–±–∫–µ
    } finally {
        hideLoader(); // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        console.log("[Calculate Modal] saveCalculation: End");
    }
}

// === –ö–û–ù–ï–¶: –õ–æ–≥–∏–∫–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –†–∞—Å—á–µ—Ç–∞ ===

// index.html (–≤–Ω—É—Ç—Ä–∏ <script>)

// =================================================================
// –ú–û–î–£–õ–¨: –ù–ê–°–¢–†–û–ô–ö–ò (–í–ª–∞–¥–µ–ª–µ—Ü)
// =================================================================

// –ö—ç—à –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
let companySettings = {}; // { key: value, ... }

// --- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≤–∫–ª–∞–¥–∫–∏ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏" ---
async function renderSettingsTab() {
    console.log("[Render] renderSettingsTab: Start");
    const pane = document.getElementById('tab-settings');
    if (!pane) return;

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –¥–ª—è –≤–∫–ª–∞–¥–∫–∏
    pane.innerHTML = `
        <div class="bg-white p-6 rounded-lg shadow-md max-w-4xl mx-auto">
            <h2 class="text-2xl font-bold mb-4">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ö–æ–º–ø–∞–Ω–∏–∏</h2>

            <div class="border-b border-gray-200 mb-6">
                <nav class="-mb-px flex space-x-8" id="settings-subtabs">
                    <button data-subtab="settings-main" class="setting-subtab-btn tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-600">–û—Å–Ω–æ–≤–Ω—ã–µ</button>
                    <button data-subtab="settings-ai" class="setting-subtab-btn tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700">ü§ñ –ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è –ò–ò</button>
                    <button data-subtab="settings-passwords" class="setting-subtab-btn tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700">–ü–∞—Ä–æ–ª–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</button>
                </nav>
            </div>

            <form id="settings-form" class="space-y-6">

                <div id="subtab-settings-main" class="setting-subtab-pane space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">–ê–¥—Ä–µ—Å —Å–∫–ª–∞–¥–∞ –≤ –ö–∏—Ç–∞–µ</label>
                        <p class="text-xs text-gray-500 mb-1">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ <code>{{client_code}}</code> –¥–ª—è –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–æ–¥–∞.</p>
                        <textarea data-key="china_warehouse_address" class="setting-input w-full p-2 border rounded-md h-24 font-mono"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">–°—Å—ã–ª–∫–∞ –Ω–∞ PDF —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π</label>
                        <input type="url" data-key="instruction_pdf_link" class="setting-input w-full p-2 border rounded-md" placeholder="https://...">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">–ù–∞—á–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä –∫–æ–¥–∞ –∫–ª–∏–µ–Ω—Ç–∞</label>
                        <input type="number" data-key="client_code_start" class="setting-input w-full p-2 border rounded-md" placeholder="1001">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">–ì—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã (–¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –±–æ—Ç–µ)</label>
                        <input type="text" data-key="office_schedule" class="setting-input w-full p-2 border rounded-md" placeholder="–ü–Ω-–°–± 09:00-18:00">
                    </div>
                </div>

                <div id="subtab-settings-ai" class="setting-subtab-pane space-y-6 hidden">
                    <div class="bg-blue-50 p-4 rounded-md border border-blue-200 mb-4">
                        <p class="text-sm text-blue-800">
                            ‚ÑπÔ∏è <b>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</b> –í—Å—ë, —á—Ç–æ –≤—ã –Ω–∞–ø–∏—à–µ—Ç–µ –∑–¥–µ—Å—å, –ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç –ø—Ä–æ—á–∏—Ç–∞–µ—Ç –∏ –∑–∞–ø–æ–º–Ω–∏—Ç. 
                            –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–ø—Ä–æ—Å–∏—Ç –ø—Ä–æ –≤—ã–∫—É–ø, –ò–ò –æ—Ç–≤–µ—Ç–∏—Ç –ø–æ –≤–∞—à–∏–º –ø—Ä–∞–≤–∏–ª–∞–º. –ü–∏—à–∏—Ç–µ –ø—Ä–æ—Å—Ç–æ –∏ –ø–æ–Ω—è—Ç–Ω–æ.
                        </p>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-800">üõí –ü—Ä–∞–≤–∏–ª–∞ –í–´–ö–£–ü–ê (–£—Å–ª—É–≥–∏ –±–∞–π–µ—Ä–∞)</label>
                        <p class="text-xs text-gray-500 mb-1">–ù–∞–ø—Ä–∏–º–µ—Ä: "–í—ã–∫—É–ø–∞–µ–º —Å Taobao/1688. –ö–æ–º–∏—Å—Å–∏—è 5%. –ö—É—Ä—Å —é–∞–Ω—è –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –Ω–∞ –¥–µ–Ω—å –æ–ø–ª–∞—Ç—ã." –∏–ª–∏ "–í—ã–∫—É–ø–æ–º –Ω–µ –∑–∞–Ω–∏–º–∞–µ–º—Å—è."</p>
                        <textarea data-key="rule_buyout" class="setting-input w-full p-2 border rounded-md h-32" placeholder="–û–ø–∏—à–∏—Ç–µ —É—Å–ª–æ–≤–∏—è –≤—ã–∫—É–ø–∞..."></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-800">üöö –ü—Ä–∞–≤–∏–ª–∞ –î–û–°–¢–ê–í–ö–ò –∏ –°—Ä–æ–∫–∏</label>
                        <p class="text-xs text-gray-500 mb-1">–ù–∞–ø—Ä–∏–º–µ—Ä: "–°—Ä–æ–∫–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ 10-15 –¥–Ω–µ–π. –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ —Ö—Ä—É–ø–∫–∏–π –≥—Ä—É–∑ –Ω–µ –Ω–µ—Å–µ–º –±–µ–∑ –æ–±—Ä–µ—à–µ—Ç–∫–∏."</p>
                        <textarea data-key="rule_delivery" class="setting-input w-full p-2 border rounded-md h-32" placeholder="–û–ø–∏—à–∏—Ç–µ —É—Å–ª–æ–≤–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏..."></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-800">‚ÑπÔ∏è –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è / –ó–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã</label>
                        <p class="text-xs text-gray-500 mb-1">–õ—é–±–∞—è –¥—Ä—É–≥–∞—è –≤–∞–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è, –∫–æ—Ç–æ—Ä—É—é –¥–æ–ª–∂–µ–Ω –∑–Ω–∞—Ç—å –ò–ò.</p>
                        <textarea data-key="rule_general" class="setting-input w-full p-2 border rounded-md h-24" placeholder="–ó–∞–ø—Ä–µ—â–µ–Ω–æ –≤–æ–∑–∏—Ç—å: –∂–∏–¥–∫–æ—Å—Ç–∏, –±–∞—Ç–∞—Ä–µ–π–∫–∏..."></textarea>
                    </div>
                </div>

                <div id="subtab-settings-passwords" class="setting-subtab-pane space-y-6 hidden">
                    <p class="text-sm text-gray-600">–ü–∞—Ä–æ–ª–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–∞—Å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –≤ –ê–¥–º–∏–Ω–∫–µ.</p>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">–ü–∞—Ä–æ–ª—å –Ω–∞ –í–æ–∑–≤—Ä–∞—Ç —Å—Ç–∞—Ç—É—Å–∞</label>
                        <input type="text" data-key="password_revert_order" class="setting-input w-full p-2 border rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">–ü–∞—Ä–æ–ª—å –Ω–∞ –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</label>
                        <input type="text" data-key="password_delete_order" class="setting-input w-full p-2 border rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">–ü–∞—Ä–æ–ª—å –Ω–∞ –£–¥–∞–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞</label>
                        <input type="text" data-key="password_delete_client" class="setting-input w-full p-2 border rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-red-700">üîë –ü–∞—Ä–æ–ª—å –Ω–∞ –û–¢–ö–ê–¢ –°–¢–ê–¢–£–°–ê (–ì–æ—Ç–æ–≤ -> –í –ø—É—Ç–∏)</label>
                        <p class="text-xs text-gray-500 mb-1">–ó–∞—â–∏—â–∞–µ—Ç –æ—Ç –∫—Ä–∞–∂–∏ "–≥–æ—Ç–æ–≤—ã—Ö" –∑–∞–∫–∞–∑–æ–≤ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏.</p>
                        <input type="text" data-key="password_status_rollback" class="setting-input w-full p-2 border rounded-md border-red-200 bg-red-50" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ —Å–ª–æ–∂–Ω—ã–π –ø–∞—Ä–æ–ª—å">
                    </div>
                </div>

                <div class="border-t pt-4 sticky bottom-0 bg-white pb-4">
                    <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 shadow-md transition-colors">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –í—Å–µ –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                </div>
            </form>
        </div>
    `;

    // --- –ü—Ä–∏–≤—è–∑–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª–µ–π ---
    const form = document.getElementById('settings-form');
    if (form) {
        form.replaceWith(form.cloneNode(true));
        document.getElementById('settings-form').addEventListener('submit', handleSaveSettings);
    }

    // –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∫–ª–∞–¥–æ–∫
    const subtabsContainer = document.getElementById('settings-subtabs');
    if (subtabsContainer) {
        const newSubtabsContainer = subtabsContainer.cloneNode(true);
        subtabsContainer.parentNode?.replaceChild(newSubtabsContainer, subtabsContainer);
        newSubtabsContainer.addEventListener('click', e => {
            const tabButton = e.target.closest('.setting-subtab-btn');
            if (tabButton) {
                const tabName = tabButton.dataset.subtab;
                document.querySelectorAll('.setting-subtab-btn').forEach(btn => {
                    btn.classList.remove('border-indigo-500', 'text-indigo-600');
                    btn.classList.add('border-transparent', 'text-gray-500');
                });
                tabButton.classList.add('border-indigo-500', 'text-indigo-600');
                tabButton.classList.remove('border-transparent', 'text-gray-500');
                document.querySelectorAll('.setting-subtab-pane').forEach(pane => {
                    pane.classList.toggle('hidden', pane.id !== `subtab-${tabName}`);
                });
            }
        });
    }

    await fetchAndRenderSettings();
    console.log("[Render] renderSettingsTab: End");
}

// --- –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ù–∞—Å—Ç—Ä–æ–µ–∫ ---
async function fetchAndRenderSettings() {
    console.log("[Fetch] fetchAndRenderSettings: Start");
    showLoader();
    try {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º GET /api/settings –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–æ–º–ø–∞–Ω–∏–∏
        const settingsList = await apiFetch('/api/settings'); 
        
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å–ø–∏—Å–æ–∫ [{key: k, value: v}, ...] –≤ —É–¥–æ–±–Ω—ã–π –æ–±—ä–µ–∫—Ç (–∫—ç—à)
        companySettings = settingsList.reduce((acc, setting) => {
            acc[setting.key] = setting.value;
            return acc;
        }, {});
        
        console.log("[Fetch] fetchAndRenderSettings: Settings loaded:", companySettings);

        // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –≤–≤–æ–¥–∞ (—Ä–∞–±–æ—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ —Å —Ç–µ–∫—Å—Ç–æ–≤—ã–º–∏ –ø–æ–ª—è–º–∏)
        document.querySelectorAll('.setting-input').forEach(input => {
            const key = input.dataset.key;
            if (companySettings.hasOwnProperty(key)) {
                 // AI-–†—É–±–∏–ª—å–Ω–∏–∫ —É–¥–∞–ª–µ–Ω, –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤–∞—è –ª–æ–≥–∏–∫–∞
                 input.value = companySettings[key] || '';
            } else {
                 input.value = '';
            }
        });

    } catch (e) {
        console.error("[Fetch] fetchAndRenderSettings: Error", e);
        alert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫: ${e.message}`);
    } finally {
        hideLoader();
    }
}

// index.html (–í–Ω—É—Ç—Ä–∏ –ú–û–î–£–õ–¨: –ù–ê–°–¢–†–û–ô–ö–ò)

// --- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ù–∞—Å—Ç—Ä–æ–µ–∫ ---
async function handleSaveSettings(e) {
    e.preventDefault();
    console.log("[Save] handleSaveSettings: Start");
    showLoader();
    
    // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ –∏–∑ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –ø–æ–ª–µ–π
    const settingsToSave = {};
    document.querySelectorAll('.setting-input').forEach(input => {
        const key = input.dataset.key;
        if (key) {
             // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ null, –µ—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ (—á—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –ë–î)
             settingsToSave[key] = input.value.trim() || null; 
        }
    });
    
    const payload = {
        settings: settingsToSave // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–ª–æ–≤–∞—Ä—å {key: value}
    };

    try {
        console.log("[Save] handleSaveSettings: Sending payload:", payload);
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º PUT /api/settings –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (—Å–æ–∑–¥–∞–Ω–∏—è/–∏–∑–º–µ–Ω–µ–Ω–∏—è)
        const updatedSettingsList = await apiFetch('/api/settings', {
            method: 'PUT',
            body: JSON.stringify(payload)
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à (–ª–æ–≥–∏–∫–∞ –æ—Å—Ç–∞–µ—Ç—Å—è)
        companySettings = updatedSettingsList.reduce((acc, setting) => {
            acc[setting.key] = setting.value;
            return acc;
        }, {});
        
        console.log("[Save] handleSaveSettings: Settings saved successfully.");
        alert("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!");

    } catch (err) {
        console.error("[Save] handleSaveSettings: Error", err);
        alert(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫: ${err.message}`);
    } finally {
        hideLoader();
        console.log("[Save] handleSaveSettings: End");
    }
}
// --- –ö–û–ù–ï–¶ –ú–û–î–£–õ–Ø –ù–ê–°–¢–†–û–ô–ö–ò ---

// ==========================================
// –ú–û–î–£–õ–¨: –†–£–ß–ù–û–ï –ü–†–ò–°–í–û–ï–ù–ò–ï (MANUAL CLAIM)
// ==========================================

let unclaimedOrdersCache = []; // –ö—ç—à –Ω–µ–≤–æ—Å—Ç—Ä–µ–±–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤
let manualClaimSelectedIds = new Set(); // –ü–∞–º—è—Ç—å –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö ID

// 1. –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
async function openManualClaimModal() {
    const modal = document.getElementById('manual-claim-modal');
    if (!modal) return;

    resetClaimInterface(); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º UI
    setupClaimListeners(); // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏
    openModal('manual-claim-modal');
}

// 2. –°–±—Ä–æ—Å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
function resetClaimInterface() {
    // –û—á–∏—â–∞–µ–º –ø–∞–º—è—Ç—å
    manualClaimSelectedIds.clear();
    unclaimedOrdersCache = [];

    // –°–±—Ä–æ—Å –õ–µ–≤–æ–π –∫–æ–ª–æ–Ω–∫–∏
    document.getElementById('claim-client-search').value = '';
    document.getElementById('claim-client-results').classList.add('hidden');
    document.getElementById('claim-selected-client-card').classList.add('hidden');
    document.getElementById('claim-client-placeholder').classList.remove('hidden');
    document.getElementById('claim-selected-client-id').value = '';
    
    // –°–±—Ä–æ—Å –ü—Ä–∞–≤–æ–π –∫–æ–ª–æ–Ω–∫–∏
    const orderSearch = document.getElementById('claim-order-search');
    orderSearch.value = '';
    orderSearch.disabled = true;
    
    document.getElementById('claim-orders-list').innerHTML = '<p class="text-center text-gray-400 p-10 mt-10">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ —Å–ª–µ–≤–∞ üëà</p>';
    
    // –°–±—Ä–æ—Å –ü–æ–¥–≤–∞–ª–∞ (Footer)
    const statusSelect = document.getElementById('claim-new-status');
    if (statusSelect) statusSelect.value = '–í –ø—É—Ç–∏';
    
    const calcPanel = document.getElementById('claim-calculation-panel');
    if (calcPanel) calcPanel.classList.add('hidden');
    
    const weightInput = document.getElementById('claim-total-weight');
    if (weightInput) weightInput.value = '';
    
    const sumDisplay = document.getElementById('claim-total-sum');
    if (sumDisplay) sumDisplay.textContent = '0';
    
    const btnText = document.getElementById('claim-btn-text');
    if (btnText) btnText.textContent = '–ü–†–ò–°–í–û–ò–¢–¨';

    // –ü–æ–¥–≥—Ä—É–∑–∫–∞ —Ç–∞—Ä–∏—Ñ–æ–≤ (–ï—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è —Å–º–µ–Ω–∞)
    const priceInput = document.getElementById('claim-price');
    const rateInput = document.getElementById('claim-rate');
    if (priceInput && rateInput) {
        if (activeShift) {
            priceInput.value = activeShift.price_per_kg_usd || 5.5;
            rateInput.value = activeShift.exchange_rate_usd || 89.5;
        } else {
            priceInput.value = 5.5;
            rateInput.value = 89.5;
        }
    }

    updateClaimButtonState();
}

// 3. –ü—Ä–∏–≤—è–∑–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª–µ–π
function setupClaimListeners() {
    // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã
    const clientSearch = document.getElementById('claim-client-search');
    const orderSearch = document.getElementById('claim-order-search');
    const submitBtn = document.getElementById('claim-submit-btn');
    const changeClientBtn = document.getElementById('claim-change-client-btn');
    const ordersListDiv = document.getElementById('claim-orders-list');
    
    // –≠–ª–µ–º–µ–Ω—Ç—ã –ø–æ–¥–≤–∞–ª–∞
    const statusSelect = document.getElementById('claim-new-status');
    const weightInput = document.getElementById('claim-total-weight');
    const priceInput = document.getElementById('claim-price');
    const rateInput = document.getElementById('claim-rate');

    // --- –û—á–∏—Å—Ç–∫–∞ –∏ –ø—Ä–∏–≤—è–∑–∫–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ–º cloneNode –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö —Å–ª—É—à–∞—Ç–µ–ª–µ–π) ---

    // –ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞
    const newClientSearch = clientSearch.cloneNode(true);
    clientSearch.parentNode.replaceChild(newClientSearch, clientSearch);
    newClientSearch.addEventListener('input', (e) => {
        handleGenericClientSearch(e.target, document.getElementById('claim-client-results'), selectClaimClient);
    });

    // –ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–∞
    const newOrderSearch = orderSearch.cloneNode(true);
    orderSearch.parentNode.replaceChild(newOrderSearch, orderSearch);
    newOrderSearch.addEventListener('input', filterClaimOrdersList);

    // –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏
    const newSubmitBtn = submitBtn.cloneNode(true);
    submitBtn.parentNode.replaceChild(newSubmitBtn, submitBtn);
    newSubmitBtn.addEventListener('click', submitManualClaim);

    // –ö–Ω–æ–ø–∫–∞ —Å–º–µ–Ω—ã –∫–ª–∏–µ–Ω—Ç–∞
    const newChangeClientBtn = changeClientBtn.cloneNode(true);
    changeClientBtn.parentNode.replaceChild(newChangeClientBtn, changeClientBtn);
    newChangeClientBtn.addEventListener('click', resetClaimClient);

    // –°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ (–¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∏–∫–æ–≤ –ø–æ —á–µ–∫–±–æ–∫—Å–∞–º)
    const newOrdersListDiv = ordersListDiv.cloneNode(false); // –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    ordersListDiv.parentNode.replaceChild(newOrdersListDiv, ordersListDiv);
    newOrdersListDiv.innerHTML = ordersListDiv.innerHTML; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç (–∑–∞–≥–ª—É—à–∫—É)
    newOrdersListDiv.addEventListener('change', (e) => {
        if (e.target.classList.contains('claim-checkbox')) {
            const orderId = parseInt(e.target.value);
            if (e.target.checked) {
                manualClaimSelectedIds.add(orderId); // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º
            } else {
                manualClaimSelectedIds.delete(orderId); // –ó–∞–±—ã–≤–∞–µ–º
            }
            updateClaimButtonState();
        }
    });

    // –°–ª—É—à–∞—Ç–µ–ª—å —Å–º–µ–Ω—ã —Å—Ç–∞—Ç—É—Å–∞
    if (statusSelect) {
        const newStatusSelect = statusSelect.cloneNode(true);
        statusSelect.parentNode.replaceChild(newStatusSelect, statusSelect);
        newStatusSelect.addEventListener('change', handleClaimStatusChange);
    }

    // –°–ª—É—à–∞—Ç–µ–ª–∏ –¥–ª—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞ (–í–µ—Å, –¶–µ–Ω–∞, –ö—É—Ä—Å)
    [weightInput, priceInput, rateInput].forEach(el => {
        if (el) {
            const newEl = el.cloneNode(true);
            el.parentNode.replaceChild(newEl, el);
            newEl.addEventListener('input', updateClaimCalculation);
        }
    });
}

// 4. –õ–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞ –∫–ª–∏–µ–Ω—Ç–∞
function selectClaimClient(client) {
    // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–∏—Å–∫
    document.getElementById('claim-client-search').value = '';
    document.getElementById('claim-client-results').classList.add('hidden');
    document.getElementById('claim-client-placeholder').classList.add('hidden');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É
    const card = document.getElementById('claim-selected-client-card');
    card.classList.remove('hidden');
    card.classList.add('flex');

    // –ó–∞–ø–æ–ª–Ω—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É
    const clientCode = (client.client_code_prefix || '') + (client.client_code_num || '');
    const displayCode = clientCode ? `<span class="font-mono font-bold text-indigo-700 bg-indigo-100 px-2 py-0.5 rounded">${clientCode}</span>` : '<span class="text-gray-400">–ù–µ—Ç –∫–æ–¥–∞</span>';
    
    const infoBlock = document.getElementById('claim-client-info-block');
    infoBlock.innerHTML = `
        <h5 class="font-bold text-gray-800 text-xl mb-1">${client.full_name}</h5>
        <div class="text-sm space-y-1">
            <div>${displayCode}</div>
            <div class="text-gray-600 font-medium">${client.phone}</div>
        </div>
    `;
    
    document.getElementById('claim-selected-client-id').value = client.id;

    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø—Ä–∞–≤—É—é —á–∞—Å—Ç—å
    const orderSearch = document.getElementById('claim-order-search');
    orderSearch.disabled = false;
    orderSearch.focus();
    
    loadUnclaimedOrders(); // –ó–∞–≥—Ä—É–∂–∞–µ–º "–ø–æ—Ç–µ—Ä—è—à–µ–∫"
}

function resetClaimClient() {
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–∏—Å–∫
    document.getElementById('claim-selected-client-card').classList.add('hidden');
    document.getElementById('claim-client-placeholder').classList.remove('hidden');
    document.getElementById('claim-selected-client-id').value = '';
    
    // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–∞–≤—É—é —á–∞—Å—Ç—å
    const orderSearch = document.getElementById('claim-order-search');
    orderSearch.disabled = true;
    orderSearch.value = '';
    document.getElementById('claim-orders-list').innerHTML = '<p class="text-center text-gray-400 p-10 mt-10">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ —Å–ª–µ–≤–∞ üëà</p>';
    
    // –û—á–∏—â–∞–µ–º –≤—ã–±–æ—Ä
    manualClaimSelectedIds.clear();
    unclaimedOrdersCache = [];
    updateClaimButtonState();
}

// 5. –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–µ–≤–æ—Å—Ç—Ä–µ–±–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤
async function loadUnclaimedOrders() {
    const listDiv = document.getElementById('claim-orders-list');
    const loadingOverlay = document.getElementById('claim-loading-overlay');
    
    if (loadingOverlay) loadingOverlay.classList.remove('hidden');
    
    try {
        const params = new URLSearchParams({
            company_id: currentCompany.id,
            unclaimed_only: 'true',
            limit: 1000
        });

        const orders = await apiFetch(`/api/orders?${params.toString()}`);
        unclaimedOrdersCache = orders || [];
        
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º: –Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É
        unclaimedOrdersCache.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        
        renderClaimOrdersList(unclaimedOrdersCache);

    } catch (e) {
        console.error(e);
        if (listDiv) listDiv.innerHTML = `<p class="text-red-500 p-4 text-center">–û—à–∏–±–∫–∞: ${e.message}</p>`;
    } finally {
        if (loadingOverlay) loadingOverlay.classList.add('hidden');
    }
}

// 6. –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–ø–∏—Å–∫–∞ (—Å —É—á–µ—Ç–æ–º –ø–∞–º—è—Ç–∏ manualClaimSelectedIds)
function renderClaimOrdersList(orders) {
    const listDiv = document.getElementById('claim-orders-list');
    
    if (orders.length === 0) {
        listDiv.innerHTML = `
            <div class="flex flex-col items-center justify-center p-10 text-gray-400">
                <span class="text-4xl mb-2">üéâ</span>
                <p>–ù–µ–≤–æ—Å—Ç—Ä–µ–±–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –Ω–µ—Ç.</p>
            </div>`;
        return;
    }

    listDiv.innerHTML = orders.map(o => {
        const datePart = o.party_date ? o.party_date.split('-').slice(1).reverse().join('.') : '‚Äî';
        const commentHtml = o.comment ? `<span class="text-xs bg-yellow-100 text-yellow-800 px-1.5 rounded ml-2 truncate max-w-[150px] inline-block align-bottom" title="${o.comment}">${o.comment}</span>` : '';
        
        // –ü–†–û–í–ï–†–Ø–ï–ú –ü–ê–ú–Ø–¢–¨
        const isChecked = manualClaimSelectedIds.has(o.id) ? 'checked' : '';
        
        return `
        <label class="grid grid-cols-12 gap-2 items-center p-3 hover:bg-indigo-50 cursor-pointer border-b transition-colors duration-150 group">
            <div class="col-span-1 text-center">
                <input type="checkbox" class="claim-checkbox w-5 h-5 text-green-600 rounded border-gray-300 focus:ring-green-500" 
                       value="${o.id}" ${isChecked}>
            </div>
            <div class="col-span-7 flex items-center flex-wrap">
                <span class="font-mono font-bold text-gray-700 text-md group-hover:text-indigo-700 transition-colors break-all">${o.track_code}</span>
                ${commentHtml}
            </div>
            <div class="col-span-4 text-right text-xs text-gray-400 font-mono">
                ${datePart}
            </div>
        </label>
    `}).join('');
}

// 7. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è (–ü–æ–∏—Å–∫ –ø–æ —Ç—Ä–µ–∫—É)
function filterClaimOrdersList(e) {
    const term = e.target.value.toLowerCase().trim();
    
    if (!term) {
        renderClaimOrdersList(unclaimedOrdersCache);
        return;
    }

    const filtered = unclaimedOrdersCache.filter(o => 
        o.track_code.toLowerCase().includes(term) || 
        (o.comment && o.comment.toLowerCase().includes(term))
    );
    renderClaimOrdersList(filtered);
    // –ü—Ä–∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–µ –≥–∞–ª–æ—á–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –±–ª–∞–≥–æ–¥–∞—Ä—è manualClaimSelectedIds
}

// 8. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–æ–∫ –∏ —Å—á–µ—Ç—á–∏–∫–æ–≤
function updateClaimButtonState() {
    const count = manualClaimSelectedIds.size;
    
    const topCounter = document.getElementById('claim-top-selected-count');
    if (topCounter) topCounter.textContent = count;
    
    const btn = document.getElementById('claim-submit-btn');
    const badge = document.getElementById('claim-btn-badge');
    
    if (btn) {
        btn.disabled = count === 0;
        if (count > 0) {
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
            if (badge) {
                badge.textContent = count;
                badge.classList.remove('hidden');
            }
        } else {
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            if (badge) badge.classList.add('hidden');
        }
    }
}

// 9. –õ–æ–≥–∏–∫–∞ —Å–º–µ–Ω—ã —Å—Ç–∞—Ç—É—Å–∞ (–ü–æ–∫–∞–∑–∞—Ç—å/–°–∫—Ä—ã—Ç—å —Ä–∞—Å—á–µ—Ç)
function handleClaimStatusChange(e) {
    const status = e.target.value;
    const panel = document.getElementById('claim-calculation-panel');
    const btnText = document.getElementById('claim-btn-text');

    if (status === '–ì–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ') {
        panel.classList.remove('hidden');
        btnText.textContent = '–†–ê–°–°–ß–ò–¢–ê–¢–¨ –ò –ü–†–ò–°–í–û–ò–¢–¨';
        // –§–æ–∫—É—Å –Ω–∞ –≤–µ—Å
        setTimeout(() => document.getElementById('claim-total-weight').focus(), 100);
    } else {
        panel.classList.add('hidden');
        btnText.textContent = '–ü–†–ò–°–í–û–ò–¢–¨';
    }
}

// 10. –ñ–∏–≤–æ–π –ø–µ—Ä–µ—Å—á–µ—Ç —Å—É–º–º—ã
function updateClaimCalculation() {
    const weight = parseFloat(document.getElementById('claim-total-weight').value) || 0;
    const price = parseFloat(document.getElementById('claim-price').value) || 0;
    const rate = parseFloat(document.getElementById('claim-rate').value) || 0;
    
    const sum = weight * price * rate;
    const sumDisplay = document.getElementById('claim-total-sum');
    if (sumDisplay) sumDisplay.textContent = sum.toFixed(0);
}

// 11. –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã (–ü—Ä–∏—Å–≤–æ–µ–Ω–∏–µ + –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç)
async function submitManualClaim() {
    const clientId = document.getElementById('claim-selected-client-id').value;
    const clientNameEl = document.getElementById('claim-client-name');
    const clientName = clientNameEl ? clientNameEl.textContent : '–ö–ª–∏–µ–Ω—Ç—É';
    
    // –ë–µ—Ä–µ–º ID –∏–∑ Set
    const orderIds = Array.from(manualClaimSelectedIds);
    
    const status = document.getElementById('claim-new-status').value;
    let calcData = {};

    if (!clientId || orderIds.length === 0) return;

    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞
    if (status === '–ì–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ') {
        const weight = parseFloat(document.getElementById('claim-total-weight').value);
        if (!weight || weight <= 0) {
            alert('‚ö†Ô∏è –î–ª—è —Å—Ç–∞—Ç—É—Å–∞ "–ì–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ" —É–∫–∞–∂–∏—Ç–µ –æ–±—â–∏–π –≤–µ—Å!');
            return;
        }
        calcData = {
            total_weight: weight,
            price_per_kg: parseFloat(document.getElementById('claim-price').value),
            exchange_rate: parseFloat(document.getElementById('claim-rate').value)
        };
    }

    if (!confirm(`üë§ –ü—Ä–∏—Å–≤–æ–∏—Ç—å ${orderIds.length} –∑–∞–∫–∞–∑–æ–≤ –∫–ª–∏–µ–Ω—Ç—É ${clientName}?\n–°—Ç–∞—Ç—É—Å: ${status}`)) return;

    showLoader();
    try {
        await apiFetch('/api/orders/bulk_action', {
            method: 'POST',
            body: JSON.stringify({
                action: 'assign_client',
                order_ids: orderIds,
                client_id: parseInt(clientId),
                new_status: status,
                ...calcData // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Ä–∞—Å—á–µ—Ç–∞, –µ—Å–ª–∏ –µ—Å—Ç—å
            })
        });

        alert(`‚úÖ –£—Å–ø–µ—à–Ω–æ!`);
        
        // –ú—è–≥–∫–∞—è –æ—á–∏—Å—Ç–∫–∞
        manualClaimSelectedIds.clear();
        document.getElementById('claim-order-search').value = '';
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–∞—Å—á–µ—Ç–Ω—ã–µ –ø–æ–ª—è
        document.getElementById('claim-total-weight').value = '';
        document.getElementById('claim-total-sum').textContent = '0';
        
        updateClaimButtonState();
        
        loadUnclaimedOrders(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ (—É–±–∏—Ä–∞–µ–º –ø—Ä–∏—Å–≤–æ–µ–Ω–Ω—ã–µ)
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ–Ω
        if (typeof fetchAndRenderOrders === 'function') fetchAndRenderOrders();

    } catch (e) {
        alert(`‚ùå –û—à–∏–±–∫–∞: ${e.message}`);
    } finally {
        hideLoader();
    }
}

// –§—É–Ω–∫—Ü–∏—è: –í—ã–±—Ä–∞—Ç—å –≤—Å–µ –∑–∞–∫–∞–∑—ã –≤–Ω—É—Ç—Ä–∏ –≥—Ä—É–ø–ø—ã –∫–ª–∏–µ–Ω—Ç–∞
function toggleClientGroupSelection(headerCheckbox, groupId) {
    const groupDiv = document.getElementById(groupId);
    const checkboxes = groupDiv.querySelectorAll('.order-checkbox');
    
    checkboxes.forEach(cb => {
        cb.checked = headerCheckbox.checked;
    });
    
    updateBulkActionBar(); // –û–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ "–í—ã–±—Ä–∞–Ω–æ: X"
}

// –ï–î–ò–ù–°–¢–í–ï–ù–ù–ê–Ø –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø (–í—Å—Ç–∞–≤—å—Ç–µ –µ—ë –≤–º–µ—Å—Ç–æ —Å—Ç–∞—Ä—ã—Ö)
function toggleOrdersSelectMode(arg) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç: 
    // –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω–æ true (—Å—Ç—Ä–æ–≥–æ –±—É–ª–µ–≤–æ) -> –º—ã –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–ª–µ –ø–æ–∏—Å–∫–∞).
    // –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω–æ –°–æ–±—ã—Ç–∏–µ (–∫–ª–∏–∫) –∏–ª–∏ undefined -> –º—ã –ü–ï–†–ï–ö–õ–Æ–ß–ê–ï–ú —Ä–µ–∂–∏–º.
    const justUpdateVisibility = (arg === true); 

    const checkboxes = document.querySelectorAll('.order-checkbox');
    const groupCheckboxes = document.querySelectorAll('.client-group-checkbox');
    const selectAllContainer = document.getElementById('orders-select-all-container');
    
    let isSelectMode = false;
    
    if (justUpdateVisibility) {
        // –õ–û–ì–ò–ö–ê –û–ë–ù–û–í–õ–ï–ù–ò–Ø (–°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ)
        const actionBar = document.getElementById('orders-bulk-action-bar');
        // –†–µ–∂–∏–º –≤–∫–ª—é—á–µ–Ω, –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞ –ø–∞–Ω–µ–ª—å –¥–µ–π—Å—Ç–≤–∏–π –ò–õ–ò –µ—Å–ª–∏ –≤–∏–¥–µ–Ω –ø–µ—Ä–≤—ã–π —á–µ–∫–±–æ–∫—Å
        isSelectMode = (actionBar && !actionBar.classList.contains('hidden')) || 
                       (checkboxes.length > 0 && !checkboxes[0].classList.contains('hidden'));
    } else {
        // –õ–û–ì–ò–ö–ê –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–Ø (–ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ)
        if (checkboxes.length > 0) {
            // –ï—Å–ª–∏ —Å–µ–π—á–∞—Å —Å–∫—Ä—ã—Ç–æ -> –í–∫–ª—é—á–∞–µ–º. –ï—Å–ª–∏ –≤–∏–¥–Ω–æ -> –í—ã–∫–ª—é—á–∞–µ–º.
            isSelectMode = checkboxes[0].classList.contains('hidden'); 
        } else {
            // –ï—Å–ª–∏ —Å–ø–∏—Å–∫–∞ –Ω–µ—Ç, –ø—Ä–æ—Å—Ç–æ –≤–∏–∑—É–∞–ª—å–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É
            const btn = document.getElementById('orders-toggle-select-mode-btn');
            if(btn) btn.classList.toggle('bg-indigo-100'); 
            return; 
        }
    }

    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ –≤—Å–µ–º —ç–ª–µ–º–µ–Ω—Ç–∞–º
    const action = isSelectMode ? 'remove' : 'add';
    
    checkboxes.forEach(cb => cb.classList[action]('hidden'));
    groupCheckboxes.forEach(cb => cb.classList[action]('hidden')); // –ì—Ä—É–ø–ø–æ–≤—ã–µ –≥–∞–ª–æ—á–∫–∏ —Ç–æ–∂–µ
    
    if (selectAllContainer) {
        selectAllContainer.classList[action]('hidden');
    }

    // –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø
    if (isSelectMode && !justUpdateVisibility) {
        // –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ —á—Ç–æ –í–ö–õ–Æ–ß–ò–õ–ò —Ä–µ–∂–∏–º -> –∑–∞–ø–æ–ª–Ω—è–µ–º —Å–µ–ª–µ–∫—Ç —Å—Ç–∞—Ç—É—Å–æ–≤ (–∫–æ–¥ –∏–∑ —Å—Ç–∞—Ä–æ–π —Ñ—É–Ω–∫—Ü–∏–∏)
        console.log("[Bulk Actions] Select mode ON.");
        const bulkStatusSelect = document.getElementById('orders-bulk-status-select');
        if (bulkStatusSelect && bulkStatusSelect.options.length <= 1 && typeof orderStatuses !== 'undefined') {
             bulkStatusSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å --</option>' + 
                                          orderStatuses.map(s => `<option value="${s}">${s}</option>`).join('');
        }
        updateBulkActionBar();
        updateSelectAllCheckboxState();
    } 
    else if (!isSelectMode && !justUpdateVisibility) {
        // –ï—Å–ª–∏ –í–´–ö–õ–Æ–ß–ò–õ–ò —Ä–µ–∂–∏–º -> —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
        console.log("[Bulk Actions] Select mode OFF.");
        hideBulkActionBar();
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ –≤–∏–¥–∏–º—ã–µ"
// (–ó–ê–ú–ï–ù–ò —Å—Ç–∞—Ä—É—é handleOrdersSelectAll –Ω–∞ —ç—Ç—É)
function handleOrdersSelectAll(e) {
    const isChecked = e.target.checked;
    
    // 1. –û—Ç–º–µ—á–∞–µ–º –∑–∞–∫–∞–∑—ã
    document.querySelectorAll('#orders-list-container .order-list-item:not([style*="display: none"]) .order-checkbox').forEach(cb => {
        cb.checked = isChecked;
    });
    
    // 2. –û—Ç–º–µ—á–∞–µ–º –≥—Ä—É–ø–ø–æ–≤—ã–µ –≥–∞–ª–æ—á–∫–∏ (–¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã)
    document.querySelectorAll('.client-group-checkbox').forEach(cb => {
        // –ï—Å–ª–∏ –≥—Ä—É–ø–ø–∞ –≤–∏–¥–Ω–∞ - –æ—Ç–º–µ—á–∞–µ–º
        if (cb.offsetParent !== null) { 
            cb.checked = isChecked;
        }
    });

    updateBulkActionBar();
}

async function fetchAndRenderDebtors() {
    const listDiv = document.getElementById('debtors-list');
    listDiv.innerHTML = '<p class="text-gray-500 text-center mt-10 animate-pulse">–ü–æ–∏—Å–∫ –¥–æ–ª–∂–Ω–∏–∫–æ–≤...</p>';

    try {
        // 1. –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ–ª–∂–Ω–∏–∫–æ–≤ (—Å –±–∞–ª–∞–Ω—Å–æ–º)
        const debtors = await apiFetch('/api/debtors');
        
        if (!debtors || debtors.length === 0) {
            listDiv.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-gray-400">
                    <span class="text-4xl mb-2">‚úÖ</span>
                    <p>–î–æ–ª–∂–Ω–∏–∫–æ–≤ –Ω–µ—Ç! –û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞.</p>
                </div>`;
            return;
        }

        // 2. –†–µ–Ω–¥–µ—Ä–∏–º —Å–ø–∏—Å–æ–∫ (–ê–∫–∫–æ—Ä–¥–µ–æ–Ω)
        listDiv.innerHTML = debtors.map(d => {
            const client = d.client;
            const balance = d.balance; // –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ
            const clientCode = `${client.client_code_prefix}${client.client_code_num}`;

            return `
                <div class="debtor-card border border-red-200 rounded-lg bg-white shadow-sm overflow-hidden mb-2"
                     data-client-id="${client.id}" data-name="${client.full_name.toLowerCase()}">
                    
                    <div class="p-4 flex justify-between items-center cursor-pointer hover:bg-red-50 transition-colors"
                         onclick="toggleDebtorDetails(${client.id})">
                        
                        <div class="flex items-center gap-3">
                            <div class="bg-red-100 text-red-600 rounded-full p-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-800">${client.full_name} <span class="text-gray-500 font-normal">(${clientCode})</span></h4>
                                <p class="text-xs text-gray-500">${client.phone}</p>
                            </div>
                        </div>

                        <div class="text-right">
                            <p class="text-red-600 font-bold text-lg">${balance.toFixed(0)} —Å.</p>
                            <p class="text-xs text-gray-400">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å ‚ñº</p>
                        </div>
                    </div>

                    <div id="debtor-details-${client.id}" class="hidden bg-gray-50 border-t border-red-100 p-4">
                        <div class="text-center py-4 text-gray-500 italic loading-details">–ó–∞–≥—Ä—É–∑–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–π...</div>
                        <div class="details-content hidden"></div>
                    </div>
                </div>
            `;
        }).join('');

    } catch (e) {
        console.error(e);
        listDiv.innerHTML = `<p class="text-red-500 text-center mt-10">–û—à–∏–±–∫–∞: ${e.message}</p>`;
    }
}

async function toggleDebtorDetails(clientId) {
    const detailsDiv = document.getElementById(`debtor-details-${clientId}`);
    if (!detailsDiv) return;

    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å
    if (!detailsDiv.classList.contains('hidden')) {
        detailsDiv.classList.add('hidden');
        return;
    }
    detailsDiv.classList.remove('hidden');

    // –ï—Å–ª–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ - –Ω–µ –≥—Ä—É–∑–∏–º —Å–Ω–æ–≤–∞
    const contentDiv = detailsDiv.querySelector('.details-content');
    if (contentDiv.innerHTML.trim() !== "") {
        contentDiv.classList.remove('hidden');
        return;
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    try {
        const transactions = await apiFetch(`/api/clients/${clientId}/transactions`);
        const loader = detailsDiv.querySelector('.loading-details');
        if (loader) loader.classList.add('hidden');
        contentDiv.classList.remove('hidden');

        if (!transactions || transactions.length === 0) {
            contentDiv.innerHTML = '<p class="text-sm text-gray-500">–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π –ø—É—Å—Ç–∞.</p>';
            return;
        }

        // --- –ì–†–£–ü–ü–ò–†–û–í–ö–ê (–í—ã–∫—É–ø vs –î–æ—Å—Ç–∞–≤–∫–∞) ---
        const buyouts = transactions.filter(t => t.transaction_type === 'buyout');
        const deliveries = transactions.filter(t => t.transaction_type === 'delivery');
        const payments = transactions.filter(t => t.transaction_type === 'payment');

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –¥–ª—è –±–ª–æ–∫–æ–≤
        let html = '';

        // –ë–ª–æ–∫ –í–´–ö–£–ü
        if (buyouts.length > 0) {
            html += renderDebtBlock('üõçÔ∏è –í—ã–∫—É–ø (–¢–æ–≤–∞—Ä—ã)', buyouts, 'red');
        }

        // –ë–ª–æ–∫ –î–û–°–¢–ê–í–ö–ê
        if (deliveries.length > 0) {
            html += renderDebtBlock('üöö –î–æ—Å—Ç–∞–≤–∫–∞ (–£—Å–ª—É–≥–∏)', deliveries, 'blue');
        }
        
        // –ò—Å—Ç–æ—Ä–∏—è –û–ø–ª–∞—Ç (—Å–≤–µ—Ä–Ω—É—Ç–∞—è –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ —Å–ø–∏—Å–æ–∫)
        if (payments.length > 0) {
             html += `
                <div class="mt-4">
                    <p class="text-xs font-bold text-green-600 uppercase mb-1">–ò—Å—Ç–æ—Ä–∏—è –æ–ø–ª–∞—Ç:</p>
                    <div class="text-xs text-gray-500 bg-green-50 p-2 rounded">
                        ${payments.slice(0, 5).map(p => `<div>+${p.amount} —Å. (${new Date(p.created_at).toLocaleDateString()})</div>`).join('')}
                        ${payments.length > 5 ? `<div>... –∏ –µ—â–µ ${payments.length - 5}</div>` : ''}
                    </div>
                </div>
             `;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω–∞—è —Å–º–µ–Ω–∞? (–ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é activeShift)
        const hasShift = (typeof activeShift !== 'undefined' && activeShift !== null);
        const shiftCheckboxState = hasShift ? 'checked' : 'disabled';
        const shiftLabelClass = hasShift ? 'text-gray-700' : 'text-gray-400 line-through';
        const shiftTitle = hasShift ? '–î–µ–Ω—å–≥–∏ –ø–æ–ø–∞–¥—É—Ç –≤ –æ—Ç—á–µ—Ç —Ç–µ–∫—É—â–µ–π —Å–º–µ–Ω—ã' : '–°–º–µ–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∞. –î–µ–Ω—å–≥–∏ –ø–æ–π–¥—É—Ç –Ω–∞ –æ–±—â–∏–π –±–∞–ª–∞–Ω—Å.';

        html += `
            <div class="mt-4 pt-3 border-t bg-gray-100 p-3 rounded-b-lg">
                <div class="flex flex-wrap items-end gap-3 justify-end">
                    
                    <div class="flex flex-col">
                        <label class="text-xs text-gray-500 mb-1">–ú–µ—Ç–æ–¥:</label>
                        <select id="repay-method-${clientId}" class="border rounded p-2 text-sm bg-white w-32">
                            <option value="cash">üíµ –ù–∞–ª–∏—á–Ω—ã–µ</option>
                            <option value="card">üí≥ –ö–∞—Ä—Ç–∞/MBank</option>
                        </select>
                    </div>

                    <div class="flex flex-col">
                        <label class="text-xs text-gray-500 mb-1">–°—É–º–º–∞:</label>
                        <input type="number" id="repay-amount-${clientId}" placeholder="0" class="border rounded p-2 w-32 text-sm font-bold">
                    </div>

                    <button class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 font-bold text-sm repay-btn h-[38px]" 
                            data-client-id="${clientId}">
                        –í–Ω–µ—Å—Ç–∏
                    </button>
                </div>
                
                <div class="mt-2 flex justify-end">
                    <label class="flex items-center cursor-pointer" title="${shiftTitle}">
                        <input type="checkbox" id="repay-shift-link-${clientId}" class="h-4 w-4 text-green-600 rounded border-gray-300 focus:ring-green-500" ${shiftCheckboxState}>
                        <span class="ml-2 text-xs ${shiftLabelClass}">–í –∫–∞—Å—Å—É —Å–º–µ–Ω—ã? ${!hasShift ? '(–°–º–µ–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∞)' : ''}</span>
                    </label>
                </div>
            </div>
        `;

        contentDiv.innerHTML = html;

    } catch (e) {
        detailsDiv.innerHTML = `<p class="text-red-500 text-sm">–û—à–∏–±–∫–∞: ${e.message}</p>`;
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è: –†–µ–Ω–¥–µ—Ä –±–ª–æ–∫–∞ (—Ç–∞–±–ª–∏—Ü—ã) —Å –ê–ö–ö–û–†–î–ï–û–ù–û–ú
function renderDebtBlock(title, items, color) {
    const colorClass = color === 'red' ? 'text-red-700 bg-red-50 border-red-100' : 'text-blue-700 bg-blue-50 border-blue-100';
    
    const rows = items.map(t => {
        const dateStr = new Date(t.created_at).toLocaleDateString();
        const amountStr = t.amount.toFixed(0);
        const hasDetails = t.details && t.details.length > 0;
        const cursorClass = hasDetails ? 'cursor-pointer hover:bg-gray-50' : '';
        const detailsId = `trx-details-${t.id}`;
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –¥–µ—Ç–∞–ª–µ–π (–µ—Å–ª–∏ –µ—Å—Ç—å)
        let detailsHtml = '';
        if (hasDetails) {
            const listItems = t.details.map(d => {
                // –†–∞–∑–Ω—ã–π –≤–∏–¥ –¥–ª—è –í—ã–∫—É–ø–∞ –∏ –î–æ—Å—Ç–∞–≤–∫–∏
                if (t.transaction_type === 'buyout') {
                    return `
                        <div class="flex justify-between text-xs py-1 border-b border-gray-100 last:border-0">
                            <span>üì¶ <b>${d.track}</b> <span class="text-gray-500 italic">(${d.comm})</span></span>
                            <span>${d.cny || '?'} ¬•</span>
                        </div>`;
                } else { // delivery
                    const cost = d.cost ? parseFloat(d.cost).toFixed(0) : '?';
                    const weight = d.weight ? parseFloat(d.weight).toFixed(2) : '?';
                    return `
                        <div class="flex justify-between text-xs py-1 border-b border-gray-100 last:border-0">
                            <span>üöö <b>${d.track}</b> <span class="text-gray-500 italic">(${d.comm})</span></span>
                            <span>${weight} –∫–≥ / ${cost} —Å.</span>
                        </div>`;
                }
            }).join('');
            
            detailsHtml = `
                <tr id="${detailsId}" class="hidden bg-gray-50">
                    <td colspan="3" class="p-2">
                        <div class="pl-4 border-l-2 border-${color}-300 text-gray-600">
                            ${listItems}
                        </div>
                    </td>
                </tr>
            `;
        }

        // –°—Ç—Ä–æ–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
        return `
            <tr class="border-b last:border-0 text-sm transition-colors ${cursorClass}" 
                ${hasDetails ? `onclick="document.getElementById('${detailsId}').classList.toggle('hidden')"` : ''}>
                
                <td class="p-2 text-gray-500 whitespace-nowrap align-top">
                    ${hasDetails ? '<span class="mr-1 text-xs">‚ñº</span>' : ''}
                    ${dateStr}
                </td>
                <td class="p-2 font-medium text-gray-800 align-top">${t.description || '‚Äî'}</td>
                <td class="p-2 text-right font-bold ${color === 'red' ? 'text-red-600' : 'text-blue-600'} align-top">
                    ${amountStr} —Å.
                </td>
            </tr>
            ${detailsHtml}
        `;
    }).join('');

    return `
        <div class="mb-3 border rounded-lg overflow-hidden ${colorClass}">
            <div class="px-3 py-2 font-bold text-xs uppercase tracking-wider opacity-80 border-b border-${color}-200">${title}</div>
            <table class="w-full bg-white">
                ${rows}
            </table>
        </div>
    `;
}

async function handleDebtorActions(e) {
    if (e.target.classList.contains('repay-btn')) {
        const clientId = e.target.dataset.clientId;
        const input = document.getElementById(`repay-amount-${clientId}`);
        const methodSelect = document.getElementById(`repay-method-${clientId}`);
        const shiftCheckbox = document.getElementById(`repay-shift-link-${clientId}`);
        
        const amount = parseFloat(input.value);
        const method = methodSelect.value;
        const linkToShift = shiftCheckbox.checked;

        if (!amount || amount <= 0) {
            alert("–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –±–æ–ª—å—à–µ 0.");
            return;
        }

        const methodText = method === 'cash' ? '–ù–∞–ª–∏—á–Ω—ã–º–∏' : '–ö–∞—Ä—Ç–æ–π';
        const shiftText = linkToShift ? '–í –ö–ê–°–°–£ —Å–º–µ–Ω—ã' : '–ú–ò–ú–û –∫–∞—Å—Å—ã (–Ω–∞ –±–∞–ª–∞–Ω—Å)';

        if (!confirm(`–ü—Ä–∏–Ω—è—Ç—å –æ–ø–ª–∞—Ç—É ${amount} —Å–æ–º (${methodText})?\n\n–ö—É–¥–∞: ${shiftText}`)) return;

        showLoader();
        try {
            await apiFetch('/api/debtors/repay', {
                method: 'POST',
                body: JSON.stringify({
                    client_id: parseInt(clientId),
                    amount: amount,
                    description: "–ü–æ–≥–∞—à–µ–Ω–∏–µ –¥–æ–ª–≥–∞ —á–µ—Ä–µ–∑ –ê–¥–º–∏–Ω–∫—É",
                    payment_method: method,      // <-- –ù–æ–≤–æ–µ
                    link_to_shift: linkToShift   // <-- –ù–æ–≤–æ–µ
                })
            });
            alert("–û–ø–ª–∞—Ç–∞ –ø—Ä–∏–Ω—è—Ç–∞!");
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
            fetchAndRenderDebtors();
            
        } catch (e) {
            alert(`–û—à–∏–±–∫–∞: ${e.message}`);
        } finally {
            hideLoader();
        }
    }
}

// –ü–æ–∏—Å–∫ –ø–æ —Å–ø–∏—Å–∫—É –¥–æ–ª–∂–Ω–∏–∫–æ–≤ (–ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä)
function handleDebtorsSearch(e) {
    const term = e.target.value.toLowerCase();
    document.querySelectorAll('.debtor-card').forEach(card => {
        const name = card.dataset.name || '';
        if (name.includes(term)) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}

// ==========================================
// –ú–û–î–£–õ–¨: –ö–û–†–ó–ò–ù–ê –í–´–ö–£–ü–ê (JS)
// ==========================================

let buyoutCartData = []; // [{client, orders: [], paid: 0}, ...]

// 2. –ü–æ–∏—Å–∫ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞
document.getElementById('buyout-cart-search')?.addEventListener('input', (e) => {
    handleGenericClientSearch(e.target, document.getElementById('buyout-cart-search-results'), async (client) => {
        // –ü—Ä–∏ –≤—ã–±–æ—Ä–µ –∫–ª–∏–µ–Ω—Ç–∞
        document.getElementById('buyout-cart-search').value = '';
        document.getElementById('buyout-cart-search-results').classList.add('hidden');
        await addClientToBuyoutCart(client);
    });
});

// 3. –õ–æ–≥–∏–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
async function addClientToBuyoutCart(client) {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç –≤ –∫–æ—Ä–∑–∏–Ω–µ
    if (buyoutCartData.find(item => item.client.id === client.id)) {
        alert("–≠—Ç–æ—Ç –∫–ª–∏–µ–Ω—Ç —É–∂–µ –≤ –∫–æ—Ä–∑–∏–Ω–µ!");
        return;
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–∫–∞–∑—ã "–û–∂–∏–¥–∞–µ—Ç –≤—ã–∫—É–ø–∞"
    try {
        const params = new URLSearchParams({
            client_id: client.id,
            statuses: "–û–∂–∏–¥–∞–µ—Ç –≤—ã–∫—É–ø–∞",
            company_id: currentCompany.id, // –í–ª–∞–¥–µ–ª–µ—Ü —Ç–æ–ª—å–∫–æ —Å–≤–æ–µ–π –∫–æ–º–ø–∞–Ω–∏–∏
            limit: 100
        });
        const orders = await apiFetch(`/api/orders?${params.toString()}`);
        
        if (!orders || orders.length === 0) {
            alert(`–£ –∫–ª–∏–µ–Ω—Ç–∞ ${client.full_name} –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º '–û–∂–∏–¥–∞–µ—Ç –≤—ã–∫—É–ø–∞'.`);
            return;
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –º–∞—Å—Å–∏–≤
        buyoutCartData.push({
            client: client,
            orders: orders,
            paid: 0 // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 0
        });
        
        renderBuyoutCartTable();

    } catch (e) {
        console.error(e);
        alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤ –∫–ª–∏–µ–Ω—Ç–∞.");
    }
}

function renderBuyoutCartTable() {
    const tbody = document.getElementById('buyout-cart-table-body');
    const emptyMsg = document.getElementById('buyout-cart-empty-msg');
    const rate = parseFloat(document.getElementById('buyout-cart-rate').value) || 0;
    
    tbody.innerHTML = '';
    
    if (buyoutCartData.length === 0) {
        emptyMsg.classList.remove('hidden');
        updateBuyoutTotals(0, 0);
        return;
    }
    emptyMsg.classList.add('hidden');

    buyoutCartData.forEach((item, index) => {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ–ª–∞–≥ included (–µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç), –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é true
        item.orders.forEach(o => { if(typeof o.is_included === 'undefined') o.is_included = true; });

        // 1. –°—á–∏—Ç–∞–µ–º (—Ç–æ–ª—å–∫–æ –≤–∫–ª—é—á–µ–Ω–Ω—ã–µ!)
        let totalCny = 0;
        let activeOrdersCount = 0;
        
        item.orders.forEach(o => {
            if (o.is_included) {
                const cost = o.buyout_item_cost_cny || 0;
                const comm = o.buyout_commission_percent || 0;
                totalCny += cost * (1 + comm / 100);
                activeOrdersCount++;
            }
        });
        
        const totalSom = Math.ceil(totalCny * rate);
        const debt = totalSom - item.paid;
        const debtColor = debt > 0 ? 'text-red-600' : 'text-green-600';

        // 2. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML (–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ + –°—Ç—Ä–æ–∫–∞ –¥–µ—Ç–∞–ª–µ–π)
        // –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–æ–∫–∞
        const trMain = document.createElement('tr');
        trMain.className = "border-b hover:bg-gray-50 main-row";
        trMain.innerHTML = `
            <td class="p-3">
                <button class="mr-2 text-gray-500 hover:text-purple-600 transition-transform transform duration-200 toggle-details-btn" data-index="${index}">
                    ‚ñº
                </button>
                <span class="font-bold">${item.client.full_name}</span>
            </td>
            <td class="p-3 text-center font-bold text-blue-600" id="cart-row-count-${index}">${activeOrdersCount}</td>
            <td class="p-3 text-right font-mono" id="cart-row-cny-${index}">${totalCny.toFixed(2)} ¬•</td>
            <td class="p-3 text-right font-bold" id="cart-row-som-${index}">${totalSom} —Å.</td>
            <td class="p-3 text-center">
                <div class="flex items-center justify-center gap-1">
                    <input type="number" class="border rounded p-1 w-24 text-center paid-input" data-index="${index}" value="${item.paid > 0 ? item.paid : ''}" placeholder="0">
                    <button class="text-xs bg-gray-200 px-2 py-1 rounded hover:bg-gray-300 set-full-btn" data-index="${index}">–í—Å–µ</button>
                </div>
            </td>
            <td id="cart-row-debt-${index}" class="p-3 text-right font-bold ${debtColor}">${debt > 0 ? '-' + debt : '0'} —Å.</td>
            <td class="p-3 text-center">
                <button class="text-red-500 hover:text-red-700 remove-row-btn" data-index="${index}">&times;</button>
            </td>
        `;
        tbody.appendChild(trMain);

        // –°—Ç—Ä–æ–∫–∞ –¥–µ—Ç–∞–ª–µ–π (–ê–∫–∫–æ—Ä–¥–µ–æ–Ω) - –°–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        const trDetails = document.createElement('tr');
        trDetails.id = `details-row-${index}`;
        trDetails.className = "order-details-row hidden";
        
        let ordersListHtml = item.orders.map((o, orderIdx) => `
            <div class="order-sub-item">
                <input type="checkbox" class="sub-item-checkbox mr-3 h-4 w-4 text-purple-600 rounded border-gray-300 focus:ring-purple-500" 
                       data-client-index="${index}" 
                       data-order-idx="${orderIdx}"
                       ${o.is_included ? 'checked' : ''}>
                
                <div class="flex-grow grid grid-cols-12 gap-2">
                    <div class="col-span-4 font-mono text-xs text-gray-600 break-all">${o.track_code}</div>
                    <div class="col-span-4 text-xs italic text-gray-500 truncate">${o.comment || '-'}</div>
                    <div class="col-span-2 text-xs text-right">${o.buyout_item_cost_cny || 0} ¬•</div>
                    <div class="col-span-2 text-xs text-right text-gray-400">${o.buyout_commission_percent}%</div>
                </div>
            </div>
        `).join('');

        trDetails.innerHTML = `
            <td colspan="7" class="p-0">
                <div class="order-sub-list border-l-4 border-purple-200 ml-4">
                    ${ordersListHtml}
                </div>
            </td>
        `;
        tbody.appendChild(trDetails);
    });

    recalculateFooter();
    setupBuyoutTableListeners(); // –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º –≤—Å–µ —Å–ª—É—à–∞—Ç–µ–ª–∏
}

// --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –ü–ï–†–ï–°–ß–ï–¢–ê ---

function recalculateSingleRow(index) {
    const item = buyoutCartData[index];
    const rate = parseFloat(document.getElementById('buyout-cart-rate').value) || 0;
    
    // –°—á–∏—Ç–∞–µ–º –¢–û–õ–¨–ö–û –≤–∫–ª—é—á–µ–Ω–Ω—ã–µ (is_included = true)
    let totalCny = 0;
    let activeCount = 0;

    item.orders.forEach(o => {
        if (o.is_included) { // <--- –í–ê–ñ–ù–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï
            const cost = o.buyout_item_cost_cny || 0;
            const comm = o.buyout_commission_percent || 0;
            totalCny += cost * (1 + comm / 100);
            activeCount++;
        }
    });

    const totalSom = Math.ceil(totalCny * rate);
    const debt = totalSom - item.paid;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —è—á–µ–π–∫–∏ –≤ DOM
    const countCell = document.getElementById(`cart-row-count-${index}`);
    const cnyCell = document.getElementById(`cart-row-cny-${index}`);
    const somCell = document.getElementById(`cart-row-som-${index}`);
    const debtCell = document.getElementById(`cart-row-debt-${index}`);

    if(countCell) countCell.textContent = activeCount;
    if(cnyCell) cnyCell.textContent = `${totalCny.toFixed(2)} ¬•`;
    if(somCell) somCell.textContent = `${totalSom} —Å.`;

    if (debtCell) {
        debtCell.textContent = debt > 0 ? `-${debt} —Å.` : '0 —Å.';
        if (debt > 0) {
            debtCell.classList.remove('text-green-600');
            debtCell.classList.add('text-red-600');
        } else {
            debtCell.classList.remove('text-red-600');
            debtCell.classList.add('text-green-600');
        }
    }
}

function recalculateFooter() {
    const rate = parseFloat(document.getElementById('buyout-cart-rate').value) || 0;
    let grandTotalSom = 0;
    let totalOrders = 0;

    buyoutCartData.forEach(item => {
        let totalCny = 0;
        item.orders.forEach(o => {
            const cost = o.buyout_item_cost_cny || 0;
            const comm = o.buyout_commission_percent || 0;
            totalCny += cost * (1 + comm / 100);
        });
        grandTotalSom += Math.ceil(totalCny * rate);
        totalOrders += item.orders.length;
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥–≤–∞–ª (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é updateBuyoutTotals)
    updateBuyoutTotals(buyoutCartData.length, totalOrders, grandTotalSom);
}

// --- –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –°–õ–£–®–ê–¢–ï–õ–ï–ô (–ë–µ–∑ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏) ---
function setupBuyoutTableListeners() {
    // 1. –ò–∑–º–µ–Ω–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã (–ñ–∏–≤–æ–π –ø–µ—Ä–µ—Å—á–µ—Ç)
    document.querySelectorAll('.paid-input').forEach(input => {
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Å–ª—É—à–∞—Ç–µ–ª–∏ —á–µ—Ä–µ–∑ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, —á—Ç–æ–±—ã –Ω–µ –¥–≤–æ–∏–ª–∏—Å—å
        const newInput = input.cloneNode(true);
        input.parentNode.replaceChild(newInput, input);

        newInput.addEventListener('input', (e) => {
            const idx = parseInt(e.target.dataset.index);
            const val = parseFloat(e.target.value); // –ú–æ–∂–µ—Ç –±—ã—Ç—å NaN, –µ—Å–ª–∏ –ø—É—Å—Ç–æ
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –ø–∞–º—è—Ç–∏
            buyoutCartData[idx].paid = isNaN(val) ? 0 : val;

            // --- –¢–û–ß–ï–ß–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï (–ë–ï–ó –ü–ï–†–ï–†–ò–°–û–í–ö–ò) ---
            recalculateSingleRow(idx);
            recalculateFooter();
        });
    });

    // 2. –ö–Ω–æ–ø–∫–∞ "–í—Å–µ"
    document.querySelectorAll('.set-full-btn').forEach(btn => {
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);

        newBtn.addEventListener('click', (e) => {
            const idx = parseInt(e.target.dataset.index);
            const amount = parseFloat(e.target.dataset.amount);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
            buyoutCartData[idx].paid = amount;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–ø—É—Ç –≤–∏–∑—É–∞–ª—å–Ω–æ
            const inputField = document.querySelector(`.paid-input[data-index="${idx}"]`);
            if (inputField) inputField.value = amount;

            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º
            recalculateSingleRow(idx);
            recalculateFooter();
        });
    });

    // 3. –£–¥–∞–ª–µ–Ω–∏–µ (–¢—É—Ç –Ω—É–∂–Ω–∞ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞, —Ç–∞–∫ –∫–∞–∫ —Å—Ç—Ä–æ–∫–∞ –∏—Å—á–µ–∑–∞–µ—Ç)
    document.querySelectorAll('.remove-row-btn').forEach(btn => {
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);

        newBtn.addEventListener('click', (e) => {
            const idx = parseInt(e.target.dataset.index);
            buyoutCartData.splice(idx, 1);
            renderBuyoutCartTable(); // –¢—É—Ç –ø–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ –Ω—É–∂–Ω–∞
        });
    });

    // 4. –ê–∫–∫–æ—Ä–¥–µ–æ–Ω (–°—Ç—Ä–µ–ª–∫–∞)
    document.querySelectorAll('.toggle-details-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const idx = e.target.dataset.index;
            const detailsRow = document.getElementById(`details-row-${idx}`);
            const arrow = e.target;
            
            if (detailsRow.classList.contains('hidden')) {
                detailsRow.classList.remove('hidden');
                arrow.style.transform = "rotate(180deg)";
            } else {
                detailsRow.classList.add('hidden');
                arrow.style.transform = "rotate(0deg)";
            }
        });
    });

    // 5. –ì–∞–ª–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ (–í–∫–ª/–í—ã–∫–ª)
    document.querySelectorAll('.sub-item-checkbox').forEach(cb => {
        cb.addEventListener('change', (e) => {
            const clientIdx = parseInt(e.target.dataset.clientIndex);
            const orderIdx = parseInt(e.target.dataset.orderIdx);
            const isChecked = e.target.checked;

            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –ø–∞–º—è—Ç–∏
            buyoutCartData[clientIdx].orders[orderIdx].is_included = isChecked;

            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É –∏ –ø–æ–¥–≤–∞–ª
            recalculateSingleRow(clientIdx);
            recalculateFooter();
        });
    });
}


// –ü–µ—Ä–µ—Å—á–µ—Ç –ø—Ä–∏ —Å–º–µ–Ω–µ –∫—É—Ä—Å–∞
document.getElementById('buyout-cart-rate')?.addEventListener('input', renderBuyoutCartTable);

function updateBuyoutTotals(clients, orders, sum = 0) {
    document.getElementById('buyout-cart-client-count').textContent = clients;
    document.getElementById('buyout-cart-order-count').textContent = orders;
    document.getElementById('buyout-cart-total-sum').textContent = sum.toLocaleString() + ' —Å.';
    document.getElementById('buyout-cart-submit-btn').disabled = clients === 0;
}

// 5. –û—Ç–ø—Ä–∞–≤–∫–∞ (–í–´–ö–£–ü–ò–¢–¨ –í–°–ï–•)
document.getElementById('buyout-cart-submit-btn')?.addEventListener('click', async () => {
    const rate = parseFloat(document.getElementById('buyout-cart-rate').value);
    if (!rate || rate <= 0) { alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∫—É—Ä—Å!"); return; }

    if (!confirm(`–í—ã–∫—É–ø–∏—Ç—å –∑–∞–∫–∞–∑—ã –¥–ª—è ${buyoutCartData.length} –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ –∫—É—Ä—Å—É ${rate}?`)) return;

    const payload = {
        exchange_rate: rate,
        items: buyoutCartData.map(d => ({
            client_id: d.client.id,
            paid_amount: d.paid,
            order_ids: d.orders.map(o => o.id),
            order_ids: d.orders.filter(o => o.is_included).map(o => o.id)
        })).filter(item => item.order_ids.length > 0) // –£–±–∏—Ä–∞–µ–º –∫–ª–∏–µ–Ω—Ç–æ–≤ –±–µ–∑ –∑–∞–∫–∞–∑–æ–≤
    };

    showLoader();
    try {
        const res = await apiFetch('/api/orders/buyout_cart', {
            method: 'POST',
            body: JSON.stringify(payload)
        });
        alert(res.message);
        closeModal('buyout-cart-modal');
        if (typeof fetchAndRenderOrders === 'function') fetchAndRenderOrders();
    } catch (e) {
        alert("–û—à–∏–±–∫–∞: " + e.message);
    } finally {
        hideLoader();
    }
});

// --- –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –û–¢–ö–†–´–¢–ò–Ø –ú–û–î–ê–õ–û–ö ---

function handleOpenBuyoutCart() {
    console.log("–û—Ç–∫—Ä—ã–≤–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É –≤—ã–∫—É–ø–∞...");
    buyoutCartData = []; // –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    renderBuyoutCartTable();
    
    // –°—Ç–∞–≤–∏–º –∫—É—Ä—Å –∏–∑ –∞–∫—Ç–∏–≤–Ω–æ–π —Å–º–µ–Ω—ã –∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç
    const rateInput = document.getElementById('buyout-cart-rate');
    if (rateInput) {
        if (activeShift && activeShift.exchange_rate_usd) {
            rateInput.value = activeShift.exchange_rate_usd;
        } else {
            rateInput.value = 12.8; // –î–µ—Ñ–æ–ª—Ç
        }
    }
    
    openModal('buyout-cart-modal');
    // –§–æ–∫—É—Å –Ω–∞ –ø–æ–∏—Å–∫–µ —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
    setTimeout(() => document.getElementById('buyout-cart-search')?.focus(), 100);
}

function handleOpenMassTracks() {
    console.log("–û—Ç–∫—Ä—ã–≤–∞–µ–º –º–∞—Å—Å–æ–≤—ã–µ —Ç—Ä–µ–∫–∏...");
    openModal('mass-track-update-modal');
    if (typeof loadPendingTracks === 'function') {
        loadPendingTracks();
    } else {
        console.error("–§—É–Ω–∫—Ü–∏—è loadPendingTracks –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!");
    }
}

// ==========================================
// –ú–û–î–£–õ–¨: –ú–ê–°–°–û–í–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –¢–†–ï–ö–û–í (V2.0 - –° –§–∏–ª—å—Ç—Ä–æ–º)
// ==========================================

// –û—Ç–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞
function handleOpenMassTracks() {
    console.log("–û—Ç–∫—Ä—ã–≤–∞–µ–º –º–∞—Å—Å–æ–≤—ã–µ —Ç—Ä–µ–∫–∏...");
    
    // –°–±—Ä–æ—Å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    document.getElementById('mass-track-client-search').value = '';
    document.getElementById('mass-track-selected-client-id').value = '';
    document.getElementById('mass-track-client-results').classList.add('hidden');
    document.getElementById('mass-track-table-body').innerHTML = '';
    document.getElementById('mass-track-empty-msg').classList.remove('hidden');
    document.getElementById('mass-track-info-text').innerHTML = '–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –µ–≥–æ –∑–∞–∫–∞–∑—ã <b>PENDING...</b>';
    document.getElementById('mass-track-save-btn').disabled = true;

    openModal('mass-track-update-modal');
    setTimeout(() => document.getElementById('mass-track-client-search').focus(), 100);
}

// –ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞ –≤ –º–æ–¥–∞–ª–∫–µ
document.getElementById('mass-track-client-search')?.addEventListener('input', (e) => {
    handleGenericClientSearch(e.target, document.getElementById('mass-track-client-results'), (client) => {
        // –ü—Ä–∏ –≤—ã–±–æ—Ä–µ –∫–ª–∏–µ–Ω—Ç–∞
        document.getElementById('mass-track-client-search').value = `${client.full_name} (${client.client_code_prefix}${client.client_code_num})`;
        document.getElementById('mass-track-selected-client-id').value = client.id;
        document.getElementById('mass-track-client-results').classList.add('hidden');
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –µ–≥–æ –∑–∞–∫–∞–∑—ã
        loadPendingTracksForClient(client);
    });
});

// –ó–∞–≥—Ä—É–∑–∫–∞ PENDING –∑–∞–∫–∞–∑–æ–≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
async function loadPendingTracksForClient(client) {
    const tbody = document.getElementById('mass-track-table-body');
    const emptyMsg = document.getElementById('mass-track-empty-msg');
    const infoText = document.getElementById('mass-track-info-text');
    
    tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4 animate-pulse">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</td></tr>';
    emptyMsg.classList.add('hidden');

    try {
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∑–∞–∫–∞–∑—ã: –°—Ç–∞—Ç—É—Å "–í—ã–∫—É–ø–ª–µ–Ω" + ClientID
        const params = new URLSearchParams({
            statuses: "–í—ã–∫—É–ø–ª–µ–Ω",
            client_id: client.id,
            company_id: currentCompany.id,
            limit: 100
        });
        
        const orders = await apiFetch(`/api/orders?${params.toString()}`);
        
        // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ PENDING –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (–∏–ª–∏ –º–æ–∂–Ω–æ –±—ã–ª–æ uncalculated_only=false, –Ω–æ —Ç—É—Ç –¥—Ä—É–≥–æ–µ)
        const pendingOrders = orders.filter(o => o.track_code.startsWith("PENDING"));

        tbody.innerHTML = '';
        
        if (pendingOrders.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-gray-500">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤ PENDING —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "–í—ã–∫—É–ø–ª–µ–Ω".</td></tr>';
            document.getElementById('mass-track-save-btn').disabled = true;
            return;
        }

        infoText.innerHTML = `–ù–∞–π–¥–µ–Ω–æ <b>${pendingOrders.length}</b> –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤ –¥–ª—è <b>${client.full_name}</b>`;
        document.getElementById('mass-track-save-btn').disabled = false;

        pendingOrders.forEach(o => {
            const row = document.createElement('tr');
            row.className = "border-b hover:bg-gray-50";
            row.innerHTML = `
                <td class="p-3 font-bold text-gray-700">${client.full_name}</td>
                <td class="p-3 text-gray-600 text-xs">
                    ${o.purchase_type === '–í—ã–∫—É–ø' ? '<span class="bg-purple-100 text-purple-800 px-1 rounded">–í—ã–∫—É–ø</span>' : ''}
                    ${o.comment || '-'}
                </td>
                <td class="p-3 text-gray-400 font-mono text-xs select-all">${o.track_code}</td>
                <td class="p-2">
                    <input type="text" class="new-track-input w-full border border-blue-300 rounded p-2 focus:ring-2 focus:ring-blue-500 bg-blue-50 font-mono" 
                           data-order-id="${o.id}" placeholder="–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ –Ω–æ–≤—ã–π —Ç—Ä–µ–∫">
                </td>
            `;
            tbody.appendChild(row);
        });
        
        // –ê–≤—Ç–æ-—Ñ–æ–∫—É—Å –Ω–∞ –ø–µ—Ä–≤–æ–µ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        const firstInput = document.querySelector('.new-track-input');
        if(firstInput) firstInput.focus();

    } catch (e) {
        tbody.innerHTML = `<tr><td colspan="4" class="text-red-500 text-center p-4">–û—à–∏–±–∫–∞: ${e.message}</td></tr>`;
    }
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
document.getElementById('mass-track-save-btn')?.addEventListener('click', async () => {
    const inputs = document.querySelectorAll('.new-track-input');
    const updates = [];

    inputs.forEach(input => {
        const val = input.value.trim();
        // –ï—Å–ª–∏ –ø–æ–ª–µ –Ω–µ –ø—É—Å—Ç–æ–µ –∏ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç "PENDING" (–∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É—Ä–∞–∫–∞)
        if (val.length > 5 && !val.startsWith("PENDING")) {
            updates.push({
                order_id: parseInt(input.dataset.orderId),
                new_track_code: val
            });
        }
    });

    if (updates.length === 0) {
        alert("–í—ã –Ω–µ –≤–≤–µ–ª–∏ –Ω–∏ –æ–¥–Ω–æ–≥–æ –Ω–æ–≤–æ–≥–æ —Ç—Ä–µ–∫-–∫–æ–¥–∞.");
        return;
    }

    if (!confirm(`–û–±–Ω–æ–≤–∏—Ç—å ${updates.length} —Ç—Ä–µ–∫–æ–≤ –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É?`)) return;

    showLoader();
    try {
        const res = await apiFetch('/api/orders/mass_update_tracks', {
            method: 'POST',
            body: JSON.stringify({ updates: updates })
        });
        alert(res.message);
        
        closeModal('mass-track-update-modal');
        if (typeof fetchAndRenderOrders === 'function') fetchAndRenderOrders();
        
    } catch (e) {
        alert("–û—à–∏–±–∫–∞: " + e.message);
    } finally {
        hideLoader();
    }
});

</script>
</body>
</html>
