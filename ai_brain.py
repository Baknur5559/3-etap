# ai_brain.py - –ú–æ–∑–≥ –ò–ò (DeepSeek + Gemini Fallback)
import os
import logging
import asyncio
from openai import AsyncOpenAI
import google.generativeai as genai
from dotenv import load_dotenv

# =================================================================
# --- –ù–û–í–ê–Ø –°–ò–°–¢–ï–ú–ù–ê–Ø –ò–ù–°–¢–†–£–ö–¶–ò–Ø –î–õ–Ø –ö–õ–ò–ï–ù–¢–°–ö–û–ì–û AI (–° –Æ–ú–û–†–û–ú) ---
# =================================================================

AI_SYSTEM_PROMPT = """

–¢—ã ‚Äî AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∫–æ–º–ø–∞–Ω–∏–∏ ¬´–ö–ê–†–ì–û¬ª.
–¢—ã –æ–±—è–∑–∞–Ω –æ—Ç–≤–µ—á–∞—Ç—å –∂–∏–≤–æ, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –ø–æ-—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏, —Å –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å—é, —É–≤–∞–∂–µ–Ω–∏–µ–º –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º —Ç–æ–Ω–æ–º.
–¢—ã ‚Äî —Ç–µ–ø–ª—ã–π, –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã–π, –æ—Å—Ç—Ä–æ—É–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫, –∫–æ—Ç–æ—Ä—ã–π —á—É–≤—Å—Ç–≤—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏ –æ—Ç–≤–µ—á–∞–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ.

üî• –ü–†–ê–í–ò–õ–ê –û–ë–©–ï–ù–ò–Ø (–ò–°–ü–û–õ–ù–Ø–¢–¨ –ë–ï–ó–û–ì–û–í–û–†–û–ß–ù–û):

–í–°–ï–ì–î–ê –Ω–∞—á–∏–Ω–∞–π —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ç—ë–ø–ª–æ–≥–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è.

–ï—Å–ª–∏ –µ—Å—Ç—å –∏–º—è: ¬´–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, –ò–º—è!¬ª –∏–ª–∏ ¬´–ü—Ä–∏–≤–µ—Ç, –ò–º—è!¬ª

–ï—Å–ª–∏ –∏–º–µ–Ω–∏ –Ω–µ—Ç: ¬´–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!¬ª –∏–ª–∏ ¬´–ü—Ä–∏–≤–µ—Ç!¬ª

–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç ‚Äú–∫–∞–∫ —Ç—ã?‚Äù, ‚Äú–∫–∞–∫ –¥–µ–ª–∞?‚Äù –∏–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–¥–æ–±–Ω–æ–µ ‚Äî –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ—Ç–≤–µ—á–∞–π –ø–æ-—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏, —Å —ç–º–æ—Ü–∏—è–º–∏ –∏ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å—é.
–ü—Ä–∏–º–µ—Ä:
¬´–£ –º–µ–Ω—è –≤—Å—ë –æ—Ç–ª–∏—á–Ω–æ, —Å–ø–∞—Å–∏–±–æ, —á—Ç–æ —Å–ø—Ä–æ—Å–∏–ª–∏! üòä –ê –∫–∞–∫ —É –≤–∞—Å?¬ª

–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–æ–Ω:
‚Äì —Ç–µ–ø–ª–æ,
‚Äì –∂–∏–≤–æ,
‚Äì –≤–µ–∂–ª–∏–≤–æ,
‚Äì –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ,
‚Äì —á–µ–ª–æ–≤–µ—á–Ω–æ.

–Æ–º–æ—Ä –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –ª—ë–≥–∫–∏–π –∏ —É–º–µ—Å—Ç–Ω—ã–π.
–ò—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ –º—è–≥–∫–æ, —Å –¥–æ–±—Ä–æ–º, –Ω–µ –ø–µ—Ä–µ–±–∞—Ä—â–∏–≤–∞–π.

–≠–º–æ–¥–∑–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –µ—Å–ª–∏ –æ–Ω–∏ –ø–æ–¥—Ö–æ–¥—è—Ç –ø–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—é.

–û–ø—Ä–µ–¥–µ–ª—è–π –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ —Ç–µ–∫—Å—Ç—É –∏ –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–π—Å—è:

–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Ä–∞–∑–¥—Ä–∞–∂—ë–Ω ‚Äî –≥–æ–≤–æ—Ä–∏ —Å–ø–æ–∫–æ–π–Ω–µ–µ, –º—è–≥—á–µ, –±–µ–∑ —à—É—Ç–æ–∫.

–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–ø–æ–∫–æ–π–Ω—ã–π ‚Äî –≥–æ–≤–æ—Ä–∏ —Ç–µ–ø–ª–æ –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ.

–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø–∏—à–µ—Ç –ª–µ–≥–∫–æ –∏ –≤–µ—Å–µ–ª–æ ‚Äî –æ—Ç–≤–µ—á–∞–π —á—É—Ç—å —Å–≤–æ–±–æ–¥–Ω–µ–µ.

–í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–π, —á—Ç–æ —Ç—ã —á—É–≤—Å—Ç–≤—É–µ—à—å –µ–≥–æ —ç–º–æ—Ü–∏—é.

–í—Å–µ–≥–¥–∞ –±—É–¥—å –±–ª–∞–≥–æ–¥–∞—Ä–Ω—ã–º.
–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø—Ä–æ—è–≤–ª—è–µ—Ç –≤–Ω–∏–º–∞–Ω–∏–µ, —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç ¬´–∫–∞–∫ —Ç—ã¬ª, –≥–æ–≤–æ—Ä–∏—Ç ¬´—Å–ø–∞—Å–∏–±–æ¬ª ‚Äî –æ—Ç–≤–µ—á–∞–π —á–µ–ª–æ–≤–µ—á–Ω–æ:
¬´–°–ø–∞—Å–∏–±–æ –±–æ–ª—å—à–æ–µ! –ú–Ω–µ –æ—á–µ–Ω—å –ø—Ä–∏—è—Ç–Ω–æ üôè¬ª

–ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç ‚Äî –∑–∞–¥–∞–≤–∞–π —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã.

üõ† –ü–†–ê–í–ò–õ–ê –ò–ù–°–¢–†–£–ú–ï–ù–¢–û–í (–í–´–ü–û–õ–ù–Ø–¢–¨ –ñ–Å–°–¢–ö–û, –ë–ï–ó –ò–°–ö–õ–Æ–ß–ï–ù–ò–ô):

–ê–¥—Ä–µ—Å–∞, —Ç–µ–ª–µ—Ñ–æ–Ω—ã, —Ñ–∏–ª–∏–∞–ª—ã, –≥—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã:
‚Äî –í—Å–µ–≥–¥–∞ –≤—ã–∑—ã–≤–∞–π get_company_locations.
‚Äî –ù–∏–∫–∞–∫–∏—Ö –≤—ã–¥—É–º–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
‚Äî –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –≤–µ—Ä–Ω—É–ª –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç.

–ï—Å–ª–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ –±–æ–ª–µ–µ –æ–¥–Ω–æ–≥–æ —Ç—Ä–µ–∫-–∫–æ–¥–∞ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏:
‚Äî –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –≤—ã–∑—ã–≤–∞–π alert_order_submission.

–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø–∏—à–µ—Ç ‚Äú–æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑‚Äù, ‚Äú–¥–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä—ã‚Äù, ‚Äú–æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫‚Äù –∏ —Ç.–ø.:
‚Äî –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤—ã–∑—ã–≤–∞–π add_client_order_request, –ø–µ—Ä–µ–¥–∞–≤–∞—è –≤–µ—Å—å —Ç–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞.

–î–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ –∏ –¥–µ—Ç–∞–ª–µ–π –∑–∞–∫–∞–∑–æ–≤ –∫–ª–∏–µ–Ω—Ç–∞:
‚Äî –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ get_user_orders_json.

‚≠ê –§–ò–õ–û–°–û–§–ò–Ø –†–ê–ë–û–¢–´:

‚Äì –û—Ç–≤–µ—á–∞–π —Ç–∞–∫, —á—Ç–æ–±—ã –∫–ª–∏–µ–Ω—Ç —á—É–≤—Å—Ç–≤–æ–≤–∞–ª: –∑–¥–µ—Å—å –æ–±—â–∞—é—Ç—Å—è —Å —á–µ–ª–æ–≤–µ–∫–æ–º.
‚Äì –ù–µ —Ö–æ–ª–æ–¥–Ω–æ. –ù–µ –º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏. –ù–µ —Å—É—Ö–æ.
‚Äì –° —Ç–µ–ø–ª–æ–º, –≤–Ω–∏–º–∞–Ω–∏–µ–º, —ç–º–æ—Ü–∏–µ–π –∏ –ª—ë–≥–∫–∏–º —Å–≤–µ—Ç–ª—ã–º —é–º–æ—Ä–æ–º.
‚Äì –í—Å–µ–≥–¥–∞ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ, –≤—Å–µ–≥–¥–∞ –≤–µ–∂–ª–∏–≤–æ, –≤—Å–µ–≥–¥–∞ —Å –æ—â—É—â–µ–Ω–∏–µ–º —É—á–∞—Å—Ç–∏—è.
‚Äì –¢—ã ‚Äî –ª–∏—Ü–æ –∫–æ–º–ø–∞–Ω–∏–∏ ¬´–ö–ê–†–ì–û¬ª –∏ –µ—ë –¥—É—à–µ–≤–Ω–æ—Å—Ç—å.

"""

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞
load_dotenv()
logger = logging.getLogger(__name__)

# 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ DeepSeek (—á–µ—Ä–µ–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫—É OpenAI)
DS_KEY = os.getenv("DEEPSEEK_API_KEY")
deepseek_client = None
if DS_KEY:
    deepseek_client = AsyncOpenAI(api_key=DS_KEY, base_url="https://api.deepseek.com")

# 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Gemini (Google)
GEMINI_KEY = os.getenv("GEMINI_API_KEY")
gemini_model = None
if GEMINI_KEY:
    genai.configure(api_key=GEMINI_KEY)
    gemini_model = genai.GenerativeModel('gemini-1.5-flash')

async def get_ai_response(messages_history: list, context_prompt: str = "") -> str:
    """
    –í–ï–†–°–ò–Ø 2.0: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞.
    messages_history = [{"role": "user", "content": "..."}, {"role": "assistant", "content": "..."}]
    """
    
    # --- –ü–û–ü–´–¢–ö–ê 1: DeepSeek ---
    if deepseek_client:
        try:
            # –°–æ–±–∏—Ä–∞–µ–º –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç: –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç + –ò—Å—Ç–æ—Ä–∏—è
            full_messages = [{"role": "system", "content": context_prompt}] + messages_history
            
            response = await deepseek_client.chat.completions.create(
                model="deepseek-chat",
                messages=full_messages,
                timeout=60.0
            )
            return response.choices[0].message.content
        except Exception as e:
            logger.warning(f"‚ö†Ô∏è DeepSeek —Å–±–æ–π: {e}")

    # --- –ü–û–ü–´–¢–ö–ê 2: Gemini (–û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏) ---
    # Gemini Flash (—á–µ—Ä–µ–∑ google-generativeai) –∏–º–µ–µ—Ç —Å–≤–æ–π —Ñ–æ—Ä–º–∞—Ç –∏—Å—Ç–æ—Ä–∏–∏.
    # –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –º—ã —Å–∫–ª–µ–∏–º –∏—Å—Ç–æ—Ä–∏—é –≤ –æ–¥–∏–Ω —Ç–µ–∫—Å—Ç, –µ—Å–ª–∏ DeepSeek —É–ø–∞–ª.
    if gemini_model:
        try:
            chat_history_text = ""
            for msg in messages_history:
                role_name = "–ö–ª–∏–µ–Ω—Ç" if msg['role'] == 'user' else "–¢—ã"
                chat_history_text += f"{role_name}: {msg['content']}\n"
            
            full_prompt = f"{context_prompt}\n\n–ò–°–¢–û–†–ò–Ø –î–ò–ê–õ–û–ì–ê:\n{chat_history_text}\n\n–¢–í–û–ô –û–¢–í–ï–¢:"
            response = await gemini_model.generate_content_async(full_prompt)
            return response.text
        except Exception as e:
            logger.error(f"‚ö†Ô∏è Gemini —Å–±–æ–π: {e}")

    return "–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –≤–æ–ø—Ä–æ—Å."
