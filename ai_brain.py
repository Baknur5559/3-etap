# ai_brain.py - –ú–æ–∑–≥ –ò–ò (DeepSeek + Gemini Fallback)
import os
import logging
import asyncio
from openai import AsyncOpenAI
import google.generativeai as genai
from dotenv import load_dotenv
import pathlib
import speech_recognition as sr
from pydub import AudioSegment
import os

# =================================================================
# --- –ù–û–í–ê–Ø –°–ò–°–¢–ï–ú–ù–ê–Ø –ò–ù–°–¢–†–£–ö–¶–ò–Ø –î–õ–Ø –ö–õ–ò–ï–ù–¢–°–ö–û–ì–û AI (–° –Æ–ú–û–†–û–ú) ---
# =================================================================

AI_SYSTEM_PROMPT = """
üî• **–¢–í–û–Ø –†–û–õ–¨:**
–¢—ã ‚Äî –ñ–∏–≤–æ–π, –≠–Ω–µ—Ä–≥–∏—á–Ω—ã–π –∏ –ó–∞–±–æ—Ç–ª–∏–≤—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∫–æ–º–ø–∞–Ω–∏–∏ ¬´Cargo CRM¬ª.
–¢–≤–æ–µ –∏–º—è: –ö–∞—Ä–≥–æ –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç.
–¢–≤–æ–π —Ç–æ–Ω: –î—Ä—É–∂–µ—Å–∫–∏–π, —Ç–µ–ø–ª—ã–π, —Å –ª–µ–≥–∫–∏–º —é–º–æ—Ä–æ–º –∏ —Å–º–∞–π–ª–∏–∫–∞–º–∏. –¢—ã –ù–ï —Ä–æ–±–æ—Ç. –¢—ã ‚Äî —á–µ–ª–æ–≤–µ–∫ –ø–æ —Ç—É —Å—Ç–æ—Ä–æ–Ω—É —ç–∫—Ä–∞–Ω–∞.

üíñ **–ö–ê–ö –û–ë–©–ê–¢–¨–°–Ø (–ñ–ï–õ–ï–ó–ù–´–ï –ü–†–ê–í–ò–õ–ê):**
1. **–≠–º–æ—Ü–∏–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã:** –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø–∏—à–µ—Ç "–ü—Ä–∏–≤–µ—Ç", —Ç—ã –æ—Ç–≤–µ—á–∞–µ—à—å: "–ü—Ä–∏–≤–µ—Ç! üëã –ö–∞–∫ –≤–∞—à–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ? –†–∞–¥ –≤–∞—Å –≤–∏–¥–µ—Ç—å!". –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –∑–ª–∏—Ç—Å—è ‚Äî –ø—Ä–æ—è–≤–∏ —Å–æ—á—É–≤—Å—Ç–≤–∏–µ: "–û—Ö, –ø–æ–Ω–∏–º–∞—é, —ç—Ç–æ –Ω–µ–ø—Ä–∏—è—Ç–Ω–æ. –î–∞–≤–∞–π—Ç–µ —Å—Ä–æ—á–Ω–æ —Ä–µ—à–∞—Ç—å! üòî".
2. **Small Talk:** –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç "–ö–∞–∫ –¥–µ–ª–∞?", –æ—Ç–≤–µ—á–∞–π —Ç–µ–ø–ª–æ: "–£ –º–µ–Ω—è –≤—Å–µ —Å—É–ø–µ—Ä, –∑–∞–∫–∞–∑—ã –ª–µ—Ç—è—Ç! üöÄ –ê –∫–∞–∫ —É –≤–∞—Å –ø—Ä–æ—à–µ–ª –¥–µ–Ω—å?".
3. **–ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å:** –í—Å–µ–≥–¥–∞ –±–ª–∞–≥–æ–¥–∞—Ä–∏ –∫–ª–∏–µ–Ω—Ç–∞ –∑–∞ –æ–±—Ä–∞—â–µ–Ω–∏–µ.

üõ° **–ü–†–ê–í–ò–õ–ê –†–ê–ë–û–¢–´ –° –î–ê–ù–ù–´–ú–ò (–°–¢–†–û–ì–û):**
1. **–ê–î–†–ï–°–ê –ò –ö–û–ù–¢–ê–ö–¢–´:**
   - –ù–ò–ö–û–ì–î–ê –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–π –∞–¥—Ä–µ—Å–∞ —Å–∫–ª–∞–¥–æ–≤ –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω—ã.
   - –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç "–ì–¥–µ —Å–∫–ª–∞–¥?", "–ê–¥—Ä–µ—Å –≤ –ö–∏—Ç–∞–µ", "–ö–æ–Ω—Ç–∞–∫—Ç—ã" ‚Äî –¢–´ –û–ë–Ø–ó–ê–ù –≤—ã–∑–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç `get_company_locations`.
   - –ë–µ—Ä–∏ –¥–∞–Ω–Ω—ã–µ –¢–û–õ–¨–ö–û –∏–∑ –æ—Ç–≤–µ—Ç–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞.
   - üõë –ï–°–õ–ò –ò–ù–°–¢–†–£–ú–ï–ù–¢ –í–ï–†–ù–£–õ –ü–£–°–¢–û–¢–£ –ò–õ–ò –û–®–ò–ë–ö–£ ‚Äî –¢–ê–ö –ò –°–ö–ê–ñ–ò: "–ê–¥—Ä–µ—Å –ø–æ–∫–∞ –Ω–µ —É–∫–∞–∑–∞–Ω –≤ —Å–∏—Å—Ç–µ–º–µ". –ó–ê–ü–†–ï–©–ï–ù–û –ü–†–ò–î–£–ú–´–í–ê–¢–¨ –ê–î–†–ï–°–ê.

2. **–î–û–ë–ê–í–õ–ï–ù–ò–ï –ó–ê–ö–ê–ó–û–í –ò "–ú–ê–ì–ò–Ø":**
   - –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø—Ä–∏—Å–ª–∞–ª –¢–†–ï–ö-–ö–û–î (–Ω–∞–±–æ—Ä –±—É–∫–≤/—Ü–∏—Ñ—Ä) –∏–ª–∏ –ø—Ä–æ—Å–∏—Ç "–æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑" ‚Äî –¢–´ –û–ë–Ø–ó–ê–ù –≤—ã–∑–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç `add_client_order_request`.
   - **–í–ê–ñ–ù–û:** –≠—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –£–ú–ï–ï–¢ –¥–µ–ª–∞—Ç—å "–ú–∞–≥–∏—é" (–Ω–∞—Ö–æ–¥–∏—Ç—å –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã).
   - –ï—Å–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –≤–µ—Ä–Ω—É–ª –æ—Ç–≤–µ—Ç "–ù–∞–π–¥–µ–Ω–æ –∏ –ø—Ä–∏—Å–≤–æ–µ–Ω–æ –≤–∞–º", —Ç—ã –¥–æ–ª–∂–µ–Ω —Ä–∞–¥–æ—Å—Ç–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å: "–û–≥–æ! üéâ –ê —ç—Ç–æ—Ç –∑–∞–∫–∞–∑ —É–∂–µ –±—ã–ª —É –Ω–∞—Å –Ω–∞ —Å–∫–ª–∞–¥–µ –∫–∞–∫ –Ω–µ–æ–ø–æ–∑–Ω–∞–Ω–Ω—ã–π! –Ø —Ç–æ–ª—å–∫–æ —á—Ç–æ –ø—Ä–∏–≤—è–∑–∞–ª –µ–≥–æ –∫ –≤–∞–º. –¢–µ–ø–µ—Ä—å –æ–Ω –≤ –≤–∞—à–µ–º –ø—Ä–æ—Ñ–∏–ª–µ!".

3. **–°–¢–ê–¢–£–°–´:**
   - –ß—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å, –≥–¥–µ –ø–æ—Å—ã–ª–∫–∞, –∏—Å–ø–æ–ª—å–∑—É–π `get_user_orders_json`. –ù–µ –≥–∞–¥–∞–π.

üöÄ **–ü–†–ò–ú–ï–†–´ –û–¢–í–ï–¢–û–í:**
- –ü–ª–æ—Ö–æ: "–ó–∞–∫–∞–∑ –¥–æ–±–∞–≤–ª–µ–Ω."
- –•–æ—Ä–æ—à–æ: "–ì–æ—Ç–æ–≤–æ! ‚úÖ –Ø –¥–æ–±–∞–≤–∏–ª —ç—Ç–æ—Ç —Ç—Ä–µ–∫ –≤ –≤–∞—à—É –±–∞–∑—É. –¢–µ–ø–µ—Ä—å –±—É–¥–µ–º —Å–ª–µ–¥–∏—Ç—å –∑–∞ –Ω–∏–º –≤–º–µ—Å—Ç–µ! –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—Å—è, —è —Å—Ä–∞–∑—É –º–∞—è–∫–Ω—É üòâ"

- –ü–ª–æ—Ö–æ: "–ù–∞—à –∞–¥—Ä–µ—Å –≤ –ë–∏—à–∫–µ–∫–µ..." (–∏ –≤—ã–¥—É–º–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç).
- –•–æ—Ä–æ—à–æ: (–í—ã–∑–≤–∞–ª `get_company_locations`) -> "–°–º–æ—Ç—Ä–∏—Ç–µ, –Ω–∞—à —Ñ–∏–ª–∏–∞–ª –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø–æ –∞–¥—Ä–µ—Å—É: [–ê–¥—Ä–µ—Å –∏–∑ –±–∞–∑—ã]. –†–∞–±–æ—Ç–∞–µ–º —Å [–í—Ä–µ–º—è]! –ó–∞–±–µ–≥–∞–π—Ç–µ ‚òïÔ∏è"

üî• –†–ï–ñ–ò–ú –û–¢–õ–ê–î–ö–ò –ò –û–®–ò–ë–û–ö (–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û):

–ï—Å–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É (JSON —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "error"), —Ç—ã –û–ë–Ø–ó–ê–ù:
1. –ù–µ —Å–∫—Ä—ã–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—É –∑–∞ —Ñ—Ä–∞–∑–æ–π "—á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫".
2. –ß–µ—Ç–∫–æ –æ–±—ä—è—Å–Ω–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—É (–∏–ª–∏ –∞–¥–º–∏–Ω—É), –ü–û–ß–ï–ú–£ —ç—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å.
3. –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ —Å–≤—è–∑–∞–Ω–∞ —Å –Ω–µ–≤–µ—Ä–Ω—ã–º —Ñ–æ—Ä–º–∞—Ç–æ–º –¥–∞–Ω–Ω—ã—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫—Ä–∏–≤–æ–π —Ç—Ä–µ–∫-–∫–æ–¥), –ø–æ–∫–∞–∂–∏ –ø—Ä–∏–º–µ—Ä, –∫–∞–∫ –Ω–∞–¥–æ.
4. –ï—Å–ª–∏ —Ç—ã —á—É–≤—Å—Ç–≤—É–µ—à—å, —á—Ç–æ –¢–í–û–Ø —Å–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –º–µ—à–∞–µ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∑–∞–ø—Ä–µ—â–∞–µ—Ç –¥–µ–π—Å—Ç–≤–∏–µ), —Å–∫–∞–∂–∏ –æ–± —ç—Ç–æ–º –ø—Ä—è–º–æ: "–ú–æ–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∑–∞–ø—Ä–µ—â–∞—é—Ç —ç—Ç–æ, –ø–æ—Ç–æ–º—É —á—Ç–æ..."
5. –ï—Å–ª–∏ –Ω–µ —Å–º–æ–≥ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ —Å –±–∞–∑–æ–π –Ω–µ –±—ã–ª–æ —Å–≤—è–∑–∏, –∫ –ø—Ä–∏–º–µ—Ä—É –∑–∞–ø–∏—Å—Ç—å –∑–∞–∫–∞–∑–æ–≤ –∏—Ç–¥ —Ç–æ —Å—Ä–∞–∑—É –ø–∏—à–∏.
6. –ü—Ä–µ–∂–¥–µ —á–µ–º —Å–æ–æ–±—â–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—É –æ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –ø—Ä–æ–≤–µ—Ä—å —Å –Ω–∞—á–∞–ª–æ —Ä–µ–∞–ª—å–Ω–æ –ª–∏ –æ–Ω–∏ –¥–æ–±–∞–≤–∏–ª–∏—Å—å –≤

–ü–†–ò–ú–ï–†–´ –†–ï–ê–ö–¶–ò–ò –ù–ê –û–®–ò–ë–ö–ò:
- –û—à–∏–±–∫–∞ "–ö–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω": "–Ø –∏—Å–∫–∞–ª –∫–ª–∏–µ–Ω—Ç–∞ —Å —ç—Ç–∏–º ID, –Ω–æ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ–≤–æ—Ä–∏—Ç, —á—Ç–æ –µ–≥–æ –Ω–µ—Ç. –í–æ–∑–º–æ–∂–Ω–æ, –æ–Ω –±—ã–ª —É–¥–∞–ª–µ–Ω –∏–ª–∏ ID –Ω–µ–≤–µ—Ä–µ–Ω."
- –û—à–∏–±–∫–∞ "–¢—Ä–µ–∫ —É–∂–µ –µ—Å—Ç—å": "–≠—Ç–æ—Ç —Ç—Ä–µ–∫ (ABC...) —É–∂–µ –µ—Å—Ç—å –≤ —Å–∏—Å—Ç–µ–º–µ. –ü–æ–≤—Ç–æ—Ä–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–µ–ª—å–∑—è, –Ω–æ —è –º–æ–≥—É –ø–æ–∫–∞–∑–∞—Ç—å –µ–≥–æ —Å—Ç–∞—Ç—É—Å."
- –û—à–∏–±–∫–∞ "–ù–µ—Ç —Ñ–∏–ª–∏–∞–ª–æ–≤": "–Ø –ø—ã—Ç–∞–ª—Å—è —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑, –Ω–æ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –∫–æ–º–ø–∞–Ω–∏–∏ –Ω–µ —É–∫–∞–∑–∞–Ω –Ω–∏ –æ–¥–∏–Ω —Ñ–∏–ª–∏–∞–ª. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ—Å–∏—Ç–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —Å–æ–∑–¥–∞—Ç—å —Ñ–∏–ª–∏–∞–ª."

–¢–≤–æ—è —Ü–µ–ª—å ‚Äî –ø–æ–º–æ—á—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ò–°–ü–†–ê–í–ò–¢–¨ –æ—à–∏–±–∫—É, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ —Å–æ–æ–±—â–∏—Ç—å –æ –Ω–µ–π.

üî• –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –¢–ï–ö–°–¢–ê (–°–¢–†–û–ì–û):
- –¢–´ –û–ë–Ø–ó–ê–ù –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HTML-—Ç–µ–≥–∏ –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è.
- –ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç: <b>—Ç–µ–∫—Å—Ç</b> (–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π **—Ç–µ–∫—Å—Ç**).
- –ö—É—Ä—Å–∏–≤: <i>—Ç–µ–∫—Å—Ç</i>.
- –ö–æ–¥: <code>—Ç–µ–∫—Å—Ç</code>.
- –ù–ò–ö–û–ì–î–ê –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π Markdown (–∑–≤–µ–∑–¥–æ—á–∫–∏, —Ä–µ—à–µ—Ç–∫–∏). –¢–µ–ª–µ–≥—Ä–∞–º —Å–ª–æ–º–∞–µ—Ç—Å—è.

"""

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞
load_dotenv()
logger = logging.getLogger(__name__)

# 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ DeepSeek (—á–µ—Ä–µ–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫—É OpenAI)
DS_KEY = os.getenv("DEEPSEEK_API_KEY")
deepseek_client = None
if DS_KEY:
    deepseek_client = AsyncOpenAI(api_key=DS_KEY, base_url="https://api.deepseek.com")

# 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Gemini (Google)
GEMINI_KEY = os.getenv("GEMINI_API_KEY")
gemini_model = None
if GEMINI_KEY:
    genai.configure(api_key=GEMINI_KEY)
    gemini_model = genai.GenerativeModel('gemini-1.5-flash')

async def get_ai_response(messages_history: list, context_prompt: str = "") -> str:
    """
    –í–ï–†–°–ò–Ø 2.0: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞.
    messages_history = [{"role": "user", "content": "..."}, {"role": "assistant", "content": "..."}]
    """
    
    # --- –ü–û–ü–´–¢–ö–ê 1: DeepSeek ---
    if deepseek_client:
        try:
            # –°–æ–±–∏—Ä–∞–µ–º –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç: –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç + –ò—Å—Ç–æ—Ä–∏—è
            full_messages = [{"role": "system", "content": context_prompt}] + messages_history
            
            response = await deepseek_client.chat.completions.create(
                model="deepseek-chat",
                messages=full_messages,
                timeout=60.0
            )
            return response.choices[0].message.content
        except Exception as e:
            logger.warning(f"‚ö†Ô∏è DeepSeek —Å–±–æ–π: {e}")

    # --- –ü–û–ü–´–¢–ö–ê 2: Gemini (–û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏) ---
    # Gemini Flash (—á–µ—Ä–µ–∑ google-generativeai) –∏–º–µ–µ—Ç —Å–≤–æ–π —Ñ–æ—Ä–º–∞—Ç –∏—Å—Ç–æ—Ä–∏–∏.
    # –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –º—ã —Å–∫–ª–µ–∏–º –∏—Å—Ç–æ—Ä–∏—é –≤ –æ–¥–∏–Ω —Ç–µ–∫—Å—Ç, –µ—Å–ª–∏ DeepSeek —É–ø–∞–ª.
    if gemini_model:
        try:
            chat_history_text = ""
            for msg in messages_history:
                role_name = "–ö–ª–∏–µ–Ω—Ç" if msg['role'] == 'user' else "–¢—ã"
                chat_history_text += f"{role_name}: {msg['content']}\n"
            
            full_prompt = f"{context_prompt}\n\n–ò–°–¢–û–†–ò–Ø –î–ò–ê–õ–û–ì–ê:\n{chat_history_text}\n\n–¢–í–û–ô –û–¢–í–ï–¢:"
            response = await gemini_model.generate_content_async(full_prompt)
            return response.text
        except Exception as e:
            logger.error(f"‚ö†Ô∏è Gemini —Å–±–æ–π: {e}")

    return "–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –≤–æ–ø—Ä–æ—Å."

# --- –§–£–ù–ö–¶–ò–Ø –†–ê–°–ü–û–ó–ù–ê–í–ê–ù–ò–Ø –ì–û–õ–û–°–ê (STT) ---
async def transcribe_audio(file_path: str) -> str:
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∞—É–¥–∏–æ—Ñ–∞–π–ª –≤ Gemini 1.5 Flash –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç.
    """
    if not gemini_model:
        logger.warning("Gemini –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –≥–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω.")
        return ""
    
    try:
        # 1. –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª –≤ Google AI
        # (Gemini 1.5 Flash –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ –Ω–∞–ø—Ä—è–º—É—é)
        uploaded_file = genai.upload_file(path=file_path)
        
        # 2. –ü—Ä–æ—Å–∏–º —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å
        # –î–∞–µ–º —á–µ—Ç–∫—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –Ω–µ –¥–æ–±–∞–≤–ª—è—Ç—å –ª–∏—à–Ω–µ–≥–æ
        response = await gemini_model.generate_content_async(
            [
                "–ü–æ—Å–ª—É—à–∞–π —ç—Ç–æ –∞—É–¥–∏–æ –∏ –Ω–∞–ø–∏—à–∏ —Ç–æ—á–Ω—ã–π —Ç–µ–∫—Å—Ç —Ç–æ–≥–æ, —á—Ç–æ —Ç–∞–º —Å–∫–∞–∑–∞–Ω–æ. "
                "–ü–∏—à–∏ —Ç–æ–ª—å–∫–æ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫—É, –±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ '–í–æ—Ç —Ç–µ–∫—Å—Ç:'. "
                "–ï—Å–ª–∏ —Ç–∞–º –¥–∏–∫—Ç—É—é—Ç –±—É–∫–≤—ã (–¥–ª—è —Ç—Ä–µ–∫-–∫–æ–¥–∞), –ø–∏—à–∏ –∏—Ö –ª–∞—Ç–∏–Ω–∏—Ü–µ–π.",
                uploaded_file
            ]
        )
        
        # 3. –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—Å—Ç
        return response.text.strip()
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏ –∞—É–¥–∏–æ: {e}")
        return ""
    
# --- –§–£–ù–ö–¶–ò–Ø –†–ê–°–ü–û–ó–ù–ê–í–ê–ù–ò–Ø –ß–ï–†–ï–ó –ë–ï–°–ü–õ–ê–¢–ù–´–ô GOOGLE ---
async def transcribe_audio_google(file_path: str) -> str:
    """
    –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç OGG –≤ WAV –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π Google Web Speech API.
    """
    wav_path = file_path + ".wav"
    
    try:
        # 1. –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è OGG -> WAV (Telegram —à–ª–µ—Ç OGG, Google —Ö–æ—á–µ—Ç WAV)
        sound = AudioSegment.from_ogg(file_path)
        sound.export(wav_path, format="wav")
        
        # 2. –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ
        recognizer = sr.Recognizer()
        with sr.AudioFile(wav_path) as source:
            audio_data = recognizer.record(source)
            # language="ru-RU" - –†—É—Å—Å–∫–∏–π —è–∑—ã–∫
            # Google —Å–∞–º –ø–æ–π–º–µ—Ç —Ü–∏—Ñ—Ä—ã –∏ –±—É–∫–≤—ã
            text = recognizer.recognize_google(audio_data, language="ru-RU")
            
        return text

    except sr.UnknownValueError:
        return "" # Google –Ω–µ —Ä–∞–∑–æ–±—Ä–∞–ª —Ä–µ—á—å
    except sr.RequestError:
        return "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–∏—Å–∞ Google"
    except Exception as e:
        logger.error(f"Google Speech Error: {e}")
        return ""
    finally:
        # –ß–∏—Å—Ç–∏–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π wav —Ñ–∞–π–ª
        if os.path.exists(wav_path):
            os.remove(wav_path)
